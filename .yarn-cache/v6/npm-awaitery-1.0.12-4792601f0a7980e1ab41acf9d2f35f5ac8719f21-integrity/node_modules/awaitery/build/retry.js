// @ts-check
import timeout from "./timeout.js";
import wait from "./wait.js";
/**
 * @typedef {object} RetryArgs
 * @property {number} [timeout] The timeout in milliseconds
 * @property {number} [tries] The number of tries (default: 3)
 * @property {number} [wait] The wait time in milliseconds between tries (default: 50)
 * @property {string} [timeoutErrorMessage] The error message when timing out
 */
/**
 * @template T
 * @typedef {() => (T | Promise<T>)} RetryCallback
 */
/**
 * Retries a callback until it succeeds or the timeout is reached without arguments.
 * @template T
 * @overload
 * @param {RetryCallback<T>} arg1 - The callback to retry.
 * @param {undefined} [arg2]
 * @returns {Promise<T>} Resolves with the callback result.
 */
/**
 * Retries a callback until it succeeds or the timeout is reached with arguments.
 * @template T
 * @overload
 * @param {RetryArgs} arg1 - The arguments.
 * @param {RetryCallback<T>} arg2 - The callback to retry.
 * @returns {Promise<T>} Resolves with the callback result.
 */
/**
 * @template T
 * @param {RetryArgs | RetryCallback<T>} arg1 The arguments or the callback.
 * @param {RetryCallback<T>} [arg2] The callback when arguments are provided.
 * @returns {Promise<T>} Resolves with the callback result.
 */
export default async function retry(arg1, arg2) {
    /** @type {RetryArgs | undefined} */
    let args;
    /** @type {RetryCallback<T> | undefined} */
    let callback;
    if (typeof arg1 == "function" && arg2 === undefined) {
        args = {};
        callback = arg1;
    }
    else if (typeof arg1 == "object" && typeof arg2 == "function") {
        args = arg1;
        callback = arg2;
    }
    if (callback == undefined)
        throw new Error("Somehow callback is undefined");
    if (typeof args !== "object")
        throw new Error("Somehow args isn't an object");
    const { timeout: timeoutNumber = null, tries = 3, wait: waitNumber = undefined, timeoutErrorMessage, ...restArgs } = args;
    const restArgsKeys = Object.keys(restArgs);
    if (restArgsKeys.length > 0)
        throw new Error(`Unknown arguments given to retry: ${restArgsKeys.join(", ")}`);
    for (let tryNumber = 1; tryNumber <= tries; tryNumber++) {
        try {
            if (timeoutNumber) {
                return await timeout({ timeout: timeoutNumber, errorMessage: timeoutErrorMessage }, callback);
            }
            else {
                return await callback();
            }
        }
        catch (error) {
            if (tryNumber < tries) {
                if (waitNumber !== undefined && waitNumber > 0) {
                    await wait(waitNumber);
                }
            }
            else {
                throw error;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV0cnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmV0cnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWTtBQUVaLE9BQU8sT0FBTyxNQUFNLGNBQWMsQ0FBQTtBQUNsQyxPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFFNUI7Ozs7OztHQU1HO0FBRUg7OztHQUdHO0FBRUg7Ozs7Ozs7R0FPRztBQUNIOzs7Ozs7O0dBT0c7QUFDSDs7Ozs7R0FLRztBQUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFVLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSTtJQUM1QyxvQ0FBb0M7SUFDcEMsSUFBSSxJQUFJLENBQUE7SUFFUiwyQ0FBMkM7SUFDM0MsSUFBSSxRQUFRLENBQUE7SUFFWixJQUFJLE9BQU8sSUFBSSxJQUFJLFVBQVUsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDcEQsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUNULFFBQVEsR0FBRyxJQUFJLENBQUE7SUFDakIsQ0FBQztTQUFNLElBQUksT0FBTyxJQUFJLElBQUksUUFBUSxJQUFJLE9BQU8sSUFBSSxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2hFLElBQUksR0FBRyxJQUFJLENBQUE7UUFDWCxRQUFRLEdBQUcsSUFBSSxDQUFBO0lBQ2pCLENBQUM7SUFFRCxJQUFJLFFBQVEsSUFBSSxTQUFTO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFBO0lBQzNFLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQTtJQUU3RSxNQUFNLEVBQ0osT0FBTyxFQUFFLGFBQWEsR0FBRyxJQUFJLEVBQzdCLEtBQUssR0FBRyxDQUFDLEVBQ1QsSUFBSSxFQUFFLFVBQVUsR0FBRyxTQUFTLEVBQzVCLG1CQUFtQixFQUNuQixHQUFHLFFBQVEsRUFDWixHQUFHLElBQUksQ0FBQTtJQUNSLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7SUFFMUMsSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUM7UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHFDQUFxQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUU1RyxLQUFLLElBQUksU0FBUyxHQUFHLENBQUMsRUFBRSxTQUFTLElBQUksS0FBSyxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUM7UUFDeEQsSUFBSSxDQUFDO1lBQ0gsSUFBSSxhQUFhLEVBQUUsQ0FBQztnQkFDbEIsT0FBTyxNQUFNLE9BQU8sQ0FBQyxFQUFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLG1CQUFtQixFQUFDLEVBQUUsUUFBUSxDQUFDLENBQUE7WUFDN0YsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE9BQU8sTUFBTSxRQUFRLEVBQUUsQ0FBQTtZQUN6QixDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLFNBQVMsR0FBRyxLQUFLLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxVQUFVLEtBQUssU0FBUyxJQUFJLFVBQVUsR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDL0MsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQ3hCLENBQUM7WUFDSCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sTUFBTSxLQUFLLENBQUE7WUFDYixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWNoZWNrXG5cbmltcG9ydCB0aW1lb3V0IGZyb20gXCIuL3RpbWVvdXQuanNcIlxuaW1wb3J0IHdhaXQgZnJvbSBcIi4vd2FpdC5qc1wiXG5cbi8qKlxuICogQHR5cGVkZWYge29iamVjdH0gUmV0cnlBcmdzXG4gKiBAcHJvcGVydHkge251bWJlcn0gW3RpbWVvdXRdIFRoZSB0aW1lb3V0IGluIG1pbGxpc2Vjb25kc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IFt0cmllc10gVGhlIG51bWJlciBvZiB0cmllcyAoZGVmYXVsdDogMylcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbd2FpdF0gVGhlIHdhaXQgdGltZSBpbiBtaWxsaXNlY29uZHMgYmV0d2VlbiB0cmllcyAoZGVmYXVsdDogNTApXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW3RpbWVvdXRFcnJvck1lc3NhZ2VdIFRoZSBlcnJvciBtZXNzYWdlIHdoZW4gdGltaW5nIG91dFxuICovXG5cbi8qKlxuICogQHRlbXBsYXRlIFRcbiAqIEB0eXBlZGVmIHsoKSA9PiAoVCB8IFByb21pc2U8VD4pfSBSZXRyeUNhbGxiYWNrXG4gKi9cblxuLyoqXG4gKiBSZXRyaWVzIGEgY2FsbGJhY2sgdW50aWwgaXQgc3VjY2VlZHMgb3IgdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCB3aXRob3V0IGFyZ3VtZW50cy5cbiAqIEB0ZW1wbGF0ZSBUXG4gKiBAb3ZlcmxvYWRcbiAqIEBwYXJhbSB7UmV0cnlDYWxsYmFjazxUPn0gYXJnMSAtIFRoZSBjYWxsYmFjayB0byByZXRyeS5cbiAqIEBwYXJhbSB7dW5kZWZpbmVkfSBbYXJnMl1cbiAqIEByZXR1cm5zIHtQcm9taXNlPFQ+fSBSZXNvbHZlcyB3aXRoIHRoZSBjYWxsYmFjayByZXN1bHQuXG4gKi9cbi8qKlxuICogUmV0cmllcyBhIGNhbGxiYWNrIHVudGlsIGl0IHN1Y2NlZWRzIG9yIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgd2l0aCBhcmd1bWVudHMuXG4gKiBAdGVtcGxhdGUgVFxuICogQG92ZXJsb2FkXG4gKiBAcGFyYW0ge1JldHJ5QXJnc30gYXJnMSAtIFRoZSBhcmd1bWVudHMuXG4gKiBAcGFyYW0ge1JldHJ5Q2FsbGJhY2s8VD59IGFyZzIgLSBUaGUgY2FsbGJhY2sgdG8gcmV0cnkuXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxUPn0gUmVzb2x2ZXMgd2l0aCB0aGUgY2FsbGJhY2sgcmVzdWx0LlxuICovXG4vKipcbiAqIEB0ZW1wbGF0ZSBUXG4gKiBAcGFyYW0ge1JldHJ5QXJncyB8IFJldHJ5Q2FsbGJhY2s8VD59IGFyZzEgVGhlIGFyZ3VtZW50cyBvciB0aGUgY2FsbGJhY2suXG4gKiBAcGFyYW0ge1JldHJ5Q2FsbGJhY2s8VD59IFthcmcyXSBUaGUgY2FsbGJhY2sgd2hlbiBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLlxuICogQHJldHVybnMge1Byb21pc2U8VD59IFJlc29sdmVzIHdpdGggdGhlIGNhbGxiYWNrIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gcmV0cnkoYXJnMSwgYXJnMikge1xuICAvKiogQHR5cGUge1JldHJ5QXJncyB8IHVuZGVmaW5lZH0gKi9cbiAgbGV0IGFyZ3NcblxuICAvKiogQHR5cGUge1JldHJ5Q2FsbGJhY2s8VD4gfCB1bmRlZmluZWR9ICovXG4gIGxldCBjYWxsYmFja1xuXG4gIGlmICh0eXBlb2YgYXJnMSA9PSBcImZ1bmN0aW9uXCIgJiYgYXJnMiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgYXJncyA9IHt9XG4gICAgY2FsbGJhY2sgPSBhcmcxXG4gIH0gZWxzZSBpZiAodHlwZW9mIGFyZzEgPT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgYXJnMiA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBhcmdzID0gYXJnMVxuICAgIGNhbGxiYWNrID0gYXJnMlxuICB9XG5cbiAgaWYgKGNhbGxiYWNrID09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKFwiU29tZWhvdyBjYWxsYmFjayBpcyB1bmRlZmluZWRcIilcbiAgaWYgKHR5cGVvZiBhcmdzICE9PSBcIm9iamVjdFwiKSB0aHJvdyBuZXcgRXJyb3IoXCJTb21laG93IGFyZ3MgaXNuJ3QgYW4gb2JqZWN0XCIpXG5cbiAgY29uc3Qge1xuICAgIHRpbWVvdXQ6IHRpbWVvdXROdW1iZXIgPSBudWxsLFxuICAgIHRyaWVzID0gMyxcbiAgICB3YWl0OiB3YWl0TnVtYmVyID0gdW5kZWZpbmVkLFxuICAgIHRpbWVvdXRFcnJvck1lc3NhZ2UsXG4gICAgLi4ucmVzdEFyZ3NcbiAgfSA9IGFyZ3NcbiAgY29uc3QgcmVzdEFyZ3NLZXlzID0gT2JqZWN0LmtleXMocmVzdEFyZ3MpXG5cbiAgaWYgKHJlc3RBcmdzS2V5cy5sZW5ndGggPiAwKSB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gYXJndW1lbnRzIGdpdmVuIHRvIHJldHJ5OiAke3Jlc3RBcmdzS2V5cy5qb2luKFwiLCBcIil9YClcblxuICBmb3IgKGxldCB0cnlOdW1iZXIgPSAxOyB0cnlOdW1iZXIgPD0gdHJpZXM7IHRyeU51bWJlcisrKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aW1lb3V0TnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aW1lb3V0KHt0aW1lb3V0OiB0aW1lb3V0TnVtYmVyLCBlcnJvck1lc3NhZ2U6IHRpbWVvdXRFcnJvck1lc3NhZ2V9LCBjYWxsYmFjaylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBjYWxsYmFjaygpXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmICh0cnlOdW1iZXIgPCB0cmllcykge1xuICAgICAgICBpZiAod2FpdE51bWJlciAhPT0gdW5kZWZpbmVkICYmIHdhaXROdW1iZXIgPiAwKSB7XG4gICAgICAgICAgYXdhaXQgd2FpdCh3YWl0TnVtYmVyKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnJvclxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19