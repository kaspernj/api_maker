/* eslint-disable sort-imports */
import config from "./config.js";
import escapeStringRegexp from "escape-string-regexp";
import * as inflection from "inflection";
import PropTypes from "prop-types";
import propTypesExact from "prop-types-exact";
import { useCallback, useMemo } from "react";
import useShape from "set-state-compare/build/use-shape.js";
const useRouterPropTypes = propTypesExact({
    locales: PropTypes.array.isRequired,
    path: PropTypes.string,
    routeDefinitions: PropTypes.object.isRequired,
    routes: PropTypes.object.isRequired
});
const useRouter = (props) => {
    PropTypes.checkPropTypes(useRouterPropTypes, props, "prop", "useRouter");
    const s = useShape(props);
    const findRouteParams = useCallback((routeDefinition) => {
        const result = [];
        const parts = routeDefinition.path.split("/");
        for (const part of parts) {
            if (part.match(/^:([a-z_]+)$/))
                result.push(part);
        }
        return result;
    }, []);
    const getPath = useCallback(() => {
        let path = s.p.path || window.location.pathname;
        path = path.replace(/[/]+$/, "");
        return path;
    }, []);
    const getRouteDefinitions = useCallback(() => s.p.routeDefinitions || config.getRouteDefinitions(), []);
    const getRoutes = useCallback(() => s.p.routes || config.getRoutes(), []);
    const parseRouteDefinitions = useCallback(() => {
        const routeDefinitions = getRouteDefinitions();
        const routes = getRoutes();
        const regex = /:([A-z\d_]+)/;
        const parsedRouteDefinitions = [];
        for (const locale of s.p.locales) {
            for (const routeDefinition of routeDefinitions.routes) {
                const routePathName = `${inflection.camelize(routeDefinition.name, true)}Path`;
                const params = findRouteParams(routeDefinition);
                params.push({ locale });
                if (!(routePathName in routes))
                    throw new Error(`${routePathName} not found in routes: ${Object.keys(routes, ", ")}`);
                const routePath = routes[routePathName](...params).replace(/[/]+$/, "");
                const groups = [];
                let pathRegexString = "^";
                pathRegexString += escapeStringRegexp(routePath);
                while (true) {
                    const match = pathRegexString.match(regex);
                    if (!match)
                        break;
                    const variableName = match[1];
                    groups.push(variableName);
                    pathRegexString = pathRegexString.replace(match[0], "([^/]+)");
                }
                pathRegexString += "$";
                const pathRegex = new RegExp(pathRegexString);
                parsedRouteDefinitions.push({ groups, pathRegex, routeDefinition });
            }
        }
        return parsedRouteDefinitions;
    }, []);
    const parsedRouteDefinitions = useMemo(() => parseRouteDefinitions(), []);
    s.updateMeta({ parsedRouteDefinitions });
    const findMatchingRoute = useCallback(() => {
        const path = getPath();
        for (const parsedRouteDefinition of s.m.parsedRouteDefinitions) {
            const match = path.match(parsedRouteDefinition.pathRegex);
            let matched, params;
            if (match) {
                matched = true;
                params = {};
                for (const groupKey in parsedRouteDefinition.groups) {
                    const groupName = parsedRouteDefinition.groups[groupKey];
                    params[groupName] = match[Number(groupKey) + 1];
                }
            }
            if (path == "" && parsedRouteDefinition.routeDefinition.path == "/")
                matched = true;
            if (matched) {
                return { params, parsedRouteDefinition };
            }
        }
    }, []);
    const matchingRoute = findMatchingRoute();
    const params = matchingRoute?.params || {};
    const match = {
        matchingRoute,
        params
    };
    return { match };
};
export default useRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLXJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIvc3JjLyIsInNvdXJjZXMiOlsidXNlLXJvdXRlci5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsaUNBQWlDO0FBQ2pDLE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQTtBQUNoQyxPQUFPLGtCQUFrQixNQUFNLHNCQUFzQixDQUFBO0FBQ3JELE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLGNBQWMsTUFBTSxrQkFBa0IsQ0FBQTtBQUM3QyxPQUFPLEVBQUMsV0FBVyxFQUFFLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUMxQyxPQUFPLFFBQVEsTUFBTSxzQ0FBc0MsQ0FBQTtBQUUzRCxNQUFNLGtCQUFrQixHQUFHLGNBQWMsQ0FBQztJQUN4QyxPQUFPLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxVQUFVO0lBQ25DLElBQUksRUFBRSxTQUFTLENBQUMsTUFBTTtJQUN0QixnQkFBZ0IsRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7SUFDN0MsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBVTtDQUNwQyxDQUFDLENBQUE7QUFFRixNQUFNLFNBQVMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQzFCLFNBQVMsQ0FBQyxjQUFjLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUV4RSxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFekIsTUFBTSxlQUFlLEdBQUcsV0FBVyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQUU7UUFDdEQsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFBO1FBQ2pCLE1BQU0sS0FBSyxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRTdDLEtBQUssTUFBTSxJ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QUMsZUFBZSxDQUFDLElBQUksSUFBSSxHQUFHO2dCQUFFLE9BQU8sR0FBRyxJQUFJLENBQUE7WUFDbkYsSUFBSSxPQUFPLEVBQUUsQ0FBQztnQkFDWixPQUFPLEVBQUMsTUFBTSxFQUFFLHFCQUFxQixFQUFDLENBQUE7WUFDeEMsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFTixNQUFNLGFBQWEsR0FBRyxpQkFBaUIsRUFBRSxDQUFBO0lBQ3pDLE1BQU0sTUFBTSxHQUFHLGFBQWEsRUFBRSxNQUFNLElBQUksRUFBRSxDQUFBO0lBQzFDLE1BQU0sS0FBSyxHQUFHO1FBQ1osYUFBYTtRQUNiLE1BQU07S0FDUCxDQUFBO0lBRUQsT0FBTyxFQUFDLEtBQUssRUFBQyxDQUFBO0FBQ2hCLENBQUMsQ0FBQTtBQUVELGVBQWUsU0FBUyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgc29ydC1pbXBvcnRzICovXG5pbXBvcnQgY29uZmlnIGZyb20gXCIuL2NvbmZpZy5qc1wiXG5pbXBvcnQgZXNjYXBlU3RyaW5nUmVnZXhwIGZyb20gXCJlc2NhcGUtc3RyaW5nLXJlZ2V4cFwiXG5pbXBvcnQgKiBhcyBpbmZsZWN0aW9uIGZyb20gXCJpbmZsZWN0aW9uXCJcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSBcInByb3AtdHlwZXNcIlxuaW1wb3J0IHByb3BUeXBlc0V4YWN0IGZyb20gXCJwcm9wLXR5cGVzLWV4YWN0XCJcbmltcG9ydCB7dXNlQ2FsbGJhY2ssIHVzZU1lbW99IGZyb20gXCJyZWFjdFwiXG5pbXBvcnQgdXNlU2hhcGUgZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3VzZS1zaGFwZS5qc1wiXG5cbmNvbnN0IHVzZVJvdXRlclByb3BUeXBlcyA9IHByb3BUeXBlc0V4YWN0KHtcbiAgbG9jYWxlczogUHJvcFR5cGVzLmFycmF5LmlzUmVxdWlyZWQsXG4gIHBhdGg6IFByb3BUeXBlcy5zdHJpbmcsXG4gIHJvdXRlRGVmaW5pdGlvbnM6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgcm91dGVzOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWRcbn0pXG5cbmNvbnN0IHVzZVJvdXRlciA9IChwcm9wcykgPT4ge1xuICBQcm9wVHlwZXMuY2hlY2tQcm9wVHlwZXModXNlUm91dGVyUHJvcFR5cGVzLCBwcm9wcywgXCJwcm9wXCIsIFwidXNlUm91dGVyXCIpXG5cbiAgY29uc3QgcyA9IHVzZVNoYXBlKHByb3BzKVxuXG4gIGNvbnN0IGZpbmRSb3V0ZVBhcmFtcyA9IHVzZUNhbGxiYWNrKChyb3V0ZURlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBbXVxuICAgIGNvbnN0IHBhcnRzID0gcm91dGVEZWZpbml0aW9uLnBhdGguc3BsaXQoXCIvXCIpXG5cbiAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHtcbiAgICAgIGlmIChwYXJ0Lm1hdGNoKC9eOihbYS16X10rKSQvKSlcbiAgICAgICAgcmVzdWx0LnB1c2gocGFydClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0XG4gIH0sIFtdKVxuXG4gIGNvbnN0IGdldFBhdGggPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgbGV0IHBhdGggPSBzLnAucGF0aCB8fCB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWVcblxuICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoL1svXSskLywgXCJcIilcblxuICAgIHJldHVybiBwYXRoXG4gIH0sIFtdKVxuXG4gIGNvbnN0IGdldFJvdXRlRGVmaW5pdGlvbnMgPSB1c2VDYWxsYmFjaygoKSA9PiBzLnAucm91dGVEZWZpbml0aW9ucyB8fCBjb25maWcuZ2V0Um91dGVEZWZpbml0aW9ucygpLCBbXSlcbiAgY29uc3QgZ2V0Um91dGVzID0gdXNlQ2FsbGJhY2soKCkgPT4gcy5wLnJvdXRlcyB8fCBjb25maWcuZ2V0Um91dGVzKCksIFtdKVxuXG4gIGNvbnN0IHBhcnNlUm91dGVEZWZpbml0aW9ucyA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCByb3V0ZURlZmluaXRpb25zID0gZ2V0Um91dGVEZWZpbml0aW9ucygpXG4gICAgY29uc3Qgcm91dGVzID0gZ2V0Um91dGVzKClcbiAgICBjb25zdCByZWdleCA9IC86KFtBLXpcXGRfXSspL1xuICAgIGNvbnN0IHBhcnNlZFJvdXRlRGVmaW5pdGlvbnMgPSBbXVxuXG4gICAgZm9yIChjb25zdCBsb2NhbGUgb2Ygcy5wLmxvY2FsZXMpIHtcbiAgICAgIGZvciAoY29uc3Qgcm91dGVEZWZpbml0aW9uIG9mIHJvdXRlRGVmaW5pdGlvbnMucm91dGVzKSB7XG4gICAgICAgIGNvbnN0IHJvdXRlUGF0aE5hbWUgPSBgJHtpbmZsZWN0aW9uLmNhbWVsaXplKHJvdXRlRGVmaW5pdGlvbi5uYW1lLCB0cnVlKX1QYXRoYFxuICAgICAgICBjb25zdCBwYXJhbXMgPSBmaW5kUm91dGVQYXJhbXMocm91dGVEZWZpbml0aW9uKVxuXG4gICAgICAgIHBhcmFtcy5wdXNoKHtsb2NhbGV9KVxuXG4gICAgICAgIGlmICghKHJvdXRlUGF0aE5hbWUgaW4gcm91dGVzKSlcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cm91dGVQYXRoTmFtZX0gbm90IGZvdW5kIGluIHJvdXRlczogJHtPYmplY3Qua2V5cyhyb3V0ZXMsIFwiLCBcIil9YClcblxuICAgICAgICBjb25zdCByb3V0ZVBhdGggPSByb3V0ZXNbcm91dGVQYXRoTmFtZV0oLi4ucGFyYW1zKS5yZXBsYWNlKC9bL10rJC8sIFwiXCIpXG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IFtdXG4gICAgICAgIGxldCBwYXRoUmVnZXhTdHJpbmcgPSBcIl5cIlxuXG4gICAgICAgIHBhdGhSZWdleFN0cmluZyArPSBlc2NhcGVTdHJpbmdSZWdleHAocm91dGVQYXRoKVxuXG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgY29uc3QgbWF0Y2ggPSBwYXRoUmVnZXhTdHJpbmcubWF0Y2gocmVnZXgpXG5cbiAgICAgICAgICBpZiAoIW1hdGNoKSBicmVha1xuXG4gICAgICAgICAgY29uc3QgdmFyaWFibGVOYW1lID0gbWF0Y2hbMV1cblxuICAgICAgICAgIGdyb3Vwcy5wdXNoKHZhcmlhYmxlTmFtZSlcblxuICAgICAgICAgIHBhdGhSZWdleFN0cmluZyA9IHBhdGhSZWdleFN0cmluZy5yZXBsYWNlKG1hdGNoWzBdLCBcIihbXi9dKylcIilcbiAgICAgICAgfVxuXG4gICAgICAgIHBhdGhSZWdleFN0cmluZyArPSBcIiRcIlxuXG4gICAgICAgIGNvbnN0IHBhdGhSZWdleCA9IG5ldyBSZWdFeHAocGF0aFJlZ2V4U3RyaW5nKVxuXG4gICAgICAgIHBhcnNlZFJvdXRlRGVmaW5pdGlvbnMucHVzaCh7Z3JvdXBzLCBwYXRoUmVnZXgsIHJvdXRlRGVmaW5pdGlvbn0pXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcnNlZFJvdXRlRGVmaW5pdGlvbnNcbiAgfSwgW10pXG5cbiAgY29uc3QgcGFyc2VkUm91dGVEZWZpbml0aW9ucyA9IHVzZU1lbW8oKCkgPT4gcGFyc2VSb3V0ZURlZmluaXRpb25zKCksIFtdKVxuXG4gIHMudXBkYXRlTWV0YSh7cGFyc2VkUm91dGVEZWZpbml0aW9uc30pXG5cbiAgY29uc3QgZmluZE1hdGNoaW5nUm91dGUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgcGF0aCA9IGdldFBhdGgoKVxuXG4gICAgZm9yIChjb25zdCBwYXJzZWRSb3V0ZURlZmluaXRpb24gb2Ygcy5tLnBhcnNlZFJvdXRlRGVmaW5pdGlvbnMpIHtcbiAgICAgIGNvbnN0IG1hdGNoID0gcGF0aC5tYXRjaChwYXJzZWRSb3V0ZURlZmluaXRpb24ucGF0aFJlZ2V4KVxuICAgICAgbGV0IG1hdGNoZWQsIHBhcmFtc1xuXG4gICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgbWF0Y2hlZCA9IHRydWVcbiAgICAgICAgcGFyYW1zID0ge31cblxuICAgICAgICBmb3IgKGNvbnN0IGdyb3VwS2V5IGluIHBhcnNlZFJvdXRlRGVmaW5pdGlvbi5ncm91cHMpIHtcbiAgICAgICAgICBjb25zdCBncm91cE5hbWUgPSBwYXJzZWRSb3V0ZURlZmluaXRpb24uZ3JvdXBzW2dyb3VwS2V5XVxuXG4gICAgICAgICAgcGFyYW1zW2dyb3VwTmFtZV0gPSBtYXRjaFtOdW1iZXIoZ3JvdXBLZXkpICsgMV1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocGF0aCA9PSBcIlwiICYmIHBhcnNlZFJvdXRlRGVmaW5pdGlvbi5yb3V0ZURlZmluaXRpb24ucGF0aCA9PSBcIi9cIikgbWF0Y2hlZCA9IHRydWVcbiAgICAgIGlmIChtYXRjaGVkKSB7XG4gICAgICAgIHJldHVybiB7cGFyYW1zLCBwYXJzZWRSb3V0ZURlZmluaXRpb259XG4gICAgICB9XG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCBtYXRjaGluZ1JvdXRlID0gZmluZE1hdGNoaW5nUm91dGUoKVxuICBjb25zdCBwYXJhbXMgPSBtYXRjaGluZ1JvdXRlPy5wYXJhbXMgfHwge31cbiAgY29uc3QgbWF0Y2ggPSB7XG4gICAgbWF0Y2hpbmdSb3V0ZSxcbiAgICBwYXJhbXNcbiAgfVxuXG4gIHJldHVybiB7bWF0Y2h9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHVzZVJvdXRlclxuIl19