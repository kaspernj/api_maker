/* eslint-disable implicit-arrow-linebreak, no-extra-parens, no-use-before-define, prefer-object-spread */
import { dig, digg } from "diggerize";
import { useCallback, useEffect, useMemo, useRef } from "react";
import idForComponent from "./inputs/id-for-component.js";
import nameForComponent from "./inputs/name-for-component.js";
import strftime from "strftime";
import useShape from "set-state-compare/build/use-shape.js";
import useValidationErrors from "./use-validation-errors.js";
/**
 * @param {object} args
 * @param {object} args.props
 * @param {object} args.props.inputRef
 * @param {string} args.props.type
 * @param {object} args.props.inputProps
 * @param {string} args.props.inputProps.name
 * @param {object} args.props.inputProps.wrapperOpts
 * @param {object} args.wrapperOptions
 * @param {string} args.wrapperOptions.type
 * @returns {{inputProps: object, wrapperOpts: object, restProps: object}}
 */
const useInput = ({ props, wrapperOptions, ...useInputRestProps }) => {
    const useInputRestPropsKeys = Object.keys(useInputRestProps);
    if (useInputRestPropsKeys.length > 0) {
        throw new Error(`Unknown props given to useInput: ${useInputRestPropsKeys.join(", ")}`);
    }
    const s = useShape(props);
    const backupRef = useRef();
    s.useStates({
        form: undefined
    });
    useEffect(() => {
        setForm();
    }, [s.props.inputRef?.current]);
    s.meta.fakeComponent = { props };
    s.meta.isCheckbox = props.type == "checkbox" || wrapperOptions?.type == "checkbox";
    s.meta.isSelect = wrapperOptions?.type == "select";
    const formatValue = useCallback((value) => {
        const { formatValue } = s.props;
        if (formatValue) {
            return formatValue(value);
        }
        else if (value instanceof Date && !isNaN(value.getTime())) {
            // We need to use a certain format for datetime-local
            if (inputType() == "datetime-local") {
                return strftime("%Y-%m-%dT%H:%M:%S", value);
            }
            else if (inputType() == "date") {
                return strftime("%Y-%m-%d", value);
            }
        }
        return value;
    }, []);
    const inputDefaultChecked = useCallback(() => {
        if ("defaultChecked" in s.props) {
            return s.props.defaultChecked;
        }
        else if (s.props.attribute && s.props.model) {
            if (!s.props.model[s.props.attribute])
                throw new Error(`No such attribute: ${s.props.attribute}`);
            return s.props.model[s.props.attribute]();
        }
    }, []);
    const inputDefaultValue = useCallback(() => {
        if ("defaultValue" in s.props) {
            return formatValue(s.props.defaultValue);
        }
        else if (s.props.model && s.props.attribute) {
            if (!s.props.model[s.props.attribute]) {
                throw new Error(`No such attribute defined on resource: ${digg(s.props.model.modelClassData(), "name")}#${s.props.attribute}`);
            }
            return formatValue(s.props.model[s.props.attribute]());
        }
    }, []);
    const inputRef = useCallback(() => s.props.inputRef || backupRef);
    const inputType = useCallback(() => {
        if ("type" in s.props) {
            return s.props.type;
        }
        else if (s.m.isCheckbox) {
            return "checkbox";
        }
        else {
            return "text";
        }
    }, []);
    const label = useCallback(() => {
        if ("label" in s.props) {
            return s.props.label;
        }
        else if (s.props.attribute && s.props.model) {
            return s.props.model.modelClass().humanAttributeName(s.props.attribute);
        }
    }, []);
    const setForm = useCallback(() => {
        const inputElement = inputRef().current;
        let form;
        if (inputElement)
            form = dig(inputElement, "form");
        if (form && form != s.s.form)
            s.set({ form });
    }, []);
    const getId = useCallback(() => idForComponent(s.m.fakeComponent), []);
    const getName = useCallback(() => nameForComponent(s.m.fakeComponent), []);
    const getInputProps = useCallback(() => {
        const givenInputProps = s.props.inputProps || {};
        const inputProps = Object.assign({
            id: getId(),
            name: getName(),
            ref: inputRef()
        }, givenInputProps);
        if (s.m.isCheckbox) {
            if ("checked" in s.props) {
                inputProps.checked = s.props.checked;
            }
            if ("defaultChecked" in s.props || (s.props.attribute && s.props.model)) {
                inputProps.defaultChecked = inputDefaultChecked();
            }
        }
        else if ("value" in s.props) {
            inputProps.value = s.props.value;
        }
        else if (!("value" in s.props)) {
            inputProps.defaultValue = inputDefaultValue();
        }
        return inputProps;
    }, []);
    const { inputProps: oldInputProps, wrapperOpts: oldWrapperOpts, ...restProps } = props;
    const type = inputType();
    s.meta.inputProps = getInputProps();
    s.meta.inputNameWithoutId = useMemo(() => s.m.inputProps.name?.replace(/\[(.+)_id\]$/, "[$1]"), [s.m.inputProps.name]);
    if (!s.m.inputProps.ref)
        throw new Error("No input ref?");
    if (!s.m.isSelect)
        s.m.inputProps.type = type;
    const { validationErrors } = useValidationErrors((validationError) => validationError.inputName &&
        s.m.inputProps.name &&
        (validationError.inputName == s.m.inputProps.name || validationError.inputName == s.m.inputNameWithoutId));
    const wrapperOpts = {
        errors: validationErrors,
        form: s.s.form,
        label: label()
    };
    return {
        inputProps: s.m.inputProps,
        wrapperOpts,
        restProps
    };
};
export default useInput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWlucHV0LmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJ1c2UtaW5wdXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMEdBQTBHO0FBQzFHLE9BQU8sRUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQ25DLE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUMsTUFBTSxPQUFPLENBQUE7QUFDN0QsT0FBTyxjQUFjLE1BQU0sOEJBQThCLENBQUE7QUFDekQsT0FBTyxnQkFBZ0IsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM3RCxPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxRQUFRLE1BQU0sc0NBQXNDLENBQUE7QUFDM0QsT0FBTyxtQkFBbUIsTUFBTSw0QkFBNEIsQ0FBQTtBQUU1RDs7Ozs7Ozs7Ozs7R0FXRztBQUNILE1BQU0sUUFBUSxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLEdBQUcsaUJBQWlCLEVBQUMsRUFBRSxFQUFFO0lBQ2pFLE1BQU0scUJBQXFCLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBRTVELElBQUkscUJBQXFCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDekYsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN6QixNQUFNLFNBQVMsR0FBRyxNQUFNLEVBQUUsQ0FBQTtJQUUxQixDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ1YsSUFBSSxFQUFFLFNBQVM7S0FDaEIsQ0FBQyxDQUFBO0lBRUYsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE9BQU8sRUFBRSxDQUFBO0lBQ1gsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQTtJQUUvQixDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFDLEtBQUssRUFBQyxDQUFBO0lBQzlCLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksVUFBVSxJQUFJLGNBQWMsRUFBRSxJQUFJLElBQUksVUFBVSxDQUFBO0lBQ2xGLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLGNBQWMsRUFBRSxJQUFJLElBQUksUUFBUSxDQUFBO0lBRWxELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3hDLE1BQU0sRUFBQyxXQUFXLEVBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFBO1FBRTdCLElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDM0IsQ0FBQzthQUFNLElBQUksS0FBSyxZQUFZLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzVELHFEQUFxRDtZQUNyRCxJQUFJLFNBQVMsRUFBRSxJQUFJLGdCQUFnQixFQUFFLENBQUM7Z0JBQ3BDLE9BQU8sUUFBUSxDQUFDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQzdDLENBQUM7aUJBQU0sSUFBSSxTQUFTLEVBQUUsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDakMsT0FBTyxRQUFRLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3BDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFTixNQUFNLG1CQUFtQixHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7UUFDM0MsSUFBSSxnQkFBZ0IsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQTtRQUMvQixDQUFDO2FBQU0sSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztnQkFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO1lBRTVELE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFBO1FBQzNDLENBQUM7SUFDSCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFTixNQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7UUFDekMsSUFBSSxjQUFjLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlCLE9BQU8sV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDMUMsQ0FBQzthQUFNLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO2dCQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO1lBQ2hJLENBQUM7WUFFRCxPQUFPLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUN4RCxDQUFDO0lBQ0gsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRU4sTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxDQUFBO0lBRWpFLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7UUFDakMsSUFBSSxNQUFNLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RCLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUE7UUFDckIsQ0FBQzthQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUMxQixPQUFPLFVBQVUsQ0FBQTtRQUNuQixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sTUFBTSxDQUFBO1FBQ2YsQ0FBQztJQUNILENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVOLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7UUFDN0IsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUE7UUFDdEIsQ0FBQzthQUFNLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM5QyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDekUsQ0FBQztJQUNILENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVOLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7UUFDL0IsTUFBTSxZQUFZLEdBQUcsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFBO1FBRXZDLElBQUksSUFBSSxDQUFBO1FBRVIsSUFBSSxZQUFZO1lBQUUsSUFBSSxHQUFHLEdBQUcsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDbEQsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBQyxJQUFJLEVBQUMsQ0FBQyxDQUFBO0lBQzdDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVOLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUN0RSxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUUxRSxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFO1FBQ3JDLE1BQU0sZUFBZSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQTtRQUNoRCxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUM5QjtZQUNFLEVBQUUsRUFBRSxLQUFLLEVBQUU7WUFDWCxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ2YsR0FBRyxFQUFFLFFBQVEsRUFBRTtTQUNoQixFQUNELGVBQWUsQ0FDaEIsQ0FBQTtRQUVELElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNuQixJQUFJLFNBQVMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ3pCLFVBQVUsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUE7WUFDdEMsQ0FBQztZQUVELElBQUksZ0JBQWdCLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDeEUsVUFBVSxDQUFDLGNBQWMsR0FBRyxtQkFBbUIsRUFBRSxDQUFBO1lBQ25ELENBQUM7UUFDSCxDQUFDO2FBQU0sSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlCLFVBQVUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUE7UUFDbEMsQ0FBQzthQUFNLElBQUksQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLENBQUMsWUFBWSxHQUFHLGlCQUFpQixFQUFFLENBQUE7UUFDL0MsQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFBO0lBQ25CLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVOLE1BQU0sRUFBQyxVQUFVLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsR0FBRyxTQUFTLEVBQUMsR0FBRyxLQUFLLENBQUE7SUFDcEYsTUFBTSxJQUFJLEdBQUcsU0FBUyxFQUFFLENBQUE7SUFFeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsYUFBYSxFQUFFLENBQUE7SUFDbkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0lBRXRILElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUN6RCxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRO1FBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtJQUU3QyxNQUFNLEVBQUMsZ0JBQWdCLEVBQUMsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQ2pFLGVBQWUsQ0FBQyxTQUFTO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUk7UUFDbkIsQ0FBQyxlQUFlLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxlQUFlLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FDNUcsQ0FBQTtJQUVELE1BQU0sV0FBVyxHQUFHO1FBQ2xCLE1BQU0sRUFBRSxnQkFBZ0I7UUFDeEIsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtRQUNkLEtBQUssRUFBRSxLQUFLLEVBQUU7S0FDZixDQUFBO0lBRUQsT0FBTztRQUNMLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVU7UUFDMUIsV0FBVztRQUNYLFNBQVM7S0FDVixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsZUFBZSxRQUFRLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBpbXBsaWNpdC1hcnJvdy1saW5lYnJlYWssIG5vLWV4dHJhLXBhcmVucywgbm8tdXNlLWJlZm9yZS1kZWZpbmUsIHByZWZlci1vYmplY3Qtc3ByZWFkICovXG5pbXBvcnQge2RpZywgZGlnZ30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQge3VzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZU1lbW8sIHVzZVJlZn0gZnJvbSBcInJlYWN0XCJcbmltcG9ydCBpZEZvckNvbXBvbmVudCBmcm9tIFwiLi9pbnB1dHMvaWQtZm9yLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgbmFtZUZvckNvbXBvbmVudCBmcm9tIFwiLi9pbnB1dHMvbmFtZS1mb3ItY29tcG9uZW50LmpzXCJcbmltcG9ydCBzdHJmdGltZSBmcm9tIFwic3RyZnRpbWVcIlxuaW1wb3J0IHVzZVNoYXBlIGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC91c2Utc2hhcGUuanNcIlxuaW1wb3J0IHVzZVZhbGlkYXRpb25FcnJvcnMgZnJvbSBcIi4vdXNlLXZhbGlkYXRpb24tZXJyb3JzLmpzXCJcblxuLyoqXG4gKiBAcGFyYW0ge29iamVjdH0gYXJnc1xuICogQHBhcmFtIHtvYmplY3R9IGFyZ3MucHJvcHNcbiAqIEBwYXJhbSB7b2JqZWN0fSBhcmdzLnByb3BzLmlucHV0UmVmXG4gKiBAcGFyYW0ge3N0cmluZ30gYXJncy5wcm9wcy50eXBlXG4gKiBAcGFyYW0ge29iamVjdH0gYXJncy5wcm9wcy5pbnB1dFByb3BzXG4gKiBAcGFyYW0ge3N0cmluZ30gYXJncy5wcm9wcy5pbnB1dFByb3BzLm5hbWVcbiAqIEBwYXJhbSB7b2JqZWN0fSBhcmdzLnByb3BzLmlucHV0UHJvcHMud3JhcHBlck9wdHNcbiAqIEBwYXJhbSB7b2JqZWN0fSBhcmdzLndyYXBwZXJPcHRpb25zXG4gKiBAcGFyYW0ge3N0cmluZ30gYXJncy53cmFwcGVyT3B0aW9ucy50eXBlXG4gKiBAcmV0dXJucyB7e2lucHV0UHJvcHM6IG9iamVjdCwgd3JhcHBlck9wdHM6IG9iamVjdCwgcmVzdFByb3BzOiBvYmplY3R9fVxuICovXG5jb25zdCB1c2VJbnB1dCA9ICh7cHJvcHMsIHdyYXBwZXJPcHRpb25zLCAuLi51c2VJbnB1dFJlc3RQcm9wc30pID0+IHtcbiAgY29uc3QgdXNlSW5wdXRSZXN0UHJvcHNLZXlzID0gT2JqZWN0LmtleXModXNlSW5wdXRSZXN0UHJvcHMpXG5cbiAgaWYgKHVzZUlucHV0UmVzdFByb3BzS2V5cy5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHByb3BzIGdpdmVuIHRvIHVzZUlucHV0OiAke3VzZUlucHV0UmVzdFByb3BzS2V5cy5qb2luKFwiLCBcIil9YClcbiAgfVxuXG4gIGNvbnN0IHMgPSB1c2VTaGFwZShwcm9wcylcbiAgY29uc3QgYmFja3VwUmVmID0gdXNlUmVmKClcblxuICBzLnVzZVN0YXRlcyh7XG4gICAgZm9ybTogdW5kZWZpbmVkXG4gIH0pXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBzZXRGb3JtKClcbiAgfSwgW3MucHJvcHMuaW5wdXRSZWY/LmN1cnJlbnRdKVxuXG4gIHMubWV0YS5mYWtlQ29tcG9uZW50ID0ge3Byb3BzfVxuICBzLm1ldGEuaXNDaGVja2JveCA9IHByb3BzLnR5cGUgPT0gXCJjaGVja2JveFwiIHx8IHdyYXBwZXJPcHRpb25zPy50eXBlID09IFwiY2hlY2tib3hcIlxuICBzLm1ldGEuaXNTZWxlY3QgPSB3cmFwcGVyT3B0aW9ucz8udHlwZSA9PSBcInNlbGVjdFwiXG5cbiAgY29uc3QgZm9ybWF0VmFsdWUgPSB1c2VDYWxsYmFjaygodmFsdWUpID0+IHtcbiAgICBjb25zdCB7Zm9ybWF0VmFsdWV9ID0gcy5wcm9wc1xuXG4gICAgaWYgKGZvcm1hdFZhbHVlKSB7XG4gICAgICByZXR1cm4gZm9ybWF0VmFsdWUodmFsdWUpXG4gICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHZhbHVlLmdldFRpbWUoKSkpIHtcbiAgICAgIC8vIFdlIG5lZWQgdG8gdXNlIGEgY2VydGFpbiBmb3JtYXQgZm9yIGRhdGV0aW1lLWxvY2FsXG4gICAgICBpZiAoaW5wdXRUeXBlKCkgPT0gXCJkYXRldGltZS1sb2NhbFwiKSB7XG4gICAgICAgIHJldHVybiBzdHJmdGltZShcIiVZLSVtLSVkVCVIOiVNOiVTXCIsIHZhbHVlKVxuICAgICAgfSBlbHNlIGlmIChpbnB1dFR5cGUoKSA9PSBcImRhdGVcIikge1xuICAgICAgICByZXR1cm4gc3RyZnRpbWUoXCIlWS0lbS0lZFwiLCB2YWx1ZSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVcbiAgfSwgW10pXG5cbiAgY29uc3QgaW5wdXREZWZhdWx0Q2hlY2tlZCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAoXCJkZWZhdWx0Q2hlY2tlZFwiIGluIHMucHJvcHMpIHtcbiAgICAgIHJldHVybiBzLnByb3BzLmRlZmF1bHRDaGVja2VkXG4gICAgfSBlbHNlIGlmIChzLnByb3BzLmF0dHJpYnV0ZSAmJiBzLnByb3BzLm1vZGVsKSB7XG4gICAgICBpZiAoIXMucHJvcHMubW9kZWxbcy5wcm9wcy5hdHRyaWJ1dGVdKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHN1Y2ggYXR0cmlidXRlOiAke3MucHJvcHMuYXR0cmlidXRlfWApXG5cbiAgICAgIHJldHVybiBzLnByb3BzLm1vZGVsW3MucHJvcHMuYXR0cmlidXRlXSgpXG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCBpbnB1dERlZmF1bHRWYWx1ZSA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAoXCJkZWZhdWx0VmFsdWVcIiBpbiBzLnByb3BzKSB7XG4gICAgICByZXR1cm4gZm9ybWF0VmFsdWUocy5wcm9wcy5kZWZhdWx0VmFsdWUpXG4gICAgfSBlbHNlIGlmIChzLnByb3BzLm1vZGVsICYmIHMucHJvcHMuYXR0cmlidXRlKSB7XG4gICAgICBpZiAoIXMucHJvcHMubW9kZWxbcy5wcm9wcy5hdHRyaWJ1dGVdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc3VjaCBhdHRyaWJ1dGUgZGVmaW5lZCBvbiByZXNvdXJjZTogJHtkaWdnKHMucHJvcHMubW9kZWwubW9kZWxDbGFzc0RhdGEoKSwgXCJuYW1lXCIpfSMke3MucHJvcHMuYXR0cmlidXRlfWApXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmb3JtYXRWYWx1ZShzLnByb3BzLm1vZGVsW3MucHJvcHMuYXR0cmlidXRlXSgpKVxuICAgIH1cbiAgfSwgW10pXG5cbiAgY29uc3QgaW5wdXRSZWYgPSB1c2VDYWxsYmFjaygoKSA9PiBzLnByb3BzLmlucHV0UmVmIHx8IGJhY2t1cFJlZilcblxuICBjb25zdCBpbnB1dFR5cGUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKFwidHlwZVwiIGluIHMucHJvcHMpIHtcbiAgICAgIHJldHVybiBzLnByb3BzLnR5cGVcbiAgICB9IGVsc2UgaWYgKHMubS5pc0NoZWNrYm94KSB7XG4gICAgICByZXR1cm4gXCJjaGVja2JveFwiXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBcInRleHRcIlxuICAgIH1cbiAgfSwgW10pXG5cbiAgY29uc3QgbGFiZWwgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKFwibGFiZWxcIiBpbiBzLnByb3BzKSB7XG4gICAgICByZXR1cm4gcy5wcm9wcy5sYWJlbFxuICAgIH0gZWxzZSBpZiAocy5wcm9wcy5hdHRyaWJ1dGUgJiYgcy5wcm9wcy5tb2RlbCkge1xuICAgICAgcmV0dXJuIHMucHJvcHMubW9kZWwubW9kZWxDbGFzcygpLmh1bWFuQXR0cmlidXRlTmFtZShzLnByb3BzLmF0dHJpYnV0ZSlcbiAgICB9XG4gIH0sIFtdKVxuXG4gIGNvbnN0IHNldEZvcm0gPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgaW5wdXRFbGVtZW50ID0gaW5wdXRSZWYoKS5jdXJyZW50XG5cbiAgICBsZXQgZm9ybVxuXG4gICAgaWYgKGlucHV0RWxlbWVudCkgZm9ybSA9IGRpZyhpbnB1dEVsZW1lbnQsIFwiZm9ybVwiKVxuICAgIGlmIChmb3JtICYmIGZvcm0gIT0gcy5zLmZvcm0pIHMuc2V0KHtmb3JtfSlcbiAgfSwgW10pXG5cbiAgY29uc3QgZ2V0SWQgPSB1c2VDYWxsYmFjaygoKSA9PiBpZEZvckNvbXBvbmVudChzLm0uZmFrZUNvbXBvbmVudCksIFtdKVxuICBjb25zdCBnZXROYW1lID0gdXNlQ2FsbGJhY2soKCkgPT4gbmFtZUZvckNvbXBvbmVudChzLm0uZmFrZUNvbXBvbmVudCksIFtdKVxuXG4gIGNvbnN0IGdldElucHV0UHJvcHMgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgZ2l2ZW5JbnB1dFByb3BzID0gcy5wcm9wcy5pbnB1dFByb3BzIHx8IHt9XG4gICAgY29uc3QgaW5wdXRQcm9wcyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7XG4gICAgICAgIGlkOiBnZXRJZCgpLFxuICAgICAgICBuYW1lOiBnZXROYW1lKCksXG4gICAgICAgIHJlZjogaW5wdXRSZWYoKVxuICAgICAgfSxcbiAgICAgIGdpdmVuSW5wdXRQcm9wc1xuICAgIClcblxuICAgIGlmIChzLm0uaXNDaGVja2JveCkge1xuICAgICAgaWYgKFwiY2hlY2tlZFwiIGluIHMucHJvcHMpIHtcbiAgICAgICAgaW5wdXRQcm9wcy5jaGVja2VkID0gcy5wcm9wcy5jaGVja2VkXG4gICAgICB9XG5cbiAgICAgIGlmIChcImRlZmF1bHRDaGVja2VkXCIgaW4gcy5wcm9wcyB8fCAocy5wcm9wcy5hdHRyaWJ1dGUgJiYgcy5wcm9wcy5tb2RlbCkpIHtcbiAgICAgICAgaW5wdXRQcm9wcy5kZWZhdWx0Q2hlY2tlZCA9IGlucHV0RGVmYXVsdENoZWNrZWQoKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXCJ2YWx1ZVwiIGluIHMucHJvcHMpIHtcbiAgICAgIGlucHV0UHJvcHMudmFsdWUgPSBzLnByb3BzLnZhbHVlXG4gICAgfSBlbHNlIGlmICghKFwidmFsdWVcIiBpbiBzLnByb3BzKSkge1xuICAgICAgaW5wdXRQcm9wcy5kZWZhdWx0VmFsdWUgPSBpbnB1dERlZmF1bHRWYWx1ZSgpXG4gICAgfVxuXG4gICAgcmV0dXJuIGlucHV0UHJvcHNcbiAgfSwgW10pXG5cbiAgY29uc3Qge2lucHV0UHJvcHM6IG9sZElucHV0UHJvcHMsIHdyYXBwZXJPcHRzOiBvbGRXcmFwcGVyT3B0cywgLi4ucmVzdFByb3BzfSA9IHByb3BzXG4gIGNvbnN0IHR5cGUgPSBpbnB1dFR5cGUoKVxuXG4gIHMubWV0YS5pbnB1dFByb3BzID0gZ2V0SW5wdXRQcm9wcygpXG4gIHMubWV0YS5pbnB1dE5hbWVXaXRob3V0SWQgPSB1c2VNZW1vKCgpID0+IHMubS5pbnB1dFByb3BzLm5hbWU/LnJlcGxhY2UoL1xcWyguKylfaWRcXF0kLywgXCJbJDFdXCIpLCBbcy5tLmlucHV0UHJvcHMubmFtZV0pXG5cbiAgaWYgKCFzLm0uaW5wdXRQcm9wcy5yZWYpIHRocm93IG5ldyBFcnJvcihcIk5vIGlucHV0IHJlZj9cIilcbiAgaWYgKCFzLm0uaXNTZWxlY3QpIHMubS5pbnB1dFByb3BzLnR5cGUgPSB0eXBlXG5cbiAgY29uc3Qge3ZhbGlkYXRpb25FcnJvcnN9ID0gdXNlVmFsaWRhdGlvbkVycm9ycygodmFsaWRhdGlvbkVycm9yKSA9PlxuICAgIHZhbGlkYXRpb25FcnJvci5pbnB1dE5hbWUgJiZcbiAgICAgIHMubS5pbnB1dFByb3BzLm5hbWUgJiZcbiAgICAgICh2YWxpZGF0aW9uRXJyb3IuaW5wdXROYW1lID09IHMubS5pbnB1dFByb3BzLm5hbWUgfHwgdmFsaWRhdGlvbkVycm9yLmlucHV0TmFtZSA9PSBzLm0uaW5wdXROYW1lV2l0aG91dElkKVxuICApXG5cbiAgY29uc3Qgd3JhcHBlck9wdHMgPSB7XG4gICAgZXJyb3JzOiB2YWxpZGF0aW9uRXJyb3JzLFxuICAgIGZvcm06IHMucy5mb3JtLFxuICAgIGxhYmVsOiBsYWJlbCgpXG4gIH1cblxuICByZXR1cm4ge1xuICAgIGlucHV0UHJvcHM6IHMubS5pbnB1dFByb3BzLFxuICAgIHdyYXBwZXJPcHRzLFxuICAgIHJlc3RQcm9wc1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHVzZUlucHV0XG4iXX0=