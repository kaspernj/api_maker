/* eslint-disable no-continue, sort-imports */
import { digg, digs } from "diggerize";
import * as inflection from "inflection";
import modelClassRequire from "../model-class-require.js";
class SelectCalculator {
    constructor({ table }) {
        this.table = table;
    }
    selects() {
        const { modelClass } = digs(this.table.props, "modelClass");
        const select = this.table.props.select || {};
        const { preparedColumns } = digs(this.table.state, "preparedColumns");
        // Ensure the primary key column is loader for the primary model class
        const className = digg(modelClass.modelClassData(), "name");
        const primaryKeyColumnName = modelClass.primaryKey();
        if (!(className in select))
            select[className] = [];
        if (!select[className].includes(primaryKeyColumnName))
            select[className].push(primaryKeyColumnName);
        // Ensure 'updatedAt' is selected if defined as an attribute, because it is used for cacheKey and updates in the table
        if (modelClass.hasAttribute("updatedAt")) {
            if (!(className in select))
                select[className] = [];
            if (!select[className].includes("updatedAt"))
                select[className].push("updatedAt");
        }
        // Ensure columns used for columns are loaded
        for (const preparedColumn of preparedColumns) {
            const { column } = digs(preparedColumn, "column");
            if (!column?.attribute)
                continue; // 'column' might not exist if has been removed in code but still saved in DB
            const { attribute } = digs(column, "attribute");
            const { path } = column;
            let currentModelClass = modelClass;
            if (path) {
                for (const pathPart of path) {
                    const relationships = digg(currentModelClass.modelClassData(), "relationships");
                    const relationship = relationships.find((relationshipInArray) => relationshipInArray.name == inflection.underscore(pathPart));
                    if (!relationship)
                        throw new Error(`No such relationship: ${currentModelClass.modelClassData().name}#${pathPart}`);
                    currentModelClass = modelClassRequire(digg(relationship, "resource_name"));
                }
            }
            const currentModelClassName = digg(currentModelClass.modelClassData(), "name");
            if (!(currentModelClassName in select))
                select[currentModelClassName] = [];
            if (!select[currentModelClassName].includes(attribute))
                select[currentModelClassName].push(attribute);
        }
        return select;
    }
}
export default function selectCalculator(...props) {
    return new SelectCalculator(...props).selects();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWNhbGN1bGF0b3IuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInRhYmxlL3NlbGVjdC1jYWxjdWxhdG9yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDhDQUE4QztBQUM5QyxPQUFPLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUNwQyxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLGlCQUFpQixNQUFNLDJCQUEyQixDQUFBO0FBRXpELE1BQU0sZ0JBQWdCO0lBQ3BCLFlBQVksRUFBQyxLQUFLLEVBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7SUFDcEIsQ0FBQztJQUVELE9BQU87UUFDTCxNQUFNLEVBQUMsVUFBVSxFQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFBO1FBQ3pELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUE7UUFDNUMsTUFBTSxFQUFDLGVBQWUsRUFBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxDQUFBO1FBR25FLHNFQUFzRTtRQUN0RSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBQzNELE1BQU0sb0JBQW9CLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBRXBELElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUM7WUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ2xELElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDO1lBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBR25HLHNIQUFzSDtRQUN0SCxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztZQUN6QyxJQUFJLENBQUMsQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDO2dCQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUE7WUFDbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO2dCQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDbkYsQ0FBQztRQUdELDZDQUE2QztRQUM3QyxLQUFLLE1BQU0sY0FBYyxJQUFJLGVBQWUsRUFBRSxDQUFDO1lBQzdDLE1BQU0sRUFBQyxNQUFNLEVBQUMsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1lBRS9DLElBQUksQ0FBQyxNQUFNLEVBQUUsU0FBUztnQkFBRSxTQUFRLENBQUMsNkVBQTZFO1lBRTlHLE1BQU0sRUFBQyxTQUFTLEVBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1lBQzdDLE1BQU0sRUFBQyxJQUFJLEVBQUMsR0FBRyxNQUFNLENBQUE7WUFFckIsSUFBSSxpQkFBaUIsR0FBRyxVQUFVLENBQUE7WUFFbEMsSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDVCxLQUFLLE1BQU0sUUFBUSxJQUFJLElBQUksRUFBRSxDQUFDO29CQUM1QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsY0FBYyxFQUFFLEVBQUUsZUFBZSxDQUFDLENBQUE7b0JBQy9FLE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtvQkFFN0gsSUFBSSxDQUFDLFlBQVk7d0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsaUJBQWlCLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxJQUFJLFFBQVEsRUFBRSxDQUFDLENBQUE7b0JBRWxILGlCQUFpQixHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQTtnQkFDNUUsQ0FBQztZQUNILENBQUM7WUFFRCxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtZQUU5RSxJQUFJLENBQUMsQ0FBQyxxQkFBcUIsSUFBSSxNQUFNLENBQUM7Z0JBQUUsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxDQUFBO1lBQzFFLElBQUksQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDO2dCQUFFLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUN2RyxDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUE7SUFDZixDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxVQUFVLGdCQUFnQixDQUFDLEdBQUcsS0FBSztJQUMvQyxPQUFPLElBQUksZ0JBQWdCLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtBQUNqRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tY29udGludWUsIHNvcnQtaW1wb3J0cyAqL1xuaW1wb3J0IHtkaWdnLCBkaWdzfSBmcm9tIFwiZGlnZ2VyaXplXCJcbmltcG9ydCAqIGFzIGluZmxlY3Rpb24gZnJvbSBcImluZmxlY3Rpb25cIlxuaW1wb3J0IG1vZGVsQ2xhc3NSZXF1aXJlIGZyb20gXCIuLi9tb2RlbC1jbGFzcy1yZXF1aXJlLmpzXCJcblxuY2xhc3MgU2VsZWN0Q2FsY3VsYXRvciB7XG4gIGNvbnN0cnVjdG9yKHt0YWJsZX0pIHtcbiAgICB0aGlzLnRhYmxlID0gdGFibGVcbiAgfVxuXG4gIHNlbGVjdHMoKSB7XG4gICAgY29uc3Qge21vZGVsQ2xhc3N9ID0gZGlncyh0aGlzLnRhYmxlLnByb3BzLCBcIm1vZGVsQ2xhc3NcIilcbiAgICBjb25zdCBzZWxlY3QgPSB0aGlzLnRhYmxlLnByb3BzLnNlbGVjdCB8fCB7fVxuICAgIGNvbnN0IHtwcmVwYXJlZENvbHVtbnN9ID0gZGlncyh0aGlzLnRhYmxlLnN0YXRlLCBcInByZXBhcmVkQ29sdW1uc1wiKVxuXG5cbiAgICAvLyBFbnN1cmUgdGhlIHByaW1hcnkga2V5IGNvbHVtbiBpcyBsb2FkZXIgZm9yIHRoZSBwcmltYXJ5IG1vZGVsIGNsYXNzXG4gICAgY29uc3QgY2xhc3NOYW1lID0gZGlnZyhtb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCksIFwibmFtZVwiKVxuICAgIGNvbnN0IHByaW1hcnlLZXlDb2x1bW5OYW1lID0gbW9kZWxDbGFzcy5wcmltYXJ5S2V5KClcblxuICAgIGlmICghKGNsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbY2xhc3NOYW1lXSA9IFtdXG4gICAgaWYgKCFzZWxlY3RbY2xhc3NOYW1lXS5pbmNsdWRlcyhwcmltYXJ5S2V5Q29sdW1uTmFtZSkpIHNlbGVjdFtjbGFzc05hbWVdLnB1c2gocHJpbWFyeUtleUNvbHVtbk5hbWUpXG5cblxuICAgIC8vIEVuc3VyZSAndXBkYXRlZEF0JyBpcyBzZWxlY3RlZCBpZiBkZWZpbmVkIGFzIGFuIGF0dHJpYnV0ZSwgYmVjYXVzZSBpdCBpcyB1c2VkIGZvciBjYWNoZUtleSBhbmQgdXBkYXRlcyBpbiB0aGUgdGFibGVcbiAgICBpZiAobW9kZWxDbGFzcy5oYXNBdHRyaWJ1dGUoXCJ1cGRhdGVkQXRcIikpIHtcbiAgICAgIGlmICghKGNsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbY2xhc3NOYW1lXSA9IFtdXG4gICAgICBpZiAoIXNlbGVjdFtjbGFzc05hbWVdLmluY2x1ZGVzKFwidXBkYXRlZEF0XCIpKSBzZWxlY3RbY2xhc3NOYW1lXS5wdXNoKFwidXBkYXRlZEF0XCIpXG4gICAgfVxuXG5cbiAgICAvLyBFbnN1cmUgY29sdW1ucyB1c2VkIGZvciBjb2x1bW5zIGFyZSBsb2FkZWRcbiAgICBmb3IgKGNvbnN0IHByZXBhcmVkQ29sdW1uIG9mIHByZXBhcmVkQ29sdW1ucykge1xuICAgICAgY29uc3Qge2NvbHVtbn0gPSBkaWdzKHByZXBhcmVkQ29sdW1uLCBcImNvbHVtblwiKVxuXG4gICAgICBpZiAoIWNvbHVtbj8uYXR0cmlidXRlKSBjb250aW51ZSAvLyAnY29sdW1uJyBtaWdodCBub3QgZXhpc3QgaWYgaGFzIGJlZW4gcmVtb3ZlZCBpbiBjb2RlIGJ1dCBzdGlsbCBzYXZlZCBpbiBEQlxuXG4gICAgICBjb25zdCB7YXR0cmlidXRlfSA9IGRpZ3MoY29sdW1uLCBcImF0dHJpYnV0ZVwiKVxuICAgICAgY29uc3Qge3BhdGh9ID0gY29sdW1uXG5cbiAgICAgIGxldCBjdXJyZW50TW9kZWxDbGFzcyA9IG1vZGVsQ2xhc3NcblxuICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgZm9yIChjb25zdCBwYXRoUGFydCBvZiBwYXRoKSB7XG4gICAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwcyA9IGRpZ2coY3VycmVudE1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKSwgXCJyZWxhdGlvbnNoaXBzXCIpXG4gICAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwcy5maW5kKChyZWxhdGlvbnNoaXBJbkFycmF5KSA9PiByZWxhdGlvbnNoaXBJbkFycmF5Lm5hbWUgPT0gaW5mbGVjdGlvbi51bmRlcnNjb3JlKHBhdGhQYXJ0KSlcblxuICAgICAgICAgIGlmICghcmVsYXRpb25zaGlwKSB0aHJvdyBuZXcgRXJyb3IoYE5vIHN1Y2ggcmVsYXRpb25zaGlwOiAke2N1cnJlbnRNb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCkubmFtZX0jJHtwYXRoUGFydH1gKVxuXG4gICAgICAgICAgY3VycmVudE1vZGVsQ2xhc3MgPSBtb2RlbENsYXNzUmVxdWlyZShkaWdnKHJlbGF0aW9uc2hpcCwgXCJyZXNvdXJjZV9uYW1lXCIpKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGN1cnJlbnRNb2RlbENsYXNzTmFtZSA9IGRpZ2coY3VycmVudE1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKSwgXCJuYW1lXCIpXG5cbiAgICAgIGlmICghKGN1cnJlbnRNb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbY3VycmVudE1vZGVsQ2xhc3NOYW1lXSA9IFtdXG4gICAgICBpZiAoIXNlbGVjdFtjdXJyZW50TW9kZWxDbGFzc05hbWVdLmluY2x1ZGVzKGF0dHJpYnV0ZSkpIHNlbGVjdFtjdXJyZW50TW9kZWxDbGFzc05hbWVdLnB1c2goYXR0cmlidXRlKVxuICAgIH1cblxuICAgIHJldHVybiBzZWxlY3RcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBzZWxlY3RDYWxjdWxhdG9yKC4uLnByb3BzKSB7XG4gIHJldHVybiBuZXcgU2VsZWN0Q2FsY3VsYXRvciguLi5wcm9wcykuc2VsZWN0cygpXG59XG4iXX0=