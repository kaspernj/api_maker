/* eslint-disable jest/require-hook */
import { useCallback, useEffect, useMemo, useRef } from "react";
import CanCan from "./can-can.js";
import Devise from "./devise.js";
import useCurrentUser from "./use-current-user.js";
import useEventEmitter from "ya-use-event-emitter";
import useShape from "set-state-compare/build/use-shape.js";
const dependencyKeyMap = new WeakMap();
let dependencyKeyNextId = 1;
const dependencyKeyFor = (value) => {
    if (value === null)
        return "null";
    if (value === undefined)
        return "undefined";
    const valueType = typeof value;
    if (valueType !== "object" && valueType !== "function") {
        return `${valueType}:${String(value)}`;
    }
    if (!dependencyKeyMap.has(value)) {
        dependencyKeyMap.set(value, dependencyKeyNextId);
        dependencyKeyNextId += 1;
    }
    return `${valueType}:ref:${dependencyKeyMap.get(value)}`;
};
const dependencyListKey = (list) => {
    if (!Array.isArray(list))
        return dependencyKeyFor(list);
    return list.map((value) => dependencyKeyFor(value)).join("|");
};
/**
 * @param {function() : Array} abilitiesCallback
 * @param {Array} dependencies
 * @returns {CanCan}
 */
export default function useCanCan(abilitiesCallback, dependencies) {
    const currentUser = useCurrentUser();
    const s = useShape({ abilitiesCallback });
    s.useStates({
        canCan: CanCan.current(),
        lastUpdate: () => new Date()
    });
    const deviseReloadKeyRef = useRef(0);
    const loadAbilities = useCallback(async (reloadKey) => {
        const canCan = CanCan.current();
        const abilities = s.p.abilitiesCallback();
        if (reloadKey === undefined) {
            await canCan.loadAbilities(abilities);
        }
        else {
            await canCan.reloadAbilities(abilities, reloadKey);
        }
        s.set({ lastUpdate: new Date() });
    }, []);
    const onDeviseChange = useCallback(() => {
        deviseReloadKeyRef.current += 1;
        loadAbilities(`devise:${deviseReloadKeyRef.current}`);
    }, [loadAbilities]);
    const onResetAbilities = useCallback(() => {
        loadAbilities();
    }, [loadAbilities]);
    const currentUserId = currentUser?.id();
    const dependencyList = dependencies ?? [currentUserId];
    const dependencyKey = useMemo(() => dependencyListKey(dependencyList), dependencyList);
    useEffect(() => {
        loadAbilities(dependencyKey);
    }, [dependencyKey]);
    useEventEmitter(Devise.events(), "onDeviseSignIn", onDeviseChange);
    useEventEmitter(Devise.events(), "onDeviseSignOut", onDeviseChange);
    useEventEmitter(CanCan.current().events, "onResetAbilities", onResetAbilities);
    return s.s.canCan;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWNhbi1jYW4uanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInVzZS1jYW4tY2FuLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHNDQUFzQztBQUN0QyxPQUFPLEVBQUMsV0FBVyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFDLE1BQU0sT0FBTyxDQUFBO0FBQzdELE9BQU8sTUFBTSxNQUFNLGNBQWMsQ0FBQTtBQUNqQyxPQUFPLE1BQU0sTUFBTSxhQUFhLENBQUE7QUFDaEMsT0FBTyxjQUFjLE1BQU0sdUJBQXVCLENBQUE7QUFDbEQsT0FBTyxlQUFlLE1BQU0sc0JBQXNCLENBQUE7QUFDbEQsT0FBTyxRQUFRLE1BQU0sc0NBQXNDLENBQUE7QUFFM0QsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO0FBQ3RDLElBQUksbUJBQW1CLEdBQUcsQ0FBQyxDQUFBO0FBRTNCLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNqQyxJQUFJLEtBQUssS0FBSyxJQUFJO1FBQUUsT0FBTyxNQUFNLENBQUE7SUFDakMsSUFBSSxLQUFLLEtBQUssU0FBUztRQUFFLE9BQU8sV0FBVyxDQUFBO0lBRTNDLE1BQU0sU0FBUyxHQUFHLE9BQU8sS0FBSyxDQUFBO0lBRTlCLElBQUksU0FBUyxLQUFLLFFBQVEsSUFBSSxTQUFTLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDdkQsT0FBTyxHQUFHLFNBQVMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQTtJQUN4QyxDQUFDO0lBRUQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ2pDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsbUJBQW1CLENBQUMsQ0FBQTtRQUNoRCxtQkFBbUIsSUFBSSxDQUFDLENBQUE7SUFDMUIsQ0FBQztJQUVELE9BQU8sR0FBRyxTQUFTLFFBQVEs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RSxDQUFDLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFBO0lBRTlFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDbkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGplc3QvcmVxdWlyZS1ob29rICovXG5pbXBvcnQge3VzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZU1lbW8sIHVzZVJlZn0gZnJvbSBcInJlYWN0XCJcbmltcG9ydCBDYW5DYW4gZnJvbSBcIi4vY2FuLWNhbi5qc1wiXG5pbXBvcnQgRGV2aXNlIGZyb20gXCIuL2RldmlzZS5qc1wiXG5pbXBvcnQgdXNlQ3VycmVudFVzZXIgZnJvbSBcIi4vdXNlLWN1cnJlbnQtdXNlci5qc1wiXG5pbXBvcnQgdXNlRXZlbnRFbWl0dGVyIGZyb20gXCJ5YS11c2UtZXZlbnQtZW1pdHRlclwiXG5pbXBvcnQgdXNlU2hhcGUgZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3VzZS1zaGFwZS5qc1wiXG5cbmNvbnN0IGRlcGVuZGVuY3lLZXlNYXAgPSBuZXcgV2Vha01hcCgpXG5sZXQgZGVwZW5kZW5jeUtleU5leHRJZCA9IDFcblxuY29uc3QgZGVwZW5kZW5jeUtleUZvciA9ICh2YWx1ZSkgPT4ge1xuICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiBcIm51bGxcIlxuICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIFwidW5kZWZpbmVkXCJcblxuICBjb25zdCB2YWx1ZVR5cGUgPSB0eXBlb2YgdmFsdWVcblxuICBpZiAodmFsdWVUeXBlICE9PSBcIm9iamVjdFwiICYmIHZhbHVlVHlwZSAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgcmV0dXJuIGAke3ZhbHVlVHlwZX06JHtTdHJpbmcodmFsdWUpfWBcbiAgfVxuXG4gIGlmICghZGVwZW5kZW5jeUtleU1hcC5oYXModmFsdWUpKSB7XG4gICAgZGVwZW5kZW5jeUtleU1hcC5zZXQodmFsdWUsIGRlcGVuZGVuY3lLZXlOZXh0SWQpXG4gICAgZGVwZW5kZW5jeUtleU5leHRJZCArPSAxXG4gIH1cblxuICByZXR1cm4gYCR7dmFsdWVUeXBlfTpyZWY6JHtkZXBlbmRlbmN5S2V5TWFwLmdldCh2YWx1ZSl9YFxufVxuXG5jb25zdCBkZXBlbmRlbmN5TGlzdEtleSA9IChsaXN0KSA9PiB7XG4gIGlmICghQXJyYXkuaXNBcnJheShsaXN0KSkgcmV0dXJuIGRlcGVuZGVuY3lLZXlGb3IobGlzdClcblxuICByZXR1cm4gbGlzdC5tYXAoKHZhbHVlKSA9PiBkZXBlbmRlbmN5S2V5Rm9yKHZhbHVlKSkuam9pbihcInxcIilcbn1cblxuLyoqXG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCkgOiBBcnJheX0gYWJpbGl0aWVzQ2FsbGJhY2tcbiAqIEBwYXJhbSB7QXJyYXl9IGRlcGVuZGVuY2llc1xuICogQHJldHVybnMge0NhbkNhbn1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdXNlQ2FuQ2FuKGFiaWxpdGllc0NhbGxiYWNrLCBkZXBlbmRlbmNpZXMpIHtcbiAgY29uc3QgY3VycmVudFVzZXIgPSB1c2VDdXJyZW50VXNlcigpXG4gIGNvbnN0IHMgPSB1c2VTaGFwZSh7YWJpbGl0aWVzQ2FsbGJhY2t9KVxuXG4gIHMudXNlU3RhdGVzKHtcbiAgICBjYW5DYW46IENhbkNhbi5jdXJyZW50KCksXG4gICAgbGFzdFVwZGF0ZTogKCkgPT4gbmV3IERhdGUoKVxuICB9KVxuXG4gIGNvbnN0IGRldmlzZVJlbG9hZEtleVJlZiA9IHVzZVJlZigwKVxuXG4gIGNvbnN0IGxvYWRBYmlsaXRpZXMgPSB1c2VDYWxsYmFjayhhc3luYyAocmVsb2FkS2V5KSA9PiB7XG4gICAgY29uc3QgY2FuQ2FuID0gQ2FuQ2FuLmN1cnJlbnQoKVxuICAgIGNvbnN0IGFiaWxpdGllcyA9IHMucC5hYmlsaXRpZXNDYWxsYmFjaygpXG5cbiAgICBpZiAocmVsb2FkS2V5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGF3YWl0IGNhbkNhbi5sb2FkQWJpbGl0aWVzKGFiaWxpdGllcylcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgY2FuQ2FuLnJlbG9hZEFiaWxpdGllcyhhYmlsaXRpZXMsIHJlbG9hZEtleSlcbiAgICB9XG5cbiAgICBzLnNldCh7bGFzdFVwZGF0ZTogbmV3IERhdGUoKX0pXG4gIH0sIFtdKVxuXG4gIGNvbnN0IG9uRGV2aXNlQ2hhbmdlID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGRldmlzZVJlbG9hZEtleVJlZi5jdXJyZW50ICs9IDFcbiAgICBsb2FkQWJpbGl0aWVzKGBkZXZpc2U6JHtkZXZpc2VSZWxvYWRLZXlSZWYuY3VycmVudH1gKVxuICB9LCBbbG9hZEFiaWxpdGllc10pXG5cbiAgY29uc3Qgb25SZXNldEFiaWxpdGllcyA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBsb2FkQWJpbGl0aWVzKClcbiAgfSwgW2xvYWRBYmlsaXRpZXNdKVxuXG4gIGNvbnN0IGN1cnJlbnRVc2VySWQgPSBjdXJyZW50VXNlcj8uaWQoKVxuICBjb25zdCBkZXBlbmRlbmN5TGlzdCA9IGRlcGVuZGVuY2llcyA/PyBbY3VycmVudFVzZXJJZF1cbiAgY29uc3QgZGVwZW5kZW5jeUtleSA9IHVzZU1lbW8oKCkgPT4gZGVwZW5kZW5jeUxpc3RLZXkoZGVwZW5kZW5jeUxpc3QpLCBkZXBlbmRlbmN5TGlzdClcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGxvYWRBYmlsaXRpZXMoZGVwZW5kZW5jeUtleSlcbiAgfSwgW2RlcGVuZGVuY3lLZXldKVxuXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduSW5cIiwgb25EZXZpc2VDaGFuZ2UpXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduT3V0XCIsIG9uRGV2aXNlQ2hhbmdlKVxuICB1c2VFdmVudEVtaXR0ZXIoQ2FuQ2FuLmN1cnJlbnQoKS5ldmVudHMsIFwib25SZXNldEFiaWxpdGllc1wiLCBvblJlc2V0QWJpbGl0aWVzKVxuXG4gIHJldHVybiBzLnMuY2FuQ2FuXG59XG4iXX0=