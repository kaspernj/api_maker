import { dig } from "diggerize";
import CableSubscription from "./cable-subscription.js"; // eslint-disable-line sort-imports
import CableSubscriptionPool from "./cable-subscription-pool.js";
import RunLast from "./run-last.js";
const shared = {};
export default class ApiMakerCableConnectionPool {
    cableSubscriptionPools = [];
    connections = {};
    upcomingSubscriptionData = {};
    upcomingSubscriptions = {};
    static current() {
        if (!shared.apiMakerCableConnectionPool)
            shared.apiMakerCableConnectionPool = new ApiMakerCableConnectionPool();
        return shared.apiMakerCableConnectionPool;
    }
    connectEventToExistingSubscription({ path, subscription, value }) {
        for (const cableSubscriptionPool of this.cableSubscriptionPools) {
            if (cableSubscriptionPool.isConnected()) {
                let existingSubscriptions;
                if (value === true) {
                    existingSubscriptions = dig(cableSubscriptionPool.subscriptions, ...path);
                }
                else {
                    existingSubscriptions = dig(cableSubscriptionPool.subscriptions, ...path, value);
                }
                if (existingSubscriptions !== undefined) {
                    if (!Array.isArray(existingSubscriptions)) {
                        throw new Error(`existingSubscriptions wasn't an array: ${typeof existingSubscriptions} (${dig(existingSubscriptions, "constructor", "name")})`);
                    }
                    existingSubscriptions.push(subscription);
                    cableSubscriptionPool.connectUnsubscriptionForSubscription(subscription);
                    return true;
                }
            }
        }
        return false;
    }
    connectModelEvent({ callback, path, value }) {
        const subscription = new CableSubscription();
        subscription.events.addListener("received", callback);
        if (this.connectEventToExistingSubscription({ path, subscription, value })) {
            // Managed to connect to existing connection
            return subscription;
        }
        let currentSubscriptionData = this.upcomingSubscriptionData;
        let currentSubscription = this.upcomingSubscriptions;
        for (let i = 0; i < path.length; i++) {
            const pathPart = path[i];
            if (!(pathPart in currentSubscriptionData)) {
                if (i == path.length - 1) {
                    currentSubscriptionData[pathPart] = [];
                }
                else {
                    currentSubscriptionData[pathPart] = {};
                }
            }
            currentSubscriptionData = currentSubscriptionData[pathPart];
            if (!(pathPart in currentSubscription)) {
                if (value === true && i == path.length - 1) {
                    currentSubscription[pathPart] = [];
                }
                else {
                    currentSubscription[pathPart] = {};
                }
            }
            currentSubscription = currentSubscription[pathPart];
        }
        if (!currentSubscriptionData.includes(value)) {
            currentSubscriptionData.push(value);
        }
        if (value === true) {
            currentSubscription.push(subscription);
        }
        else {
            if (!(value in currentSubscription)) {
                currentSubscription[value] = [];
            }
            currentSubscription[value].push(subscription);
        }
        this.scheduleConnectUpcomingRunLast.queue();
        return subscription;
    }
    connectCreated = (modelName, callback) => this.connectModelEvent({ callback, value: true, path: [modelName, "creates"] });
    connectEvent = (modelName, modelId, eventName, callback) => this.connectModelEvent({
        callback,
        value: modelId,
        path: [modelName, "events", eventName]
    });
    connectDestroyed = (modelName, modelId, callback) => this.connectModelEvent({ callback, value: modelId, path: [modelName, "destroys"] });
    connectModelClassEvent = (modelName, eventName, callback) => this.connectModelEvent({ callback, value: eventName, path: [modelName, "model_class_events"] });
    connectUpdate = (modelName, modelId, callback) => this.connectModelEvent({ callback, value: modelId, path: [modelName, "updates"] });
    connectUpcoming = () => {
        const subscriptionData = this.upcomingSubscriptionData;
        const subscriptions = this.upcomingSubscriptions;
        this.upcomingSubscriptionData = {};
        this.upcomingSubscriptions = {};
        const cableSubscriptionPool = new CableSubscriptionPool();
        cableSubscriptionPool.registerSubscriptions(subscriptions);
        cableSubscriptionPool.connect(subscriptionData);
        this.cableSubscriptionPools.push(cableSubscriptionPool);
    };
    scheduleConnectUpcomingRunLast = new RunLast(this.connectUpcoming);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FibGUtY29ubmVjdGlvbi1wb29sLmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJjYWJsZS1jb25uZWN0aW9uLXBvb2wuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUM3QixPQUFPLGlCQUFpQixNQUFNLHlCQUF5QixDQUFBLENBQUMsbUNBQW1DO0FBQzNGLE9BQU8scUJBQXFCLE1BQU0sOEJBQThCLENBQUE7QUFDaEUsT0FBTyxPQUFPLE1BQU0sZUFBZSxDQUFBO0FBRW5DLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtBQUVqQixNQUFNLENBQUMsT0FBTyxPQUFPLDJCQUEyQjtJQUM5QyxzQkFBc0IsR0FBRyxFQUFFLENBQUE7SUFDM0IsV0FBVyxHQUFHLEVBQUUsQ0FBQTtJQUNoQix3QkFBd0IsR0FBRyxFQUFFLENBQUE7SUFDN0IscUJBQXFCLEdBQUcsRUFBRSxDQUFBO0lBRTFCLE1BQU0sQ0FBQyxPQUFPO1FBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQywyQkFBMkI7WUFBRSxNQUFNLENBQUMsMkJBQTJCLEdBQUcsSUFBSSwyQkFBMkIsRUFBRSxDQUFBO1FBRS9HLE9BQU8sTUFBTSxDQUFDLDJCQUEyQixDQUFBO0lBQzNDLENBQUM7SUFFRCxrQ0FBa0MsQ0FBRSxFQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFDO1FBQzdELEtBQUssTUFBTSxxQkFBcUIsSUFBSSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7Z0JBQ3hDLElBQUkscUJBQXFCLENBQUE7Z0JBRXpCLElBQUksS0FBSyxLQUFLLElBQUksRUFBRSxDQUFDO29CQUNuQixxQkFBcUIsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsYUFBYSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUE7Z0JBQzNFLENBQUM7cUJB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RSxDQUFDLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQyxFQUFDLENBQUMsQ0FBQTtJQUMxSixhQUFhLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxFQUFDLENBQUMsQ0FBQTtJQUVsSSxlQUFlLEdBQUcsR0FBRyxFQUFFO1FBQ3JCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFBO1FBQ3RELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQTtRQUVoRCxJQUFJLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFBO1FBQ2xDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUE7UUFFL0IsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLHFCQUFxQixFQUFFLENBQUE7UUFFekQscUJBQXFCLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDMUQscUJBQXFCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUE7UUFFL0MsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0lBQ3pELENBQUMsQ0FBQTtJQUVELDhCQUE4QixHQUFHLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtDQUNuRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZGlnfSBmcm9tIFwiZGlnZ2VyaXplXCJcbmltcG9ydCBDYWJsZVN1YnNjcmlwdGlvbiBmcm9tIFwiLi9jYWJsZS1zdWJzY3JpcHRpb24uanNcIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHNvcnQtaW1wb3J0c1xuaW1wb3J0IENhYmxlU3Vic2NyaXB0aW9uUG9vbCBmcm9tIFwiLi9jYWJsZS1zdWJzY3JpcHRpb24tcG9vbC5qc1wiXG5pbXBvcnQgUnVuTGFzdCBmcm9tIFwiLi9ydW4tbGFzdC5qc1wiXG5cbmNvbnN0IHNoYXJlZCA9IHt9XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCB7XG4gIGNhYmxlU3Vic2NyaXB0aW9uUG9vbHMgPSBbXVxuICBjb25uZWN0aW9ucyA9IHt9XG4gIHVwY29taW5nU3Vic2NyaXB0aW9uRGF0YSA9IHt9XG4gIHVwY29taW5nU3Vic2NyaXB0aW9ucyA9IHt9XG5cbiAgc3RhdGljIGN1cnJlbnQgKCkge1xuICAgIGlmICghc2hhcmVkLmFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCkgc2hhcmVkLmFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCA9IG5ldyBBcGlNYWtlckNhYmxlQ29ubmVjdGlvblBvb2woKVxuXG4gICAgcmV0dXJuIHNoYXJlZC5hcGlNYWtlckNhYmxlQ29ubmVjdGlvblBvb2xcbiAgfVxuXG4gIGNvbm5lY3RFdmVudFRvRXhpc3RpbmdTdWJzY3JpcHRpb24gKHtwYXRoLCBzdWJzY3JpcHRpb24sIHZhbHVlfSkge1xuICAgIGZvciAoY29uc3QgY2FibGVTdWJzY3JpcHRpb25Qb29sIG9mIHRoaXMuY2FibGVTdWJzY3JpcHRpb25Qb29scykge1xuICAgICAgaWYgKGNhYmxlU3Vic2NyaXB0aW9uUG9vbC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgIGxldCBleGlzdGluZ1N1YnNjcmlwdGlvbnNcblxuICAgICAgICBpZiAodmFsdWUgPT09IHRydWUpIHtcbiAgICAgICAgICBleGlzdGluZ1N1YnNjcmlwdGlvbnMgPSBkaWcoY2FibGVTdWJzY3JpcHRpb25Qb29sLnN1YnNjcmlwdGlvbnMsIC4uLnBhdGgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZXhpc3RpbmdTdWJzY3JpcHRpb25zID0gZGlnKGNhYmxlU3Vic2NyaXB0aW9uUG9vbC5zdWJzY3JpcHRpb25zLCAuLi5wYXRoLCB2YWx1ZSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChleGlzdGluZ1N1YnNjcmlwdGlvbnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShleGlzdGluZ1N1YnNjcmlwdGlvbnMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGV4aXN0aW5nU3Vic2NyaXB0aW9ucyB3YXNuJ3QgYW4gYXJyYXk6ICR7dHlwZW9mIGV4aXN0aW5nU3Vic2NyaXB0aW9uc30gKCR7ZGlnKGV4aXN0aW5nU3Vic2NyaXB0aW9ucywgXCJjb25zdHJ1Y3RvclwiLCBcIm5hbWVcIil9KWApXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZXhpc3RpbmdTdWJzY3JpcHRpb25zLnB1c2goc3Vic2NyaXB0aW9uKVxuICAgICAgICAgIGNhYmxlU3Vic2NyaXB0aW9uUG9vbC5jb25uZWN0VW5zdWJzY3JpcHRpb25Gb3JTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKVxuXG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgY29ubmVjdE1vZGVsRXZlbnQgKHtjYWxsYmFjaywgcGF0aCwgdmFsdWV9KSB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gbmV3IENhYmxlU3Vic2NyaXB0aW9uKClcblxuICAgIHN1YnNjcmlwdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIoXCJyZWNlaXZlZFwiLCBjYWxsYmFjaylcblxuICAgIGlmICh0aGlzLmNvbm5lY3RFdmVudFRvRXhpc3RpbmdTdWJzY3JpcHRpb24oe3BhdGgsIHN1YnNjcmlwdGlvbiwgdmFsdWV9KSkge1xuICAgICAgLy8gTWFuYWdlZCB0byBjb25uZWN0IHRvIGV4aXN0aW5nIGNvbm5lY3Rpb25cbiAgICAgIHJldHVybiBzdWJzY3JpcHRpb25cbiAgICB9XG5cbiAgICBsZXQgY3VycmVudFN1YnNjcmlwdGlvbkRhdGEgPSB0aGlzLnVwY29taW5nU3Vic2NyaXB0aW9uRGF0YVxuICAgIGxldCBjdXJyZW50U3Vic2NyaXB0aW9uID0gdGhpcy51cGNvbWluZ1N1YnNjcmlwdGlvbnNcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgcGF0aFBhcnQgPSBwYXRoW2ldXG5cbiAgICAgIGlmICghKHBhdGhQYXJ0IGluIGN1cnJlbnRTdWJzY3JpcHRpb25EYXRhKSkge1xuICAgICAgICBpZiAoaSA9PSBwYXRoLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBjdXJyZW50U3Vic2NyaXB0aW9uRGF0YVtwYXRoUGFydF0gPSBbXVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb25EYXRhW3BhdGhQYXJ0XSA9IHt9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY3VycmVudFN1YnNjcmlwdGlvbkRhdGEgPSBjdXJyZW50U3Vic2NyaXB0aW9uRGF0YVtwYXRoUGFydF1cblxuICAgICAgaWYgKCEocGF0aFBhcnQgaW4gY3VycmVudFN1YnNjcmlwdGlvbikpIHtcbiAgICAgICAgaWYgKHZhbHVlID09PSB0cnVlICYmIGkgPT0gcGF0aC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgY3VycmVudFN1YnNjcmlwdGlvbltwYXRoUGFydF0gPSBbXVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb25bcGF0aFBhcnRdID0ge31cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjdXJyZW50U3Vic2NyaXB0aW9uID0gY3VycmVudFN1YnNjcmlwdGlvbltwYXRoUGFydF1cbiAgICB9XG5cbiAgICBpZiAoIWN1cnJlbnRTdWJzY3JpcHRpb25EYXRhLmluY2x1ZGVzKHZhbHVlKSkge1xuICAgICAgY3VycmVudFN1YnNjcmlwdGlvbkRhdGEucHVzaCh2YWx1ZSlcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgPT09IHRydWUpIHtcbiAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb24ucHVzaChzdWJzY3JpcHRpb24pXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghKHZhbHVlIGluIGN1cnJlbnRTdWJzY3JpcHRpb24pKSB7XG4gICAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb25bdmFsdWVdID0gW11cbiAgICAgIH1cblxuICAgICAgY3VycmVudFN1YnNjcmlwdGlvblt2YWx1ZV0ucHVzaChzdWJzY3JpcHRpb24pXG4gICAgfVxuXG4gICAgdGhpcy5zY2hlZHVsZUNvbm5lY3RVcGNvbWluZ1J1bkxhc3QucXVldWUoKVxuXG4gICAgcmV0dXJuIHN1YnNjcmlwdGlvblxuICB9XG5cbiAgY29ubmVjdENyZWF0ZWQgPSAobW9kZWxOYW1lLCBjYWxsYmFjaykgPT4gdGhpcy5jb25uZWN0TW9kZWxFdmVudCh7Y2FsbGJhY2ssIHZhbHVlOiB0cnVlLCBwYXRoOiBbbW9kZWxOYW1lLCBcImNyZWF0ZXNcIl19KVxuICBjb25uZWN0RXZlbnQgPSAobW9kZWxOYW1lLCBtb2RlbElkLCBldmVudE5hbWUsIGNhbGxiYWNrKSA9PiB0aGlzLmNvbm5lY3RNb2RlbEV2ZW50KHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBtYXgtcGFyYW1zXG4gICAgY2FsbGJhY2ssXG4gICAgdmFsdWU6IG1vZGVsSWQsXG4gICAgcGF0aDogW21vZGVsTmFtZSwgXCJldmVudHNcIiwgZXZlbnROYW1lXVxuICB9KVxuICBjb25uZWN0RGVzdHJveWVkID0gKG1vZGVsTmFtZSwgbW9kZWxJZCwgY2FsbGJhY2spID0+IHRoaXMuY29ubmVjdE1vZGVsRXZlbnQoe2NhbGxiYWNrLCB2YWx1ZTogbW9kZWxJZCwgcGF0aDogW21vZGVsTmFtZSwgXCJkZXN0cm95c1wiXX0pXG4gIGNvbm5lY3RNb2RlbENsYXNzRXZlbnQgPSAobW9kZWxOYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrKSA9PiB0aGlzLmNvbm5lY3RNb2RlbEV2ZW50KHtjYWxsYmFjaywgdmFsdWU6IGV2ZW50TmFtZSwgcGF0aDogW21vZGVsTmFtZSwgXCJtb2RlbF9jbGFzc19ldmVudHNcIl19KVxuICBjb25uZWN0VXBkYXRlID0gKG1vZGVsTmFtZSwgbW9kZWxJZCwgY2FsbGJhY2spID0+IHRoaXMuY29ubmVjdE1vZGVsRXZlbnQoe2NhbGxiYWNrLCB2YWx1ZTogbW9kZWxJZCwgcGF0aDogW21vZGVsTmFtZSwgXCJ1cGRhdGVzXCJdfSlcblxuICBjb25uZWN0VXBjb21pbmcgPSAoKSA9PiB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uRGF0YSA9IHRoaXMudXBjb21pbmdTdWJzY3JpcHRpb25EYXRhXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IHRoaXMudXBjb21pbmdTdWJzY3JpcHRpb25zXG5cbiAgICB0aGlzLnVwY29taW5nU3Vic2NyaXB0aW9uRGF0YSA9IHt9XG4gICAgdGhpcy51cGNvbWluZ1N1YnNjcmlwdGlvbnMgPSB7fVxuXG4gICAgY29uc3QgY2FibGVTdWJzY3JpcHRpb25Qb29sID0gbmV3IENhYmxlU3Vic2NyaXB0aW9uUG9vbCgpXG5cbiAgICBjYWJsZVN1YnNjcmlwdGlvblBvb2wucmVnaXN0ZXJTdWJzY3JpcHRpb25zKHN1YnNjcmlwdGlvbnMpXG4gICAgY2FibGVTdWJzY3JpcHRpb25Qb29sLmNvbm5lY3Qoc3Vic2NyaXB0aW9uRGF0YSlcblxuICAgIHRoaXMuY2FibGVTdWJzY3JpcHRpb25Qb29scy5wdXNoKGNhYmxlU3Vic2NyaXB0aW9uUG9vbClcbiAgfVxuXG4gIHNjaGVkdWxlQ29ubmVjdFVwY29taW5nUnVuTGFzdCA9IG5ldyBSdW5MYXN0KHRoaXMuY29ubmVjdFVwY29taW5nKVxufVxuIl19