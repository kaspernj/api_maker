import { jsx as _jsx } from "react/jsx-runtime";
/* eslint-disable jest/require-hook, react/function-component-definition, sort-imports */
import React, { useCallback, useMemo } from "react";
import Devise from "./devise.js";
import { digg } from "diggerize";
import { events } from "./use-current-user.js";
import * as inflection from "inflection";
import Logger from "./logger.js";
import Services from "./services.js";
import useEventEmitter from "ya-use-event-emitter";
import useShape from "set-state-compare/build/use-shape.js";
const logger = new Logger({ name: "ApiMaker / UseCurrentUserContext" });
logger.setDebug(false);
/**
 * @param {object} props
 * @param {Function} props.children
 * @param {string} [props.scope]
 * @returns {import("react").ReactNode}
 */
const UseCurrentUserContext = (props) => {
    const { children, scope = "user", ...restProps } = props;
    if (Object.keys(restProps).length > 0) {
        throw new Error(`Unknown props given to UseCurrentUserContext: ${Object.keys(restProps).join(", ")}`);
    }
    const s = useShape(props);
    const scopeName = `current${inflection.camelize(scope)}`;
    const scopeInstance = Devise.getScope(scope);
    const ScopeContext = scopeInstance.getContext();
    s.meta.scope = scope;
    s.meta.scopeName = scopeName;
    const loadCurrentUserFromRequest = useCallback(async () => {
        const { scope } = s.m;
        const getArgsMethodName = `get${inflection.camelize(scope)}Args`;
        const args = Devise[getArgsMethodName]();
        logger.debug(() => `Loading ${scope} with request`);
        const result = await Services.current().sendRequest("Devise::Current", { query: args.query, scope });
        const current = digg(result, "current")[0];
        if (current)
            Devise.updateSession(current);
        s.set({
            result: {
                loaded: true,
                model: current
            }
        });
        events.emit("currentUserLoaded", { current });
    }, []);
    const defaultCurrentUser = useCallback(() => {
        const { scope, scopeName } = s.m;
        let current;
        if (Devise.current().hasCurrentScope(s.m.scope)) {
            current = Devise.current().getCurrentScope(scope);
            logger.debug(() => `Setting ${scope} from current scope: ${current?.id()}`);
        }
        else if (Devise.current().hasGlobalCurrentScope(scope)) {
            current = Devise[scopeName]();
            logger.debug(() => `Setting ${scope} from global current scope: ${current?.id()}`);
        }
        if (current) {
            events.emit("currentUserLoaded", { current });
        }
        return current;
    }, []);
    s.useStates({
        result: () => ({
            loaded: false,
            model: defaultCurrentUser()
        })
    });
    const updateCurrentUser = useCallback(() => {
        s.set({
            result: {
                loaded: true,
                model: Devise[s.m.scopeName]()
            }
        });
    }, []);
    useMemo(() => {
        if (!Devise.current().hasGlobalCurrentScope(s.m.scope) && !Devise.current().hasCurrentScope(s.m.scope)) {
            logger.debug(() => `Devise hasn't got current scope ${s.m.scope} so loading from request`);
            loadCurrentUserFromRequest();
        }
    }, []);
    const onDeviseSignIn = useCallback(() => {
        updateCurrentUser();
    }, []);
    const onDeviseSignOut = useCallback(() => {
        updateCurrentUser();
    }, []);
    useEventEmitter(Devise.events(), "onDeviseSignIn", onDeviseSignIn);
    useEventEmitter(Devise.events(), "onDeviseSignOut", onDeviseSignOut);
    return (_jsx(ScopeContext.Provider, { value: s.s.result, children: children }));
};
export default UseCurrentUserContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWN1cnJlbnQtdXNlci1jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJ1c2UtY3VycmVudC11c2VyLWNvbnRleHQuanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSx5RkFBeUY7QUFDekYsT0FBTyxLQUFLLEVBQUUsRUFBQyxXQUFXLEVBQUUsT0FBTyxFQUFDLE1BQU0sT0FBTyxDQUFBO0FBQ2pELE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQTtBQUNoQyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQzlCLE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQTtBQUM1QyxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLE1BQU0sTUFBTSxhQUFhLENBQUE7QUFDaEMsT0FBTyxRQUFRLE1BQU0sZUFBZSxDQUFBO0FBQ3BDLE9BQU8sZUFBZSxNQUFNLHNCQUFzQixDQUFBO0FBQ2xELE9BQU8sUUFBUSxNQUFNLHNDQUFzQyxDQUFBO0FBRTNELE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUMsSUFBSSxFQUFFLGtDQUFrQyxFQUFDLENBQUMsQ0FBQTtBQUVyRSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBRXRCOzs7OztHQUtHO0FBQ0gsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ3RDLE1BQU0sRUFBQyxRQUFRLEVBQUUsS0FBSyxHQUFHLE1BQU0sRUFBRSxHQUFHLFNBQVMsRUFBQyxHQUFHLEtBQUssQ0FBQTtJQUV0RCxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFF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ZSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsQ0FBQTtJQUNsRSxlQUFlLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLGlCQUFpQixFQUFFLGVBQWUsQ0FBQyxDQUFBO0lBRXBFLE9BQU8sQ0FDTCxLQUFDLFlBQVksQ0FBQyxRQUFRLElBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxZQUNyQyxRQUFRLEdBQ2EsQ0FDekIsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQUVELGVBQWUscUJBQXFCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBqZXN0L3JlcXVpcmUtaG9vaywgcmVhY3QvZnVuY3Rpb24tY29tcG9uZW50LWRlZmluaXRpb24sIHNvcnQtaW1wb3J0cyAqL1xuaW1wb3J0IFJlYWN0LCB7dXNlQ2FsbGJhY2ssIHVzZU1lbW99IGZyb20gXCJyZWFjdFwiXG5pbXBvcnQgRGV2aXNlIGZyb20gXCIuL2RldmlzZS5qc1wiXG5pbXBvcnQge2RpZ2d9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IHtldmVudHN9IGZyb20gXCIuL3VzZS1jdXJyZW50LXVzZXIuanNcIlxuaW1wb3J0ICogYXMgaW5mbGVjdGlvbiBmcm9tIFwiaW5mbGVjdGlvblwiXG5pbXBvcnQgTG9nZ2VyIGZyb20gXCIuL2xvZ2dlci5qc1wiXG5pbXBvcnQgU2VydmljZXMgZnJvbSBcIi4vc2VydmljZXMuanNcIlxuaW1wb3J0IHVzZUV2ZW50RW1pdHRlciBmcm9tIFwieWEtdXNlLWV2ZW50LWVtaXR0ZXJcIlxuaW1wb3J0IHVzZVNoYXBlIGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC91c2Utc2hhcGUuanNcIlxuXG5jb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHtuYW1lOiBcIkFwaU1ha2VyIC8gVXNlQ3VycmVudFVzZXJDb250ZXh0XCJ9KVxuXG5sb2dnZXIuc2V0RGVidWcoZmFsc2UpXG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IHByb3BzXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm9wcy5jaGlsZHJlblxuICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wcy5zY29wZV1cbiAqIEByZXR1cm5zIHtpbXBvcnQoXCJyZWFjdFwiKS5SZWFjdE5vZGV9XG4gKi9cbmNvbnN0IFVzZUN1cnJlbnRVc2VyQ29udGV4dCA9IChwcm9wcykgPT4ge1xuICBjb25zdCB7Y2hpbGRyZW4sIHNjb3BlID0gXCJ1c2VyXCIsIC4uLnJlc3RQcm9wc30gPSBwcm9wc1xuXG4gIGlmIChPYmplY3Qua2V5cyhyZXN0UHJvcHMpLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcHJvcHMgZ2l2ZW4gdG8gVXNlQ3VycmVudFVzZXJDb250ZXh0OiAke09iamVjdC5rZXlzKHJlc3RQcm9wcykuam9pbihcIiwgXCIpfWApXG4gIH1cblxuICBjb25zdCBzID0gdXNlU2hhcGUocHJvcHMpXG4gIGNvbnN0IHNjb3BlTmFtZSA9IGBjdXJyZW50JHtpbmZsZWN0aW9uLmNhbWVsaXplKHNjb3BlKX1gXG4gIGNvbnN0IHNjb3BlSW5zdGFuY2UgPSBEZXZpc2UuZ2V0U2NvcGUoc2NvcGUpXG4gIGNvbnN0IFNjb3BlQ29udGV4dCA9IHNjb3BlSW5zdGFuY2UuZ2V0Q29udGV4dCgpXG5cbiAgcy5tZXRhLnNjb3BlID0gc2NvcGVcbiAgcy5tZXRhLnNjb3BlTmFtZSA9IHNjb3BlTmFtZVxuXG4gIGNvbnN0IGxvYWRDdXJyZW50VXNlckZyb21SZXF1ZXN0ID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHtzY29wZX0gPSBzLm1cbiAgICBjb25zdCBnZXRBcmdzTWV0aG9kTmFtZSA9IGBnZXQke2luZmxlY3Rpb24uY2FtZWxpemUoc2NvcGUpfUFyZ3NgXG4gICAgY29uc3QgYXJncyA9IERldmlzZVtnZXRBcmdzTWV0aG9kTmFtZV0oKVxuXG4gICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBMb2FkaW5nICR7c2NvcGV9IHdpdGggcmVxdWVzdGApXG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTZXJ2aWNlcy5jdXJyZW50KCkuc2VuZFJlcXVlc3QoXCJEZXZpc2U6OkN1cnJlbnRcIiwge3F1ZXJ5OiBhcmdzLnF1ZXJ5LCBzY29wZX0pXG4gICAgY29uc3QgY3VycmVudCA9IGRpZ2cocmVzdWx0LCBcImN1cnJlbnRcIilbMF1cblxuICAgIGlmIChjdXJyZW50KSBEZXZpc2UudXBkYXRlU2Vzc2lvbihjdXJyZW50KVxuXG4gICAgcy5zZXQoe1xuICAgICAgcmVzdWx0OiB7XG4gICAgICAgIGxvYWRlZDogdHJ1ZSxcbiAgICAgICAgbW9kZWw6IGN1cnJlbnRcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgZXZlbnRzLmVtaXQoXCJjdXJyZW50VXNlckxvYWRlZFwiLCB7Y3VycmVudH0pXG4gIH0sIFtdKVxuXG4gIGNvbnN0IGRlZmF1bHRDdXJyZW50VXNlciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCB7c2NvcGUsIHNjb3BlTmFtZX0gPSBzLm1cbiAgICBsZXQgY3VycmVudFxuXG4gICAgaWYgKERldmlzZS5jdXJyZW50KCkuaGFzQ3VycmVudFNjb3BlKHMubS5zY29wZSkpIHtcbiAgICAgIGN1cnJlbnQgPSBEZXZpc2UuY3VycmVudCgpLmdldEN1cnJlbnRTY29wZShzY29wZSlcblxuICAgICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBTZXR0aW5nICR7c2NvcGV9IGZyb20gY3VycmVudCBzY29wZTogJHtjdXJyZW50Py5pZCgpfWApXG4gICAgfSBlbHNlIGlmIChEZXZpc2UuY3VycmVudCgpLmhhc0dsb2JhbEN1cnJlbnRTY29wZShzY29wZSkpIHtcbiAgICAgIGN1cnJlbnQgPSBEZXZpc2Vbc2NvcGVOYW1lXSgpXG5cbiAgICAgIGxvZ2dlci5kZWJ1ZygoKSA9PiBgU2V0dGluZyAke3Njb3BlfSBmcm9tIGdsb2JhbCBjdXJyZW50IHNjb3BlOiAke2N1cnJlbnQ/LmlkKCl9YClcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudCkge1xuICAgICAgZXZlbnRzLmVtaXQoXCJjdXJyZW50VXNlckxvYWRlZFwiLCB7Y3VycmVudH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRcbiAgfSwgW10pXG5cbiAgcy51c2VTdGF0ZXMoe1xuICAgIHJlc3VsdDogKCkgPT4gKHtcbiAgICAgIGxvYWRlZDogZmFsc2UsXG4gICAgICBtb2RlbDogZGVmYXVsdEN1cnJlbnRVc2VyKClcbiAgICB9KVxuICB9KVxuXG4gIGNvbnN0IHVwZGF0ZUN1cnJlbnRVc2VyID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHMuc2V0KHtcbiAgICAgIHJlc3VsdDoge1xuICAgICAgICBsb2FkZWQ6IHRydWUsXG4gICAgICAgIG1vZGVsOiBEZXZpc2Vbcy5tLnNjb3BlTmFtZV0oKVxuICAgICAgfVxuICAgIH0pXG4gIH0sIFtdKVxuXG4gIHVzZU1lbW8oKCkgPT4ge1xuICAgIGlmICghRGV2aXNlLmN1cnJlbnQoKS5oYXNHbG9iYWxDdXJyZW50U2NvcGUocy5tLnNjb3BlKSAmJiAhRGV2aXNlLmN1cnJlbnQoKS5oYXNDdXJyZW50U2NvcGUocy5tLnNjb3BlKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBEZXZpc2UgaGFzbid0IGdvdCBjdXJyZW50IHNjb3BlICR7cy5tLnNjb3BlfSBzbyBsb2FkaW5nIGZyb20gcmVxdWVzdGApXG4gICAgICBsb2FkQ3VycmVudFVzZXJGcm9tUmVxdWVzdCgpXG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCBvbkRldmlzZVNpZ25JbiA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICB1cGRhdGVDdXJyZW50VXNlcigpXG4gIH0sIFtdKVxuXG4gIGNvbnN0IG9uRGV2aXNlU2lnbk91dCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICB1cGRhdGVDdXJyZW50VXNlcigpXG4gIH0sIFtdKVxuXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduSW5cIiwgb25EZXZpc2VTaWduSW4pXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduT3V0XCIsIG9uRGV2aXNlU2lnbk91dClcblxuICByZXR1cm4gKFxuICAgIDxTY29wZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3Mucy5yZXN1bHR9PlxuICAgICAge2NoaWxkcmVufVxuICAgIDwvU2NvcGVDb250ZXh0LlByb3ZpZGVyPlxuICApXG59XG5cbmV4cG9ydCBkZWZhdWx0IFVzZUN1cnJlbnRVc2VyQ29udGV4dFxuIl19