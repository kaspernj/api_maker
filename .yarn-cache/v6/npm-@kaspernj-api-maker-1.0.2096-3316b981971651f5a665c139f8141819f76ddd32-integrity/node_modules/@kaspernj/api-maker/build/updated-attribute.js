/* eslint-disable sort-imports */
import { digg } from "diggerize";
import ModelEvents from "./model-events.js";
import PropTypes from "prop-types";
import propTypesExact from "prop-types-exact";
import React from "react";
export default class ApiMakerUpdatedAttribute extends React.PureComponent {
    static propTypes = propTypesExact({
        attribute: PropTypes.string,
        model: PropTypes.object.isRequired,
        onValue: PropTypes.func
    });
    constructor(props) {
        super(props);
        this.state = {
            model: this.props.model
        };
    }
    componentDidMount() {
        this.setAttribute();
        this.connect();
    }
    componentWillUnmount() {
        // Apparently 'componentWillUnmount' can be called without 'componentDidMount' was called. Several bug reports on this.
        if (this.connectUpdated) {
            this.connectUpdated.unsubscribe();
        }
    }
    connect() {
        this.connectUpdated = ModelEvents.connectUpdated(this.props.model, (args) => {
            if (!this.props.attribute || args.model.isAttributeLoaded(this.props.attribute)) {
                this.setState({ model: args.model }, () => this.setAttribute());
            }
            else {
                this.loadModelWithAttribute();
            }
        });
    }
    // This loads the model from the backend with the primary key and the attribute and calls setAttribute
    async loadModelWithAttribute() {
        const id = this.props.model.primaryKey();
        const modelClass = this.props.model.modelClass();
        const modelName = digg(modelClass.modelClassData(), "name");
        const primaryKey = digg(modelClass.modelClassData(), "primaryKey");
        const args = {};
        args[`${primaryKey}_eq`] = id;
        const select = {};
        select[modelName] = [primaryKey, this.props.attribute];
        const model = await modelClass
            .ransack(args)
            .select(select)
            .first();
        this.setState({ model }, () => this.setAttribute());
    }
    setAttribute() {
        let newValue;
        if (this.props.onValue) {
            newValue = this.props.onValue.apply(null, [{ model: this.state.model }]);
        }
        else {
            if (!this.state.model[this.props.attribute]) {
                throw new Error(`No such method: ${digg(this.state.model.modelClassData(), "name")}#${this.props.attribute}()`);
            }
            newValue = this.state.model[this.props.attribute].apply(this.state.model);
        }
        this.setState({
            value: newValue
        });
    }
    render() {
        if (this.state.value === undefined)
            return null;
        return this.state.value;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlZC1hdHRyaWJ1dGUuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInVwZGF0ZWQtYXR0cmlidXRlLmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxpQ0FBaUM7QUFDakMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUM5QixPQUFPLFdBQVcsTUFBTSxtQkFBbUIsQ0FBQTtBQUMzQyxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUE7QUFDbEMsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUE7QUFDN0MsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBRXpCLE1BQU0sQ0FBQyxPQUFPLE9BQU8sd0JBQXlCLFNBQVEsS0FBSyxDQUFDLGFBQWE7SUFDdkUsTUFBTSxDQUFDLFNBQVMsR0FBRyxjQUFjLENBQUM7UUFDaEMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxNQUFNO1FBQzNCLEtBQUssRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7UUFDbEMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxJQUFJO0tBQ3hCLENBQUMsQ0FBQTtJQUVGLFlBQWEsS0FBSztRQUNoQixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDWixJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSztTQUN4QixDQUFBO0lBQ0gsQ0FBQztJQUVELGlCQUFpQjtRQUNmLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUNuQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDaEIsQ0FBQztJQUVELG9CQUFvQjtRQUNsQix1SEFBdUg7UUFDdkgsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUNuQyxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQyxjQUFj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QyxLQUFLLEtBQUssU0FBUztZQUFFLE9BQU8sSUFBSSxDQUFBO1FBRS9DLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUE7SUFDekIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHNvcnQtaW1wb3J0cyAqL1xuaW1wb3J0IHtkaWdnfSBmcm9tIFwiZGlnZ2VyaXplXCJcbmltcG9ydCBNb2RlbEV2ZW50cyBmcm9tIFwiLi9tb2RlbC1ldmVudHMuanNcIlxuaW1wb3J0IFByb3BUeXBlcyBmcm9tIFwicHJvcC10eXBlc1wiXG5pbXBvcnQgcHJvcFR5cGVzRXhhY3QgZnJvbSBcInByb3AtdHlwZXMtZXhhY3RcIlxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwaU1ha2VyVXBkYXRlZEF0dHJpYnV0ZSBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0gcHJvcFR5cGVzRXhhY3Qoe1xuICAgIGF0dHJpYnV0ZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBtb2RlbDogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIG9uVmFsdWU6IFByb3BUeXBlcy5mdW5jXG4gIH0pXG5cbiAgY29uc3RydWN0b3IgKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIG1vZGVsOiB0aGlzLnByb3BzLm1vZGVsXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQgKCkge1xuICAgIHRoaXMuc2V0QXR0cmlidXRlKClcbiAgICB0aGlzLmNvbm5lY3QoKVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQgKCkge1xuICAgIC8vIEFwcGFyZW50bHkgJ2NvbXBvbmVudFdpbGxVbm1vdW50JyBjYW4gYmUgY2FsbGVkIHdpdGhvdXQgJ2NvbXBvbmVudERpZE1vdW50JyB3YXMgY2FsbGVkLiBTZXZlcmFsIGJ1ZyByZXBvcnRzIG9uIHRoaXMuXG4gICAgaWYgKHRoaXMuY29ubmVjdFVwZGF0ZWQpIHtcbiAgICAgIHRoaXMuY29ubmVjdFVwZGF0ZWQudW5zdWJzY3JpYmUoKVxuICAgIH1cbiAgfVxuXG4gIGNvbm5lY3QgKCkge1xuICAgIHRoaXMuY29ubmVjdFVwZGF0ZWQgPSBNb2RlbEV2ZW50cy5jb25uZWN0VXBkYXRlZCh0aGlzLnByb3BzLm1vZGVsLCAoYXJncykgPT4ge1xuICAgICAgaWYgKCF0aGlzLnByb3BzLmF0dHJpYnV0ZSB8fCBhcmdzLm1vZGVsLmlzQXR0cmlidXRlTG9hZGVkKHRoaXMucHJvcHMuYXR0cmlidXRlKSkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKFxuICAgICAgICAgIHttb2RlbDogYXJncy5tb2RlbH0sXG4gICAgICAgICAgKCkgPT4gdGhpcy5zZXRBdHRyaWJ1dGUoKVxuICAgICAgICApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvYWRNb2RlbFdpdGhBdHRyaWJ1dGUoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBUaGlzIGxvYWRzIHRoZSBtb2RlbCBmcm9tIHRoZSBiYWNrZW5kIHdpdGggdGhlIHByaW1hcnkga2V5IGFuZCB0aGUgYXR0cmlidXRlIGFuZCBjYWxscyBzZXRBdHRyaWJ1dGVcbiAgYXN5bmMgbG9hZE1vZGVsV2l0aEF0dHJpYnV0ZSAoKSB7XG4gICAgY29uc3QgaWQgPSB0aGlzLnByb3BzLm1vZGVsLnByaW1hcnlLZXkoKVxuICAgIGNvbnN0IG1vZGVsQ2xhc3MgPSB0aGlzLnByb3BzLm1vZGVsLm1vZGVsQ2xhc3MoKVxuICAgIGNvbnN0IG1vZGVsTmFtZSA9IGRpZ2cobW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLCBcIm5hbWVcIilcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gZGlnZyhtb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCksIFwicHJpbWFyeUtleVwiKVxuXG4gICAgY29uc3QgYXJncyA9IHt9XG4gICAgYXJnc1tgJHtwcmltYXJ5S2V5fV9lcWBdID0gaWRcblxuICAgIGNvbnN0IHNlbGVjdCA9IHt9XG4gICAgc2VsZWN0W21vZGVsTmFtZV0gPSBbcHJpbWFyeUtleSwgdGhpcy5wcm9wcy5hdHRyaWJ1dGVdXG5cbiAgICBjb25zdCBtb2RlbCA9IGF3YWl0IG1vZGVsQ2xhc3NcbiAgICAgIC5yYW5zYWNrKGFyZ3MpXG4gICAgICAuc2VsZWN0KHNlbGVjdClcbiAgICAgIC5maXJzdCgpXG5cbiAgICB0aGlzLnNldFN0YXRlKFxuICAgICAge21vZGVsfSxcbiAgICAgICgpID0+IHRoaXMuc2V0QXR0cmlidXRlKClcbiAgICApXG4gIH1cblxuICBzZXRBdHRyaWJ1dGUgKCkge1xuICAgIGxldCBuZXdWYWx1ZVxuXG4gICAgaWYgKHRoaXMucHJvcHMub25WYWx1ZSkge1xuICAgICAgbmV3VmFsdWUgPSB0aGlzLnByb3BzLm9uVmFsdWUuYXBwbHkobnVsbCwgW3ttb2RlbDogdGhpcy5zdGF0ZS5tb2RlbH1dKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMuc3RhdGUubW9kZWxbdGhpcy5wcm9wcy5hdHRyaWJ1dGVdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc3VjaCBtZXRob2Q6ICR7ZGlnZyh0aGlzLnN0YXRlLm1vZGVsLm1vZGVsQ2xhc3NEYXRhKCksIFwibmFtZVwiKX0jJHt0aGlzLnByb3BzLmF0dHJpYnV0ZX0oKWApXG4gICAgICB9XG5cbiAgICAgIG5ld1ZhbHVlID0gdGhpcy5zdGF0ZS5tb2RlbFt0aGlzLnByb3BzLmF0dHJpYnV0ZV0uYXBwbHkodGhpcy5zdGF0ZS5tb2RlbClcbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHZhbHVlOiBuZXdWYWx1ZVxuICAgIH0pXG4gIH1cblxuICByZW5kZXIgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlLnZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsXG5cbiAgICByZXR1cm4gdGhpcy5zdGF0ZS52YWx1ZVxuICB9XG59XG4iXX0=