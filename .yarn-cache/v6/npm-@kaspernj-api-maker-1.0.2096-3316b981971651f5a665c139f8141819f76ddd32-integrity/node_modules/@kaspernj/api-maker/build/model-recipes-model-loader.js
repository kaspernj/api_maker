import * as inflection from "inflection";
import { digg, digs } from "diggerize";
import BaseModel from "./base-model.js";
import Collection from "./collection.js";
export default class ApiMakerModelRecipesModelLoader {
    constructor({ modelRecipe, modelRecipesLoader }) {
        if (!modelRecipe)
            throw new Error("No 'modelRecipe' was given");
        this.modelRecipesLoader = modelRecipesLoader;
        this.modelRecipe = modelRecipe;
    }
    createClass() {
        const { modelRecipe } = digs(this, "modelRecipe");
        const { attributes, collection_commands: collectionCommands, member_commands: memberCommands, model_class_data: modelClassData, relationships } = digs(modelRecipe, "attributes", "collection_commands", "member_commands", "model_class_data", "relationships");
        const { name: modelClassName } = digs(modelClassData, "name");
        const ModelClass = class ApiMakerModel extends BaseModel {
        };
        Object.defineProperty(ModelClass, "name", { writable: false, value: modelClassName });
        ModelClass.prototype.constructor.modelClassData = () => modelClassData;
        this.addAttributeMethodsToModelClass(ModelClass, attributes);
        this.addRelationshipsToModelClass(ModelClass, modelClassData, relationships);
        this.addQueryCommandsToModelClass(ModelClass, collectionCommands);
        this.addMemberCommandsToModelClass(ModelClass, memberCommands);
        return ModelClass;
    }
    addAttributeMethodsToModelClass(ModelClass, attributes) {
        for (const attributeName in attributes) {
            const attribute = attributes[attributeName];
            const { name } = digs(attribute, "name");
            const methodName = inflection.camelize(name, true);
            const hasMethodName = inflection.camelize(`has_${name}`, true);
            ModelClass.prototype[methodName] = function () {
                return this.readAttributeUnderscore(attributeName);
            };
            ModelClass.prototype[hasMethodName] = function () {
                const value = this[methodName]();
                return this._isPresent(value);
            };
        }
    }
    addQueryCommandsToModelClass(ModelClass, collectionCommands) {
        for (const collectionCommandName in collectionCommands) {
            const methodName = inflection.camelize(collectionCommandName, true);
            ModelClass[methodName] = function (args, commandArgs = {}) {
                return this._callCollectionCommand({
                    args,
                    command: collectionCommandName,
                    collectionName: digg(this.modelClassData(), "collectionName"),
                    type: "collection"
                }, commandArgs);
            };
        }
    }
    addMemberCommandsToModelClass(ModelClass, memberCommands) {
        for (const memberCommandName in memberCommands) {
            const methodName = inflection.camelize(memberCommandName, true);
            ModelClass.prototype[methodName] = function (args, commandArgs = {}) {
                return this._callMemberCommand({
                    args,
                    command: memberCommandName,
                    primaryKey: this.primaryKey(),
                    collectionName: this.modelClassData().collectionName,
                    type: "member"
                }, commandArgs);
            };
        }
    }
    addRelationshipsToModelClass(ModelClass, modelClassData, relationships) {
        const { modelRecipesLoader } = digs(this, "modelRecipesLoader");
        for (const relationshipName in relationships) {
            const relationship = relationships[relationshipName];
            const { active_record: { name: activeRecordName, primary_key: activeRecordPrimaryKey }, class_name: className, foreign_key: foreignKey, klass: { primary_key: klassPrimaryKey }, options: { as: optionsAs, primary_key: optionsPrimaryKey, through: optionsThrough }, resource_name: resourceName, type } = digs(relationship, "active_record", "class_name", "foreign_key", "klass", "options", "resource_name", "type");
            const loadMethodName = inflection.camelize(`load_${relationshipName}`, true);
            const modelMethodName = inflection.camelize(relationshipName, true);
            if (type == "belongs_to") {
                this.defineBelongsToGetMethod({ ModelClass, modelMethodName, relationshipName });
                this.defineBelongsToLoadMethod({
                    foreignKey,
                    klassPrimaryKey,
                    loadMethodName,
                    ModelClass,
                    modelRecipesLoader,
                    optionsPrimaryKey,
                    relationshipName,
                    resourceName
                });
            }
            else if (type == "has_many") {
                this.defineHasManyGetMethod({
                    activeRecordName,
                    className,
                    foreignKey,
                    ModelClass,
                    modelMethodName,
                    modelRecipesLoader,
                    optionsAs,
                    optionsPrimaryKey,
                    optionsThrough,
                    relationshipName,
                    resourceName
                });
                this.defineHasManyLoadMethod({ foreignKey, loadMethodName, ModelClass, modelClassData, modelRecipesLoader, relationshipName, resourceName });
            }
            else if (type == "has_one") {
                this.defineHasOneGetMethd({ ModelClass, modelMethodName, relationshipName });
                this.defineHasOneLoadMethod({
                    activeRecordPrimaryKey,
                    foreignKey,
                    loadMethodName,
                    ModelClass,
                    modelClassData,
                    modelRecipesLoader,
                    optionsThrough,
                    relationshipName,
                    resourceName
                });
            }
            else {
                throw new Error(`Unknown relationship type: ${type}`);
            }
        }
    }
    defineBelongsToGetMethod({ ModelClass, modelMethodName, relationshipName }) {
        ModelClass.prototype[modelMethodName] = function () {
            return this._readBelongsToReflection({ reflectionName: relationshipName });
        };
    }
    defineBelongsToLoadMethod({ foreignKey, klassPrimaryKey, ModelClass, modelRecipesLoader, loadMethodName, optionsPrimaryKey, relationshipName, resourceName }) {
        ModelClass.prototype[loadMethodName] = function () {
            const foreignKeyMethodName = inflection.camelize(foreignKey, true);
            if (!(foreignKeyMethodName in this))
                throw new Error(`Foreign key method wasn't defined: ${foreignKeyMethodName}`);
            const id = this[foreignKeyMethodName]();
            const modelClass = modelRecipesLoader.getModelClass(resourceName);
            const ransack = {};
            const ransackIdSearchKey = `${optionsPrimaryKey || klassPrimaryKey}_eq`;
            ransack[ransackIdSearchKey] = id;
            return this._loadBelongsToReflection({ reflectionName: relationshipName, model: this, modelClass }, { ransack });
        };
    }
    defineHasManyGetMethod({ activeRecordName, className, foreignKey, ModelClass, modelMethodName, modelRecipesLoader, optionsAs, optionsPrimaryKey, optionsThrough, relationshipName, resourceName }) {
        ModelClass.prototype[modelMethodName] = function () {
            const id = this.primaryKey();
            const modelClass = modelRecipesLoader.getModelClass(resourceName);
            const ransack = {};
            ransack[`${foreignKey}_eq`] = id;
            const hasManyParameters = {
                reflectionName: relationshipName,
                model: this,
                modelName: className,
                modelClass
            };
            let queryParameters;
            if (optionsThrough) {
                queryParameters = {
                    params: {
                        through: {
                            model: activeRecordName,
                            id: this.primaryKey(),
                            reflection: relationshipName
                        }
                    }
                };
            }
            else {
                const ransack = {};
                const primaryKeyColumnName = optionsPrimaryKey || digg(ModelClass.modelClassData(), "primaryKey");
                const primaryKeyMethodName = inflection.camelize(primaryKeyColumnName, true);
                if (!(primaryKeyMethodName in this))
                    throw new Error(`No such primary key method: ${primaryKeyMethodName}`);
                ransack[`${foreignKey}_eq`] = this[primaryKeyMethodName]();
                if (optionsAs) {
                    ransack[`${optionsAs}_type_eq`] = activeRecordName;
                }
                queryParameters = { ransack };
            }
            return new Collection(hasManyParameters, queryParameters);
        };
    }
    defineHasManyLoadMethod({ foreignKey, loadMethodName, ModelClass, modelClassData, modelRecipesLoader, optionsThrough, relationshipName, resourceName }) {
        ModelClass.prototype[loadMethodName] = function () {
            const id = this.primaryKey();
            const modelClass = modelRecipesLoader.getModelClass(resourceName);
            if (optionsThrough) {
                const modelClassName = digg(modelClassData, "className");
                return this._loadHasManyReflection({
                    reflectionName: relationshipName,
                    model: this,
                    modelClass
                }, {
                    params: {
                        through: {
                            model: modelClassName,
                            id,
                            reflection: relationshipName
                        }
                    }
                });
            }
            else {
                const ransack = {};
                ransack[`${foreignKey}_eq`] = id;
                return this._loadHasManyReflection({
                    reflectionName: relationshipName,
                    model: this,
                    modelClass
                }, { ransack });
            }
        };
    }
    defineHasOneGetMethd({ ModelClass, modelMethodName, relationshipName }) {
        ModelClass.prototype[modelMethodName] = function () {
            return this._readHasOneReflection({ reflectionName: relationshipName });
        };
    }
    defineHasOneLoadMethod({ activeRecordPrimaryKey, foreignKey, loadMethodName, ModelClass, modelClassData, modelRecipesLoader, optionsThrough, relationshipName, resourceName }) {
        ModelClass.prototype[loadMethodName] = function () {
            const primaryKeyMethodName = inflection.camelize(activeRecordPrimaryKey, true);
            if (!(primaryKeyMethodName in this))
                throw new Error(`Primary key method wasn't defined: ${primaryKeyMethodName}`);
            const id = this[primaryKeyMethodName]();
            const modelClass = modelRecipesLoader.getModelClass(resourceName);
            if (optionsThrough) {
                const modelClassName = digg(modelClassData, "className");
                return this._loadHasOneReflection({ reflectionName: relationshipName, model: this, modelClass }, { params: { through: { model: modelClassName, id, reflection: relationshipName } } });
            }
            else {
                const ransack = {};
                ransack[`${foreignKey}_eq`] = id;
                return this._loadHasOneReflection({
                    reflectionName: relationshipName,
                    model: this,
                    modelClass
                }, { ransack });
            }
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwtcmVjaXBlcy1tb2RlbC1sb2FkZXIuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbIm1vZGVsLXJlY2lwZXMtbW9kZWwtbG9hZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8sRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQ3BDLE9BQU8sU0FBUyxNQUFNLGlCQUFpQixDQUFBO0FBQ3ZDLE9BQU8sVUFBVSxNQUFNLGlCQUFpQixDQUFBO0FBRXhDLE1BQU0sQ0FBQyxPQUFPLE9BQU8sK0JBQStCO0lBQ2xELFlBQWEsRUFBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUM7UUFDNUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUE7UUFFL0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFBO1FBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFBO0lBQ2hDLENBQUM7SUFFRCxXQUFXO1FBQ1QsTUFBTSxFQUFDLFdBQVcsRUFBQyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUE7UUFDL0MsTUFBTSxFQUNKLFVBQVUsRUFDVixtQkFBbUIsRUFBRSxrQkFBa0IsRUFDdkMsZUFBZSxFQUFFLGNBQWMsRUFDL0IsZ0JBQWdCLEVBQUUsY0FBYyxFQUNoQyxhQUFhLEVBQ2QsR0FBRyxJQUFJLENBQ04sV0FBVyxFQUNYLFlBQVksRUFDWixxQkFBcUIsRUFDckIsaUJBQWlCLEVBQ2pCLGtCQUFrQixFQUNsQixlQUFlLENBQ2hCLENBQUE7UUFDRCxNQUFNLEVBQUMsSUFBSSxFQUFFLGNBQWMsRUFBQyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDM0QsTUFBTSxVQUFVLEdBQUcsTUFBTSxhQUFjLFNBQVEsU0FBUztT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Q3ZDLE1BQU0sVUFBVSxHQUFHLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUVqRSxJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUNuQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxDQUFBO2dCQUV4RCxPQUFPLElBQUksQ0FBQyxxQkFBcUIsQ0FDL0IsRUFBQyxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUMsRUFDM0QsRUFBQyxNQUFNLEVBQUUsRUFBQyxPQUFPLEVBQUUsRUFBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUMsRUFBQyxFQUFDLENBQy9FLENBQUE7WUFDSCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO2dCQUVsQixPQUFPLENBQUMsR0FBRyxVQUFVLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQTtnQkFFaEMsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQy9CO29CQUNFLGNBQWMsRUFBRSxnQkFBZ0I7b0JBQ2hDLEtBQUssRUFBRSxJQUFJO29CQUNYLFVBQVU7aUJBQ1gsRUFDRCxFQUFDLE9BQU8sRUFBQyxDQUNWLENBQUE7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgaW5mbGVjdGlvbiBmcm9tIFwiaW5mbGVjdGlvblwiXG5pbXBvcnQge2RpZ2csIGRpZ3N9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IEJhc2VNb2RlbCBmcm9tIFwiLi9iYXNlLW1vZGVsLmpzXCJcbmltcG9ydCBDb2xsZWN0aW9uIGZyb20gXCIuL2NvbGxlY3Rpb24uanNcIlxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcGlNYWtlck1vZGVsUmVjaXBlc01vZGVsTG9hZGVyIHtcbiAgY29uc3RydWN0b3IgKHttb2RlbFJlY2lwZSwgbW9kZWxSZWNpcGVzTG9hZGVyfSkge1xuICAgIGlmICghbW9kZWxSZWNpcGUpIHRocm93IG5ldyBFcnJvcihcIk5vICdtb2RlbFJlY2lwZScgd2FzIGdpdmVuXCIpXG5cbiAgICB0aGlzLm1vZGVsUmVjaXBlc0xvYWRlciA9IG1vZGVsUmVjaXBlc0xvYWRlclxuICAgIHRoaXMubW9kZWxSZWNpcGUgPSBtb2RlbFJlY2lwZVxuICB9XG5cbiAgY3JlYXRlQ2xhc3MgKCkge1xuICAgIGNvbnN0IHttb2RlbFJlY2lwZX0gPSBkaWdzKHRoaXMsIFwibW9kZWxSZWNpcGVcIilcbiAgICBjb25zdCB7XG4gICAgICBhdHRyaWJ1dGVzLFxuICAgICAgY29sbGVjdGlvbl9jb21tYW5kczogY29sbGVjdGlvbkNvbW1hbmRzLFxuICAgICAgbWVtYmVyX2NvbW1hbmRzOiBtZW1iZXJDb21tYW5kcyxcbiAgICAgIG1vZGVsX2NsYXNzX2RhdGE6IG1vZGVsQ2xhc3NEYXRhLFxuICAgICAgcmVsYXRpb25zaGlwc1xuICAgIH0gPSBkaWdzKFxuICAgICAgbW9kZWxSZWNpcGUsXG4gICAgICBcImF0dHJpYnV0ZXNcIixcbiAgICAgIFwiY29sbGVjdGlvbl9jb21tYW5kc1wiLFxuICAgICAgXCJtZW1iZXJfY29tbWFuZHNcIixcbiAgICAgIFwibW9kZWxfY2xhc3NfZGF0YVwiLFxuICAgICAgXCJyZWxhdGlvbnNoaXBzXCJcbiAgICApXG4gICAgY29uc3Qge25hbWU6IG1vZGVsQ2xhc3NOYW1lfSA9IGRpZ3MobW9kZWxDbGFzc0RhdGEsIFwibmFtZVwiKVxuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSBjbGFzcyBBcGlNYWtlck1vZGVsIGV4dGVuZHMgQmFzZU1vZGVsIHsgfVxuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1vZGVsQ2xhc3MsIFwibmFtZVwiLCB7d3JpdGFibGU6IGZhbHNlLCB2YWx1ZTogbW9kZWxDbGFzc05hbWV9KVxuXG4gICAgTW9kZWxDbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IubW9kZWxDbGFzc0RhdGEgPSAoKSA9PiBtb2RlbENsYXNzRGF0YVxuXG4gICAgdGhpcy5hZGRBdHRyaWJ1dGVNZXRob2RzVG9Nb2RlbENsYXNzKE1vZGVsQ2xhc3MsIGF0dHJpYnV0ZXMpXG4gICAgdGhpcy5hZGRSZWxhdGlvbnNoaXBzVG9Nb2RlbENsYXNzKE1vZGVsQ2xhc3MsIG1vZGVsQ2xhc3NEYXRhLCByZWxhdGlvbnNoaXBzKVxuICAgIHRoaXMuYWRkUXVlcnlDb21tYW5kc1RvTW9kZWxDbGFzcyhNb2RlbENsYXNzLCBjb2xsZWN0aW9uQ29tbWFuZHMpXG4gICAgdGhpcy5hZGRNZW1iZXJDb21tYW5kc1RvTW9kZWxDbGFzcyhNb2RlbENsYXNzLCBtZW1iZXJDb21tYW5kcylcblxuICAgIHJldHVybiBNb2RlbENsYXNzXG4gIH1cblxuICBhZGRBdHRyaWJ1dGVNZXRob2RzVG9Nb2RlbENsYXNzIChNb2RlbENsYXNzLCBhdHRyaWJ1dGVzKSB7XG4gICAgZm9yIChjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV1cbiAgICAgIGNvbnN0IHtuYW1lfSA9IGRpZ3MoYXR0cmlidXRlLCBcIm5hbWVcIilcbiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBpbmZsZWN0aW9uLmNhbWVsaXplKG5hbWUsIHRydWUpXG4gICAgICBjb25zdCBoYXNNZXRob2ROYW1lID0gaW5mbGVjdGlvbi5jYW1lbGl6ZShgaGFzXyR7bmFtZX1gLCB0cnVlKVxuXG4gICAgICBNb2RlbENsYXNzLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVhZEF0dHJpYnV0ZVVuZGVyc2NvcmUoYXR0cmlidXRlTmFtZSlcbiAgICAgIH1cblxuICAgICAgTW9kZWxDbGFzcy5wcm90b3R5cGVbaGFzTWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpc1ttZXRob2ROYW1lXSgpXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzUHJlc2VudCh2YWx1ZSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhZGRRdWVyeUNvbW1hbmRzVG9Nb2RlbENsYXNzIChNb2RlbENsYXNzLCBjb2xsZWN0aW9uQ29tbWFuZHMpIHtcbiAgICBmb3IgKGNvbnN0IGNvbGxlY3Rpb25Db21tYW5kTmFtZSBpbiBjb2xsZWN0aW9uQ29tbWFuZHMpIHtcbiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBpbmZsZWN0aW9uLmNhbWVsaXplKGNvbGxlY3Rpb25Db21tYW5kTmFtZSwgdHJ1ZSlcblxuICAgICAgTW9kZWxDbGFzc1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uIChhcmdzLCBjb21tYW5kQXJncyA9IHt9KSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jYWxsQ29sbGVjdGlvbkNvbW1hbmQoXG4gICAgICAgICAge1xuICAgICAgICAgICAgYXJncyxcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbGxlY3Rpb25Db21tYW5kTmFtZSxcbiAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lOiBkaWdnKHRoaXMubW9kZWxDbGFzc0RhdGEoKSwgXCJjb2xsZWN0aW9uTmFtZVwiKSxcbiAgICAgICAgICAgIHR5cGU6IFwiY29sbGVjdGlvblwiXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb21tYW5kQXJnc1xuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYWRkTWVtYmVyQ29tbWFuZHNUb01vZGVsQ2xhc3MgKE1vZGVsQ2xhc3MsIG1lbWJlckNvbW1hbmRzKSB7XG4gICAgZm9yIChjb25zdCBtZW1iZXJDb21tYW5kTmFtZSBpbiBtZW1iZXJDb21tYW5kcykge1xuICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IGluZmxlY3Rpb24uY2FtZWxpemUobWVtYmVyQ29tbWFuZE5hbWUsIHRydWUpXG5cbiAgICAgIE1vZGVsQ2xhc3MucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKGFyZ3MsIGNvbW1hbmRBcmdzID0ge30pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbGxNZW1iZXJDb21tYW5kKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGFyZ3MsXG4gICAgICAgICAgICBjb21tYW5kOiBtZW1iZXJDb21tYW5kTmFtZSxcbiAgICAgICAgICAgIHByaW1hcnlLZXk6IHRoaXMucHJpbWFyeUtleSgpLFxuICAgICAgICAgICAgY29sbGVjdGlvbk5hbWU6IHRoaXMubW9kZWxDbGFzc0RhdGEoKS5jb2xsZWN0aW9uTmFtZSxcbiAgICAgICAgICAgIHR5cGU6IFwibWVtYmVyXCJcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbW1hbmRBcmdzXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhZGRSZWxhdGlvbnNoaXBzVG9Nb2RlbENsYXNzIChNb2RlbENsYXNzLCBtb2RlbENsYXNzRGF0YSwgcmVsYXRpb25zaGlwcykge1xuICAgIGNvbnN0IHttb2RlbFJlY2lwZXNMb2FkZXJ9ID0gZGlncyh0aGlzLCBcIm1vZGVsUmVjaXBlc0xvYWRlclwiKVxuXG4gICAgZm9yIChjb25zdCByZWxhdGlvbnNoaXBOYW1lIGluIHJlbGF0aW9uc2hpcHMpIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwTmFtZV1cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgYWN0aXZlX3JlY29yZDoge1xuICAgICAgICAgIG5hbWU6IGFjdGl2ZVJlY29yZE5hbWUsXG4gICAgICAgICAgcHJpbWFyeV9rZXk6IGFjdGl2ZVJlY29yZFByaW1hcnlLZXlcbiAgICAgICAgfSxcbiAgICAgICAgY2xhc3NfbmFtZTogY2xhc3NOYW1lLFxuICAgICAgICBmb3JlaWduX2tleTogZm9yZWlnbktleSxcbiAgICAgICAga2xhc3M6IHtwcmltYXJ5X2tleToga2xhc3NQcmltYXJ5S2V5fSxcbiAgICAgICAgb3B0aW9uczoge2FzOiBvcHRpb25zQXMsIHByaW1hcnlfa2V5OiBvcHRpb25zUHJpbWFyeUtleSwgdGhyb3VnaDogb3B0aW9uc1Rocm91Z2h9LFxuICAgICAgICByZXNvdXJjZV9uYW1lOiByZXNvdXJjZU5hbWUsXG4gICAgICAgIHR5cGVcbiAgICAgIH0gPSBkaWdzKFxuICAgICAgICByZWxhdGlvbnNoaXAsXG4gICAgICAgIFwiYWN0aXZlX3JlY29yZFwiLFxuICAgICAgICBcImNsYXNzX25hbWVcIixcbiAgICAgICAgXCJmb3JlaWduX2tleVwiLFxuICAgICAgICBcImtsYXNzXCIsXG4gICAgICAgIFwib3B0aW9uc1wiLFxuICAgICAgICBcInJlc291cmNlX25hbWVcIixcbiAgICAgICAgXCJ0eXBlXCJcbiAgICAgIClcbiAgICAgIGNvbnN0IGxvYWRNZXRob2ROYW1lID0gaW5mbGVjdGlvbi5jYW1lbGl6ZShgbG9hZF8ke3JlbGF0aW9uc2hpcE5hbWV9YCwgdHJ1ZSlcbiAgICAgIGNvbnN0IG1vZGVsTWV0aG9kTmFtZSA9IGluZmxlY3Rpb24uY2FtZWxpemUocmVsYXRpb25zaGlwTmFtZSwgdHJ1ZSlcblxuICAgICAgaWYgKHR5cGUgPT0gXCJiZWxvbmdzX3RvXCIpIHtcbiAgICAgICAgdGhpcy5kZWZpbmVCZWxvbmdzVG9HZXRNZXRob2Qoe01vZGVsQ2xhc3MsIG1vZGVsTWV0aG9kTmFtZSwgcmVsYXRpb25zaGlwTmFtZX0pXG4gICAgICAgIHRoaXMuZGVmaW5lQmVsb25nc1RvTG9hZE1ldGhvZCh7XG4gICAgICAgICAgZm9yZWlnbktleSxcbiAgICAgICAgICBrbGFzc1ByaW1hcnlLZXksXG4gICAgICAgICAgbG9hZE1ldGhvZE5hbWUsXG4gICAgICAgICAgTW9kZWxDbGFzcyxcbiAgICAgICAgICBtb2RlbFJlY2lwZXNMb2FkZXIsXG4gICAgICAgICAgb3B0aW9uc1ByaW1hcnlLZXksXG4gICAgICAgICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgICAgICByZXNvdXJjZU5hbWVcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSBcImhhc19tYW55XCIpIHtcbiAgICAgICAgdGhpcy5kZWZpbmVIYXNNYW55R2V0TWV0aG9kKHtcbiAgICAgICAgICBhY3RpdmVSZWNvcmROYW1lLFxuICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICBmb3JlaWduS2V5LFxuICAgICAgICAgIE1vZGVsQ2xhc3MsXG4gICAgICAgICAgbW9kZWxNZXRob2ROYW1lLFxuICAgICAgICAgIG1vZGVsUmVjaXBlc0xvYWRlcixcbiAgICAgICAgICBvcHRpb25zQXMsXG4gICAgICAgICAgb3B0aW9uc1ByaW1hcnlLZXksXG4gICAgICAgICAgb3B0aW9uc1Rocm91Z2gsXG4gICAgICAgICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgICAgICByZXNvdXJjZU5hbWVcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5kZWZpbmVIYXNNYW55TG9hZE1ldGhvZCh7Zm9yZWlnbktleSwgbG9hZE1ldGhvZE5hbWUsIE1vZGVsQ2xhc3MsIG1vZGVsQ2xhc3NEYXRhLCBtb2RlbFJlY2lwZXNMb2FkZXIsIHJlbGF0aW9uc2hpcE5hbWUsIHJlc291cmNlTmFtZX0pXG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gXCJoYXNfb25lXCIpIHtcbiAgICAgICAgdGhpcy5kZWZpbmVIYXNPbmVHZXRNZXRoZCh7TW9kZWxDbGFzcywgbW9kZWxNZXRob2ROYW1lLCByZWxhdGlvbnNoaXBOYW1lfSlcbiAgICAgICAgdGhpcy5kZWZpbmVIYXNPbmVMb2FkTWV0aG9kKHtcbiAgICAgICAgICBhY3RpdmVSZWNvcmRQcmltYXJ5S2V5LFxuICAgICAgICAgIGZvcmVpZ25LZXksXG4gICAgICAgICAgbG9hZE1ldGhvZE5hbWUsXG4gICAgICAgICAgTW9kZWxDbGFzcyxcbiAgICAgICAgICBtb2RlbENsYXNzRGF0YSxcbiAgICAgICAgICBtb2RlbFJlY2lwZXNMb2FkZXIsXG4gICAgICAgICAgb3B0aW9uc1Rocm91Z2gsXG4gICAgICAgICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgICAgICByZXNvdXJjZU5hbWVcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biByZWxhdGlvbnNoaXAgdHlwZTogJHt0eXBlfWApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZGVmaW5lQmVsb25nc1RvR2V0TWV0aG9kICh7TW9kZWxDbGFzcywgbW9kZWxNZXRob2ROYW1lLCByZWxhdGlvbnNoaXBOYW1lfSkge1xuICAgIE1vZGVsQ2xhc3MucHJvdG90eXBlW21vZGVsTWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fcmVhZEJlbG9uZ3NUb1JlZmxlY3Rpb24oe3JlZmxlY3Rpb25OYW1lOiByZWxhdGlvbnNoaXBOYW1lfSlcbiAgICB9XG4gIH1cblxuICBkZWZpbmVCZWxvbmdzVG9Mb2FkTWV0aG9kICh7Zm9yZWlnbktleSwga2xhc3NQcmltYXJ5S2V5LCBNb2RlbENsYXNzLCBtb2RlbFJlY2lwZXNMb2FkZXIsIGxvYWRNZXRob2ROYW1lLCBvcHRpb25zUHJpbWFyeUtleSwgcmVsYXRpb25zaGlwTmFtZSwgcmVzb3VyY2VOYW1lfSkge1xuICAgIE1vZGVsQ2xhc3MucHJvdG90eXBlW2xvYWRNZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IGZvcmVpZ25LZXlNZXRob2ROYW1lID0gaW5mbGVjdGlvbi5jYW1lbGl6ZShmb3JlaWduS2V5LCB0cnVlKVxuXG4gICAgICBpZiAoIShmb3JlaWduS2V5TWV0aG9kTmFtZSBpbiB0aGlzKSkgdGhyb3cgbmV3IEVycm9yKGBGb3JlaWduIGtleSBtZXRob2Qgd2Fzbid0IGRlZmluZWQ6ICR7Zm9yZWlnbktleU1ldGhvZE5hbWV9YClcblxuICAgICAgY29uc3QgaWQgPSB0aGlzW2ZvcmVpZ25LZXlNZXRob2ROYW1lXSgpXG4gICAgICBjb25zdCBtb2RlbENsYXNzID0gbW9kZWxSZWNpcGVzTG9hZGVyLmdldE1vZGVsQ2xhc3MocmVzb3VyY2VOYW1lKVxuICAgICAgY29uc3QgcmFuc2FjayA9IHt9XG4gICAgICBjb25zdCByYW5zYWNrSWRTZWFyY2hLZXkgPSBgJHtvcHRpb25zUHJpbWFyeUtleSB8fCBrbGFzc1ByaW1hcnlLZXl9X2VxYFxuXG4gICAgICByYW5zYWNrW3JhbnNhY2tJZFNlYXJjaEtleV0gPSBpZFxuXG4gICAgICByZXR1cm4gdGhpcy5fbG9hZEJlbG9uZ3NUb1JlZmxlY3Rpb24oXG4gICAgICAgIHtyZWZsZWN0aW9uTmFtZTogcmVsYXRpb25zaGlwTmFtZSwgbW9kZWw6IHRoaXMsIG1vZGVsQ2xhc3N9LFxuICAgICAgICB7cmFuc2Fja31cbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBkZWZpbmVIYXNNYW55R2V0TWV0aG9kICh7XG4gICAgYWN0aXZlUmVjb3JkTmFtZSxcbiAgICBjbGFzc05hbWUsXG4gICAgZm9yZWlnbktleSxcbiAgICBNb2RlbENsYXNzLFxuICAgIG1vZGVsTWV0aG9kTmFtZSxcbiAgICBtb2RlbFJlY2lwZXNMb2FkZXIsXG4gICAgb3B0aW9uc0FzLFxuICAgIG9wdGlvbnNQcmltYXJ5S2V5LFxuICAgIG9wdGlvbnNUaHJvdWdoLFxuICAgIHJlbGF0aW9uc2hpcE5hbWUsXG4gICAgcmVzb3VyY2VOYW1lXG4gIH0pIHtcbiAgICBNb2RlbENsYXNzLnByb3RvdHlwZVttb2RlbE1ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLnByaW1hcnlLZXkoKVxuICAgICAgY29uc3QgbW9kZWxDbGFzcyA9IG1vZGVsUmVjaXBlc0xvYWRlci5nZXRNb2RlbENsYXNzKHJlc291cmNlTmFtZSlcbiAgICAgIGNvbnN0IHJhbnNhY2sgPSB7fVxuXG4gICAgICByYW5zYWNrW2Ake2ZvcmVpZ25LZXl9X2VxYF0gPSBpZFxuXG4gICAgICBjb25zdCBoYXNNYW55UGFyYW1ldGVycyA9IHtcbiAgICAgICAgcmVmbGVjdGlvbk5hbWU6IHJlbGF0aW9uc2hpcE5hbWUsXG4gICAgICAgIG1vZGVsOiB0aGlzLFxuICAgICAgICBtb2RlbE5hbWU6IGNsYXNzTmFtZSxcbiAgICAgICAgbW9kZWxDbGFzc1xuICAgICAgfVxuXG4gICAgICBsZXQgcXVlcnlQYXJhbWV0ZXJzXG5cbiAgICAgIGlmIChvcHRpb25zVGhyb3VnaCkge1xuICAgICAgICBxdWVyeVBhcmFtZXRlcnMgPSB7XG4gICAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgICB0aHJvdWdoOiB7XG4gICAgICAgICAgICAgIG1vZGVsOiBhY3RpdmVSZWNvcmROYW1lLFxuICAgICAgICAgICAgICBpZDogdGhpcy5wcmltYXJ5S2V5KCksXG4gICAgICAgICAgICAgIHJlZmxlY3Rpb246IHJlbGF0aW9uc2hpcE5hbWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJhbnNhY2sgPSB7fVxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5Q29sdW1uTmFtZSA9IG9wdGlvbnNQcmltYXJ5S2V5IHx8IGRpZ2coTW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLCBcInByaW1hcnlLZXlcIilcbiAgICAgICAgY29uc3QgcHJpbWFyeUtleU1ldGhvZE5hbWUgPSBpbmZsZWN0aW9uLmNhbWVsaXplKHByaW1hcnlLZXlDb2x1bW5OYW1lLCB0cnVlKVxuXG4gICAgICAgIGlmICghKHByaW1hcnlLZXlNZXRob2ROYW1lIGluIHRoaXMpKSB0aHJvdyBuZXcgRXJyb3IoYE5vIHN1Y2ggcHJpbWFyeSBrZXkgbWV0aG9kOiAke3ByaW1hcnlLZXlNZXRob2ROYW1lfWApXG5cbiAgICAgICAgcmFuc2Fja1tgJHtmb3JlaWduS2V5fV9lcWBdID0gdGhpc1twcmltYXJ5S2V5TWV0aG9kTmFtZV0oKVxuXG4gICAgICAgIGlmIChvcHRpb25zQXMpIHtcbiAgICAgICAgICByYW5zYWNrW2Ake29wdGlvbnNBc31fdHlwZV9lcWBdID0gYWN0aXZlUmVjb3JkTmFtZVxuICAgICAgICB9XG5cbiAgICAgICAgcXVlcnlQYXJhbWV0ZXJzID0ge3JhbnNhY2t9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBuZXcgQ29sbGVjdGlvbihoYXNNYW55UGFyYW1ldGVycywgcXVlcnlQYXJhbWV0ZXJzKVxuICAgIH1cbiAgfVxuXG4gIGRlZmluZUhhc01hbnlMb2FkTWV0aG9kICh7Zm9yZWlnbktleSwgbG9hZE1ldGhvZE5hbWUsIE1vZGVsQ2xhc3MsIG1vZGVsQ2xhc3NEYXRhLCBtb2RlbFJlY2lwZXNMb2FkZXIsIG9wdGlvbnNUaHJvdWdoLCByZWxhdGlvbnNoaXBOYW1lLCByZXNvdXJjZU5hbWV9KSB7XG4gICAgTW9kZWxDbGFzcy5wcm90b3R5cGVbbG9hZE1ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLnByaW1hcnlLZXkoKVxuICAgICAgY29uc3QgbW9kZWxDbGFzcyA9IG1vZGVsUmVjaXBlc0xvYWRlci5nZXRNb2RlbENsYXNzKHJlc291cmNlTmFtZSlcblxuICAgICAgaWYgKG9wdGlvbnNUaHJvdWdoKSB7XG4gICAgICAgIGNvbnN0IG1vZGVsQ2xhc3NOYW1lID0gZGlnZyhtb2RlbENsYXNzRGF0YSwgXCJjbGFzc05hbWVcIilcblxuICAgICAgICByZXR1cm4gdGhpcy5fbG9hZEhhc01hbnlSZWZsZWN0aW9uKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlZmxlY3Rpb25OYW1lOiByZWxhdGlvbnNoaXBOYW1lLFxuICAgICAgICAgICAgbW9kZWw6IHRoaXMsXG4gICAgICAgICAgICBtb2RlbENsYXNzXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgdGhyb3VnaDoge1xuICAgICAgICAgICAgICAgIG1vZGVsOiBtb2RlbENsYXNzTmFtZSxcbiAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICByZWZsZWN0aW9uOiByZWxhdGlvbnNoaXBOYW1lXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJhbnNhY2sgPSB7fVxuXG4gICAgICAgIHJhbnNhY2tbYCR7Zm9yZWlnbktleX1fZXFgXSA9IGlkXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWRIYXNNYW55UmVmbGVjdGlvbihcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZWZsZWN0aW9uTmFtZTogcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgICAgICAgIG1vZGVsOiB0aGlzLFxuICAgICAgICAgICAgbW9kZWxDbGFzc1xuICAgICAgICAgIH0sXG4gICAgICAgICAge3JhbnNhY2t9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBkZWZpbmVIYXNPbmVHZXRNZXRoZCAoe01vZGVsQ2xhc3MsIG1vZGVsTWV0aG9kTmFtZSwgcmVsYXRpb25zaGlwTmFtZX0pIHtcbiAgICBNb2RlbENsYXNzLnByb3RvdHlwZVttb2RlbE1ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHRoaXMuX3JlYWRIYXNPbmVSZWZsZWN0aW9uKHtyZWZsZWN0aW9uTmFtZTogcmVsYXRpb25zaGlwTmFtZX0pXG4gICAgfVxuICB9XG5cbiAgZGVmaW5lSGFzT25lTG9hZE1ldGhvZCAoe1xuICAgIGFjdGl2ZVJlY29yZFByaW1hcnlLZXksXG4gICAgZm9yZWlnbktleSxcbiAgICBsb2FkTWV0aG9kTmFtZSxcbiAgICBNb2RlbENsYXNzLFxuICAgIG1vZGVsQ2xhc3NEYXRhLFxuICAgIG1vZGVsUmVjaXBlc0xvYWRlcixcbiAgICBvcHRpb25zVGhyb3VnaCxcbiAgICByZWxhdGlvbnNoaXBOYW1lLFxuICAgIHJlc291cmNlTmFtZVxuICB9KSB7XG4gICAgTW9kZWxDbGFzcy5wcm90b3R5cGVbbG9hZE1ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgcHJpbWFyeUtleU1ldGhvZE5hbWUgPSBpbmZsZWN0aW9uLmNhbWVsaXplKGFjdGl2ZVJlY29yZFByaW1hcnlLZXksIHRydWUpXG5cbiAgICAgIGlmICghKHByaW1hcnlLZXlNZXRob2ROYW1lIGluIHRoaXMpKSB0aHJvdyBuZXcgRXJyb3IoYFByaW1hcnkga2V5IG1ldGhvZCB3YXNuJ3QgZGVmaW5lZDogJHtwcmltYXJ5S2V5TWV0aG9kTmFtZX1gKVxuXG4gICAgICBjb25zdCBpZCA9IHRoaXNbcHJpbWFyeUtleU1ldGhvZE5hbWVdKClcbiAgICAgIGNvbnN0IG1vZGVsQ2xhc3MgPSBtb2RlbFJlY2lwZXNMb2FkZXIuZ2V0TW9kZWxDbGFzcyhyZXNvdXJjZU5hbWUpXG5cbiAgICAgIGlmIChvcHRpb25zVGhyb3VnaCkge1xuICAgICAgICBjb25zdCBtb2RlbENsYXNzTmFtZSA9IGRpZ2cobW9kZWxDbGFzc0RhdGEsIFwiY2xhc3NOYW1lXCIpXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWRIYXNPbmVSZWZsZWN0aW9uKFxuICAgICAgICAgIHtyZWZsZWN0aW9uTmFtZTogcmVsYXRpb25zaGlwTmFtZSwgbW9kZWw6IHRoaXMsIG1vZGVsQ2xhc3N9LFxuICAgICAgICAgIHtwYXJhbXM6IHt0aHJvdWdoOiB7bW9kZWw6IG1vZGVsQ2xhc3NOYW1lLCBpZCwgcmVmbGVjdGlvbjogcmVsYXRpb25zaGlwTmFtZX19fVxuICAgICAgICApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByYW5zYWNrID0ge31cblxuICAgICAgICByYW5zYWNrW2Ake2ZvcmVpZ25LZXl9X2VxYF0gPSBpZFxuXG4gICAgICAgIHJldHVybiB0aGlzLl9sb2FkSGFzT25lUmVmbGVjdGlvbihcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZWZsZWN0aW9uTmFtZTogcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgICAgICAgIG1vZGVsOiB0aGlzLFxuICAgICAgICAgICAgbW9kZWxDbGFzc1xuICAgICAgICAgIH0sXG4gICAgICAgICAge3JhbnNhY2t9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==