import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
/* eslint-disable complexity, implicit-arrow-linebreak, max-len, newline-per-chained-call, react/jsx-sort-props, sort-imports */
import React, { useMemo } from "react";
import AttributeRow from "../../bootstrap/attribute-row";
import BaseComponent from "../../base-component";
import BelongsToAttributeRow from "./belongs-to-attribute-row";
import ConfigReader from "../config-reader";
import { digg } from "diggerize";
import memo from "set-state-compare/build/memo.js";
import * as inflection from "inflection";
import PropTypes from "prop-types";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import ShowNav from "../show-nav";
import useModel from "../../use-model.js";
import { View } from "react-native";
const AttributePresenter = memo(({ attribute, model, modelArgs }) => {
    const attributeRowProps = {
        model
    };
    if (typeof attribute == "object") {
        if (attribute.attribute)
            attributeRowProps.attribute = attribute.attribute;
        if (attribute.content)
            attributeRowProps.children = attribute.content(modelArgs);
        if (attribute.label)
            attributeRowProps.label = attribute.label;
    }
    else if (attribute) {
        attributeRowProps.attribute = attribute;
    }
    return (_jsx(AttributeRow, { ...attributeRowProps }));
});
export default memo(shapeComponent(class ApiMakerSuperAdminShowPage extends BaseComponent {
    static propTypes = {
        modelClass: PropTypes.func.isRequired
    };
    setup() {
        const { modelClass } = this.props;
        const configReader = useMemo(() => ConfigReader.forModel(modelClass), [modelClass]);
        const showConfig = configReader.modelConfig?.show;
        this.setInstance({ configReader, showConfig });
    }
    render() {
        const { modelClass } = this.props;
        const { configReader, showConfig } = this.tt;
        const attributes = configReader.attributesToShow();
        const extraContent = showConfig?.extraContent;
        const modelClassName = modelClass.modelClassData().name;
        const primaryKeyName = modelClass.primaryKey();
        const preload = [];
        const select = showConfig?.extraSelect || {};
        const modelClassSelect = select[modelClassName] || [];
        if (showConfig?.preload) {
            for (const showConfigPreload of showConfig.preload) {
                preload.push(showConfigPreload);
            }
        }
        if (!(modelClassName in select))
            select[modelClassName] = modelClassSelect;
        if (!modelClassSelect.includes(primaryKeyName))
            modelClassSelect.push(primaryKeyName);
        // Select all attributes selected by default because they will be shown by default
        for (const attribute of modelClass.attributes()) {
            if ((attribute.isSelectedByDefault() || attribute.name() == "name") && !modelClassSelect.includes(attribute.name())) {
                modelClassSelect.push(attribute.name());
            }
        }
        for (const reflection of modelClass.reflections()) {
            if (reflection.macro() == "belongs_to") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any belongs-to-relationships
                if (!modelClassSelect.includes(reflection.foreignKey())) {
                    const foreignKeyAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == reflection.foreignKey());
                    if (!foreignKeyAttribute) {
                        throw new Error(`${reflection.foreignKey()} wasn't defined as an attribute on ${modelClassName}`);
                    }
                    modelClassSelect.push(reflection.foreignKey());
                }
            }
            else if (reflection.macro() == "has_one") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any has-one-relationships
                if (!modelClassSelect.includes(reflection.foreignKey()) && !select[reflectionModelClassName].includes(reflection.foreignKey()) && !reflection.through()) {
                    select[reflectionModelClassName].push(reflection.foreignKey());
                }
            }
        }
        const useModelResult = useModel(modelClass, {
            loadByQueryParam: ({ queryParams }) => queryParams.model_id,
            preload,
            select
        });
        const camelizedLower = digg(modelClass.modelClassData(), "camelizedLower");
        const model = digg(useModelResult, camelizedLower);
        const modelArgs = {};
        modelArgs[inflection.camelize(modelClass.modelClassData().name, true)] = model;
        return (_jsxs(View, { testID: "super-admin/show-page", children: [model &&
                    _jsx(ShowNav, { model: model, modelClass: modelClass }), attributes && model && attributes.map((attribute) => _jsx(AttributePresenter, { attribute: attribute, modelArgs: modelArgs, model: model }, attribute.key || attribute.attribute || attribute)), model && modelClass.reflections().filter((reflection) => reflection.macro() == "belongs_to" || reflection.macro() == "has_one").map((reflection) => _jsx(BelongsToAttributeRow, { model: model, modelClass: modelClass, reflection: reflection }, reflection.name())), model && extraContent && extraContent(modelArgs)] }));
    }
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInN1cGVyLWFkbWluL3Nob3ctcGFnZS9pbmRleC5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGdJQUFnSTtBQUNoSSxPQUFPLEtBQUssRUFBRSxFQUFDLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUNwQyxPQUFPLFlBQVksTUFBTSwrQkFBK0IsQ0FBQTtBQUN4RCxPQUFPLGFBQWEsTUFBTSxzQkFBc0IsQ0FBQTtBQUNoRCxPQUFPLHFCQUFxQixNQUFNLDRCQUE0QixDQUFBO0FBQzlELE9BQU8sWUFBWSxNQUFNLGtCQUFrQixDQUFBO0FBQzNDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFDOUIsT0FBTyxJQUFJLE1BQU0saUNBQWlDLENBQUE7QUFDbEQsT0FBTyxLQUFLLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDeEMsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw0Q0FBNEMsQ0FBQTtBQUN6RSxPQUFPLE9BQU8sTUFBTSxhQUFhLENBQUE7QUFDakMsT0FBTyxRQUFRLE1BQU0sb0JBQW9CLENBQUE7QUFDekMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQTtBQUVqQyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsRUFBRSxFQUFFO0lBQ2hFLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsS0FBSztLQUNOLENBQUE7SUFFRCxJQUFJLE9BQU8sU0FBUyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLElBQUksU0FBUyxDQUFDLFNBQVM7WUFBRSxpQkFBaUIsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQTtRQUMxRSxJQUFJLFNBQVMsQ0FBQyxPQUFPO1lBQUUsaUJBQWlCLENBQUMsUUFBUSxHQUFH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S0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsVUFBVSxHQUFJLEVBRWxELFVBQVUsSUFBSSxLQUFLLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQ25ELEtBQUMsa0JBQWtCLElBQUMsU0FBUyxFQUFFLFNBQVMsRUFBMEQsU0FBUyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxJQUFyRixTQUFTLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUF3QyxDQUN6SSxFQUNBLEtBQUssSUFBSSxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksWUFBWSxJQUFJLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUNsSixLQUFDLHFCQUFxQixJQUF5QixLQUFLLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFVBQVUsSUFBL0UsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFrRSxDQUNoSCxFQUNBLEtBQUssSUFBSSxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUM1QyxDQUNSLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBjb21wbGV4aXR5LCBpbXBsaWNpdC1hcnJvdy1saW5lYnJlYWssIG1heC1sZW4sIG5ld2xpbmUtcGVyLWNoYWluZWQtY2FsbCwgcmVhY3QvanN4LXNvcnQtcHJvcHMsIHNvcnQtaW1wb3J0cyAqL1xuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSBcInJlYWN0XCJcbmltcG9ydCBBdHRyaWJ1dGVSb3cgZnJvbSBcIi4uLy4uL2Jvb3RzdHJhcC9hdHRyaWJ1dGUtcm93XCJcbmltcG9ydCBCYXNlQ29tcG9uZW50IGZyb20gXCIuLi8uLi9iYXNlLWNvbXBvbmVudFwiXG5pbXBvcnQgQmVsb25nc1RvQXR0cmlidXRlUm93IGZyb20gXCIuL2JlbG9uZ3MtdG8tYXR0cmlidXRlLXJvd1wiXG5pbXBvcnQgQ29uZmlnUmVhZGVyIGZyb20gXCIuLi9jb25maWctcmVhZGVyXCJcbmltcG9ydCB7ZGlnZ30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG5pbXBvcnQgKiBhcyBpbmZsZWN0aW9uIGZyb20gXCJpbmZsZWN0aW9uXCJcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSBcInByb3AtdHlwZXNcIlxuaW1wb3J0IHtzaGFwZUNvbXBvbmVudH0gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3NoYXBlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgU2hvd05hdiBmcm9tIFwiLi4vc2hvdy1uYXZcIlxuaW1wb3J0IHVzZU1vZGVsIGZyb20gXCIuLi8uLi91c2UtbW9kZWwuanNcIlxuaW1wb3J0IHtWaWV3fSBmcm9tIFwicmVhY3QtbmF0aXZlXCJcblxuY29uc3QgQXR0cmlidXRlUHJlc2VudGVyID0gbWVtbygoe2F0dHJpYnV0ZSwgbW9kZWwsIG1vZGVsQXJnc30pID0+IHtcbiAgY29uc3QgYXR0cmlidXRlUm93UHJvcHMgPSB7XG4gICAgbW9kZWxcbiAgfVxuXG4gIGlmICh0eXBlb2YgYXR0cmlidXRlID09IFwib2JqZWN0XCIpIHtcbiAgICBpZiAoYXR0cmlidXRlLmF0dHJpYnV0ZSkgYXR0cmlidXRlUm93UHJvcHMuYXR0cmlidXRlID0gYXR0cmlidXRlLmF0dHJpYnV0ZVxuICAgIGlmIChhdHRyaWJ1dGUuY29udGVudCkgYXR0cmlidXRlUm93UHJvcHMuY2hpbGRyZW4gPSBhdHRyaWJ1dGUuY29udGVudChtb2RlbEFyZ3MpXG4gICAgaWYgKGF0dHJpYnV0ZS5sYWJlbCkgYXR0cmlidXRlUm93UHJvcHMubGFiZWwgPSBhdHRyaWJ1dGUubGFiZWxcbiAgfSBlbHNlIGlmIChhdHRyaWJ1dGUpIHtcbiAgICBhdHRyaWJ1dGVSb3dQcm9wcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGVcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgPEF0dHJpYnV0ZVJvdyB7Li4uYXR0cmlidXRlUm93UHJvcHN9IC8+XG4gIClcbn0pXG5cbmV4cG9ydCBkZWZhdWx0IG1lbW8oc2hhcGVDb21wb25lbnQoY2xhc3MgQXBpTWFrZXJTdXBlckFkbWluU2hvd1BhZ2UgZXh0ZW5kcyBCYXNlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBtb2RlbENsYXNzOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkXG4gIH1cblxuICBzZXR1cCgpIHtcbiAgICBjb25zdCB7bW9kZWxDbGFzc30gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgY29uZmlnUmVhZGVyID0gdXNlTWVtbygoKSA9PiBDb25maWdSZWFkZXIuZm9yTW9kZWwobW9kZWxDbGFzcyksIFttb2RlbENsYXNzXSlcbiAgICBjb25zdCBzaG93Q29uZmlnID0gY29uZmlnUmVhZGVyLm1vZGVsQ29uZmlnPy5zaG93XG5cbiAgICB0aGlzLnNldEluc3RhbmNlKHtjb25maWdSZWFkZXIsIHNob3dDb25maWd9KVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHttb2RlbENsYXNzfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7Y29uZmlnUmVhZGVyLCBzaG93Q29uZmlnfSA9IHRoaXMudHRcbiAgICBjb25zdCBhdHRyaWJ1dGVzID0gY29uZmlnUmVhZGVyLmF0dHJpYnV0ZXNUb1Nob3coKVxuICAgIGNvbnN0IGV4dHJhQ29udGVudCA9IHNob3dDb25maWc/LmV4dHJhQ29udGVudFxuICAgIGNvbnN0IG1vZGVsQ2xhc3NOYW1lID0gbW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLm5hbWVcbiAgICBjb25zdCBwcmltYXJ5S2V5TmFtZSA9IG1vZGVsQ2xhc3MucHJpbWFyeUtleSgpXG4gICAgY29uc3QgcHJlbG9hZCA9IFtdXG4gICAgY29uc3Qgc2VsZWN0ID0gc2hvd0NvbmZpZz8uZXh0cmFTZWxlY3QgfHwge31cbiAgICBjb25zdCBtb2RlbENsYXNzU2VsZWN0ID0gc2VsZWN0W21vZGVsQ2xhc3NOYW1lXSB8fCBbXVxuXG4gICAgaWYgKHNob3dDb25maWc/LnByZWxvYWQpIHtcbiAgICAgIGZvciAoY29uc3Qgc2hvd0NvbmZpZ1ByZWxvYWQgb2Ygc2hvd0NvbmZpZy5wcmVsb2FkKSB7XG4gICAgICAgIHByZWxvYWQucHVzaChzaG93Q29uZmlnUHJlbG9hZClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIShtb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbbW9kZWxDbGFzc05hbWVdID0gbW9kZWxDbGFzc1NlbGVjdFxuICAgIGlmICghbW9kZWxDbGFzc1NlbGVjdC5pbmNsdWRlcyhwcmltYXJ5S2V5TmFtZSkpIG1vZGVsQ2xhc3NTZWxlY3QucHVzaChwcmltYXJ5S2V5TmFtZSlcblxuICAgIC8vIFNlbGVjdCBhbGwgYXR0cmlidXRlcyBzZWxlY3RlZCBieSBkZWZhdWx0IGJlY2F1c2UgdGhleSB3aWxsIGJlIHNob3duIGJ5IGRlZmF1bHRcbiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZSBvZiBtb2RlbENsYXNzLmF0dHJpYnV0ZXMoKSkge1xuICAgICAgaWYgKChhdHRyaWJ1dGUuaXNTZWxlY3RlZEJ5RGVmYXVsdCgpIHx8IGF0dHJpYnV0ZS5uYW1lKCkgPT0gXCJuYW1lXCIpICYmICFtb2RlbENsYXNzU2VsZWN0LmluY2x1ZGVzKGF0dHJpYnV0ZS5uYW1lKCkpKSB7XG4gICAgICAgIG1vZGVsQ2xhc3NTZWxlY3QucHVzaChhdHRyaWJ1dGUubmFtZSgpKVxuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgcmVmbGVjdGlvbiBvZiBtb2RlbENsYXNzLnJlZmxlY3Rpb25zKCkpIHtcbiAgICAgIGlmIChyZWZsZWN0aW9uLm1hY3JvKCkgPT0gXCJiZWxvbmdzX3RvXCIpIHtcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3MgPSByZWZsZWN0aW9uLm1vZGVsQ2xhc3MoKVxuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzc05hbWUgPSByZWZsZWN0aW9uTW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLm5hbWVcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3NBdHRyaWJ1dGVzID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3MuYXR0cmlidXRlcygpXG4gICAgICAgIGNvbnN0IG5hbWVBdHRyaWJ1dGUgPSByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZSgpID09IFwibmFtZVwiKVxuXG4gICAgICAgIHByZWxvYWQucHVzaChpbmZsZWN0aW9uLnVuZGVyc2NvcmUocmVmbGVjdGlvbi5uYW1lKCkpKVxuXG4gICAgICAgIGlmICghKHJlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXSA9IFtdXG4gICAgICAgIGlmICghc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0uaW5jbHVkZXMoXCJpZFwiKSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChcImlkXCIpXG4gICAgICAgIGlmIChuYW1lQXR0cmlidXRlICYmICFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhcIm5hbWVcIikpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLnB1c2goXCJuYW1lXCIpXG5cbiAgICAgICAgLy8gVGhlIGZvcmVpZ24ga2V5IGlzIG5lZWRlZCB0byBsb29rIHVwIGFueSBiZWxvbmdzLXRvLXJlbGF0aW9uc2hpcHNcbiAgICAgICAgaWYgKCFtb2RlbENsYXNzU2VsZWN0LmluY2x1ZGVzKHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKSkge1xuICAgICAgICAgIGNvbnN0IGZvcmVpZ25LZXlBdHRyaWJ1dGUgPSByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZSgpID09IHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKVxuXG4gICAgICAgICAgaWYgKCFmb3JlaWduS2V5QXR0cmlidXRlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cmVmbGVjdGlvbi5mb3JlaWduS2V5KCl9IHdhc24ndCBkZWZpbmVkIGFzIGFuIGF0dHJpYnV0ZSBvbiAke21vZGVsQ2xhc3NOYW1lfWApXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbW9kZWxDbGFzc1NlbGVjdC5wdXNoKHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHJlZmxlY3Rpb24ubWFjcm8oKSA9PSBcImhhc19vbmVcIikge1xuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzcyA9IHJlZmxlY3Rpb24ubW9kZWxDbGFzcygpXG4gICAgICAgIGNvbnN0IHJlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZSA9IHJlZmxlY3Rpb25Nb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCkubmFtZVxuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMgPSByZWZsZWN0aW9uTW9kZWxDbGFzcy5hdHRyaWJ1dGVzKClcbiAgICAgICAgY29uc3QgbmFtZUF0dHJpYnV0ZSA9IHJlZmxlY3Rpb25Nb2RlbENsYXNzQXR0cmlidXRlcy5maW5kKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5uYW1lKCkgPT0gXCJuYW1lXCIpXG5cbiAgICAgICAgcHJlbG9hZC5wdXNoKGluZmxlY3Rpb24udW5kZXJzY29yZShyZWZsZWN0aW9uLm5hbWUoKSkpXG5cbiAgICAgICAgaWYgKCEocmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lIGluIHNlbGVjdCkpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdID0gW11cbiAgICAgICAgaWYgKCFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhcImlkXCIpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5wdXNoKFwiaWRcIilcbiAgICAgICAgaWYgKG5hbWVBdHRyaWJ1dGUgJiYgIXNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLmluY2x1ZGVzKFwibmFtZVwiKSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChcIm5hbWVcIilcblxuICAgICAgICAvLyBUaGUgZm9yZWlnbiBrZXkgaXMgbmVlZGVkIHRvIGxvb2sgdXAgYW55IGhhcy1vbmUtcmVsYXRpb25zaGlwc1xuICAgICAgICBpZiAoIW1vZGVsQ2xhc3NTZWxlY3QuaW5jbHVkZXMocmVmbGVjdGlvbi5mb3JlaWduS2V5KCkpICYmICFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSkgJiYgIXJlZmxlY3Rpb24udGhyb3VnaCgpKSB7XG4gICAgICAgICAgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHVzZU1vZGVsUmVzdWx0ID0gdXNlTW9kZWwobW9kZWxDbGFzcywge1xuICAgICAgbG9hZEJ5UXVlcnlQYXJhbTogKHtxdWVyeVBhcmFtc30pID0+IHF1ZXJ5UGFyYW1zLm1vZGVsX2lkLFxuICAgICAgcHJlbG9hZCxcbiAgICAgIHNlbGVjdFxuICAgIH0pXG4gICAgY29uc3QgY2FtZWxpemVkTG93ZXIgPSBkaWdnKG1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKSwgXCJjYW1lbGl6ZWRMb3dlclwiKVxuICAgIGNvbnN0IG1vZGVsID0gZGlnZyh1c2VNb2RlbFJlc3VsdCwgY2FtZWxpemVkTG93ZXIpXG4gICAgY29uc3QgbW9kZWxBcmdzID0ge31cblxuICAgIG1vZGVsQXJnc1tpbmZsZWN0aW9uLmNhbWVsaXplKG1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKS5uYW1lLCB0cnVlKV0gPSBtb2RlbFxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3IHRlc3RJRD1cInN1cGVyLWFkbWluL3Nob3ctcGFnZVwiPlxuICAgICAgICB7bW9kZWwgJiZcbiAgICAgICAgICA8U2hvd05hdiBtb2RlbD17bW9kZWx9IG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9IC8+XG4gICAgICAgIH1cbiAgICAgICAge2F0dHJpYnV0ZXMgJiYgbW9kZWwgJiYgYXR0cmlidXRlcy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICA8QXR0cmlidXRlUHJlc2VudGVyIGF0dHJpYnV0ZT17YXR0cmlidXRlfSBrZXk9e2F0dHJpYnV0ZS5rZXkgfHwgYXR0cmlidXRlLmF0dHJpYnV0ZSB8fCBhdHRyaWJ1dGV9IG1vZGVsQXJncz17bW9kZWxBcmdzfSBtb2RlbD17bW9kZWx9IC8+XG4gICAgICAgICl9XG4gICAgICAgIHttb2RlbCAmJiBtb2RlbENsYXNzLnJlZmxlY3Rpb25zKCkuZmlsdGVyKChyZWZsZWN0aW9uKSA9PiByZWZsZWN0aW9uLm1hY3JvKCkgPT0gXCJiZWxvbmdzX3RvXCIgfHwgcmVmbGVjdGlvbi5tYWNybygpID09IFwiaGFzX29uZVwiKS5tYXAoKHJlZmxlY3Rpb24pID0+XG4gICAgICAgICAgPEJlbG9uZ3NUb0F0dHJpYnV0ZVJvdyBrZXk9e3JlZmxlY3Rpb24ubmFtZSgpfSBtb2RlbD17bW9kZWx9IG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9IHJlZmxlY3Rpb249e3JlZmxlY3Rpb259IC8+XG4gICAgICAgICl9XG4gICAgICAgIHttb2RlbCAmJiBleHRyYUNvbnRlbnQgJiYgZXh0cmFDb250ZW50KG1vZGVsQXJncyl9XG4gICAgICA8L1ZpZXc+XG4gICAgKVxuICB9XG59KSlcbiJdfQ==