import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import * as inflection from "inflection";
import React, { useMemo } from "react";
import { ShapeComponent, shapeComponent } from "set-state-compare/build/shape-component.js";
import { digs } from "diggerize";
import InvalidFeedback from "./invalid-feedback"; // eslint-disable-line sort-imports
import PropTypes from "prop-types";
import memo from "set-state-compare/build/memo.js";
import propTypesExact from "prop-types-exact";
import { useForm } from "../form";
import useInput from "../use-input.js";
const OptionElement = memo(shapeComponent(class OptionElement extends ShapeComponent {
    render() {
        const { generatedId, inputCheckboxClassName, isDefaultSelected, inputName, option, optionIndex, options, wrapperOpts } = this.p;
        const { errors } = digs(wrapperOpts, "errors");
        const id = `${generatedId}-${optionIndex}`;
        return (_jsxs("div", { className: "checkboxes-option", children: [_jsx("input", { className: inputCheckboxClassName, "data-option-value": option[1], defaultChecked: isDefaultSelected, id: id, name: inputName, onChange: this.tt.onChange, type: "checkbox", value: option[1] }), _jsx("label", { className: "ml-1", htmlFor: id, children: option[0] }), optionIndex + 1 == options.length && errors.length > 0 &&
                    _jsx(InvalidFeedback, { errors: errors })] }, `option-${option[1]}`));
    }
    onChange = (event, ...restProps) => {
        this.p.onOptionChecked({ event, option: this.p.option });
        if (this.props.onChange)
            this.props.onChange(event, ...restProps);
    };
}));
export default memo(shapeComponent(class ApiMakerBootstrapCheckboxes extends ShapeComponent {
    static propTypes = propTypesExact({
        attribute: PropTypes.string,
        defaultValue: PropTypes.array,
        label: PropTypes.string,
        labelClassName: PropTypes.string,
        model: PropTypes.object,
        name: PropTypes.string,
        onChange: PropTypes.func,
        options: PropTypes.array.isRequired
    });
    setup() {
        const { inputProps, wrapperOpts } = useInput({ props: this.props });
        this.generatedId = useMemo(() => Math.random()
            .toString(36)
            .substring(2, 15) + Math.random()
            .toString(36)
            .substring(2, 15), []);
        this.setInstance({
            form: useForm(),
            inputProps,
            wrapperOpts
        });
        this.useStates({
            checkedOptions: () => {
                if (Array.isArray(this.props.defaultValue))
                    return this.props.defaultValue;
                if (this.props.defaultValue)
                    return [this.props.defaultValue];
                return [];
            }
        });
        useMemo(() => {
            if (this.form && inputProps.name) {
                this.form.setValue(inputProps.name, this.s.checkedOptions);
            }
        }, []);
    }
    render() {
        return (_jsxs("div", { className: "component-bootstrap-checkboxes form-group", children: [_jsx("label", { className: this.labelClassName(), children: this.tt.wrapperOpts.label }), _jsx("input", { name: this.inputName(), ref: this.tt.inputProps.ref, type: "hidden", value: "" }), this.props.options.map((option, index) => {
                    return (_jsx(OptionElement, { generatedId: this.tt.generatedId, inputCheckboxClassName: this.tt.inputCheckboxClassName(), inputName: this.inputName(), isDefaultSelected: this.isDefaultSelected(option[1]), onChange: this.props.onChange, onOptionChecked: this.tt.onOptionChecked, option: option, optionIndex: index, options: this.props.options, wrapperOpts: this.tt.wrapperOpts }, option[1]));
                })] }));
    }
    inputDefaultValue() {
        const { attribute, defaultValue, model } = this.props;
        if (defaultValue) {
            return defaultValue;
        }
        else if (attribute && model) {
            if (!model[attribute])
                throw new Error(`No such attribute: ${attribute}`);
            return this.props.model[attribute]();
        }
    }
    inputCheckboxClassName() {
        const classNames = [];
        if (this.tt.wrapperOpts.errors.length > 0)
            classNames.push("is-invalid");
        return classNames.join(" ");
    }
    inputName() {
        if (this.props.name) {
            return `${this.props.name}[]`;
        }
        else if (this.props.model) {
            return `${this.props.model.modelClassData().paramKey}[${inflection.underscore(this.props.attribute)}]`;
        }
    }
    isDefaultSelected(option) {
        let defaultValue = this.inputDefaultValue();
        if (!defaultValue)
            return false;
        if (defaultValue.constructor === Array) {
            return defaultValue.includes(option);
        }
        else {
            return defaultValue == option;
        }
    }
    labelClassName() {
        const classNames = [];
        if (this.props.labelClassName)
            classNames.push(this.props.labelClassName);
        return classNames.join(" ");
    }
    onOptionChecked = ({ event, option }) => {
        const { inputProps, form } = this.tt;
        const { name } = inputProps;
        const checked = event.target.checked;
        let newOptions;
        if (checked) {
            newOptions = this.s.checkedOptions.concat([option[1]]);
            this.setState({ checkedOptions: newOptions });
        }
        else {
            newOptions = this.s.checkedOptions.filter((value) => value != option[1]);
            this.setState({ checkedOptions: newOptions });
        }
        if (form && name) {
            form.setValue(name, newOptions);
        }
    };
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tib3hlcy5qcyIsInNvdXJjZVJvb3QiOiIvc3JjLyIsInNvdXJjZXMiOlsiYm9vdHN0cmFwL2NoZWNrYm94ZXMuanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLEtBQUssRUFBRSxFQUFDLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUNwQyxPQUFPLEVBQUMsY0FBYyxFQUFFLGNBQWMsRUFBQyxNQUFNLDRDQUE0QyxDQUFBO0FBQ3pGLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFDOUIsT0FBTyxlQUFlLE1BQU0sb0JBQW9CLENBQUEsQ0FBQyxtQ0FBbUM7QUFDcEYsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sSUFBSSxNQUFNLGlDQUFpQyxDQUFBO0FBQ2xELE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFBO0FBQzdDLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxTQUFTLENBQUE7QUFDL0IsT0FBTyxRQUFRLE1BQU0saUJBQWlCLENBQUE7QUFFdEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLGFBQWMsU0FBUSxjQUFjO0lBQ2xGLE1BQU07UUFDSixNQUFNLEVBQUMsV0FBVyxFQUFFLHNCQUFzQixFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQzdILE1BQU0sRUFBQyxNQUFNLEVBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQzVDLE1BQU0sRUFBRSxHQUFHLEdBQUcsV0FBVyxJQUFJLFdBQVcsRUFBRSxDQUFBO1FBRTFDLE9BQU8sQ0FDTCxlQUFLLFNBQVMsRUFBQyxtQkFBbUIsYUFDaEMsZ0JBQ0UsU0FBUyxFQUFFLHNCQUFzQix1QkFD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QyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBRXRELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxjQUFjLEVBQUUsVUFBVSxFQUFDLENBQUMsQ0FBQTtRQUM3QyxDQUFDO2FBQU0sQ0FBQztZQUNOLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUV4RSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUMsY0FBYyxFQUFFLFVBQVUsRUFBQyxDQUFDLENBQUE7UUFDN0MsQ0FBQztRQUVELElBQUksSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQ2pDLENBQUM7SUFDSCxDQUFDLENBQUE7Q0FDRixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGluZmxlY3Rpb24gZnJvbSBcImluZmxlY3Rpb25cIlxuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSBcInJlYWN0XCJcbmltcG9ydCB7U2hhcGVDb21wb25lbnQsIHNoYXBlQ29tcG9uZW50fSBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvc2hhcGUtY29tcG9uZW50LmpzXCJcbmltcG9ydCB7ZGlnc30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgSW52YWxpZEZlZWRiYWNrIGZyb20gXCIuL2ludmFsaWQtZmVlZGJhY2tcIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHNvcnQtaW1wb3J0c1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tIFwicHJvcC10eXBlc1wiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG5pbXBvcnQgcHJvcFR5cGVzRXhhY3QgZnJvbSBcInByb3AtdHlwZXMtZXhhY3RcIlxuaW1wb3J0IHt1c2VGb3JtfSBmcm9tIFwiLi4vZm9ybVwiXG5pbXBvcnQgdXNlSW5wdXQgZnJvbSBcIi4uL3VzZS1pbnB1dC5qc1wiXG5cbmNvbnN0IE9wdGlvbkVsZW1lbnQgPSBtZW1vKHNoYXBlQ29tcG9uZW50KGNsYXNzIE9wdGlvbkVsZW1lbnQgZXh0ZW5kcyBTaGFwZUNvbXBvbmVudCB7XG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7Z2VuZXJhdGVkSWQsIGlucHV0Q2hlY2tib3hDbGFzc05hbWUsIGlzRGVmYXVsdFNlbGVjdGVkLCBpbnB1dE5hbWUsIG9wdGlvbiwgb3B0aW9uSW5kZXgsIG9wdGlvbnMsIHdyYXBwZXJPcHRzfSA9IHRoaXMucFxuICAgIGNvbnN0IHtlcnJvcnN9ID0gZGlncyh3cmFwcGVyT3B0cywgXCJlcnJvcnNcIilcbiAgICBjb25zdCBpZCA9IGAke2dlbmVyYXRlZElkfS0ke29wdGlvbkluZGV4fWBcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImNoZWNrYm94ZXMtb3B0aW9uXCIga2V5PXtgb3B0aW9uLSR7b3B0aW9uWzFdfWB9PlxuICAgICAgICA8aW5wdXRcbiAgICAgICAgICBjbGFzc05hbWU9e2lucHV0Q2hlY2tib3hDbGFzc05hbWV9XG4gICAgICAgICAgZGF0YS1vcHRpb24tdmFsdWU9e29wdGlvblsxXX1cbiAgICAgICAgICBkZWZhdWx0Q2hlY2tlZD17aXNEZWZhdWx0U2VsZWN0ZWR9XG4gICAgICAgICAgaWQ9e2lkfVxuICAgICAgICAgIG5hbWU9e2lucHV0TmFtZX1cbiAgICAgICAgICBvbkNoYW5nZT17dGhpcy50dC5vbkNoYW5nZX1cbiAgICAgICAgICB0eXBlPVwiY2hlY2tib3hcIlxuICAgICAgICAgIHZhbHVlPXtvcHRpb25bMV19XG4gICAgICAgIC8+XG5cbiAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT1cIm1sLTFcIiBodG1sRm9yPXtpZH0+XG4gICAgICAgICAge29wdGlvblswXX1cbiAgICAgICAgPC9sYWJlbD5cblxuICAgICAgICB7b3B0aW9uSW5kZXggKyAxID09IG9wdGlvbnMubGVuZ3RoICYmIGVycm9ycy5sZW5ndGggPiAwICYmXG4gICAgICAgICAgPEludmFsaWRGZWVkYmFjayBlcnJvcnM9e2Vycm9yc30gLz5cbiAgICAgICAgfVxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgb25DaGFuZ2UgPSAoZXZlbnQsIC4uLnJlc3RQcm9wcykgPT4ge1xuICAgIHRoaXMucC5vbk9wdGlvbkNoZWNrZWQoe2V2ZW50LCBvcHRpb246IHRoaXMucC5vcHRpb259KVxuXG4gICAgaWYgKHRoaXMucHJvcHMub25DaGFuZ2UpIHRoaXMucHJvcHMub25DaGFuZ2UoZXZlbnQsIC4uLnJlc3RQcm9wcylcbiAgfVxufSkpXG5cbmV4cG9ydCBkZWZhdWx0IG1lbW8oc2hhcGVDb21wb25lbnQoY2xhc3MgQXBpTWFrZXJCb290c3RyYXBDaGVja2JveGVzIGV4dGVuZHMgU2hhcGVDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0gcHJvcFR5cGVzRXhhY3Qoe1xuICAgIGF0dHJpYnV0ZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBkZWZhdWx0VmFsdWU6IFByb3BUeXBlcy5hcnJheSxcbiAgICBsYWJlbDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBsYWJlbENsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBtb2RlbDogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBuYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIG9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvcHRpb25zOiBQcm9wVHlwZXMuYXJyYXkuaXNSZXF1aXJlZFxuICB9KVxuXG4gIHNldHVwKCkge1xuICAgIGNvbnN0IHtpbnB1dFByb3BzLCB3cmFwcGVyT3B0c30gPSB1c2VJbnB1dCh7cHJvcHM6IHRoaXMucHJvcHN9KVxuXG4gICAgdGhpcy5nZW5lcmF0ZWRJZCA9IHVzZU1lbW8oXG4gICAgICAoKSA9PiBNYXRoLnJhbmRvbSgpXG4gICAgICAgIC50b1N0cmluZygzNilcbiAgICAgICAgLnN1YnN0cmluZygyLCAxNSkgKyBNYXRoLnJhbmRvbSgpXG4gICAgICAgIC50b1N0cmluZygzNilcbiAgICAgICAgLnN1YnN0cmluZygyLCAxNSksXG4gICAgICBbXVxuICAgIClcblxuICAgIHRoaXMuc2V0SW5zdGFuY2Uoe1xuICAgICAgZm9ybTogdXNlRm9ybSgpLFxuICAgICAgaW5wdXRQcm9wcyxcbiAgICAgIHdyYXBwZXJPcHRzXG4gICAgfSlcbiAgICB0aGlzLnVzZVN0YXRlcyh7XG4gICAgICBjaGVja2VkT3B0aW9uczogKCkgPT4ge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLnByb3BzLmRlZmF1bHRWYWx1ZSkpIHJldHVybiB0aGlzLnByb3BzLmRlZmF1bHRWYWx1ZVxuICAgICAgICBpZiAodGhpcy5wcm9wcy5kZWZhdWx0VmFsdWUpIHJldHVybiBbdGhpcy5wcm9wcy5kZWZhdWx0VmFsdWVdXG5cbiAgICAgICAgcmV0dXJuIFtdXG4gICAgICB9XG4gICAgfSlcblxuICAgIHVzZU1lbW8oKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuZm9ybSAmJiBpbnB1dFByb3BzLm5hbWUpIHtcbiAgICAgICAgdGhpcy5mb3JtLnNldFZhbHVlKGlucHV0UHJvcHMubmFtZSwgdGhpcy5zLmNoZWNrZWRPcHRpb25zKVxuICAgICAgfVxuICAgIH0sIFtdKVxuICB9XG5cbiAgcmVuZGVyICgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJjb21wb25lbnQtYm9vdHN0cmFwLWNoZWNrYm94ZXMgZm9ybS1ncm91cFwiPlxuICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPXt0aGlzLmxhYmVsQ2xhc3NOYW1lKCl9PlxuICAgICAgICAgIHt0aGlzLnR0LndyYXBwZXJPcHRzLmxhYmVsfVxuICAgICAgICA8L2xhYmVsPlxuXG4gICAgICAgIDxpbnB1dCBuYW1lPXt0aGlzLmlucHV0TmFtZSgpfSByZWY9e3RoaXMudHQuaW5wdXRQcm9wcy5yZWZ9IHR5cGU9XCJoaWRkZW5cIiB2YWx1ZT1cIlwiIC8+XG4gICAgICAgIHt0aGlzLnByb3BzLm9wdGlvbnMubWFwKChvcHRpb24sIGluZGV4KSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgYXJyb3ctYm9keS1zdHlsZVxuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8T3B0aW9uRWxlbWVudFxuICAgICAgICAgICAgICBnZW5lcmF0ZWRJZD17dGhpcy50dC5nZW5lcmF0ZWRJZH1cbiAgICAgICAgICAgICAgaW5wdXRDaGVja2JveENsYXNzTmFtZT17dGhpcy50dC5pbnB1dENoZWNrYm94Q2xhc3NOYW1lKCl9XG4gICAgICAgICAgICAgIGlucHV0TmFtZT17dGhpcy5pbnB1dE5hbWUoKX1cbiAgICAgICAgICAgICAgaXNEZWZhdWx0U2VsZWN0ZWQ9e3RoaXMuaXNEZWZhdWx0U2VsZWN0ZWQob3B0aW9uWzFdKX1cbiAgICAgICAgICAgICAga2V5PXtvcHRpb25bMV19XG4gICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLnByb3BzLm9uQ2hhbmdlfVxuICAgICAgICAgICAgICBvbk9wdGlvbkNoZWNrZWQ9e3RoaXMudHQub25PcHRpb25DaGVja2VkfVxuICAgICAgICAgICAgICBvcHRpb249e29wdGlvbn1cbiAgICAgICAgICAgICAgb3B0aW9uSW5kZXg9e2luZGV4fVxuICAgICAgICAgICAgICBvcHRpb25zPXt0aGlzLnByb3BzLm9wdGlvbnN9XG4gICAgICAgICAgICAgIHdyYXBwZXJPcHRzPXt0aGlzLnR0LndyYXBwZXJPcHRzfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApXG4gICAgICAgIH0pfVxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgaW5wdXREZWZhdWx0VmFsdWUgKCkge1xuICAgIGNvbnN0IHthdHRyaWJ1dGUsIGRlZmF1bHRWYWx1ZSwgbW9kZWx9ID0gdGhpcy5wcm9wc1xuXG4gICAgaWYgKGRlZmF1bHRWYWx1ZSkge1xuICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZVxuICAgIH0gZWxzZSBpZiAoYXR0cmlidXRlICYmIG1vZGVsKSB7XG4gICAgICBpZiAoIW1vZGVsW2F0dHJpYnV0ZV0pIHRocm93IG5ldyBFcnJvcihgTm8gc3VjaCBhdHRyaWJ1dGU6ICR7YXR0cmlidXRlfWApXG5cbiAgICAgIHJldHVybiB0aGlzLnByb3BzLm1vZGVsW2F0dHJpYnV0ZV0oKVxuICAgIH1cbiAgfVxuXG4gIGlucHV0Q2hlY2tib3hDbGFzc05hbWUgKCkge1xuICAgIGNvbnN0IGNsYXNzTmFtZXMgPSBbXVxuXG4gICAgaWYgKHRoaXMudHQud3JhcHBlck9wdHMuZXJyb3JzLmxlbmd0aCA+IDApIGNsYXNzTmFtZXMucHVzaChcImlzLWludmFsaWRcIilcblxuICAgIHJldHVybiBjbGFzc05hbWVzLmpvaW4oXCIgXCIpXG4gIH1cblxuICBpbnB1dE5hbWUgKCkge1xuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJldHVybiBgJHt0aGlzLnByb3BzLm5hbWV9W11gXG4gICAgfSBlbHNlIGlmICh0aGlzLnByb3BzLm1vZGVsKSB7XG4gICAgICByZXR1cm4gYCR7dGhpcy5wcm9wcy5tb2RlbC5tb2RlbENsYXNzRGF0YSgpLnBhcmFtS2V5fVske2luZmxlY3Rpb24udW5kZXJzY29yZSh0aGlzLnByb3BzLmF0dHJpYnV0ZSl9XWBcbiAgICB9XG4gIH1cblxuICBpc0RlZmF1bHRTZWxlY3RlZCAob3B0aW9uKSB7XG4gICAgbGV0IGRlZmF1bHRWYWx1ZSA9IHRoaXMuaW5wdXREZWZhdWx0VmFsdWUoKVxuXG4gICAgaWYgKCFkZWZhdWx0VmFsdWUpIHJldHVybiBmYWxzZVxuXG4gICAgaWYgKGRlZmF1bHRWYWx1ZS5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHtcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWUuaW5jbHVkZXMob3B0aW9uKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGVmYXVsdFZhbHVlID09IG9wdGlvblxuICAgIH1cbiAgfVxuXG4gIGxhYmVsQ2xhc3NOYW1lICgpIHtcbiAgICBjb25zdCBjbGFzc05hbWVzID0gW11cblxuICAgIGlmICh0aGlzLnByb3BzLmxhYmVsQ2xhc3NOYW1lKSBjbGFzc05hbWVzLnB1c2godGhpcy5wcm9wcy5sYWJlbENsYXNzTmFtZSlcblxuICAgIHJldHVybiBjbGFzc05hbWVzLmpvaW4oXCIgXCIpXG4gIH1cblxuICBvbk9wdGlvbkNoZWNrZWQgPSAoe2V2ZW50LCBvcHRpb259KSA9PiB7XG4gICAgY29uc3Qge2lucHV0UHJvcHMsIGZvcm19ID0gdGhpcy50dFxuICAgIGNvbnN0IHtuYW1lfSA9IGlucHV0UHJvcHNcbiAgICBjb25zdCBjaGVja2VkID0gZXZlbnQudGFyZ2V0LmNoZWNrZWRcbiAgICBsZXQgbmV3T3B0aW9uc1xuXG4gICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgIG5ld09wdGlvbnMgPSB0aGlzLnMuY2hlY2tlZE9wdGlvbnMuY29uY2F0KFtvcHRpb25bMV1dKVxuXG4gICAgICB0aGlzLnNldFN0YXRlKHtjaGVja2VkT3B0aW9uczogbmV3T3B0aW9uc30pXG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld09wdGlvbnMgPSB0aGlzLnMuY2hlY2tlZE9wdGlvbnMuZmlsdGVyKCh2YWx1ZSkgPT4gdmFsdWUgIT0gb3B0aW9uWzFdKVxuXG4gICAgICB0aGlzLnNldFN0YXRlKHtjaGVja2VkT3B0aW9uczogbmV3T3B0aW9uc30pXG4gICAgfVxuXG4gICAgaWYgKGZvcm0gJiYgbmFtZSkge1xuICAgICAgZm9ybS5zZXRWYWx1ZShuYW1lLCBuZXdPcHRpb25zKVxuICAgIH1cbiAgfVxufSkpXG4iXX0=