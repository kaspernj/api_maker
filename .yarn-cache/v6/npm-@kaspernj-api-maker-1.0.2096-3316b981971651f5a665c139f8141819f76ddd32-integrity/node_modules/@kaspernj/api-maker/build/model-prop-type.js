/* eslint-disable max-depth */
import * as inflection from "inflection";
import { digg } from "diggerize";
export default class ApiMakerModelPropType {
    static ofModel(modelClass) {
        const modelPropTypeInstance = new ApiMakerModelPropType();
        modelPropTypeInstance.withModelType(modelClass);
        return modelPropTypeInstance;
    }
    constructor() {
        this.isNotRequired = this.isNotRequired.bind(this);
        this.isRequired = this.isRequired.bind(this);
        this._withLoadedAssociations = {};
    }
    isNotRequired(props, propName, _componentName) {
        const model = props[propName];
        if (model) {
            return this.validate({ model, propName });
        }
    }
    isRequired(props, propName, _componentName) {
        const model = props[propName];
        if (!model)
            return new Error(`${propName} was required but not given`);
        return this.validate({ model, propName });
    }
    previous() {
        if (!this._previousModelPropType)
            throw new Error("No previous model prop type set");
        return this._previousModelPropType;
    }
    setPreviousModelPropType(previousModelPropType) {
        this._previousModelPropType = previousModelPropType;
    }
    withModelType(modelClass) {
        this._withModelType = modelClass;
    }
    validate({ model, propName }) {
        if (this._withModelType && this._withModelType.name != model.constructor.name)
            return new Error(`Expected ${propName} to be of type ${this._withModelType.name} but it wasn't: ${model.constructor.name}`);
        if (this._withLoadedAbilities) {
            for (const abilityName of this._withLoadedAbilities) {
                const underscoreAbilityName = inflection.underscore(abilityName);
                if (!(underscoreAbilityName in model.abilities))
                    return new Error(`The ability ${abilityName} was required to be loaded in ${propName} of the ${model.constructor.name} type but it wasn't`);
            }
        }
        if (this._withLoadedAssociations) {
            for (const associationName in this._withLoadedAssociations) {
                const associationModelPropType = digg(this._withLoadedAssociations, associationName);
                const underscoreAssociationName = inflection.underscore(associationName);
                if (!(underscoreAssociationName in model.relationshipsCache))
                    return new Error(`The association ${associationName} was required to be loaded in ${propName} of the ${model.constructor.name} type but it wasn't`);
                const associationCache = digg(model.relationshipsCache, underscoreAssociationName);
                // Find a model to run sub-model-prop-type-validations on
                if (Array.isArray(associationCache)) {
                    for (const preloadedModel of associationCache) {
                        const validationResult = associationModelPropType.validate({
                            model: preloadedModel,
                            propName: `${propName}.${associationName}`
                        });
                        if (validationResult)
                            return validationResult;
                    }
                }
                else if (associationCache) {
                    const validationResult = associationModelPropType.validate({
                        model: associationCache,
                        propName: `${propName}.${associationName}`
                    });
                    if (validationResult)
                        return validationResult;
                }
            }
        }
        if (this._withLoadedAttributes && model.isPersisted()) {
            for (const attributeName of this._withLoadedAttributes) {
                const underscoreAttributeName = inflection.underscore(attributeName);
                if (!(underscoreAttributeName in model.modelData)) {
                    return new Error(`The attribute ${attributeName} was required to be loaded in ${propName} of the ${model.constructor.name} type but it wasn't`);
                }
            }
        }
    }
    withLoadedAbilities(arrayOfAbilities) {
        this._withLoadedAbilities = arrayOfAbilities;
        return this;
    }
    withLoadedAssociation(associationName) {
        const associationModelPropType = new ApiMakerModelPropType();
        associationModelPropType.setPreviousModelPropType(this);
        this._withLoadedAssociations[associationName] = associationModelPropType;
        return associationModelPropType;
    }
    withLoadedAttributes(arrayOfAttributes) {
        this._withLoadedAttributes = arrayOfAttributes;
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwtcHJvcC10eXBlLmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJtb2RlbC1wcm9wLXR5cGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsOEJBQThCO0FBQzlCLE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFFOUIsTUFBTSxDQUFDLE9BQU8sT0FBTyxxQkFBcUI7SUFDeEMsTUFBTSxDQUFDLE9BQU8sQ0FBRSxVQUFVO1FBQ3hCLE1BQU0scUJBQXFCLEdBQUcsSUFBSSxxQkFBcUIsRUFBRSxDQUFBO1FBRXpELHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUUvQyxPQUFPLHFCQUFxQixDQUFBO0lBQzlCLENBQUM7SUFFRDtRQUNFLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFBO0lBQ25DLENBQUM7SUFFRCxhQUFhLENBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxjQUFjO1FBQzVDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUU3QixJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUMsS0FBSyxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUE7UUFDekMsQ0FBQztJQUNILENBQUM7SUFFRCxVQUFVLENBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxjQUFjO1FBQ3pDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUU3QixJQUFJLENBQUMsS0FBSztZQUFFLE9B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QUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG1heC1kZXB0aCAqL1xuaW1wb3J0ICogYXMgaW5mbGVjdGlvbiBmcm9tIFwiaW5mbGVjdGlvblwiXG5pbXBvcnQge2RpZ2d9IGZyb20gXCJkaWdnZXJpemVcIlxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcGlNYWtlck1vZGVsUHJvcFR5cGUge1xuICBzdGF0aWMgb2ZNb2RlbCAobW9kZWxDbGFzcykge1xuICAgIGNvbnN0IG1vZGVsUHJvcFR5cGVJbnN0YW5jZSA9IG5ldyBBcGlNYWtlck1vZGVsUHJvcFR5cGUoKVxuXG4gICAgbW9kZWxQcm9wVHlwZUluc3RhbmNlLndpdGhNb2RlbFR5cGUobW9kZWxDbGFzcylcblxuICAgIHJldHVybiBtb2RlbFByb3BUeXBlSW5zdGFuY2VcbiAgfVxuXG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICB0aGlzLmlzTm90UmVxdWlyZWQgPSB0aGlzLmlzTm90UmVxdWlyZWQuYmluZCh0aGlzKVxuICAgIHRoaXMuaXNSZXF1aXJlZCA9IHRoaXMuaXNSZXF1aXJlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5fd2l0aExvYWRlZEFzc29jaWF0aW9ucyA9IHt9XG4gIH1cblxuICBpc05vdFJlcXVpcmVkIChwcm9wcywgcHJvcE5hbWUsIF9jb21wb25lbnROYW1lKSB7XG4gICAgY29uc3QgbW9kZWwgPSBwcm9wc1twcm9wTmFtZV1cblxuICAgIGlmIChtb2RlbCkge1xuICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGUoe21vZGVsLCBwcm9wTmFtZX0pXG4gICAgfVxuICB9XG5cbiAgaXNSZXF1aXJlZCAocHJvcHMsIHByb3BOYW1lLCBfY29tcG9uZW50TmFtZSkge1xuICAgIGNvbnN0IG1vZGVsID0gcHJvcHNbcHJvcE5hbWVdXG5cbiAgICBpZiAoIW1vZGVsKSByZXR1cm4gbmV3IEVycm9yKGAke3Byb3BOYW1lfSB3YXMgcmVxdWlyZWQgYnV0IG5vdCBnaXZlbmApXG5cbiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZSh7bW9kZWwsIHByb3BOYW1lfSlcbiAgfVxuXG4gIHByZXZpb3VzICgpIHtcbiAgICBpZiAoIXRoaXMuX3ByZXZpb3VzTW9kZWxQcm9wVHlwZSkgdGhyb3cgbmV3IEVycm9yKFwiTm8gcHJldmlvdXMgbW9kZWwgcHJvcCB0eXBlIHNldFwiKVxuXG4gICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzTW9kZWxQcm9wVHlwZVxuICB9XG5cbiAgc2V0UHJldmlvdXNNb2RlbFByb3BUeXBlIChwcmV2aW91c01vZGVsUHJvcFR5cGUpIHtcbiAgICB0aGlzLl9wcmV2aW91c01vZGVsUHJvcFR5cGUgPSBwcmV2aW91c01vZGVsUHJvcFR5cGVcbiAgfVxuXG4gIHdpdGhNb2RlbFR5cGUgKG1vZGVsQ2xhc3MpIHtcbiAgICB0aGlzLl93aXRoTW9kZWxUeXBlID0gbW9kZWxDbGFzc1xuICB9XG5cbiAgdmFsaWRhdGUgKHttb2RlbCwgcHJvcE5hbWV9KSB7XG4gICAgaWYgKHRoaXMuX3dpdGhNb2RlbFR5cGUgJiYgdGhpcy5fd2l0aE1vZGVsVHlwZS5uYW1lICE9IG1vZGVsLmNvbnN0cnVjdG9yLm5hbWUpXG4gICAgICByZXR1cm4gbmV3IEVycm9yKGBFeHBlY3RlZCAke3Byb3BOYW1lfSB0byBiZSBvZiB0eXBlICR7dGhpcy5fd2l0aE1vZGVsVHlwZS5uYW1lfSBidXQgaXQgd2Fzbid0OiAke21vZGVsLmNvbnN0cnVjdG9yLm5hbWV9YClcblxuICAgIGlmICh0aGlzLl93aXRoTG9hZGVkQWJpbGl0aWVzKSB7XG4gICAgICBmb3IgKGNvbnN0IGFiaWxpdHlOYW1lIG9mIHRoaXMuX3dpdGhMb2FkZWRBYmlsaXRpZXMpIHtcbiAgICAgICAgY29uc3QgdW5kZXJzY29yZUFiaWxpdHlOYW1lID0gaW5mbGVjdGlvbi51bmRlcnNjb3JlKGFiaWxpdHlOYW1lKVxuXG4gICAgICAgIGlmICghKHVuZGVyc2NvcmVBYmlsaXR5TmFtZSBpbiBtb2RlbC5hYmlsaXRpZXMpKVxuICAgICAgICAgIHJldHVybiBuZXcgRXJyb3IoYFRoZSBhYmlsaXR5ICR7YWJpbGl0eU5hbWV9IHdhcyByZXF1aXJlZCB0byBiZSBsb2FkZWQgaW4gJHtwcm9wTmFtZX0gb2YgdGhlICR7bW9kZWwuY29uc3RydWN0b3IubmFtZX0gdHlwZSBidXQgaXQgd2Fzbid0YClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5fd2l0aExvYWRlZEFzc29jaWF0aW9ucykge1xuICAgICAgZm9yIChjb25zdCBhc3NvY2lhdGlvbk5hbWUgaW4gdGhpcy5fd2l0aExvYWRlZEFzc29jaWF0aW9ucykge1xuICAgICAgICBjb25zdCBhc3NvY2lhdGlvbk1vZGVsUHJvcFR5cGUgPSBkaWdnKHRoaXMuX3dpdGhMb2FkZWRBc3NvY2lhdGlvbnMsIGFzc29jaWF0aW9uTmFtZSlcbiAgICAgICAgY29uc3QgdW5kZXJzY29yZUFzc29jaWF0aW9uTmFtZSA9IGluZmxlY3Rpb24udW5kZXJzY29yZShhc3NvY2lhdGlvbk5hbWUpXG5cbiAgICAgICAgaWYgKCEodW5kZXJzY29yZUFzc29jaWF0aW9uTmFtZSBpbiBtb2RlbC5yZWxhdGlvbnNoaXBzQ2FjaGUpKVxuICAgICAgICAgIHJldHVybiBuZXcgRXJyb3IoYFRoZSBhc3NvY2lhdGlvbiAke2Fzc29jaWF0aW9uTmFtZX0gd2FzIHJlcXVpcmVkIHRvIGJlIGxvYWRlZCBpbiAke3Byb3BOYW1lfSBvZiB0aGUgJHttb2RlbC5jb25zdHJ1Y3Rvci5uYW1lfSB0eXBlIGJ1dCBpdCB3YXNuJ3RgKVxuXG4gICAgICAgIGNvbnN0IGFzc29jaWF0aW9uQ2FjaGUgPSBkaWdnKG1vZGVsLnJlbGF0aW9uc2hpcHNDYWNoZSwgdW5kZXJzY29yZUFzc29jaWF0aW9uTmFtZSlcblxuICAgICAgICAvLyBGaW5kIGEgbW9kZWwgdG8gcnVuIHN1Yi1tb2RlbC1wcm9wLXR5cGUtdmFsaWRhdGlvbnMgb25cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXNzb2NpYXRpb25DYWNoZSkpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IHByZWxvYWRlZE1vZGVsIG9mIGFzc29jaWF0aW9uQ2FjaGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBhc3NvY2lhdGlvbk1vZGVsUHJvcFR5cGUudmFsaWRhdGUoe1xuICAgICAgICAgICAgICBtb2RlbDogcHJlbG9hZGVkTW9kZWwsXG4gICAgICAgICAgICAgIHByb3BOYW1lOiBgJHtwcm9wTmFtZX0uJHthc3NvY2lhdGlvbk5hbWV9YFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHQpIHJldHVybiB2YWxpZGF0aW9uUmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGFzc29jaWF0aW9uQ2FjaGUpIHtcbiAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gYXNzb2NpYXRpb25Nb2RlbFByb3BUeXBlLnZhbGlkYXRlKHtcbiAgICAgICAgICAgIG1vZGVsOiBhc3NvY2lhdGlvbkNhY2hlLFxuICAgICAgICAgICAgcHJvcE5hbWU6IGAke3Byb3BOYW1lfS4ke2Fzc29jaWF0aW9uTmFtZX1gXG4gICAgICAgICAgfSlcblxuICAgICAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0KSByZXR1cm4gdmFsaWRhdGlvblJlc3VsdFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3dpdGhMb2FkZWRBdHRyaWJ1dGVzICYmIG1vZGVsLmlzUGVyc2lzdGVkKCkpIHtcbiAgICAgIGZvciAoY29uc3QgYXR0cmlidXRlTmFtZSBvZiB0aGlzLl93aXRoTG9hZGVkQXR0cmlidXRlcykge1xuICAgICAgICBjb25zdCB1bmRlcnNjb3JlQXR0cmlidXRlTmFtZSA9IGluZmxlY3Rpb24udW5kZXJzY29yZShhdHRyaWJ1dGVOYW1lKVxuXG4gICAgICAgIGlmICghKHVuZGVyc2NvcmVBdHRyaWJ1dGVOYW1lIGluIG1vZGVsLm1vZGVsRGF0YSkpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKGBUaGUgYXR0cmlidXRlICR7YXR0cmlidXRlTmFtZX0gd2FzIHJlcXVpcmVkIHRvIGJlIGxvYWRlZCBpbiAke3Byb3BOYW1lfSBvZiB0aGUgJHttb2RlbC5jb25zdHJ1Y3Rvci5uYW1lfSB0eXBlIGJ1dCBpdCB3YXNuJ3RgKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgd2l0aExvYWRlZEFiaWxpdGllcyAoYXJyYXlPZkFiaWxpdGllcykge1xuICAgIHRoaXMuX3dpdGhMb2FkZWRBYmlsaXRpZXMgPSBhcnJheU9mQWJpbGl0aWVzXG5cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgd2l0aExvYWRlZEFzc29jaWF0aW9uIChhc3NvY2lhdGlvbk5hbWUpIHtcbiAgICBjb25zdCBhc3NvY2lhdGlvbk1vZGVsUHJvcFR5cGUgPSBuZXcgQXBpTWFrZXJNb2RlbFByb3BUeXBlKClcblxuICAgIGFzc29jaWF0aW9uTW9kZWxQcm9wVHlwZS5zZXRQcmV2aW91c01vZGVsUHJvcFR5cGUodGhpcylcbiAgICB0aGlzLl93aXRoTG9hZGVkQXNzb2NpYXRpb25zW2Fzc29jaWF0aW9uTmFtZV0gPSBhc3NvY2lhdGlvbk1vZGVsUHJvcFR5cGVcblxuICAgIHJldHVybiBhc3NvY2lhdGlvbk1vZGVsUHJvcFR5cGVcbiAgfVxuXG4gIHdpdGhMb2FkZWRBdHRyaWJ1dGVzIChhcnJheU9mQXR0cmlidXRlcykge1xuICAgIHRoaXMuX3dpdGhMb2FkZWRBdHRyaWJ1dGVzID0gYXJyYXlPZkF0dHJpYnV0ZXNcblxuICAgIHJldHVybiB0aGlzXG4gIH1cbn1cbiJdfQ==