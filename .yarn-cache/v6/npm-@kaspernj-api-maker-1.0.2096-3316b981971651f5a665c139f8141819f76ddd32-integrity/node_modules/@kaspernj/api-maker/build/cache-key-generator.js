import SparkMD5 from "spark-md5";
export default class CacheKeyGenerator {
    constructor(model) {
        this.model = model;
        this.allModels = [model];
        this.readModels = {};
        this.recordModelType(model.modelClassData().name);
        this.recordModel(model.modelClassData().name, model);
        this.filledModels = false;
    }
    local() {
        const md5 = new SparkMD5();
        this.feedModel(this.model, md5);
        return md5.end();
    }
    recordModelType(relationshipType) {
        if (!(relationshipType in this.readModels)) {
            this.readModels[relationshipType] = {};
        }
    }
    recordModel(relationshipType, model) {
        this.allModels.push(model);
        this.readModels[relationshipType][model.id() || model.uniqueKey()] = true;
    }
    isModelRecorded(relationshipType, model) {
        if (model.id() in this.readModels[relationshipType]) {
            return true;
        }
    }
    fillModels(model) {
        for (const relationshipType in model.relationships) {
            this.recordModelType(relationshipType);
            const loadedRelationship = model.relationships[relationshipType];
            if (Array.isArray(loadedRelationship)) { // has_many
                for (const anotherModel of loadedRelationship) {
                    if (!this.isModelRecorded(relationshipType, anotherModel)) {
                        this.recordModel(relationshipType, anotherModel);
                        this.fillModels(anotherModel);
                    }
                }
            }
            else if (loadedRelationship) { // belongs_to, has_one
                if (!this.isModelRecorded(relationshipType, loadedRelationship)) {
                    this.recordModel(relationshipType, loadedRelationship);
                    this.fillModels(loadedRelationship);
                }
            }
        }
        this.filledModels = true;
    }
    cacheKey() {
        if (!this.filledModels) {
            this.fillModels(this.model);
        }
        const md5 = new SparkMD5();
        for (const model of this.allModels) {
            this.feedModel(model, md5);
        }
        return md5.end();
    }
    feedModel(model, md5) {
        md5.append("--model--");
        md5.append(model.modelClassData().name);
        md5.append("--unique-key--");
        md5.append(model.id() || model.uniqueKey());
        if (model.markedForDestruction()) {
            md5.append("--marked-for-destruction--");
        }
        md5.append("-attributes-");
        const attributes = model.attributes();
        for (const attributeName in attributes) {
            md5.append(attributeName);
            md5.append("--attribute--");
            md5.append(`${model.readAttributeUnderscore(attributeName)}`);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUta2V5LWdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIvc3JjLyIsInNvdXJjZXMiOlsiY2FjaGUta2V5LWdlbmVyYXRvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFFBQVEsTUFBTSxXQUFXLENBQUE7QUFFaEMsTUFBTSxDQUFDLE9BQU8sT0FBTyxpQkFBaUI7SUFDcEMsWUFBWSxLQUFLO1FBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNwRCxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQTtJQUMzQixDQUFDO0lBRUQsS0FBSztRQUNILE1BQU0sR0FBRyxHQUFHLElBQUksUUFBUSxFQUFFLENBQUE7UUFFMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBRS9CLE9BQU8sR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLENBQUM7SUFFRCxlQUFlLENBQUMsZ0JBQWdCO1FBQzlCLElBQUksQ0FBQyxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQzNDLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLENBQUE7UUFDeEMsQ0FBQztJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsS0FBSztRQUNqQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFL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Q0FBQTtRQUVyQyxLQUFLLE1BQU0sYUFBYSxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ3ZDLEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUE7WUFDekIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUMzQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUMvRCxDQUFDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNwYXJrTUQ1IGZyb20gXCJzcGFyay1tZDVcIlxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYWNoZUtleUdlbmVyYXRvciB7XG4gIGNvbnN0cnVjdG9yKG1vZGVsKSB7XG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsXG4gICAgdGhpcy5hbGxNb2RlbHMgPSBbbW9kZWxdXG4gICAgdGhpcy5yZWFkTW9kZWxzID0ge31cbiAgICB0aGlzLnJlY29yZE1vZGVsVHlwZShtb2RlbC5tb2RlbENsYXNzRGF0YSgpLm5hbWUpXG4gICAgdGhpcy5yZWNvcmRNb2RlbChtb2RlbC5tb2RlbENsYXNzRGF0YSgpLm5hbWUsIG1vZGVsKVxuICAgIHRoaXMuZmlsbGVkTW9kZWxzID0gZmFsc2VcbiAgfVxuXG4gIGxvY2FsKCkge1xuICAgIGNvbnN0IG1kNSA9IG5ldyBTcGFya01ENSgpXG5cbiAgICB0aGlzLmZlZWRNb2RlbCh0aGlzLm1vZGVsLCBtZDUpXG5cbiAgICByZXR1cm4gbWQ1LmVuZCgpXG4gIH1cblxuICByZWNvcmRNb2RlbFR5cGUocmVsYXRpb25zaGlwVHlwZSkge1xuICAgIGlmICghKHJlbGF0aW9uc2hpcFR5cGUgaW4gdGhpcy5yZWFkTW9kZWxzKSkge1xuICAgICAgdGhpcy5yZWFkTW9kZWxzW3JlbGF0aW9uc2hpcFR5cGVdID0ge31cbiAgICB9XG4gIH1cblxuICByZWNvcmRNb2RlbChyZWxhdGlvbnNoaXBUeXBlLCBtb2RlbCkge1xuICAgIHRoaXMuYWxsTW9kZWxzLnB1c2gobW9kZWwpXG4gICAgdGhpcy5yZWFkTW9kZWxzW3JlbGF0aW9uc2hpcFR5cGVdW21vZGVsLmlkKCkgfHwgbW9kZWwudW5pcXVlS2V5KCldID0gdHJ1ZVxuICB9XG5cbiAgaXNNb2RlbFJlY29yZGVkKHJlbGF0aW9uc2hpcFR5cGUsIG1vZGVsKSB7XG4gICAgaWYgKG1vZGVsLmlkKCkgaW4gdGhpcy5yZWFkTW9kZWxzW3JlbGF0aW9uc2hpcFR5cGVdKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgfVxuXG4gIGZpbGxNb2RlbHMobW9kZWwpIHtcbiAgICBmb3IgKGNvbnN0IHJlbGF0aW9uc2hpcFR5cGUgaW4gbW9kZWwucmVsYXRpb25zaGlwcykge1xuICAgICAgdGhpcy5yZWNvcmRNb2RlbFR5cGUocmVsYXRpb25zaGlwVHlwZSlcblxuICAgICAgY29uc3QgbG9hZGVkUmVsYXRpb25zaGlwID0gbW9kZWwucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBUeXBlXVxuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShsb2FkZWRSZWxhdGlvbnNoaXApKSB7IC8vIGhhc19tYW55XG4gICAgICAgIGZvciAoY29uc3QgYW5vdGhlck1vZGVsIG9mIGxvYWRlZFJlbGF0aW9uc2hpcCkge1xuICAgICAgICAgIGlmICghdGhpcy5pc01vZGVsUmVjb3JkZWQocmVsYXRpb25zaGlwVHlwZSwgYW5vdGhlck1vZGVsKSkge1xuICAgICAgICAgICAgdGhpcy5yZWNvcmRNb2RlbChyZWxhdGlvbnNoaXBUeXBlLCBhbm90aGVyTW9kZWwpXG4gICAgICAgICAgICB0aGlzLmZpbGxNb2RlbHMoYW5vdGhlck1vZGVsKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChsb2FkZWRSZWxhdGlvbnNoaXApIHsgLy8gYmVsb25nc190bywgaGFzX29uZVxuICAgICAgICBpZiAoIXRoaXMuaXNNb2RlbFJlY29yZGVkKHJlbGF0aW9uc2hpcFR5cGUsIGxvYWRlZFJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICB0aGlzLnJlY29yZE1vZGVsKHJlbGF0aW9uc2hpcFR5cGUsIGxvYWRlZFJlbGF0aW9uc2hpcClcbiAgICAgICAgICB0aGlzLmZpbGxNb2RlbHMobG9hZGVkUmVsYXRpb25zaGlwKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5maWxsZWRNb2RlbHMgPSB0cnVlXG4gIH1cblxuICBjYWNoZUtleSgpIHtcbiAgICBpZiAoIXRoaXMuZmlsbGVkTW9kZWxzKSB7XG4gICAgICB0aGlzLmZpbGxNb2RlbHModGhpcy5tb2RlbClcbiAgICB9XG5cbiAgICBjb25zdCBtZDUgPSBuZXcgU3BhcmtNRDUoKVxuXG4gICAgZm9yIChjb25zdCBtb2RlbCBvZiB0aGlzLmFsbE1vZGVscykge1xuICAgICAgdGhpcy5mZWVkTW9kZWwobW9kZWwsIG1kNSlcbiAgICB9XG5cbiAgICByZXR1cm4gbWQ1LmVuZCgpXG4gIH1cblxuICBmZWVkTW9kZWwobW9kZWwsIG1kNSkge1xuICAgIG1kNS5hcHBlbmQoXCItLW1vZGVsLS1cIilcbiAgICBtZDUuYXBwZW5kKG1vZGVsLm1vZGVsQ2xhc3NEYXRhKCkubmFtZSlcbiAgICBtZDUuYXBwZW5kKFwiLS11bmlxdWUta2V5LS1cIilcbiAgICBtZDUuYXBwZW5kKG1vZGVsLmlkKCkgfHwgbW9kZWwudW5pcXVlS2V5KCkpXG5cbiAgICBpZiAobW9kZWwubWFya2VkRm9yRGVzdHJ1Y3Rpb24oKSkge1xuICAgICAgbWQ1LmFwcGVuZChcIi0tbWFya2VkLWZvci1kZXN0cnVjdGlvbi0tXCIpXG4gICAgfVxuXG4gICAgbWQ1LmFwcGVuZChcIi1hdHRyaWJ1dGVzLVwiKVxuXG4gICAgY29uc3QgYXR0cmlidXRlcyA9IG1vZGVsLmF0dHJpYnV0ZXMoKVxuXG4gICAgZm9yIChjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgIG1kNS5hcHBlbmQoYXR0cmlidXRlTmFtZSlcbiAgICAgIG1kNS5hcHBlbmQoXCItLWF0dHJpYnV0ZS0tXCIpXG4gICAgICBtZDUuYXBwZW5kKGAke21vZGVsLnJlYWRBdHRyaWJ1dGVVbmRlcnNjb3JlKGF0dHJpYnV0ZU5hbWUpfWApXG4gICAgfVxuICB9XG59XG4iXX0=