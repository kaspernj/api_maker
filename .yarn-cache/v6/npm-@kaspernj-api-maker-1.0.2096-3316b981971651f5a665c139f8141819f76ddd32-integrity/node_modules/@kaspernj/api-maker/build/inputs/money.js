import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
/* eslint-disable sort-imports */
import * as inflection from "inflection";
import { ShapeComponent, shapeComponent } from "set-state-compare/build/shape-component.js";
import { digg } from "diggerize";
import Config from "../config.js";
import MoneyFormatter from "../money-formatter.js";
import PropTypes from "prop-types";
import PropTypesExact from "prop-types-exact";
import React, { useRef } from "react";
import classNames from "classnames"; // eslint-disable-line import/no-unresolved
import idForComponent from "./id-for-component.js";
import memo from "set-state-compare/build/memo.js";
export default memo(shapeComponent(class ApiMakerInputsMoney extends ShapeComponent {
    static defaultProps = {
        disabled: false,
        showCurrencyOptions: true
    };
    static propTypes = PropTypesExact({
        attribute: PropTypes.string,
        centsInputName: PropTypes.string,
        className: PropTypes.string,
        currenciesCollection: PropTypes.array,
        currencyName: PropTypes.string,
        currencyRef: PropTypes.object,
        defaultValue: PropTypes.object,
        disabled: PropTypes.bool.isRequired,
        id: PropTypes.string,
        inputRef: PropTypes.object,
        label: PropTypes.any,
        model: PropTypes.object,
        name: PropTypes.string,
        onChange: PropTypes.func,
        placeholder: PropTypes.any,
        showCurrencyOptions: PropTypes.bool,
        small: PropTypes.bool,
        type: PropTypes.string,
        wholeRef: PropTypes.object
    });
    setup() {
        this.inputRef = useRef();
        this.currencyRefBackup = useRef();
        this.currencyRef = this.props.currencyRef || this.currencyRefBackup;
        this.wholeRefBackup = useRef();
        this.wholeRef = this.props.wholeRef || this.wholeRefBackup;
    }
    getInputRef = () => this.props.inputRef || this.inputRef;
    render() {
        const { attribute, className, disabled, model, showCurrencyOptions } = this.props;
        let { currenciesCollection } = this.props;
        if (!currenciesCollection)
            currenciesCollection = Config.getCurrenciesCollection();
        return (_jsxs("div", { className: "api-maker-inputs-money", "data-attribute": attribute, "data-model-id": model?.id(), children: [_jsx("input", { defaultValue: this.inputDefaultCentsValue(), id: this.inputCentsId(), name: this.inputCentsName(), ref: this.getInputRef(), type: "hidden" }), _jsx("input", { className: classNames("money-cents", className), defaultValue: this.inputDefaultValue(), disabled: disabled, id: this.inputId(), onBlur: this.tt.setAmount, onChange: this.tt.setCents, onKeyUp: this.tt.setCents, placeholder: this.props.placeholder, ref: this.tt.wholeRef, type: "text" }), showCurrencyOptions &&
                    _jsxs("select", { className: "money-currency", defaultValue: this.inputCurrencyValue(), disabled: disabled, id: this.inputCurrencyId(), name: this.inputCurrencyName(), onChange: this.tt.onCurrencyChanged, ref: this.tt.currencyRef, children: [_jsx("option", {}), currenciesCollection.map((option) => ( // eslint-disable-line no-extra-parens
                            _jsxs("option", { value: option[1], children: [this.props.small && option[1], !this.props.small && option[0]] }, `select-option-${option[1]}`)))] })] }));
    }
    inputCurrencyId = () => `${this.inputId()}_currency`;
    inputCurrencyName() {
        if ("currencyName" in this.props)
            return this.props.currencyName;
        return `${this.props.model.modelClassData().paramKey}[${inflection.underscore(this.props.attribute)}_currency]`;
    }
    inputCurrencyValue() {
        const { defaultValue } = this.props;
        if (defaultValue) {
            return MoneyFormatter.currencyFromMoney(defaultValue).code;
        }
        else {
            return "DKK";
        }
    }
    inputDefaultValue() {
        const { defaultValue } = this.props;
        if (defaultValue) {
            return MoneyFormatter.fromMoney({ amount: defaultValue.amount, currency: this.inputCurrencyValue() }, { decimals: 2, excludeCurrency: true }).toString();
        }
        else {
            return "";
        }
    }
    inputDefaultCentsValue() {
        const { defaultValue } = this.props;
        if (this.getInputRef().current) {
            return digg(this.getInputRef(), "current", "value");
        }
        else if (defaultValue) {
            return MoneyFormatter.amountFromMoney(defaultValue);
        }
    }
    inputCentsId = () => `${this.inputId()}_cents`;
    inputCentsName() {
        if ("name" in this.props)
            return this.props.name;
        return `${this.props.model.modelClassData().paramKey}[${inflection.underscore(this.props.attribute)}_cents]`;
    }
    inputId = () => idForComponent(this);
    onCurrencyChanged = () => {
        if (this.props.onChange)
            this.props.onChange();
    };
    setAmount = () => {
        const inputElement = this.getInputRef().current;
        if (!inputElement)
            return;
        if (!inputElement.value && inputElement.value == "") {
            this.wholeRef.current.value = "";
        }
        else {
            const cents = parseFloat(inputElement.value);
            const formatted = MoneyFormatter.fromMoney({ amount: cents, currency: this.inputCurrencyValue() }, { decimals: 2, excludeCurrency: true }).toString();
            this.wholeRef.current.value = formatted;
        }
    };
    setCents = () => {
        const inputElement = this.getInputRef().current;
        if (!inputElement)
            return;
        let whole = MoneyFormatter.stringToFloat(this.wholeRef.current.value);
        let cents = parseInt(whole * 100, 10);
        let oldCents = parseInt(inputElement.value, 10);
        if (typeof cents == "number") {
            inputElement.value = cents;
        }
        else {
            inputElement.value = "";
        }
        if (this.props.onChange && oldCents != cents)
            this.props.onChange();
    };
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uZXkuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbImlucHV0cy9tb25leS5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGlDQUFpQztBQUNqQyxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLEVBQUMsY0FBYyxFQUFFLGNBQWMsRUFBQyxNQUFNLDRDQUE0QyxDQUFBO0FBQ3pGLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFDOUIsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sY0FBYyxNQUFNLHVCQUF1QixDQUFBO0FBQ2xELE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLGNBQWMsTUFBTSxrQkFBa0IsQ0FBQTtBQUM3QyxPQUFPLEtBQUssRUFBRSxFQUFDLE1BQU0sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUNuQyxPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUEsQ0FBQywyQ0FBMkM7QUFDL0UsT0FBTyxjQUFjLE1BQU0sdUJBQXVCLENBQUE7QUFDbEQsT0FBTyxJQUFJLE1BQU0saUNBQWlDLENBQUE7QUFFbEQsZUFBZSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sbUJBQW9CLFNBQVEsY0FBYztJQUNqRixNQUFNLENBQUMsWUFBWSxHQUFHO1FBQ3BCLFFBQVEsRUFBRSxLQUFLO1FBQ2YsbUJBQW1CLEVBQUUsSUFBSTtLQUMxQixDQUFBO0lBRUQsTUFBTSxDQUFDLFNBQVMsR0FBRyxjQUFjLENBQUM7UUFDaEMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxNQUFNO1FBQzNCLGNBQWMsRUFBRSxTQUFTLENBQUMsTUFBTTtRQUNoQyxTQUFTLEVBQUUsU0FBUyxDQUFDLE1BQU07UUFDM0Isb0JBQW9CLEVBQUUsU0FBUyxDQUFDLEtBQUs7UUFDckMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxNQUFNO1FBQzlCLFdBQVcsRUFBRSxTQUFTLENBQUMsTUFBTTtRQUM3QixZ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LE9BQU07UUFFekIsSUFBSSxLQUFLLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyRSxJQUFJLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyQyxJQUFJLFFBQVEsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUUvQyxJQUFJLE9BQU8sS0FBSyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQzdCLFlBQVksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQzVCLENBQUM7YUFBTSxDQUFDO1lBQ04sWUFBWSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7UUFDekIsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksUUFBUSxJQUFJLEtBQUs7WUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFBO0lBQ3JFLENBQUMsQ0FBQTtDQUNGLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgc29ydC1pbXBvcnRzICovXG5pbXBvcnQgKiBhcyBpbmZsZWN0aW9uIGZyb20gXCJpbmZsZWN0aW9uXCJcbmltcG9ydCB7U2hhcGVDb21wb25lbnQsIHNoYXBlQ29tcG9uZW50fSBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvc2hhcGUtY29tcG9uZW50LmpzXCJcbmltcG9ydCB7ZGlnZ30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuLi9jb25maWcuanNcIlxuaW1wb3J0IE1vbmV5Rm9ybWF0dGVyIGZyb20gXCIuLi9tb25leS1mb3JtYXR0ZXIuanNcIlxuaW1wb3J0IFByb3BUeXBlcyBmcm9tIFwicHJvcC10eXBlc1wiXG5pbXBvcnQgUHJvcFR5cGVzRXhhY3QgZnJvbSBcInByb3AtdHlwZXMtZXhhY3RcIlxuaW1wb3J0IFJlYWN0LCB7dXNlUmVmfSBmcm9tIFwicmVhY3RcIlxuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgaWRGb3JDb21wb25lbnQgZnJvbSBcIi4vaWQtZm9yLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG5cbmV4cG9ydCBkZWZhdWx0IG1lbW8oc2hhcGVDb21wb25lbnQoY2xhc3MgQXBpTWFrZXJJbnB1dHNNb25leSBleHRlbmRzIFNoYXBlQ29tcG9uZW50IHtcbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgc2hvd0N1cnJlbmN5T3B0aW9uczogdHJ1ZVxuICB9XG5cbiAgc3RhdGljIHByb3BUeXBlcyA9IFByb3BUeXBlc0V4YWN0KHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuZXctY2FwXG4gICAgYXR0cmlidXRlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNlbnRzSW5wdXROYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjdXJyZW5jaWVzQ29sbGVjdGlvbjogUHJvcFR5cGVzLmFycmF5LFxuICAgIGN1cnJlbmN5TmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjdXJyZW5jeVJlZjogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBkZWZhdWx0VmFsdWU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgaWQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgaW5wdXRSZWY6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgbGFiZWw6IFByb3BUeXBlcy5hbnksXG4gICAgbW9kZWw6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgbmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgcGxhY2Vob2xkZXI6IFByb3BUeXBlcy5hbnksXG4gICAgc2hvd0N1cnJlbmN5T3B0aW9uczogUHJvcFR5cGVzLmJvb2wsXG4gICAgc21hbGw6IFByb3BUeXBlcy5ib29sLFxuICAgIHR5cGU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgd2hvbGVSZWY6IFByb3BUeXBlcy5vYmplY3RcbiAgfSlcblxuICBzZXR1cCgpIHtcbiAgICB0aGlzLmlucHV0UmVmID0gdXNlUmVmKClcbiAgICB0aGlzLmN1cnJlbmN5UmVmQmFja3VwID0gdXNlUmVmKClcbiAgICB0aGlzLmN1cnJlbmN5UmVmID0gdGhpcy5wcm9wcy5jdXJyZW5jeVJlZiB8fCB0aGlzLmN1cnJlbmN5UmVmQmFja3VwXG4gICAgdGhpcy53aG9sZVJlZkJhY2t1cCA9IHVzZVJlZigpXG4gICAgdGhpcy53aG9sZVJlZiA9IHRoaXMucHJvcHMud2hvbGVSZWYgfHwgdGhpcy53aG9sZVJlZkJhY2t1cFxuICB9XG5cbiAgZ2V0SW5wdXRSZWYgPSAoKSA9PiB0aGlzLnByb3BzLmlucHV0UmVmIHx8IHRoaXMuaW5wdXRSZWZcblxuICByZW5kZXIgKCkge1xuICAgIGNvbnN0IHthdHRyaWJ1dGUsIGNsYXNzTmFtZSwgZGlzYWJsZWQsIG1vZGVsLCBzaG93Q3VycmVuY3lPcHRpb25zfSA9IHRoaXMucHJvcHNcbiAgICBsZXQge2N1cnJlbmNpZXNDb2xsZWN0aW9ufSA9IHRoaXMucHJvcHNcblxuICAgIGlmICghY3VycmVuY2llc0NvbGxlY3Rpb24pIGN1cnJlbmNpZXNDb2xsZWN0aW9uID0gQ29uZmlnLmdldEN1cnJlbmNpZXNDb2xsZWN0aW9uKClcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImFwaS1tYWtlci1pbnB1dHMtbW9uZXlcIiBkYXRhLWF0dHJpYnV0ZT17YXR0cmlidXRlfSBkYXRhLW1vZGVsLWlkPXttb2RlbD8uaWQoKX0+XG4gICAgICAgIDxpbnB1dCBkZWZhdWx0VmFsdWU9e3RoaXMuaW5wdXREZWZhdWx0Q2VudHNWYWx1ZSgpfSBpZD17dGhpcy5pbnB1dENlbnRzSWQoKX0gbmFtZT17dGhpcy5pbnB1dENlbnRzTmFtZSgpfSByZWY9e3RoaXMuZ2V0SW5wdXRSZWYoKX0gdHlwZT1cImhpZGRlblwiIC8+XG4gICAgICAgIDxpbnB1dFxuICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhcIm1vbmV5LWNlbnRzXCIsIGNsYXNzTmFtZSl9XG4gICAgICAgICAgZGVmYXVsdFZhbHVlPXt0aGlzLmlucHV0RGVmYXVsdFZhbHVlKCl9XG4gICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVkfVxuICAgICAgICAgIGlkPXt0aGlzLmlucHV0SWQoKX1cbiAgICAgICAgICBvbkJsdXI9e3RoaXMudHQuc2V0QW1vdW50fVxuICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLnR0LnNldENlbnRzfVxuICAgICAgICAgIG9uS2V5VXA9e3RoaXMudHQuc2V0Q2VudHN9XG4gICAgICAgICAgcGxhY2Vob2xkZXI9e3RoaXMucHJvcHMucGxhY2Vob2xkZXJ9XG4gICAgICAgICAgcmVmPXt0aGlzLnR0Lndob2xlUmVmfVxuICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgLz5cbiAgICAgICAge3Nob3dDdXJyZW5jeU9wdGlvbnMgJiZcbiAgICAgICAgICA8c2VsZWN0XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJtb25leS1jdXJyZW5jeVwiXG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU9e3RoaXMuaW5wdXRDdXJyZW5jeVZhbHVlKCl9XG4gICAgICAgICAgICBkaXNhYmxlZD17ZGlzYWJsZWR9XG4gICAgICAgICAgICBpZD17dGhpcy5pbnB1dEN1cnJlbmN5SWQoKX1cbiAgICAgICAgICAgIG5hbWU9e3RoaXMuaW5wdXRDdXJyZW5jeU5hbWUoKX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLnR0Lm9uQ3VycmVuY3lDaGFuZ2VkfVxuICAgICAgICAgICAgcmVmPXt0aGlzLnR0LmN1cnJlbmN5UmVmfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxvcHRpb24gLz5cbiAgICAgICAgICAgIHtjdXJyZW5jaWVzQ29sbGVjdGlvbi5tYXAoKG9wdGlvbikgPT4gKCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWV4dHJhLXBhcmVuc1xuICAgICAgICAgICAgICA8b3B0aW9uIGtleT17YHNlbGVjdC1vcHRpb24tJHtvcHRpb25bMV19YH0gdmFsdWU9e29wdGlvblsxXX0+XG4gICAgICAgICAgICAgICAge3RoaXMucHJvcHMuc21hbGwgJiYgb3B0aW9uWzFdfVxuICAgICAgICAgICAgICAgIHshdGhpcy5wcm9wcy5zbWFsbCAmJiBvcHRpb25bMF19XG4gICAgICAgICAgICAgIDwvb3B0aW9uPlxuICAgICAgICAgICAgKSl9XG4gICAgICAgICAgPC9zZWxlY3Q+XG4gICAgICAgIH1cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfVxuXG4gIGlucHV0Q3VycmVuY3lJZCA9ICgpID0+IGAke3RoaXMuaW5wdXRJZCgpfV9jdXJyZW5jeWBcblxuICBpbnB1dEN1cnJlbmN5TmFtZSAoKSB7XG4gICAgaWYgKFwiY3VycmVuY3lOYW1lXCIgaW4gdGhpcy5wcm9wcykgcmV0dXJuIHRoaXMucHJvcHMuY3VycmVuY3lOYW1lXG5cbiAgICByZXR1cm4gYCR7dGhpcy5wcm9wcy5tb2RlbC5tb2RlbENsYXNzRGF0YSgpLnBhcmFtS2V5fVske2luZmxlY3Rpb24udW5kZXJzY29yZSh0aGlzLnByb3BzLmF0dHJpYnV0ZSl9X2N1cnJlbmN5XWBcbiAgfVxuXG4gIGlucHV0Q3VycmVuY3lWYWx1ZSAoKSB7XG4gICAgY29uc3Qge2RlZmF1bHRWYWx1ZX0gPSB0aGlzLnByb3BzXG5cbiAgICBpZiAoZGVmYXVsdFZhbHVlKSB7XG4gICAgICByZXR1cm4gTW9uZXlGb3JtYXR0ZXIuY3VycmVuY3lGcm9tTW9uZXkoZGVmYXVsdFZhbHVlKS5jb2RlXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBcIkRLS1wiXG4gICAgfVxuICB9XG5cbiAgaW5wdXREZWZhdWx0VmFsdWUgKCkge1xuICAgIGNvbnN0IHtkZWZhdWx0VmFsdWV9ID0gdGhpcy5wcm9wc1xuXG4gICAgaWYgKGRlZmF1bHRWYWx1ZSkge1xuICAgICAgcmV0dXJuIE1vbmV5Rm9ybWF0dGVyLmZyb21Nb25leSh7YW1vdW50OiBkZWZhdWx0VmFsdWUuYW1vdW50LCBjdXJyZW5jeTogdGhpcy5pbnB1dEN1cnJlbmN5VmFsdWUoKX0sIHtkZWNpbWFsczogMiwgZXhjbHVkZUN1cnJlbmN5OiB0cnVlfSkudG9TdHJpbmcoKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gXCJcIlxuICAgIH1cbiAgfVxuXG4gIGlucHV0RGVmYXVsdENlbnRzVmFsdWUgKCkge1xuICAgIGNvbnN0IHtkZWZhdWx0VmFsdWV9ID0gdGhpcy5wcm9wc1xuXG4gICAgaWYgKHRoaXMuZ2V0SW5wdXRSZWYoKS5jdXJyZW50KSB7XG4gICAgICByZXR1cm4gZGlnZyh0aGlzLmdldElucHV0UmVmKCksIFwiY3VycmVudFwiLCBcInZhbHVlXCIpXG4gICAgfSBlbHNlIGlmIChkZWZhdWx0VmFsdWUpIHtcbiAgICAgIHJldHVybiBNb25leUZvcm1hdHRlci5hbW91bnRGcm9tTW9uZXkoZGVmYXVsdFZhbHVlKVxuICAgIH1cbiAgfVxuXG4gIGlucHV0Q2VudHNJZCA9ICgpID0+IGAke3RoaXMuaW5wdXRJZCgpfV9jZW50c2BcblxuICBpbnB1dENlbnRzTmFtZSAoKSB7XG4gICAgaWYgKFwibmFtZVwiIGluIHRoaXMucHJvcHMpIHJldHVybiB0aGlzLnByb3BzLm5hbWVcblxuICAgIHJldHVybiBgJHt0aGlzLnByb3BzLm1vZGVsLm1vZGVsQ2xhc3NEYXRhKCkucGFyYW1LZXl9WyR7aW5mbGVjdGlvbi51bmRlcnNjb3JlKHRoaXMucHJvcHMuYXR0cmlidXRlKX1fY2VudHNdYFxuICB9XG5cbiAgaW5wdXRJZCA9ICgpID0+IGlkRm9yQ29tcG9uZW50KHRoaXMpXG5cbiAgb25DdXJyZW5jeUNoYW5nZWQgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMucHJvcHMub25DaGFuZ2UpIHRoaXMucHJvcHMub25DaGFuZ2UoKVxuICB9XG5cbiAgc2V0QW1vdW50ID0gKCkgPT4ge1xuICAgIGNvbnN0IGlucHV0RWxlbWVudCA9IHRoaXMuZ2V0SW5wdXRSZWYoKS5jdXJyZW50XG5cbiAgICBpZiAoIWlucHV0RWxlbWVudCkgcmV0dXJuXG5cbiAgICBpZiAoIWlucHV0RWxlbWVudC52YWx1ZSAmJiBpbnB1dEVsZW1lbnQudmFsdWUgPT0gXCJcIikge1xuICAgICAgdGhpcy53aG9sZVJlZi5jdXJyZW50LnZhbHVlID0gXCJcIlxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjZW50cyA9IHBhcnNlRmxvYXQoaW5wdXRFbGVtZW50LnZhbHVlKVxuICAgICAgY29uc3QgZm9ybWF0dGVkID0gTW9uZXlGb3JtYXR0ZXIuZnJvbU1vbmV5KHthbW91bnQ6IGNlbnRzLCBjdXJyZW5jeTogdGhpcy5pbnB1dEN1cnJlbmN5VmFsdWUoKX0sIHtkZWNpbWFsczogMiwgZXhjbHVkZUN1cnJlbmN5OiB0cnVlfSkudG9TdHJpbmcoKVxuXG4gICAgICB0aGlzLndob2xlUmVmLmN1cnJlbnQudmFsdWUgPSBmb3JtYXR0ZWRcbiAgICB9XG4gIH1cblxuICBzZXRDZW50cyA9ICgpID0+IHtcbiAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSB0aGlzLmdldElucHV0UmVmKCkuY3VycmVudFxuXG4gICAgaWYgKCFpbnB1dEVsZW1lbnQpIHJldHVyblxuXG4gICAgbGV0IHdob2xlID0gTW9uZXlGb3JtYXR0ZXIuc3RyaW5nVG9GbG9hdCh0aGlzLndob2xlUmVmLmN1cnJlbnQudmFsdWUpXG4gICAgbGV0IGNlbnRzID0gcGFyc2VJbnQod2hvbGUgKiAxMDAsIDEwKVxuICAgIGxldCBvbGRDZW50cyA9IHBhcnNlSW50KGlucHV0RWxlbWVudC52YWx1ZSwgMTApXG5cbiAgICBpZiAodHlwZW9mIGNlbnRzID09IFwibnVtYmVyXCIpIHtcbiAgICAgIGlucHV0RWxlbWVudC52YWx1ZSA9IGNlbnRzXG4gICAgfSBlbHNlIHtcbiAgICAgIGlucHV0RWxlbWVudC52YWx1ZSA9IFwiXCJcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy5vbkNoYW5nZSAmJiBvbGRDZW50cyAhPSBjZW50cykgdGhpcy5wcm9wcy5vbkNoYW5nZSgpXG4gIH1cbn0pKVxuIl19