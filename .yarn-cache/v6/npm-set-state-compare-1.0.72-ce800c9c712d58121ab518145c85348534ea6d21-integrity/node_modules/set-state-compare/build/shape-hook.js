import { arrayReferenceDifferent, referenceDifferent } from "./diff-utils.js";
import { dig } from "diggerize";
import fetchingObject from "fetching-object";
import memoCompareProps from "./memo-compare-props.js";
import PropTypes from "prop-types";
import shared from "./shared.js";
import { useEffect, useMemo, useState } from "react";
/**
 * @typedef {object} ShapeHookLifecycleHooks
 * @property {(prevProps: Record<string, any>, prevState: Record<string, any>) => void} [componentDidUpdate]
 * @property {() => void} [componentDidMount]
 * @property {() => void} [componentWillUnmount]
 * @property {{children: [import("react").ReactNode]}} props
 * @property {() => void} [setup]
 */
class ShapeHook {
    /** @type {Record<string, any> | undefined} */
    static defaultProps = undefined;
    /** @type {Record<string, import("prop-types").Validator>} */
    static propTypes = undefined;
    /** @type {Record<string, {dependencies?: any[], value: any}> | undefined} */
    static __staticCaches = undefined;
    /**
     * @param {Record<string, any>} props
     */
    constructor(props) {
        this.__caches = {};
        this.__mounting = true;
        this.__mounted = false;
        this.props = props;
        this.setStates = {};
        this.state = {};
        this.__firstRenderCompleted = false;
        this.tt = fetchingObject(this);
        this.p = fetchingObject(() => this.props);
        this.s = fetchingObject(this.state);
    }
    /**
     * @returns {boolean}
     */
    isMounted() {
        return this.__mounted;
    }
    /**
     * @returns {boolean}
     */
    isMounting() {
        return this.__mounting;
    }
    /**
     * @template T
     * @param {string} name
     * @param {T | (() => T)} value
     * @param {any[]} [dependencies]
     * @returns {T}
     */
    cache(name, value, dependencies) {
        let actualValue;
        const oldDependencies = this.__caches[name]?.dependencies;
        if (typeof value == "function") {
            // @ts-expect-error
            actualValue = value();
        }
        else {
            actualValue = value;
        }
        if (!(name in this.__caches) || arrayReferenceDifferent(oldDependencies || [], dependencies || [])) {
            this.__caches[name] = { dependencies, value: actualValue };
        }
        return this.__caches[name].value;
    }
    /**
     * @template T
     * @param {string} name
     * @param {T | (() => T)} value
     * @param {any[]} [dependencies]
     * @returns {T}
     */
    cacheStatic(name, value, dependencies) {
        const constructor = /** @type {typeof ShapeHook} */ (this.constructor);
        if (!constructor.__staticCaches) {
            constructor.__staticCaches = {};
        }
        const oldDependencies = constructor.__staticCaches[name]?.dependencies;
        const hasCache = name in constructor.__staticCaches;
        const depsChanged = arrayReferenceDifferent(oldDependencies || [], dependencies || []);
        if (!hasCache || depsChanged) {
            let actualValue;
            if (typeof value == "function") {
                // @ts-expect-error
                actualValue = value();
            }
            else {
                actualValue = value;
            }
            constructor.__staticCaches[name] = { dependencies, value: actualValue };
        }
        return constructor.__staticCaches[name].value;
    }
    /**
     * @param {Record<string, any>} variables
     * @returns {void}
     */
    setInstance(variables) {
        for (const name in variables) {
            this[name] = variables[name];
        }
    }
    /**
     * @param {Record<string, any>} statesList
     * @param {function() : void} [callback]
     * @returns {void}
     */
    setState(statesList, callback) {
        if (typeof statesList == "function") {
            statesList = statesList(this.state);
        }
        for (const stateName in statesList) {
            const newValue = statesList[stateName];
            if (!(stateName in this.setStates)) {
                throw new Error(`No such state: ${stateName}`);
            }
            this.setStates[stateName](newValue);
        }
        if (callback) {
            shared.enqueueRenderCallback(callback);
        }
    }
    /**
     * @param {Record<string, any>} statesList
     * @returns {Promise<void>}
     */
    setStateAsync(statesList) {
        return new Promise((resolve) => {
            this.setState(statesList, resolve);
        });
    }
    /**
     * @param {string} stylingName
     * @param {Record<string, any>} style
     * @returns {Record<string, any>}
     */
    stylingFor(stylingName, style = {}) {
        let customStyling = dig(this, "props", "styles", stylingName);
        if (typeof customStyling == "function") {
            customStyling = customStyling({ state: this.state, style });
        }
        if (customStyling) {
            return Object.assign(style, customStyling);
        }
        return style;
    }
    /**
     * @param {string} stateName
     * @param {any} defaultValue
     * @returns {any}
     */
    useState(stateName, defaultValue) {
        const [stateValue, setState] = useState(defaultValue);
        if (!(stateName in this.state)) {
            this.state[stateName] = stateValue;
            this.setStates[stateName] = (newValue, args) => {
                if (referenceDifferent(this.state[stateName], newValue)) {
                    let prevState;
                    // @ts-expect-error
                    if (this.componentDidUpdate) {
                        prevState = Object.assign({}, this.state);
                    }
                    this.state[stateName] = newValue;
                    // Avoid React error if using set-state while rendering or not mounted (like in a useMemo callback).
                    if (!args?.silent) {
                        if (shared.rendering > 0 || !this.isMounted()) {
                            shared.enqueueRenderCallback(() => setState(newValue));
                        }
                        else {
                            setState(newValue);
                        }
                    }
                    // @ts-expect-error
                    if (this.componentDidUpdate) {
                        // @ts-expect-error
                        this.componentDidUpdate(this.props, prevState);
                    }
                }
            };
        }
        return this.setStates[stateName];
    }
    /**
     * @param {Array<string>|Record<string, any>} statesList
     * @returns {void}
     */
    useStates(statesList) {
        if (Array.isArray(statesList)) {
            for (const stateName of statesList) {
                this.useState(stateName);
            }
        }
        else {
            for (const stateName in statesList) {
                const defaultValue = statesList[stateName];
                this.useState(stateName, defaultValue);
            }
        }
    }
}
/**
 * @template {ShapeHook} T
 * @param {typeof ShapeHook & (new (props: Record<string, any>) => T)} ShapeHookClass
 * @param {Record<string, any>} props
 * @returns {T}
 */
function useShapeHook(ShapeHookClass, props) {
    // Count rendering to avoid setting state while rendering which causes a console-error from React.
    shared.rendering += 1;
    try {
        // Calculate and validate props.
        let actualProps;
        if (ShapeHookClass.defaultProps) {
            // Undefined values are removed from the props because they shouldn't override default values.
            const propsWithoutUndefined = Object.assign({}, props);
            for (const key in propsWithoutUndefined) {
                const value = propsWithoutUndefined[key];
                if (value === undefined) {
                    delete propsWithoutUndefined[key];
                }
            }
            actualProps = Object.assign({}, ShapeHookClass.defaultProps, propsWithoutUndefined);
        }
        else {
            actualProps = props;
        }
        if (ShapeHookClass.propTypes) {
            const validateProps = {};
            for (const key in actualProps) {
                // Accessing "key" will result in a warning in the console.
                if (key == "key")
                    continue;
                validateProps[key] = actualProps[key];
            }
            PropTypes.checkPropTypes(ShapeHookClass.propTypes, validateProps, "prop", ShapeHookClass.name);
        }
        const shape = useMemo(() => new ShapeHookClass(actualProps), []);
        const prevProps = shape.props;
        shape.props = actualProps;
        const propsChanged = !memoCompareProps(prevProps, actualProps);
        if (shape.setup) {
            shape.setup();
        }
        if (shape.componentDidUpdate && shape.__firstRenderCompleted && propsChanged) {
            shape.componentDidUpdate(prevProps, shape.state);
        }
        useEffect(() => {
            shape.__mounting = false;
            shape.__mounted = true;
            if (shape.componentDidMount) {
                shape.componentDidMount();
            }
            return () => {
                shape.__mounted = false;
                if (shape.componentWillUnmount) {
                    shape.componentWillUnmount();
                }
            };
        }, []);
        shape.__firstRenderCompleted = true;
        return shape;
    }
    finally {
        shared.scheduleAfterPaint(() => {
            shared.rendering = Math.max(0, shared.rendering - 1);
        });
    }
}
export { ShapeHook, useShapeHook };
export default useShapeHook;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcGUtaG9vay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zaGFwZS1ob29rLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyx1QkFBdUIsRUFBRSxrQkFBa0IsRUFBQyxNQUFNLGlCQUFpQixDQUFBO0FBQzNFLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFDN0IsT0FBTyxjQUFjLE1BQU0saUJBQWlCLENBQUE7QUFDNUMsT0FBTyxnQkFBZ0IsTUFBTSx5QkFBeUIsQ0FBQTtBQUN0RCxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUE7QUFDbEMsT0FBTyxNQUFNLE1BQU0sYUFBYSxDQUFBO0FBQ2hDLE9BQU8sRUFBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUVsRDs7Ozs7OztHQU9HO0FBRUgsTUFBTSxTQUFTO0lBQ2IsOENBQThDO0lBQzlDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFBO0lBRS9CLDZEQUE2RDtJQUM3RCxNQUFNLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQTtJQUU1Qiw2RUFBNkU7SUFDN0UsTUFBTSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUE7SUFFakM7O09BRUc7SUFDSCxZQUFZLEtBQUs7UUFDZixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQTtRQUNsQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQTtRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQTtRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQTtRQUNmLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxLQUFLLENBQUE7UUFDbkMsSUFBSSxDQUFDLEVBQUUsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFD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ZUFBZSxZQUFZLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2FycmF5UmVmZXJlbmNlRGlmZmVyZW50LCByZWZlcmVuY2VEaWZmZXJlbnR9IGZyb20gXCIuL2RpZmYtdXRpbHMuanNcIlxuaW1wb3J0IHtkaWd9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IGZldGNoaW5nT2JqZWN0IGZyb20gXCJmZXRjaGluZy1vYmplY3RcIlxuaW1wb3J0IG1lbW9Db21wYXJlUHJvcHMgZnJvbSBcIi4vbWVtby1jb21wYXJlLXByb3BzLmpzXCJcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSBcInByb3AtdHlwZXNcIlxuaW1wb3J0IHNoYXJlZCBmcm9tIFwiLi9zaGFyZWQuanNcIlxuaW1wb3J0IHt1c2VFZmZlY3QsIHVzZU1lbW8sIHVzZVN0YXRlfSBmcm9tIFwicmVhY3RcIlxuXG4vKipcbiAqIEB0eXBlZGVmIHtvYmplY3R9IFNoYXBlSG9va0xpZmVjeWNsZUhvb2tzXG4gKiBAcHJvcGVydHkgeyhwcmV2UHJvcHM6IFJlY29yZDxzdHJpbmcsIGFueT4sIHByZXZTdGF0ZTogUmVjb3JkPHN0cmluZywgYW55PikgPT4gdm9pZH0gW2NvbXBvbmVudERpZFVwZGF0ZV1cbiAqIEBwcm9wZXJ0eSB7KCkgPT4gdm9pZH0gW2NvbXBvbmVudERpZE1vdW50XVxuICogQHByb3BlcnR5IHsoKSA9PiB2b2lkfSBbY29tcG9uZW50V2lsbFVubW91bnRdXG4gKiBAcHJvcGVydHkge3tjaGlsZHJlbjogW2ltcG9ydChcInJlYWN0XCIpLlJlYWN0Tm9kZV19fSBwcm9wc1xuICogQHByb3BlcnR5IHsoKSA9PiB2b2lkfSBbc2V0dXBdXG4gKi9cblxuY2xhc3MgU2hhcGVIb29rIHtcbiAgLyoqIEB0eXBlIHtSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkfSAqL1xuICBzdGF0aWMgZGVmYXVsdFByb3BzID0gdW5kZWZpbmVkXG5cbiAgLyoqIEB0eXBlIHtSZWNvcmQ8c3RyaW5nLCBpbXBvcnQoXCJwcm9wLXR5cGVzXCIpLlZhbGlkYXRvcj59ICovXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB1bmRlZmluZWRcblxuICAvKiogQHR5cGUge1JlY29yZDxzdHJpbmcsIHtkZXBlbmRlbmNpZXM/OiBhbnlbXSwgdmFsdWU6IGFueX0+IHwgdW5kZWZpbmVkfSAqL1xuICBzdGF0aWMgX19zdGF0aWNDYWNoZXMgPSB1bmRlZmluZWRcblxuICAvKipcbiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSBwcm9wc1xuICAgKi9cbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICB0aGlzLl9fY2FjaGVzID0ge31cbiAgICB0aGlzLl9fbW91bnRpbmcgPSB0cnVlXG4gICAgdGhpcy5fX21vdW50ZWQgPSBmYWxzZVxuICAgIHRoaXMucHJvcHMgPSBwcm9wc1xuICAgIHRoaXMuc2V0U3RhdGVzID0ge31cbiAgICB0aGlzLnN0YXRlID0ge31cbiAgICB0aGlzLl9fZmlyc3RSZW5kZXJDb21wbGV0ZWQgPSBmYWxzZVxuICAgIHRoaXMudHQgPSBmZXRjaGluZ09iamVjdCh0aGlzKVxuICAgIHRoaXMucCA9IGZldGNoaW5nT2JqZWN0KCgpID0+IHRoaXMucHJvcHMpXG4gICAgdGhpcy5zID0gZmV0Y2hpbmdPYmplY3QodGhpcy5zdGF0ZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIGlzTW91bnRlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fX21vdW50ZWRcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIGlzTW91bnRpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMuX19tb3VudGluZ1xuICB9XG5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAqIEBwYXJhbSB7VCB8ICgoKSA9PiBUKX0gdmFsdWVcbiAgICogQHBhcmFtIHthbnlbXX0gW2RlcGVuZGVuY2llc11cbiAgICogQHJldHVybnMge1R9XG4gICAqL1xuICBjYWNoZShuYW1lLCB2YWx1ZSwgZGVwZW5kZW5jaWVzKSB7XG4gICAgbGV0IGFjdHVhbFZhbHVlXG4gICAgY29uc3Qgb2xkRGVwZW5kZW5jaWVzID0gdGhpcy5fX2NhY2hlc1tuYW1lXT8uZGVwZW5kZW5jaWVzXG5cbiAgICBpZiAodHlwZW9mIHZhbHVlID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgYWN0dWFsVmFsdWUgPSB2YWx1ZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGFjdHVhbFZhbHVlID0gdmFsdWVcbiAgICB9XG5cbiAgICBpZiAoIShuYW1lIGluIHRoaXMuX19jYWNoZXMpIHx8IGFycmF5UmVmZXJlbmNlRGlmZmVyZW50KG9sZERlcGVuZGVuY2llcyB8fCBbXSwgZGVwZW5kZW5jaWVzIHx8IFtdKSkge1xuICAgICAgdGhpcy5fX2NhY2hlc1tuYW1lXSA9IHtkZXBlbmRlbmNpZXMsIHZhbHVlOiBhY3R1YWxWYWx1ZX1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fX2NhY2hlc1tuYW1lXS52YWx1ZVxuICB9XG5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAqIEBwYXJhbSB7VCB8ICgoKSA9PiBUKX0gdmFsdWVcbiAgICogQHBhcmFtIHthbnlbXX0gW2RlcGVuZGVuY2llc11cbiAgICogQHJldHVybnMge1R9XG4gICAqL1xuICBjYWNoZVN0YXRpYyhuYW1lLCB2YWx1ZSwgZGVwZW5kZW5jaWVzKSB7XG4gICAgY29uc3QgY29uc3RydWN0b3IgPSAvKiogQHR5cGUge3R5cGVvZiBTaGFwZUhvb2t9ICovICh0aGlzLmNvbnN0cnVjdG9yKVxuXG4gICAgaWYgKCFjb25zdHJ1Y3Rvci5fX3N0YXRpY0NhY2hlcykge1xuICAgICAgY29uc3RydWN0b3IuX19zdGF0aWNDYWNoZXMgPSB7fVxuICAgIH1cblxuICAgIGNvbnN0IG9sZERlcGVuZGVuY2llcyA9IGNvbnN0cnVjdG9yLl9fc3RhdGljQ2FjaGVzW25hbWVdPy5kZXBlbmRlbmNpZXNcblxuICAgIGNvbnN0IGhhc0NhY2hlID0gbmFtZSBpbiBjb25zdHJ1Y3Rvci5fX3N0YXRpY0NhY2hlc1xuICAgIGNvbnN0IGRlcHNDaGFuZ2VkID0gYXJyYXlSZWZlcmVuY2VEaWZmZXJlbnQob2xkRGVwZW5kZW5jaWVzIHx8IFtdLCBkZXBlbmRlbmNpZXMgfHwgW10pXG5cbiAgICBpZiAoIWhhc0NhY2hlIHx8IGRlcHNDaGFuZ2VkKSB7XG4gICAgICBsZXQgYWN0dWFsVmFsdWVcblxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICBhY3R1YWxWYWx1ZSA9IHZhbHVlKClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjdHVhbFZhbHVlID0gdmFsdWVcbiAgICAgIH1cblxuICAgICAgY29uc3RydWN0b3IuX19zdGF0aWNDYWNoZXNbbmFtZV0gPSB7ZGVwZW5kZW5jaWVzLCB2YWx1ZTogYWN0dWFsVmFsdWV9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbnN0cnVjdG9yLl9fc3RhdGljQ2FjaGVzW25hbWVdLnZhbHVlXG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSB2YXJpYWJsZXNcbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqL1xuICBzZXRJbnN0YW5jZSh2YXJpYWJsZXMpIHtcbiAgICBmb3IgKGNvbnN0IG5hbWUgaW4gdmFyaWFibGVzKSB7XG4gICAgICB0aGlzW25hbWVdID0gdmFyaWFibGVzW25hbWVdXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7UmVjb3JkPHN0cmluZywgYW55Pn0gc3RhdGVzTGlzdFxuICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCkgOiB2b2lkfSBbY2FsbGJhY2tdXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgc2V0U3RhdGUoc3RhdGVzTGlzdCwgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIHN0YXRlc0xpc3QgPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBzdGF0ZXNMaXN0ID0gc3RhdGVzTGlzdCh0aGlzLnN0YXRlKVxuICAgIH1cblxuICAgIGZvciAoY29uc3Qgc3RhdGVOYW1lIGluIHN0YXRlc0xpc3QpIHtcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gc3RhdGVzTGlzdFtzdGF0ZU5hbWVdXG5cbiAgICAgIGlmICghKHN0YXRlTmFtZSBpbiB0aGlzLnNldFN0YXRlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBzdWNoIHN0YXRlOiAke3N0YXRlTmFtZX1gKVxuICAgICAgfVxuXG4gICAgICB0aGlzLnNldFN0YXRlc1tzdGF0ZU5hbWVdKG5ld1ZhbHVlKVxuICAgIH1cblxuICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgc2hhcmVkLmVucXVldWVSZW5kZXJDYWxsYmFjayhjYWxsYmFjaylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSBzdGF0ZXNMaXN0XG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKi9cbiAgc2V0U3RhdGVBc3luYyhzdGF0ZXNMaXN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICB0aGlzLnNldFN0YXRlKHN0YXRlc0xpc3QsIHJlc29sdmUpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3R5bGluZ05hbWVcbiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSBzdHlsZVxuICAgKiBAcmV0dXJucyB7UmVjb3JkPHN0cmluZywgYW55Pn1cbiAgICovXG4gIHN0eWxpbmdGb3Ioc3R5bGluZ05hbWUsIHN0eWxlID0ge30pIHtcbiAgICBsZXQgY3VzdG9tU3R5bGluZyA9IGRpZyh0aGlzLCBcInByb3BzXCIsIFwic3R5bGVzXCIsIHN0eWxpbmdOYW1lKVxuXG4gICAgaWYgKHR5cGVvZiBjdXN0b21TdHlsaW5nID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY3VzdG9tU3R5bGluZyA9IGN1c3RvbVN0eWxpbmcoe3N0YXRlOiB0aGlzLnN0YXRlLCBzdHlsZX0pXG4gICAgfVxuXG4gICAgaWYgKGN1c3RvbVN0eWxpbmcpIHtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHN0eWxlLCBjdXN0b21TdHlsaW5nKVxuICAgIH1cblxuICAgIHJldHVybiBzdHlsZVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0ZU5hbWVcbiAgICogQHBhcmFtIHthbnl9IGRlZmF1bHRWYWx1ZVxuICAgKiBAcmV0dXJucyB7YW55fVxuICAgKi9cbiAgdXNlU3RhdGUoc3RhdGVOYW1lLCBkZWZhdWx0VmFsdWUpIHtcbiAgICBjb25zdCBbc3RhdGVWYWx1ZSwgc2V0U3RhdGVdID0gdXNlU3RhdGUoZGVmYXVsdFZhbHVlKVxuXG4gICAgaWYgKCEoc3RhdGVOYW1lIGluIHRoaXMuc3RhdGUpKSB7XG4gICAgICB0aGlzLnN0YXRlW3N0YXRlTmFtZV0gPSBzdGF0ZVZhbHVlXG4gICAgICB0aGlzLnNldFN0YXRlc1tzdGF0ZU5hbWVdID0gKG5ld1ZhbHVlLCBhcmdzKSA9PiB7XG4gICAgICAgIGlmIChyZWZlcmVuY2VEaWZmZXJlbnQodGhpcy5zdGF0ZVtzdGF0ZU5hbWVdLCBuZXdWYWx1ZSkpIHtcbiAgICAgICAgICBsZXQgcHJldlN0YXRlXG5cbiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgaWYgKHRoaXMuY29tcG9uZW50RGlkVXBkYXRlKSB7XG4gICAgICAgICAgICBwcmV2U3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnN0YXRlKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuc3RhdGVbc3RhdGVOYW1lXSA9IG5ld1ZhbHVlXG5cbiAgICAgICAgICAvLyBBdm9pZCBSZWFjdCBlcnJvciBpZiB1c2luZyBzZXQtc3RhdGUgd2hpbGUgcmVuZGVyaW5nIG9yIG5vdCBtb3VudGVkIChsaWtlIGluIGEgdXNlTWVtbyBjYWxsYmFjaykuXG4gICAgICAgICAgaWYgKCFhcmdzPy5zaWxlbnQpIHtcbiAgICAgICAgICAgIGlmIChzaGFyZWQucmVuZGVyaW5nID4gMCB8fCAhdGhpcy5pc01vdW50ZWQoKSkge1xuICAgICAgICAgICAgICBzaGFyZWQuZW5xdWV1ZVJlbmRlckNhbGxiYWNrKCgpID0+IHNldFN0YXRlKG5ld1ZhbHVlKSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNldFN0YXRlKG5ld1ZhbHVlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgICBpZiAodGhpcy5jb21wb25lbnREaWRVcGRhdGUpIHtcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkVXBkYXRlKHRoaXMucHJvcHMsIHByZXZTdGF0ZSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZXRTdGF0ZXNbc3RhdGVOYW1lXVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPnxSZWNvcmQ8c3RyaW5nLCBhbnk+fSBzdGF0ZXNMaXN0XG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgdXNlU3RhdGVzKHN0YXRlc0xpc3QpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShzdGF0ZXNMaXN0KSkge1xuICAgICAgZm9yKGNvbnN0IHN0YXRlTmFtZSBvZiBzdGF0ZXNMaXN0KSB7XG4gICAgICAgIHRoaXMudXNlU3RhdGUoc3RhdGVOYW1lKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IoY29uc3Qgc3RhdGVOYW1lIGluIHN0YXRlc0xpc3QpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gc3RhdGVzTGlzdFtzdGF0ZU5hbWVdXG5cbiAgICAgICAgdGhpcy51c2VTdGF0ZShzdGF0ZU5hbWUsIGRlZmF1bHRWYWx1ZSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBAdGVtcGxhdGUge1NoYXBlSG9va30gVFxuICogQHBhcmFtIHt0eXBlb2YgU2hhcGVIb29rICYgKG5ldyAocHJvcHM6IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IFQpfSBTaGFwZUhvb2tDbGFzc1xuICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSBwcm9wc1xuICogQHJldHVybnMge1R9XG4gKi9cbmZ1bmN0aW9uIHVzZVNoYXBlSG9vayhTaGFwZUhvb2tDbGFzcywgcHJvcHMpIHtcbiAgLy8gQ291bnQgcmVuZGVyaW5nIHRvIGF2b2lkIHNldHRpbmcgc3RhdGUgd2hpbGUgcmVuZGVyaW5nIHdoaWNoIGNhdXNlcyBhIGNvbnNvbGUtZXJyb3IgZnJvbSBSZWFjdC5cbiAgc2hhcmVkLnJlbmRlcmluZyArPSAxXG5cbiAgdHJ5IHtcbiAgICAvLyBDYWxjdWxhdGUgYW5kIHZhbGlkYXRlIHByb3BzLlxuICAgIGxldCBhY3R1YWxQcm9wc1xuXG4gICAgaWYgKFNoYXBlSG9va0NsYXNzLmRlZmF1bHRQcm9wcykge1xuICAgICAgLy8gVW5kZWZpbmVkIHZhbHVlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBwcm9wcyBiZWNhdXNlIHRoZXkgc2hvdWxkbid0IG92ZXJyaWRlIGRlZmF1bHQgdmFsdWVzLlxuICAgICAgY29uc3QgcHJvcHNXaXRob3V0VW5kZWZpbmVkID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvcHMpXG5cbiAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzV2l0aG91dFVuZGVmaW5lZCkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHByb3BzV2l0aG91dFVuZGVmaW5lZFtrZXldXG5cbiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBkZWxldGUgcHJvcHNXaXRob3V0VW5kZWZpbmVkW2tleV1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBhY3R1YWxQcm9wcyA9IE9iamVjdC5hc3NpZ24oe30sIFNoYXBlSG9va0NsYXNzLmRlZmF1bHRQcm9wcywgcHJvcHNXaXRob3V0VW5kZWZpbmVkKVxuICAgIH0gZWxzZSB7XG4gICAgICBhY3R1YWxQcm9wcyA9IHByb3BzXG4gICAgfVxuXG4gICAgaWYgKFNoYXBlSG9va0NsYXNzLnByb3BUeXBlcykge1xuICAgICAgY29uc3QgdmFsaWRhdGVQcm9wcyA9IHt9XG5cbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGFjdHVhbFByb3BzKSB7XG4gICAgICAgIC8vIEFjY2Vzc2luZyBcImtleVwiIHdpbGwgcmVzdWx0IGluIGEgd2FybmluZyBpbiB0aGUgY29uc29sZS5cbiAgICAgICAgaWYgKGtleSA9PSBcImtleVwiKSBjb250aW51ZVxuXG4gICAgICAgIHZhbGlkYXRlUHJvcHNba2V5XSA9IGFjdHVhbFByb3BzW2tleV1cbiAgICAgIH1cblxuICAgICAgUHJvcFR5cGVzLmNoZWNrUHJvcFR5cGVzKFNoYXBlSG9va0NsYXNzLnByb3BUeXBlcywgdmFsaWRhdGVQcm9wcywgXCJwcm9wXCIsIFNoYXBlSG9va0NsYXNzLm5hbWUpXG4gICAgfVxuXG4gICAgY29uc3Qgc2hhcGUgPSB1c2VNZW1vKCgpID0+IG5ldyBTaGFwZUhvb2tDbGFzcyhhY3R1YWxQcm9wcyksIFtdKVxuICAgIGNvbnN0IHByZXZQcm9wcyA9IHNoYXBlLnByb3BzXG5cbiAgICBzaGFwZS5wcm9wcyA9IGFjdHVhbFByb3BzXG4gICAgY29uc3QgcHJvcHNDaGFuZ2VkID0gIW1lbW9Db21wYXJlUHJvcHMocHJldlByb3BzLCBhY3R1YWxQcm9wcylcblxuICAgIGlmIChzaGFwZS5zZXR1cCkge1xuICAgICAgc2hhcGUuc2V0dXAoKVxuICAgIH1cblxuICAgIGlmIChzaGFwZS5jb21wb25lbnREaWRVcGRhdGUgJiYgc2hhcGUuX19maXJzdFJlbmRlckNvbXBsZXRlZCAmJiBwcm9wc0NoYW5nZWQpIHtcbiAgICAgIHNoYXBlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHNoYXBlLnN0YXRlKVxuICAgIH1cblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICBzaGFwZS5fX21vdW50aW5nID0gZmFsc2VcbiAgICAgIHNoYXBlLl9fbW91bnRlZCA9IHRydWVcblxuICAgICAgaWYgKHNoYXBlLmNvbXBvbmVudERpZE1vdW50KSB7XG4gICAgICAgIHNoYXBlLmNvbXBvbmVudERpZE1vdW50KClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgc2hhcGUuX19tb3VudGVkID0gZmFsc2VcblxuICAgICAgICBpZiAoc2hhcGUuY29tcG9uZW50V2lsbFVubW91bnQpIHtcbiAgICAgICAgICBzaGFwZS5jb21wb25lbnRXaWxsVW5tb3VudCgpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCBbXSlcblxuICAgIHNoYXBlLl9fZmlyc3RSZW5kZXJDb21wbGV0ZWQgPSB0cnVlXG5cbiAgICByZXR1cm4gc2hhcGVcbiAgfSBmaW5hbGx5IHtcbiAgICBzaGFyZWQuc2NoZWR1bGVBZnRlclBhaW50KCgpID0+IHtcbiAgICAgIHNoYXJlZC5yZW5kZXJpbmcgPSBNYXRoLm1heCgwLCBzaGFyZWQucmVuZGVyaW5nIC0gMSlcbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCB7U2hhcGVIb29rLCB1c2VTaGFwZUhvb2t9XG5leHBvcnQgZGVmYXVsdCB1c2VTaGFwZUhvb2tcbiJdfQ==