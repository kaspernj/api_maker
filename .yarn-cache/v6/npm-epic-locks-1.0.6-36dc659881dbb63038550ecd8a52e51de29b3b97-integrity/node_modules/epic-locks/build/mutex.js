/**
 * @typedef {Object} MutexOptions
 * @property {boolean} [debug]
 */
/**
 * Mutex for running async work sequentially.
 */
export default class Mutex {
    /**
     * @param {MutexOptions} [args]
     */
    constructor(args = {}) {
        /**
         * @returns {Promise<void>}
         */
        this._processQueue = async () => {
            if (this._debug)
                this._log("processQueue");
            // If no one has locked, and queue is not empty, we should try and proceed to next item if any
            while (this._readers == 0 && this._syncQueue.length > 0) {
                const queueItem = this._syncQueue.shift();
                if (queueItem) {
                    if (this._debug)
                        this._log("Process next job");
                    await this._runJob(queueItem);
                }
            }
        };
        this._debug = args.debug;
        this._readers = 0;
        this._processQueueTimeout = null;
        /** @type {Array<MutexQueueItem<unknown>>} */
        this._syncQueue = [];
    }
    /**
     * Run a job with exclusive access.
     * @template T
     * @param {() => (T | Promise<T>)} callback
     * @returns {Promise<T>}
     */
    sync(callback) {
        if (this._debug)
            this._log("sync");
        if (this._readers === 0 && this._syncQueue.length === 0) {
            return this.runJobInstantly(callback);
        }
        return new Promise((resolve, reject) => {
            /** @type {MutexQueueItem<T>} */
            const queueItem = { callback, resolve, reject };
            this._syncQueue.push(/** @type {MutexQueueItem<unknown>} */ (queueItem));
            this._processQueueLater();
        });
    }
    /**
     * @template T
     * @param {() => (T | Promise<T>)} callback
     * @returns {Promise<T>}
     */
    async runJobInstantly(callback) {
        this._readers++;
        try {
            return await callback();
        }
        finally {
            this._readers--;
            if (this._readers === 0 && this._syncQueue.length > 0) {
                this._processQueueLater();
            }
        }
    }
    /**
     * @param {string} message
     * @returns {void}
     */
    _log(message) {
        console.log("ReadersWriteLock", message, JSON.stringify({ readers: this._readers }));
    }
    // First execute anything waiting after having given the lock back to the original caller by executing at the end of the event-queue by timeout-hack
    /**
     * @returns {void}
     */
    _processQueueLater() {
        if (this._processQueueTimeout) {
            clearTimeout(this._processQueueTimeout);
        }
        this._processQueueTimeout = setTimeout(this._processQueue, 0);
    }
    /**
     * @param {MutexQueueItem<unknown>} item
     * @returns {Promise<void>}
     */
    async _runJob(item) {
        this._readers++;
        try {
            const result = await item.callback();
            item.resolve(result);
        }
        catch (error) {
            item.reject(error);
        }
        finally {
            this._readers--;
        }
    }
}
/**
 * @template T
 * @typedef {Object} MutexQueueItem
 * @property {() => (T | Promise<T>)} callback
 * @property {(value: T) => void} resolve
 * @property {(error: unknown) => void} reject
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXV0ZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbXV0ZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUg7O0dBRUc7QUFDSCxNQUFNLENBQUMsT0FBTyxPQUFPLEtBQUs7SUFDeEI7O09BRUc7SUFDSCxZQUFZLElBQUksR0FBRyxFQUFFO1FBcUVyQjs7V0FFRztRQUNILGtCQUFhLEdBQUcsS0FBSyxJQUFJLEVBQUU7WUFDekIsSUFBSSxJQUFJLENBQUMsTUFBTTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1lBRTFDLDhGQUE4RjtZQUM5RixPQUFPLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUN4RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFBO2dCQUV6QyxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLElBQUksSUFBSSxDQUFDLE1BQU07d0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO29CQUM5QyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7Z0JBQy9CLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFBO1FBbkZDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQTtRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQTtRQUNqQixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFBO1FBQ2hDLDZDQUE2QztRQUM3QyxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQTtJQUN0QixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxJQUFJLENBQUMsUUFBUTtRQUNYLElBQUksSUFBSSxDQUFDLE1BQU07WUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRWxDLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDeEQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLGdDQUFnQztZQUNoQyxNQUFNLFNBQVMsR0FBRyxFQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFDLENBQUE7WUFFN0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsc0NBQXNDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1lBQ3hFLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1FBQzNCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLFFBQVE7UUFDNUIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBRWYsSUFBSSxDQUFDO1lBQ0gsT0FBTyxNQUFNLFFBQVEsRUFBRSxDQUFBO1FBQ3pCLENBQUM7Z0JBQVMsQ0FBQztZQUNULElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUVmLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1lBQzNCLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksQ0FBQyxPQUFPO1FBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3BGLENBQUM7SUFFRCxvSkFBb0o7SUFDcEo7O09BRUc7SUFDSCxrQkFBa0I7UUFDaEIsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUM5QixZQUFZLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUE7UUFDekMsQ0FBQztRQUVELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0lBbUJEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSTtRQUNoQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFFZixJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUNwQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3RCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNwQixDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDakIsQ0FBQztJQUNILENBQUM7Q0FDRjtBQUVEOzs7Ozs7R0FNRyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gTXV0ZXhPcHRpb25zXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtkZWJ1Z11cbiAqL1xuXG4vKipcbiAqIE11dGV4IGZvciBydW5uaW5nIGFzeW5jIHdvcmsgc2VxdWVudGlhbGx5LlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNdXRleCB7XG4gIC8qKlxuICAgKiBAcGFyYW0ge011dGV4T3B0aW9uc30gW2FyZ3NdXG4gICAqL1xuICBjb25zdHJ1Y3RvcihhcmdzID0ge30pIHtcbiAgICB0aGlzLl9kZWJ1ZyA9IGFyZ3MuZGVidWdcbiAgICB0aGlzLl9yZWFkZXJzID0gMFxuICAgIHRoaXMuX3Byb2Nlc3NRdWV1ZVRpbWVvdXQgPSBudWxsXG4gICAgLyoqIEB0eXBlIHtBcnJheTxNdXRleFF1ZXVlSXRlbTx1bmtub3duPj59ICovXG4gICAgdGhpcy5fc3luY1F1ZXVlID0gW11cbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYSBqb2Igd2l0aCBleGNsdXNpdmUgYWNjZXNzLlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0geygpID0+IChUIHwgUHJvbWlzZTxUPil9IGNhbGxiYWNrXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFQ+fVxuICAgKi9cbiAgc3luYyhjYWxsYmFjaykge1xuICAgIGlmICh0aGlzLl9kZWJ1ZykgdGhpcy5fbG9nKFwic3luY1wiKVxuXG4gICAgaWYgKHRoaXMuX3JlYWRlcnMgPT09IDAgJiYgdGhpcy5fc3luY1F1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMucnVuSm9iSW5zdGFudGx5KGNhbGxiYWNrKVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvKiogQHR5cGUge011dGV4UXVldWVJdGVtPFQ+fSAqL1xuICAgICAgY29uc3QgcXVldWVJdGVtID0ge2NhbGxiYWNrLCByZXNvbHZlLCByZWplY3R9XG5cbiAgICAgIHRoaXMuX3N5bmNRdWV1ZS5wdXNoKC8qKiBAdHlwZSB7TXV0ZXhRdWV1ZUl0ZW08dW5rbm93bj59ICovIChxdWV1ZUl0ZW0pKVxuICAgICAgdGhpcy5fcHJvY2Vzc1F1ZXVlTGF0ZXIoKVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHsoKSA9PiAoVCB8IFByb21pc2U8VD4pfSBjYWxsYmFja1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxUPn1cbiAgICovXG4gIGFzeW5jIHJ1bkpvYkluc3RhbnRseShjYWxsYmFjaykge1xuICAgIHRoaXMuX3JlYWRlcnMrK1xuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBjYWxsYmFjaygpXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX3JlYWRlcnMtLVxuXG4gICAgICBpZiAodGhpcy5fcmVhZGVycyA9PT0gMCAmJiB0aGlzLl9zeW5jUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLl9wcm9jZXNzUXVldWVMYXRlcigpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgX2xvZyhtZXNzYWdlKSB7XG4gICAgY29uc29sZS5sb2coXCJSZWFkZXJzV3JpdGVMb2NrXCIsIG1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KHtyZWFkZXJzOiB0aGlzLl9yZWFkZXJzfSkpXG4gIH1cblxuICAvLyBGaXJzdCBleGVjdXRlIGFueXRoaW5nIHdhaXRpbmcgYWZ0ZXIgaGF2aW5nIGdpdmVuIHRoZSBsb2NrIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGNhbGxlciBieSBleGVjdXRpbmcgYXQgdGhlIGVuZCBvZiB0aGUgZXZlbnQtcXVldWUgYnkgdGltZW91dC1oYWNrXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7dm9pZH1cbiAgICovXG4gIF9wcm9jZXNzUXVldWVMYXRlcigpIHtcbiAgICBpZiAodGhpcy5fcHJvY2Vzc1F1ZXVlVGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3Byb2Nlc3NRdWV1ZVRpbWVvdXQpXG4gICAgfVxuXG4gICAgdGhpcy5fcHJvY2Vzc1F1ZXVlVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fcHJvY2Vzc1F1ZXVlLCAwKVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKi9cbiAgX3Byb2Nlc3NRdWV1ZSA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAodGhpcy5fZGVidWcpIHRoaXMuX2xvZyhcInByb2Nlc3NRdWV1ZVwiKVxuXG4gICAgLy8gSWYgbm8gb25lIGhhcyBsb2NrZWQsIGFuZCBxdWV1ZSBpcyBub3QgZW1wdHksIHdlIHNob3VsZCB0cnkgYW5kIHByb2NlZWQgdG8gbmV4dCBpdGVtIGlmIGFueVxuICAgIHdoaWxlICh0aGlzLl9yZWFkZXJzID09IDAgJiYgdGhpcy5fc3luY1F1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHF1ZXVlSXRlbSA9IHRoaXMuX3N5bmNRdWV1ZS5zaGlmdCgpXG5cbiAgICAgIGlmIChxdWV1ZUl0ZW0pIHtcbiAgICAgICAgaWYgKHRoaXMuX2RlYnVnKSB0aGlzLl9sb2coXCJQcm9jZXNzIG5leHQgam9iXCIpXG4gICAgICAgIGF3YWl0IHRoaXMuX3J1bkpvYihxdWV1ZUl0ZW0pXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7TXV0ZXhRdWV1ZUl0ZW08dW5rbm93bj59IGl0ZW1cbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqL1xuICBhc3luYyBfcnVuSm9iKGl0ZW0pIHtcbiAgICB0aGlzLl9yZWFkZXJzKytcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpdGVtLmNhbGxiYWNrKClcbiAgICAgIGl0ZW0ucmVzb2x2ZShyZXN1bHQpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGl0ZW0ucmVqZWN0KGVycm9yKVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9yZWFkZXJzLS1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBAdGVtcGxhdGUgVFxuICogQHR5cGVkZWYge09iamVjdH0gTXV0ZXhRdWV1ZUl0ZW1cbiAqIEBwcm9wZXJ0eSB7KCkgPT4gKFQgfCBQcm9taXNlPFQ+KX0gY2FsbGJhY2tcbiAqIEBwcm9wZXJ0eSB7KHZhbHVlOiBUKSA9PiB2b2lkfSByZXNvbHZlXG4gKiBAcHJvcGVydHkgeyhlcnJvcjogdW5rbm93bikgPT4gdm9pZH0gcmVqZWN0XG4gKi9cbiJdfQ==