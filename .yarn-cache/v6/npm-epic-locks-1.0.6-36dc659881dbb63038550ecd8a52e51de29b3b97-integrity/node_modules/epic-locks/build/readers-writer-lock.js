/**
 * @typedef {Object} ReadersWriterLockOptions
 * @property {boolean} [debug]
 */
/**
 * Readers-writer lock with read priority.
 */
export default class ReadersWriterLock {
    /**
     * @param {ReadersWriterLockOptions} [args]
     */
    constructor(args = {}) {
        /**
         * @returns {void}
         */
        this._processQueue = () => {
            if (this._writers == 0) {
                // If no one has begun writing, we should try and proceed to next read item if any
                const readQueueItem = this._readQueue.shift();
                if (readQueueItem) {
                    if (this._debug)
                        this._log("Process next read");
                    this._processRead(readQueueItem);
                }
                else if (this._readers == 0) {
                    // No writers, no next item to read - we should try and proceed to next write item if any
                    const writeQueueItem = this._writeQueue.shift();
                    if (writeQueueItem) {
                        if (this._debug)
                            this._log("Process next write");
                        this._processWrite(writeQueueItem);
                    }
                }
            }
        };
        this._debug = args.debug;
        this._readers = 0;
        this._writers = 0;
        this._processQueueTimeout = null;
        /** @type {Array<ReadersWriterQueueItem<unknown>>} */
        this._readQueue = [];
        /** @type {Array<ReadersWriterQueueItem<unknown>>} */
        this._writeQueue = [];
    }
    /**
     * Run a job with shared read access.
     * @template T
     * @param {(() => (T | Promise<T>))} [callback]
     * @returns {Promise<T | undefined>}
     */
    read(callback) {
        if (this._debug)
            this._log("read");
        if (this._readers === 0 && this._writers === 0 && this._readQueue.length === 0 && this._writeQueue.length === 0) {
            return this.runReadJobInstantly(callback);
        }
        return new Promise((resolve, reject) => {
            /** @type {ReadersWriterQueueItem<T>} */
            const queueItem = { callback, resolve, reject };
            this._readWithResolve(/** @type {ReadersWriterQueueItem<unknown>} */ (queueItem));
        });
    }
    /**
     * Run a job with exclusive write access.
     * @template T
     * @param {(() => (T | Promise<T>))} [callback]
     * @returns {Promise<T | undefined>}
     */
    write(callback) {
        if (this._debug)
            this._log("write");
        if (this._readers === 0 && this._writers === 0 && this._readQueue.length === 0 && this._writeQueue.length === 0) {
            return this.runWriteJobInstantly(callback);
        }
        return new Promise((resolve, reject) => {
            /** @type {ReadersWriterQueueItem<T>} */
            const queueItem = { callback, resolve, reject };
            this._writeWithResolve(/** @type {ReadersWriterQueueItem<unknown>} */ (queueItem));
        });
    }
    /**
     * @template T
     * @param {(() => (T | Promise<T>))} [callback]
     * @returns {Promise<T | undefined>}
     */
    async runReadJobInstantly(callback) {
        this._readers++;
        try {
            let result;
            if (callback)
                result = await callback();
            return result;
        }
        finally {
            this._readers--;
            if (this._readQueue.length > 0 || this._writeQueue.length > 0) {
                this._processQueueLater();
            }
        }
    }
    /**
     * @template T
     * @param {(() => (T | Promise<T>))} [callback]
     * @returns {Promise<T | undefined>}
     */
    async runWriteJobInstantly(callback) {
        this._writers++;
        try {
            let result;
            if (callback)
                result = await callback();
            return result;
        }
        finally {
            this._writers--;
            if (this._readQueue.length > 0 || this._writeQueue.length > 0) {
                this._processQueueLater();
            }
        }
    }
    /**
     * @param {string} message
     * @returns {void}
     */
    _log(message) {
        console.log("ReadersWriteLock", message, JSON.stringify({ readers: this._readers, writers: this._writers }));
    }
    /**
     * @param {ReadersWriterQueueItem<unknown>} item
     * @returns {void}
     */
    _readWithResolve(item) {
        if (this._writers > 0) {
            if (this._debug)
                this._log("Queue read");
            this._readQueue.push(item);
        }
        else {
            if (this._debug)
                this._log("Process read");
            this._processRead(item);
        }
    }
    /**
     * @param {ReadersWriterQueueItem<unknown>} item
     * @returns {void}
     */
    _writeWithResolve(item) {
        if (this._readers > 0 || this._writers > 0) {
            if (this._debug)
                this._log("Queue write");
            this._writeQueue.push(item);
        }
        else {
            if (this._debug)
                this._log("Process write");
            this._processWrite(item);
        }
    }
    /**
     * @param {ReadersWriterQueueItem<unknown>} item
     * @returns {Promise<void>}
     */
    async _processRead(item) {
        this._readers++;
        try {
            let result;
            if (item.callback)
                result = await item.callback();
            await item.resolve(result);
        }
        catch (error) {
            item.reject(error);
        }
        finally {
            this._readers--;
            this._processQueueLater();
        }
    }
    /**
     * @param {ReadersWriterQueueItem<unknown>} item
     * @returns {Promise<void>}
     */
    async _processWrite(item) {
        this._writers++;
        try {
            let result;
            if (item.callback)
                result = await item.callback();
            await item.resolve(result);
        }
        catch (error) {
            item.reject(error);
        }
        finally {
            this._writers--;
            this._processQueueLater();
        }
    }
    // First execute anything waiting after having given the lock back to the original caller by executing at the end of the event-queue by timeout-hack
    /**
     * @returns {void}
     */
    _processQueueLater() {
        if (this._processQueueTimeout) {
            clearTimeout(this._processQueueTimeout);
        }
        this._processQueueTimeout = setTimeout(this._processQueue, 0);
    }
}
/**
 * @template T
 * @typedef {Object} ReadersWriterQueueItem
 * @property {(() => (T | Promise<T>)) | undefined} callback
 * @property {(value: T | undefined) => void} resolve
 * @property {(error: unknown) => void} reject
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZGVycy13cml0ZXItbG9jay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWFkZXJzLXdyaXRlci1sb2NrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVIOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE9BQU8sT0FBTyxpQkFBaUI7SUFDcEM7O09BRUc7SUFDSCxZQUFZLElBQUksR0FBRyxFQUFFO1FBeUxyQjs7V0FFRztRQUNILGtCQUFhLEdBQUcsR0FBRyxFQUFFO1lBQ25CLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDdkIsa0ZBQWtGO2dCQUNsRixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFBO2dCQUU3QyxJQUFJLGFBQWEsRUFBRSxDQUFDO29CQUNsQixJQUFJLElBQUksQ0FBQyxNQUFNO3dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtvQkFDL0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQTtnQkFDbEMsQ0FBQztxQkFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQzlCLHlGQUF5RjtvQkFDekYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtvQkFFL0MsSUFBSSxjQUFjLEVBQUUsQ0FBQzt3QkFDbkIsSUFBSSxJQUFJLENBQUMsTUFBTTs0QkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUE7d0JBQ2hELElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUE7b0JBQ3BDLENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDLENBQUE7UUE3TUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFBO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFBO1FBQ2pCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUE7UUFDaEMscURBQXFEO1FBQ3JELElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLHFEQUFxRDtRQUNyRCxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQTtJQUN2QixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxJQUFJLENBQUMsUUFBUTtRQUNYLElBQUksSUFBSSxDQUFDLE1BQU07WUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRWxDLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2hILE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQzNDLENBQUM7UUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLHdDQUF3QztZQUN4QyxNQUFNLFNBQVMsR0FBRyxFQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFDLENBQUE7WUFFN0MsSUFBSSxDQUFDLGdCQUFnQixDQUFDLDhDQUE4QyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUNuRixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxRQUFRO1FBQ1osSUFBSSxJQUFJLENBQUMsTUFBTTtZQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFbkMsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDaEgsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDNUMsQ0FBQztRQUVELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsd0NBQXdDO1lBQ3hDLE1BQU0sU0FBUyxHQUFHLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUMsQ0FBQTtZQUU3QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsOENBQThDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQ3BGLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsUUFBUTtRQUNoQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFFZixJQUFJLENBQUM7WUFDSCxJQUFJLE1BQU0sQ0FBQTtZQUVWLElBQUksUUFBUTtnQkFBRSxNQUFNLEdBQUcsTUFBTSxRQUFRLEVBQUUsQ0FBQTtZQUN2QyxPQUFPLE1BQU0sQ0FBQTtRQUNmLENBQUM7Z0JBQVMsQ0FBQztZQUNULElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUVmLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUM5RCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtZQUMzQixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLG9CQUFvQixDQUFDLFFBQVE7UUFDakMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBRWYsSUFBSSxDQUFDO1lBQ0gsSUFBSSxNQUFNLENBQUE7WUFFVixJQUFJLFFBQVE7Z0JBQUUsTUFBTSxHQUFHLE1BQU0sUUFBUSxFQUFFLENBQUE7WUFDdkMsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7WUFFZixJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDOUQsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUE7WUFDM0IsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxDQUFDLE9BQU87UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDLENBQUE7SUFDNUcsQ0FBQztJQUVEOzs7T0FHRztJQUNILGdCQUFnQixDQUFDLElBQUk7UUFDbkIsSUFBSSxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RCLElBQUksSUFBSSxDQUFDLE1BQU07Z0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QixDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksSUFBSSxDQUFDLE1BQU07Z0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQTtZQUMxQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3pCLENBQUM7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsaUJBQWlCLENBQUMsSUFBSTtRQUNwQixJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDM0MsSUFBSSxJQUFJLENBQUMsTUFBTTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1lBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzdCLENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxJQUFJLENBQUMsTUFBTTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBQzNDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDMUIsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsWUFBWSxDQUFDLElBQUk7UUFDckIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBRWYsSUFBSSxDQUFDO1lBQ0gsSUFBSSxNQUFNLENBQUE7WUFFVixJQUFJLElBQUksQ0FBQyxRQUFRO2dCQUFFLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUNqRCxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDNUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3BCLENBQUM7Z0JBQVMsQ0FBQztZQUNULElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUNmLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1FBQzNCLENBQUM7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUVmLElBQUksQ0FBQztZQUNILElBQUksTUFBTSxDQUFBO1lBRVYsSUFBSSxJQUFJLENBQUMsUUFBUTtnQkFBRSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7WUFDakQsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQzVCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNwQixDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7WUFDZixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtRQUMzQixDQUFDO0lBQ0gsQ0FBQztJQUVELG9KQUFvSjtJQUNwSjs7T0FFRztJQUNILGtCQUFrQjtRQUNoQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQzlCLFlBQVksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQTtRQUN6QyxDQUFDO1FBRUQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQy9ELENBQUM7Q0F3QkY7QUFFRDs7Ozs7O0dBTUciLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJlYWRlcnNXcml0ZXJMb2NrT3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSBbZGVidWddXG4gKi9cblxuLyoqXG4gKiBSZWFkZXJzLXdyaXRlciBsb2NrIHdpdGggcmVhZCBwcmlvcml0eS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVhZGVyc1dyaXRlckxvY2sge1xuICAvKipcbiAgICogQHBhcmFtIHtSZWFkZXJzV3JpdGVyTG9ja09wdGlvbnN9IFthcmdzXVxuICAgKi9cbiAgY29uc3RydWN0b3IoYXJncyA9IHt9KSB7XG4gICAgdGhpcy5fZGVidWcgPSBhcmdzLmRlYnVnXG4gICAgdGhpcy5fcmVhZGVycyA9IDBcbiAgICB0aGlzLl93cml0ZXJzID0gMFxuICAgIHRoaXMuX3Byb2Nlc3NRdWV1ZVRpbWVvdXQgPSBudWxsXG4gICAgLyoqIEB0eXBlIHtBcnJheTxSZWFkZXJzV3JpdGVyUXVldWVJdGVtPHVua25vd24+Pn0gKi9cbiAgICB0aGlzLl9yZWFkUXVldWUgPSBbXVxuICAgIC8qKiBAdHlwZSB7QXJyYXk8UmVhZGVyc1dyaXRlclF1ZXVlSXRlbTx1bmtub3duPj59ICovXG4gICAgdGhpcy5fd3JpdGVRdWV1ZSA9IFtdXG4gIH1cblxuICAvKipcbiAgICogUnVuIGEgam9iIHdpdGggc2hhcmVkIHJlYWQgYWNjZXNzLlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0geygoKSA9PiAoVCB8IFByb21pc2U8VD4pKX0gW2NhbGxiYWNrXVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxUIHwgdW5kZWZpbmVkPn1cbiAgICovXG4gIHJlYWQoY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy5fZGVidWcpIHRoaXMuX2xvZyhcInJlYWRcIilcblxuICAgIGlmICh0aGlzLl9yZWFkZXJzID09PSAwICYmIHRoaXMuX3dyaXRlcnMgPT09IDAgJiYgdGhpcy5fcmVhZFF1ZXVlLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl93cml0ZVF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMucnVuUmVhZEpvYkluc3RhbnRseShjYWxsYmFjaylcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLyoqIEB0eXBlIHtSZWFkZXJzV3JpdGVyUXVldWVJdGVtPFQ+fSAqL1xuICAgICAgY29uc3QgcXVldWVJdGVtID0ge2NhbGxiYWNrLCByZXNvbHZlLCByZWplY3R9XG5cbiAgICAgIHRoaXMuX3JlYWRXaXRoUmVzb2x2ZSgvKiogQHR5cGUge1JlYWRlcnNXcml0ZXJRdWV1ZUl0ZW08dW5rbm93bj59ICovIChxdWV1ZUl0ZW0pKVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogUnVuIGEgam9iIHdpdGggZXhjbHVzaXZlIHdyaXRlIGFjY2Vzcy5cbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHsoKCkgPT4gKFQgfCBQcm9taXNlPFQ+KSl9IFtjYWxsYmFja11cbiAgICogQHJldHVybnMge1Byb21pc2U8VCB8IHVuZGVmaW5lZD59XG4gICAqL1xuICB3cml0ZShjYWxsYmFjaykge1xuICAgIGlmICh0aGlzLl9kZWJ1ZykgdGhpcy5fbG9nKFwid3JpdGVcIilcblxuICAgIGlmICh0aGlzLl9yZWFkZXJzID09PSAwICYmIHRoaXMuX3dyaXRlcnMgPT09IDAgJiYgdGhpcy5fcmVhZFF1ZXVlLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl93cml0ZVF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMucnVuV3JpdGVKb2JJbnN0YW50bHkoY2FsbGJhY2spXG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8qKiBAdHlwZSB7UmVhZGVyc1dyaXRlclF1ZXVlSXRlbTxUPn0gKi9cbiAgICAgIGNvbnN0IHF1ZXVlSXRlbSA9IHtjYWxsYmFjaywgcmVzb2x2ZSwgcmVqZWN0fVxuXG4gICAgICB0aGlzLl93cml0ZVdpdGhSZXNvbHZlKC8qKiBAdHlwZSB7UmVhZGVyc1dyaXRlclF1ZXVlSXRlbTx1bmtub3duPn0gKi8gKHF1ZXVlSXRlbSkpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0geygoKSA9PiAoVCB8IFByb21pc2U8VD4pKX0gW2NhbGxiYWNrXVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxUIHwgdW5kZWZpbmVkPn1cbiAgICovXG4gIGFzeW5jIHJ1blJlYWRKb2JJbnN0YW50bHkoY2FsbGJhY2spIHtcbiAgICB0aGlzLl9yZWFkZXJzKytcblxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVzdWx0XG5cbiAgICAgIGlmIChjYWxsYmFjaykgcmVzdWx0ID0gYXdhaXQgY2FsbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9yZWFkZXJzLS1cblxuICAgICAgaWYgKHRoaXMuX3JlYWRRdWV1ZS5sZW5ndGggPiAwIHx8IHRoaXMuX3dyaXRlUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLl9wcm9jZXNzUXVldWVMYXRlcigpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSB7KCgpID0+IChUIHwgUHJvbWlzZTxUPikpfSBbY2FsbGJhY2tdXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFQgfCB1bmRlZmluZWQ+fVxuICAgKi9cbiAgYXN5bmMgcnVuV3JpdGVKb2JJbnN0YW50bHkoY2FsbGJhY2spIHtcbiAgICB0aGlzLl93cml0ZXJzKytcblxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVzdWx0XG5cbiAgICAgIGlmIChjYWxsYmFjaykgcmVzdWx0ID0gYXdhaXQgY2FsbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl93cml0ZXJzLS1cblxuICAgICAgaWYgKHRoaXMuX3JlYWRRdWV1ZS5sZW5ndGggPiAwIHx8IHRoaXMuX3dyaXRlUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLl9wcm9jZXNzUXVldWVMYXRlcigpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgX2xvZyhtZXNzYWdlKSB7XG4gICAgY29uc29sZS5sb2coXCJSZWFkZXJzV3JpdGVMb2NrXCIsIG1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KHtyZWFkZXJzOiB0aGlzLl9yZWFkZXJzLCB3cml0ZXJzOiB0aGlzLl93cml0ZXJzfSkpXG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtSZWFkZXJzV3JpdGVyUXVldWVJdGVtPHVua25vd24+fSBpdGVtXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgX3JlYWRXaXRoUmVzb2x2ZShpdGVtKSB7XG4gICAgaWYgKHRoaXMuX3dyaXRlcnMgPiAwKSB7XG4gICAgICBpZiAodGhpcy5fZGVidWcpIHRoaXMuX2xvZyhcIlF1ZXVlIHJlYWRcIilcbiAgICAgIHRoaXMuX3JlYWRRdWV1ZS5wdXNoKGl0ZW0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl9kZWJ1ZykgdGhpcy5fbG9nKFwiUHJvY2VzcyByZWFkXCIpXG4gICAgICB0aGlzLl9wcm9jZXNzUmVhZChpdGVtKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1JlYWRlcnNXcml0ZXJRdWV1ZUl0ZW08dW5rbm93bj59IGl0ZW1cbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqL1xuICBfd3JpdGVXaXRoUmVzb2x2ZShpdGVtKSB7XG4gICAgaWYgKHRoaXMuX3JlYWRlcnMgPiAwIHx8IHRoaXMuX3dyaXRlcnMgPiAwKSB7XG4gICAgICBpZiAodGhpcy5fZGVidWcpIHRoaXMuX2xvZyhcIlF1ZXVlIHdyaXRlXCIpXG4gICAgICB0aGlzLl93cml0ZVF1ZXVlLnB1c2goaXRlbSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX2RlYnVnKSB0aGlzLl9sb2coXCJQcm9jZXNzIHdyaXRlXCIpXG4gICAgICB0aGlzLl9wcm9jZXNzV3JpdGUoaXRlbSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtSZWFkZXJzV3JpdGVyUXVldWVJdGVtPHVua25vd24+fSBpdGVtXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKi9cbiAgYXN5bmMgX3Byb2Nlc3NSZWFkKGl0ZW0pIHtcbiAgICB0aGlzLl9yZWFkZXJzKytcblxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVzdWx0XG5cbiAgICAgIGlmIChpdGVtLmNhbGxiYWNrKSByZXN1bHQgPSBhd2FpdCBpdGVtLmNhbGxiYWNrKClcbiAgICAgIGF3YWl0IGl0ZW0ucmVzb2x2ZShyZXN1bHQpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGl0ZW0ucmVqZWN0KGVycm9yKVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9yZWFkZXJzLS1cbiAgICAgIHRoaXMuX3Byb2Nlc3NRdWV1ZUxhdGVyKClcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtSZWFkZXJzV3JpdGVyUXVldWVJdGVtPHVua25vd24+fSBpdGVtXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKi9cbiAgYXN5bmMgX3Byb2Nlc3NXcml0ZShpdGVtKSB7XG4gICAgdGhpcy5fd3JpdGVycysrXG5cbiAgICB0cnkge1xuICAgICAgbGV0IHJlc3VsdFxuXG4gICAgICBpZiAoaXRlbS5jYWxsYmFjaykgcmVzdWx0ID0gYXdhaXQgaXRlbS5jYWxsYmFjaygpXG4gICAgICBhd2FpdCBpdGVtLnJlc29sdmUocmVzdWx0KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpdGVtLnJlamVjdChlcnJvcilcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5fd3JpdGVycy0tXG4gICAgICB0aGlzLl9wcm9jZXNzUXVldWVMYXRlcigpXG4gICAgfVxuICB9XG5cbiAgLy8gRmlyc3QgZXhlY3V0ZSBhbnl0aGluZyB3YWl0aW5nIGFmdGVyIGhhdmluZyBnaXZlbiB0aGUgbG9jayBiYWNrIHRvIHRoZSBvcmlnaW5hbCBjYWxsZXIgYnkgZXhlY3V0aW5nIGF0IHRoZSBlbmQgb2YgdGhlIGV2ZW50LXF1ZXVlIGJ5IHRpbWVvdXQtaGFja1xuICAvKipcbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqL1xuICBfcHJvY2Vzc1F1ZXVlTGF0ZXIoKSB7XG4gICAgaWYgKHRoaXMuX3Byb2Nlc3NRdWV1ZVRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9wcm9jZXNzUXVldWVUaW1lb3V0KVxuICAgIH1cblxuICAgIHRoaXMuX3Byb2Nlc3NRdWV1ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX3Byb2Nlc3NRdWV1ZSwgMClcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7dm9pZH1cbiAgICovXG4gIF9wcm9jZXNzUXVldWUgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuX3dyaXRlcnMgPT0gMCkge1xuICAgICAgLy8gSWYgbm8gb25lIGhhcyBiZWd1biB3cml0aW5nLCB3ZSBzaG91bGQgdHJ5IGFuZCBwcm9jZWVkIHRvIG5leHQgcmVhZCBpdGVtIGlmIGFueVxuICAgICAgY29uc3QgcmVhZFF1ZXVlSXRlbSA9IHRoaXMuX3JlYWRRdWV1ZS5zaGlmdCgpXG5cbiAgICAgIGlmIChyZWFkUXVldWVJdGVtKSB7XG4gICAgICAgIGlmICh0aGlzLl9kZWJ1ZykgdGhpcy5fbG9nKFwiUHJvY2VzcyBuZXh0IHJlYWRcIilcbiAgICAgICAgdGhpcy5fcHJvY2Vzc1JlYWQocmVhZFF1ZXVlSXRlbSlcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5fcmVhZGVycyA9PSAwKSB7XG4gICAgICAgIC8vIE5vIHdyaXRlcnMsIG5vIG5leHQgaXRlbSB0byByZWFkIC0gd2Ugc2hvdWxkIHRyeSBhbmQgcHJvY2VlZCB0byBuZXh0IHdyaXRlIGl0ZW0gaWYgYW55XG4gICAgICAgIGNvbnN0IHdyaXRlUXVldWVJdGVtID0gdGhpcy5fd3JpdGVRdWV1ZS5zaGlmdCgpXG5cbiAgICAgICAgaWYgKHdyaXRlUXVldWVJdGVtKSB7XG4gICAgICAgICAgaWYgKHRoaXMuX2RlYnVnKSB0aGlzLl9sb2coXCJQcm9jZXNzIG5leHQgd3JpdGVcIilcbiAgICAgICAgICB0aGlzLl9wcm9jZXNzV3JpdGUod3JpdGVRdWV1ZUl0ZW0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBAdGVtcGxhdGUgVFxuICogQHR5cGVkZWYge09iamVjdH0gUmVhZGVyc1dyaXRlclF1ZXVlSXRlbVxuICogQHByb3BlcnR5IHsoKCkgPT4gKFQgfCBQcm9taXNlPFQ+KSkgfCB1bmRlZmluZWR9IGNhbGxiYWNrXG4gKiBAcHJvcGVydHkgeyh2YWx1ZTogVCB8IHVuZGVmaW5lZCkgPT4gdm9pZH0gcmVzb2x2ZVxuICogQHByb3BlcnR5IHsoZXJyb3I6IHVua25vd24pID0+IHZvaWR9IHJlamVjdFxuICovXG4iXX0=