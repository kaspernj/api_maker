import * as stackTraceParser from "stacktrace-parser";
import Logger from "./logger.js";
import { SourceMapConsumer } from "source-map";
import uniqunize from "uniqunize";
// Sometimes this needs to be called and sometimes not
if (SourceMapConsumer.initialize) {
    SourceMapConsumer.initialize({
        "lib/mappings.wasm": "https://unpkg.com/source-map@0.7.4/lib/mappings.wasm"
    });
}
const logger = new Logger({ name: "ApiMaker / SourceMapsLoader" });
export default class SourceMapsLoader {
    constructor() {
        this.isLoadingSourceMaps = false;
        this.sourceMaps = [];
        this.srcLoaded = {};
    }
    loadSourceMapsForScriptTags(callback) {
        this.loadSourceMapsForScriptTagsCallback = callback;
    }
    sourceMapForSource(callback) {
        this.sourceMapForSourceCallback = callback;
    }
    async loadSourceMaps(error) {
        if (!error)
            throw new Error("No error was given to SourceMapsLoader#loadSourceMaps");
        this.isLoadingSourceMaps = true;
        try {
            const promises = [];
            const sources = this.getSources(error);
            for (const source of sources) {
                if (source.originalUrl && !this.srcLoaded[source.originalUrl]) {
                    this.srcLoaded[source.originalUrl] = true;
                    const promise = this.loadSourceMapForSource(source);
                    promises.push(promise);
                }
            }
            await Promise.all(promises);
        }
        finally {
            this.isLoadingSourceMaps = false;
        }
    }
    getSources(error) {
        let sources = this.getSourcesFromScripts();
        if (error)
            sources = sources.concat(this.getSourcesFromError(error));
        return uniqunize(sources, (source) => source.originalUrl);
    }
    getSourcesFromError(error) {
        const stack = stackTraceParser.parse(error.stack);
        const sources = [];
        for (const trace of stack) {
            const file = trace.file;
            if (file != "\u003Canonymous>") {
                const sourceMapUrl = this.getMapURL({ src: file });
                if (sourceMapUrl) {
                    logger.debug(() => `Found source map from error: ${sourceMapUrl}`);
                    sources.push({ originalUrl: file, sourceMapUrl });
                }
                else {
                    logger.debug(() => `Coudn't get source map from: ${file}`);
                }
            }
        }
        return sources;
    }
    getSourcesFromScripts() {
        const scripts = document.querySelectorAll("script");
        const sources = [];
        for (const script of scripts) {
            const sourceMapUrl = this.getMapURL({ script, src: script.src });
            if (sourceMapUrl) {
                logger.debug(() => `Found source map from script: ${sourceMapUrl}`);
                sources.push({ originalUrl: script.src, sourceMapUrl });
            }
        }
        return sources;
    }
    getMapURL({ script, src }) {
        const url = this.loadUrl(src);
        const originalUrl = `${url.origin}${url.pathname}`;
        if (this.sourceMapForSourceCallback) {
            // Use custom callback to resolve which map-file to download
            return this.sourceMapForSourceCallback({ originalUrl, script, src, url });
        }
        else if (this.includeMapURL(src)) {
            // Default to original URL with '.map' appended
            return `${originalUrl}.map`;
        }
    }
    includeMapURL = (src) => src.includes("/packs/");
    async loadSourceMapForSource({ originalUrl, sourceMapUrl }) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", sourceMapUrl, true);
        try {
            await this.loadXhr(xhr, sourceMapUrl);
        }
        catch (error) {
            console.log(`Couldn't load source map from: ${sourceMapUrl}: ${xhr.responseText}`);
            return;
        }
        const consumer = await new SourceMapConsumer(xhr.responseText);
        if (consumer) {
            this.sourceMaps.push({ consumer, originalUrl });
        }
    }
    loadUrl(url) {
        const parser = document.createElement("a");
        parser.href = url;
        return parser;
    }
    loadXhr(xhr, url) {
        return new Promise((resolve, reject) => {
            xhr.onload = () => {
                if (xhr.status == 200) {
                    resolve();
                }
                else {
                    reject(new Error(`HTTP request failed with ${xhr.status} for ${url}`));
                }
            };
            xhr.send();
        });
    }
    parseStackTrace(stackTrace) {
        return this.getStackTraceData(stackTrace)
            .map((traceData) => `at ${traceData.methodName} (${traceData.fileString})`);
    }
    getStackTraceData(stackTrace) {
        const stack = stackTraceParser.parse(stackTrace);
        const newSourceMap = [];
        for (const trace of stack) {
            const sourceMapData = this.sourceMaps.find((sourceMapData) => sourceMapData.originalUrl == trace.file);
            let filePath, fileString, original;
            if (sourceMapData) {
                original = sourceMapData.consumer.originalPositionFor({
                    line: trace.lineNumber,
                    column: trace.column
                });
            }
            if (original && original.source) {
                filePath = original.source.replace(/^webpack:\/\/(app|)\//, "");
                fileString = `${filePath}:${original.line}`;
                if (original.column) {
                    fileString += `:${original.column}`;
                }
            }
            else {
                filePath = trace.file;
                fileString = `${filePath}:${trace.lineNumber}`;
                if (trace.column) {
                    fileString += `:${trace.column}`;
                }
            }
            newSourceMap.push({
                filePath,
                fileString,
                methodName: trace.methodName
            });
        }
        return newSourceMap;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic291cmNlLW1hcHMtbG9hZGVyLmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJzb3VyY2UtbWFwcy1sb2FkZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLGdCQUFnQixNQUFNLG1CQUFtQixDQUFBO0FBQ3JELE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQTtBQUNoQyxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxZQUFZLENBQUE7QUFDNUMsT0FBTyxTQUFTLE1BQU0sV0FBVyxDQUFBO0FBRWpDLHNEQUFzRDtBQUN0RCxJQUFJLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ2pDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQztRQUMzQixtQkFBbUIsRUFBRSxzREFBc0Q7S0FDNUUsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVELE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUMsSUFBSSxFQUFFLDZCQUE2QixFQUFDLENBQUMsQ0FBQTtBQUVoRSxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUFnQjtJQUNuQztRQUNFLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUE7UUFDaEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUE7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUE7SUFDckIsQ0FBQztJQUVELDJCQUEyQixDQUFDLFFBQVE7UUFDbEMsSUFBSSxDQUFDLG1DQUFtQyxHQUFHLFFBQVEsQ0FBQTtJQUNyRCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsUUFBUTtRQUN6QixJQUFJLENBQUMsMEJBQTBCLEdBQUcsUUFBUSxDQUFBO0lBQzVDLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUs7UUFDeEIsSUFBSSxDQUFDLEtBQUs7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUE7UUFFcEYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FB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RSxDQUFBO2dCQUU5QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDakIsVUFBVSxJQUFJLElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFBO2dCQUNsQyxDQUFDO1lBQ0gsQ0FBQztZQUVELFlBQVksQ0FBQyxJQUFJLENBQUM7Z0JBQ2hCLFFBQVE7Z0JBQ1IsVUFBVTtnQkFDVixVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7YUFDN0IsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUVELE9BQU8sWUFBWSxDQUFBO0lBQ3JCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHN0YWNrVHJhY2VQYXJzZXIgZnJvbSBcInN0YWNrdHJhY2UtcGFyc2VyXCJcbmltcG9ydCBMb2dnZXIgZnJvbSBcIi4vbG9nZ2VyLmpzXCJcbmltcG9ydCB7U291cmNlTWFwQ29uc3VtZXJ9IGZyb20gXCJzb3VyY2UtbWFwXCJcbmltcG9ydCB1bmlxdW5pemUgZnJvbSBcInVuaXF1bml6ZVwiXG5cbi8vIFNvbWV0aW1lcyB0aGlzIG5lZWRzIHRvIGJlIGNhbGxlZCBhbmQgc29tZXRpbWVzIG5vdFxuaWYgKFNvdXJjZU1hcENvbnN1bWVyLmluaXRpYWxpemUpIHtcbiAgU291cmNlTWFwQ29uc3VtZXIuaW5pdGlhbGl6ZSh7XG4gICAgXCJsaWIvbWFwcGluZ3Mud2FzbVwiOiBcImh0dHBzOi8vdW5wa2cuY29tL3NvdXJjZS1tYXBAMC43LjQvbGliL21hcHBpbmdzLndhc21cIlxuICB9KVxufVxuXG5jb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHtuYW1lOiBcIkFwaU1ha2VyIC8gU291cmNlTWFwc0xvYWRlclwifSlcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU291cmNlTWFwc0xvYWRlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuaXNMb2FkaW5nU291cmNlTWFwcyA9IGZhbHNlXG4gICAgdGhpcy5zb3VyY2VNYXBzID0gW11cbiAgICB0aGlzLnNyY0xvYWRlZCA9IHt9XG4gIH1cblxuICBsb2FkU291cmNlTWFwc0ZvclNjcmlwdFRhZ3MoY2FsbGJhY2spIHtcbiAgICB0aGlzLmxvYWRTb3VyY2VNYXBzRm9yU2NyaXB0VGFnc0NhbGxiYWNrID0gY2FsbGJhY2tcbiAgfVxuXG4gIHNvdXJjZU1hcEZvclNvdXJjZShjYWxsYmFjaykge1xuICAgIHRoaXMuc291cmNlTWFwRm9yU291cmNlQ2FsbGJhY2sgPSBjYWxsYmFja1xuICB9XG5cbiAgYXN5bmMgbG9hZFNvdXJjZU1hcHMoZXJyb3IpIHtcbiAgICBpZiAoIWVycm9yKSB0aHJvdyBuZXcgRXJyb3IoXCJObyBlcnJvciB3YXMgZ2l2ZW4gdG8gU291cmNlTWFwc0xvYWRlciNsb2FkU291cmNlTWFwc1wiKVxuXG4gICAgdGhpcy5pc0xvYWRpbmdTb3VyY2VNYXBzID0gdHJ1ZVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb21pc2VzID0gW11cbiAgICAgIGNvbnN0IHNvdXJjZXMgPSB0aGlzLmdldFNvdXJjZXMoZXJyb3IpXG5cbiAgICAgIGZvcihjb25zdCBzb3VyY2Ugb2Ygc291cmNlcykge1xuICAgICAgICBpZiAoc291cmNlLm9yaWdpbmFsVXJsICYmICF0aGlzLnNyY0xvYWRlZFtzb3VyY2Uub3JpZ2luYWxVcmxdKSB7XG4gICAgICAgICAgdGhpcy5zcmNMb2FkZWRbc291cmNlLm9yaWdpbmFsVXJsXSA9IHRydWVcblxuICAgICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmxvYWRTb3VyY2VNYXBGb3JTb3VyY2Uoc291cmNlKVxuICAgICAgICAgIHByb21pc2VzLnB1c2gocHJvbWlzZSlcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcylcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5pc0xvYWRpbmdTb3VyY2VNYXBzID0gZmFsc2VcbiAgICB9XG4gIH1cblxuICBnZXRTb3VyY2VzKGVycm9yKSB7XG4gICAgbGV0IHNvdXJjZXMgPSB0aGlzLmdldFNvdXJjZXNGcm9tU2NyaXB0cygpXG5cbiAgICBpZiAoZXJyb3IpIHNvdXJjZXMgPSBzb3VyY2VzLmNvbmNhdCh0aGlzLmdldFNvdXJjZXNGcm9tRXJyb3IoZXJyb3IpKVxuXG4gICAgcmV0dXJuIHVuaXF1bml6ZShzb3VyY2VzLCAoc291cmNlKSA9PiBzb3VyY2Uub3JpZ2luYWxVcmwpXG4gIH1cblxuICBnZXRTb3VyY2VzRnJvbUVycm9yKGVycm9yKSB7XG4gICAgY29uc3Qgc3RhY2sgPSBzdGFja1RyYWNlUGFyc2VyLnBhcnNlKGVycm9yLnN0YWNrKVxuICAgIGNvbnN0IHNvdXJjZXMgPSBbXVxuXG4gICAgZm9yIChjb25zdCB0cmFjZSBvZiBzdGFjaykge1xuICAgICAgY29uc3QgZmlsZSA9IHRyYWNlLmZpbGVcblxuICAgICAgaWYgKGZpbGUgIT0gXCJcXHUwMDNDYW5vbnltb3VzPlwiKSB7XG4gICAgICAgIGNvbnN0IHNvdXJjZU1hcFVybCA9IHRoaXMuZ2V0TWFwVVJMKHtzcmM6IGZpbGV9KVxuXG4gICAgICAgIGlmIChzb3VyY2VNYXBVcmwpIHtcbiAgICAgICAgICBsb2dnZXIuZGVidWcoKCkgPT4gYEZvdW5kIHNvdXJjZSBtYXAgZnJvbSBlcnJvcjogJHtzb3VyY2VNYXBVcmx9YClcblxuICAgICAgICAgIHNvdXJjZXMucHVzaCh7b3JpZ2luYWxVcmw6IGZpbGUsIHNvdXJjZU1hcFVybH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBDb3Vkbid0IGdldCBzb3VyY2UgbWFwIGZyb206ICR7ZmlsZX1gKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNvdXJjZXNcbiAgfVxuXG4gIGdldFNvdXJjZXNGcm9tU2NyaXB0cygpIHtcbiAgICBjb25zdCBzY3JpcHRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdFwiKVxuICAgIGNvbnN0IHNvdXJjZXMgPSBbXVxuXG4gICAgZm9yIChjb25zdCBzY3JpcHQgb2Ygc2NyaXB0cykge1xuICAgICAgY29uc3Qgc291cmNlTWFwVXJsID0gdGhpcy5nZXRNYXBVUkwoe3NjcmlwdCwgc3JjOiBzY3JpcHQuc3JjfSlcblxuICAgICAgaWYgKHNvdXJjZU1hcFVybCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoKCkgPT4gYEZvdW5kIHNvdXJjZSBtYXAgZnJvbSBzY3JpcHQ6ICR7c291cmNlTWFwVXJsfWApXG4gICAgICAgIHNvdXJjZXMucHVzaCh7b3JpZ2luYWxVcmw6IHNjcmlwdC5zcmMsIHNvdXJjZU1hcFVybH0pXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNvdXJjZXNcbiAgfVxuXG4gIGdldE1hcFVSTCh7c2NyaXB0LCBzcmN9KSB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5sb2FkVXJsKHNyYylcbiAgICBjb25zdCBvcmlnaW5hbFVybCA9IGAke3VybC5vcmlnaW59JHt1cmwucGF0aG5hbWV9YFxuXG4gICAgaWYgKHRoaXMuc291cmNlTWFwRm9yU291cmNlQ2FsbGJhY2spIHtcbiAgICAgIC8vIFVzZSBjdXN0b20gY2FsbGJhY2sgdG8gcmVzb2x2ZSB3aGljaCBtYXAtZmlsZSB0byBkb3dubG9hZFxuICAgICAgcmV0dXJuIHRoaXMuc291cmNlTWFwRm9yU291cmNlQ2FsbGJhY2soe29yaWdpbmFsVXJsLCBzY3JpcHQsIHNyYywgdXJsfSlcbiAgICB9IGVsc2UgaWYgKHRoaXMuaW5jbHVkZU1hcFVSTChzcmMpKSB7XG4gICAgICAvLyBEZWZhdWx0IHRvIG9yaWdpbmFsIFVSTCB3aXRoICcubWFwJyBhcHBlbmRlZFxuICAgICAgcmV0dXJuIGAke29yaWdpbmFsVXJsfS5tYXBgXG4gICAgfVxuICB9XG5cbiAgaW5jbHVkZU1hcFVSTCA9IChzcmMpID0+IHNyYy5pbmNsdWRlcyhcIi9wYWNrcy9cIilcblxuICBhc3luYyBsb2FkU291cmNlTWFwRm9yU291cmNlKHtvcmlnaW5hbFVybCwgc291cmNlTWFwVXJsfSkge1xuICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpXG5cbiAgICB4aHIub3BlbihcIkdFVFwiLCBzb3VyY2VNYXBVcmwsIHRydWUpXG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5sb2FkWGhyKHhociwgc291cmNlTWFwVXJsKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZyhgQ291bGRuJ3QgbG9hZCBzb3VyY2UgbWFwIGZyb206ICR7c291cmNlTWFwVXJsfTogJHt4aHIucmVzcG9uc2VUZXh0fWApXG5cbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IGNvbnN1bWVyID0gYXdhaXQgbmV3IFNvdXJjZU1hcENvbnN1bWVyKHhoci5yZXNwb25zZVRleHQpXG5cbiAgICBpZiAoY29uc3VtZXIpIHtcbiAgICAgIHRoaXMuc291cmNlTWFwcy5wdXNoKHtjb25zdW1lciwgb3JpZ2luYWxVcmx9KVxuICAgIH1cbiAgfVxuXG4gIGxvYWRVcmwodXJsKSB7XG4gICAgY29uc3QgcGFyc2VyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIilcblxuICAgIHBhcnNlci5ocmVmID0gdXJsXG5cbiAgICByZXR1cm4gcGFyc2VyXG4gIH1cblxuICBsb2FkWGhyKHhociwgdXJsKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHhoci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIGlmICh4aHIuc3RhdHVzID09IDIwMCkge1xuICAgICAgICAgIHJlc29sdmUoKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYEhUVFAgcmVxdWVzdCBmYWlsZWQgd2l0aCAke3hoci5zdGF0dXN9IGZvciAke3VybH1gKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgeGhyLnNlbmQoKVxuICAgIH0pXG4gIH1cblxuICBwYXJzZVN0YWNrVHJhY2Uoc3RhY2tUcmFjZSkge1xuICAgIHJldHVybiB0aGlzLmdldFN0YWNrVHJhY2VEYXRhKHN0YWNrVHJhY2UpXG4gICAgICAubWFwKCh0cmFjZURhdGEpID0+IGBhdCAke3RyYWNlRGF0YS5tZXRob2ROYW1lfSAoJHt0cmFjZURhdGEuZmlsZVN0cmluZ30pYClcbiAgfVxuXG4gIGdldFN0YWNrVHJhY2VEYXRhKHN0YWNrVHJhY2UpIHtcbiAgICBjb25zdCBzdGFjayA9IHN0YWNrVHJhY2VQYXJzZXIucGFyc2Uoc3RhY2tUcmFjZSlcbiAgICBjb25zdCBuZXdTb3VyY2VNYXAgPSBbXVxuXG4gICAgZm9yIChjb25zdCB0cmFjZSBvZiBzdGFjaykge1xuICAgICAgY29uc3Qgc291cmNlTWFwRGF0YSA9IHRoaXMuc291cmNlTWFwcy5maW5kKChzb3VyY2VNYXBEYXRhKSA9PiBzb3VyY2VNYXBEYXRhLm9yaWdpbmFsVXJsID09IHRyYWNlLmZpbGUpXG5cbiAgICAgIGxldCBmaWxlUGF0aCwgZmlsZVN0cmluZywgb3JpZ2luYWxcblxuICAgICAgaWYgKHNvdXJjZU1hcERhdGEpIHtcbiAgICAgICAgb3JpZ2luYWwgPSBzb3VyY2VNYXBEYXRhLmNvbnN1bWVyLm9yaWdpbmFsUG9zaXRpb25Gb3Ioe1xuICAgICAgICAgIGxpbmU6IHRyYWNlLmxpbmVOdW1iZXIsXG4gICAgICAgICAgY29sdW1uOiB0cmFjZS5jb2x1bW5cbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgaWYgKG9yaWdpbmFsICYmIG9yaWdpbmFsLnNvdXJjZSkge1xuICAgICAgICBmaWxlUGF0aCA9IG9yaWdpbmFsLnNvdXJjZS5yZXBsYWNlKC9ed2VicGFjazpcXC9cXC8oYXBwfClcXC8vLCBcIlwiKVxuICAgICAgICBmaWxlU3RyaW5nID0gYCR7ZmlsZVBhdGh9OiR7b3JpZ2luYWwubGluZX1gXG5cbiAgICAgICAgaWYgKG9yaWdpbmFsLmNvbHVtbikge1xuICAgICAgICAgIGZpbGVTdHJpbmcgKz0gYDoke29yaWdpbmFsLmNvbHVtbn1gXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpbGVQYXRoID0gdHJhY2UuZmlsZVxuICAgICAgICBmaWxlU3RyaW5nID0gYCR7ZmlsZVBhdGh9OiR7dHJhY2UubGluZU51bWJlcn1gXG5cbiAgICAgICAgaWYgKHRyYWNlLmNvbHVtbikge1xuICAgICAgICAgIGZpbGVTdHJpbmcgKz0gYDoke3RyYWNlLmNvbHVtbn1gXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbmV3U291cmNlTWFwLnB1c2goe1xuICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgZmlsZVN0cmluZyxcbiAgICAgICAgbWV0aG9kTmFtZTogdHJhY2UubWV0aG9kTmFtZVxuICAgICAgfSlcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3U291cmNlTWFwXG4gIH1cbn1cbiJdfQ==