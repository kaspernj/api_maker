import React, { useMemo } from "react";
import { Pressable, StyleSheet, View } from "react-native";
import BaseComponent from "../base-component.js";
import ConfigReader from "./config-reader.js";
import EditPage from "./edit-page.js";
import FlashNotifications from "flash-notifications/build/flash-notifications.js";
import hasEditConfig from "./has-edit-config.js";
import IndexPage from "./index-page.js";
import Layout from "./layout/index.js";
import Link from "../link.js";
import memo from "set-state-compare/build/memo.js";
// @ts-expect-error
import * as models from "models.js";
import Params from "../params.js";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import ShowPage from "./show-page/index.js";
import ShowReflectionActions from "./show-reflection-actions.js";
import ShowReflectionPage from "./show-reflection-page.js";
import Text from "../utils/text.js";
import useCanCan from "../use-can-can.js";
import useCurrentUser from "../use-current-user.js";
import useQueryParams from "on-location-changed/build/use-query-params.js";
import useStyles from "../use-styles.js";
const styles = StyleSheet.create({
    actionsView: {
        flexDirection: "row",
        alignItems: "center"
    },
    createNewModelLink: {
        marginLeft: 10,
        marginRight: 10
    },
    destroyModelLink: {
        marginLeft: 10,
        marginRight: 10
    },
    editModelLink: {
        marginLeft: 10,
        marginRight: 10
    }
});
export default memo(shapeComponent(class ApiMakerSuperAdmin extends BaseComponent {
    setup() {
        this.queryParams = useQueryParams();
        if (this.queryParams.model) {
            this.modelClass = models[this.queryParams.model];
        }
        else {
            this.modelClass = null;
        }
        this.configReader = useMemo(() => this.modelClass && ConfigReader.forModel(this.modelClass), [this.modelClass]);
        this.modelId = this.queryParams.model_id;
        this.modelName = this.modelClass?.modelClassData()?.name;
        this.currentUser = useCurrentUser();
        this.canCan = useCanCan(() => {
            const abilities = [];
            if (this.modelClass)
                abilities.push([this.modelClass, ["new"]]);
            return abilities;
        }, [this.currentUser?.id(), this.modelClass]);
        this.useStates({
            model: undefined
        });
        useMemo(() => { this.loadModel(); }, [this.modelId]);
    }
    loadModel = async () => {
        const { configReader, modelClass, modelId, modelName } = this.tt;
        if (modelId && modelClass) {
            const abilities = {};
            const abilitiesForModel = ["destroy", "edit"];
            const layoutSelect = configReader?.modelConfig?.layout?.select;
            abilities[modelName] = abilitiesForModel;
            const query = await modelClass
                .ransack({ id_eq: modelId })
                .abilities(abilities);
            if (layoutSelect)
                query.select(layoutSelect);
            const model = await query.first();
            this.setState({ model });
        }
        else {
            this.setState({ model: undefined });
        }
    };
    render() {
        const { canCan, configReader, modelClass, modelId, modelName, queryParams } = this.tt;
        const { model } = this.s;
        const modelConfigActions = configReader?.modelConfig?.actions;
        let pageToShow;
        if (queryParams.model && queryParams.model_id && queryParams.model_reflection) {
            pageToShow = "show_reflection";
        }
        else if (queryParams.model && queryParams.model_id && queryParams.mode == "edit") {
            pageToShow = "edit";
        }
        else if (queryParams.model && queryParams.model_id) {
            pageToShow = "show";
        }
        else if (queryParams.model && queryParams.mode == "new") {
            pageToShow = "edit";
        }
        else if (queryParams.model) {
            pageToShow = "index";
        }
        else {
            pageToShow = "welcome";
        }
        const actionsViewStyle = useStyles(styles, "actionsView");
        const actions = useMemo(() => <View style={actionsViewStyle}>
        {model && modelConfigActions && modelConfigActions({ model })}
        {modelClass && pageToShow == "index" &&
                <>
            {canCan?.can("new", modelClass) && hasEditConfig(modelClass) &&
                        <Link dataSet={{ class: "create-new-model-link" }} style={styles.createNewModelLink} to={Params.withParams({ model: modelName, mode: "new" })}>
                <Text>
                  Create new
                </Text>
              </Link>}
          </>}
        {model && pageToShow == "show" &&
                <>
            {model.can("edit") && hasEditConfig(modelClass) &&
                        <Link dataSet={{ class: "edit-model-link" }} style={styles.editModelLink} to={Params.withParams({ model: modelName, model_id: modelId, mode: "edit" })}>
                <Text>
                  Edit
                </Text>
              </Link>}
            {model.can("destroy") &&
                        <Pressable dataSet={{ class: "destroy-model-link" }} onPress={this.tt.onDestroyClicked} style={styles.destroyModelLink}>
                <Text>
                  Delete
                </Text>
              </Pressable>}
          </>}
        {pageToShow == "show_reflection" &&
                <ShowReflectionActions model={model} modelClass={modelClass} reflectionName={queryParams.model_reflection}/>}
      </View>, [canCan, configReader?.actions, model, modelClass, pageToShow]);
        return (<Layout actions={actions} active={queryParams.model} headerTitle={modelClass?.modelName()?.human({ count: 2 })}>
        {pageToShow == "index" &&
                <IndexPage key={`index-page-${modelName}`} modelClass={modelClass}/>}
        {pageToShow == "show" &&
                <ShowPage key={`show-page-${modelName}-${modelId}`} modelClass={modelClass} modelId={modelId}/>}
        {pageToShow == "show_reflection" &&
                <ShowReflectionPage key={`show-reflection-page-${modelName}-${modelId}`} modelClass={modelClass} modelId={modelId}/>}
        {pageToShow == "edit" &&
                <EditPage key={`edit-page-${modelName}-${modelId}`} modelClass={modelClass}/>}
      </Layout>);
    }
    onDestroyClicked = async () => {
        if (!confirm("Are you sure?")) {
            return;
        }
        try {
            await this.s.model.destroy();
            Params.changeParams({ mode: undefined, model_id: undefined });
        }
        catch (error) {
            FlashNotifications.errorResponse(error);
        }
    };
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInN1cGVyLWFkbWluL2luZGV4LmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxFQUFDLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUNwQyxPQUFPLEVBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUE7QUFDeEQsT0FBTyxhQUFhLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxZQUFZLE1BQU0sb0JBQW9CLENBQUE7QUFDN0MsT0FBTyxRQUFRLE1BQU0sZ0JBQWdCLENBQUE7QUFDckMsT0FBTyxrQkFBa0IsTUFBTSxrREFBa0QsQ0FBQTtBQUNqRixPQUFPLGFBQWEsTUFBTSxzQkFBc0IsQ0FBQTtBQUNoRCxPQUFPLFNBQVMsTUFBTSxpQkFBaUIsQ0FBQTtBQUN2QyxPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQTtBQUN0QyxPQUFPLElBQUksTUFBTSxZQUFZLENBQUE7QUFDN0IsT0FBTyxJQUFJLE1BQU0saUNBQWlDLENBQUE7QUFDbEQsbUJBQW1CO0FBQ25CLE9BQU8sS0FBSyxNQUFNLE1BQU0sV0FBVyxDQUFBO0FBQ25DLE9BQU8sTUFBTSxNQUFNLGNBQWMsQ0FBQTtBQUNqQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sNENBQTRDLENBQUE7QUFDekUsT0FBTyxRQUFRLE1BQU0sc0JBQXNCLENBQUE7QUFDM0MsT0FBTyxxQkFBcUIsTUFBTSw4QkFBOEIsQ0FBQTtBQUNoRSxPQUFPLGtCQUFrQixNQUFNLDJCQUEyQixDQUFBO0FBQzFELE9BQU8sSUFBSSxNQUFNLGtCQUFrQixDQUFBO0FBQ25DLE9BQU8sU0FBUyxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sY0FBYyxNQUFNLHdCQUF3QixDQUFBO0FBQ25ELE9BQU8sY0FBYyxNQUFNLCtDQUErQyxDQUFBO0FBQzFFLE9BQU8sU0FBUyxNQUFNLGtC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QUM5QixPQUFNO1FBQ1IsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUE7WUFFNUIsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUE7UUFDN0QsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixrQkFBa0IsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDekMsQ0FBQztJQUNILENBQUMsQ0FBQTtDQUNGLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSBcInJlYWN0XCJcbmltcG9ydCB7UHJlc3NhYmxlLCBTdHlsZVNoZWV0LCBWaWV3fSBmcm9tIFwicmVhY3QtbmF0aXZlXCJcbmltcG9ydCBCYXNlQ29tcG9uZW50IGZyb20gXCIuLi9iYXNlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgQ29uZmlnUmVhZGVyIGZyb20gXCIuL2NvbmZpZy1yZWFkZXIuanNcIlxuaW1wb3J0IEVkaXRQYWdlIGZyb20gXCIuL2VkaXQtcGFnZS5qc1wiXG5pbXBvcnQgRmxhc2hOb3RpZmljYXRpb25zIGZyb20gXCJmbGFzaC1ub3RpZmljYXRpb25zL2J1aWxkL2ZsYXNoLW5vdGlmaWNhdGlvbnMuanNcIlxuaW1wb3J0IGhhc0VkaXRDb25maWcgZnJvbSBcIi4vaGFzLWVkaXQtY29uZmlnLmpzXCJcbmltcG9ydCBJbmRleFBhZ2UgZnJvbSBcIi4vaW5kZXgtcGFnZS5qc1wiXG5pbXBvcnQgTGF5b3V0IGZyb20gXCIuL2xheW91dC9pbmRleC5qc1wiXG5pbXBvcnQgTGluayBmcm9tIFwiLi4vbGluay5qc1wiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG4vLyBAdHMtZXhwZWN0LWVycm9yXG5pbXBvcnQgKiBhcyBtb2RlbHMgZnJvbSBcIm1vZGVscy5qc1wiXG5pbXBvcnQgUGFyYW1zIGZyb20gXCIuLi9wYXJhbXMuanNcIlxuaW1wb3J0IHtzaGFwZUNvbXBvbmVudH0gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3NoYXBlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgU2hvd1BhZ2UgZnJvbSBcIi4vc2hvdy1wYWdlL2luZGV4LmpzXCJcbmltcG9ydCBTaG93UmVmbGVjdGlvbkFjdGlvbnMgZnJvbSBcIi4vc2hvdy1yZWZsZWN0aW9uLWFjdGlvbnMuanNcIlxuaW1wb3J0IFNob3dSZWZsZWN0aW9uUGFnZSBmcm9tIFwiLi9zaG93LXJlZmxlY3Rpb24tcGFnZS5qc1wiXG5pbXBvcnQgVGV4dCBmcm9tIFwiLi4vdXRpbHMvdGV4dC5qc1wiXG5pbXBvcnQgdXNlQ2FuQ2FuIGZyb20gXCIuLi91c2UtY2FuLWNhbi5qc1wiXG5pbXBvcnQgdXNlQ3VycmVudFVzZXIgZnJvbSBcIi4uL3VzZS1jdXJyZW50LXVzZXIuanNcIlxuaW1wb3J0IHVzZVF1ZXJ5UGFyYW1zIGZyb20gXCJvbi1sb2NhdGlvbi1jaGFuZ2VkL2J1aWxkL3VzZS1xdWVyeS1wYXJhbXMuanNcIlxuaW1wb3J0IHVzZVN0eWxlcyBmcm9tIFwiLi4vdXNlLXN0eWxlcy5qc1wiXG5cbmNvbnN0IHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHtcbiAgYWN0aW9uc1ZpZXc6IHtcbiAgICBmbGV4RGlyZWN0aW9uOiBcInJvd1wiLFxuICAgIGFsaWduSXRlbXM6IFwiY2VudGVyXCJcbiAgfSxcbiAgY3JlYXRlTmV3TW9kZWxMaW5rOiB7XG4gICAgbWFyZ2luTGVmdDogMTAsXG4gICAgbWFyZ2luUmlnaHQ6IDEwXG4gIH0sXG4gIGRlc3Ryb3lNb2RlbExpbms6IHtcbiAgICBtYXJnaW5MZWZ0OiAxMCxcbiAgICBtYXJnaW5SaWdodDogMTBcbiAgfSxcbiAgZWRpdE1vZGVsTGluazoge1xuICAgIG1hcmdpbkxlZnQ6IDEwLFxuICAgIG1hcmdpblJpZ2h0OiAxMFxuICB9XG59KVxuXG5leHBvcnQgZGVmYXVsdCBtZW1vKHNoYXBlQ29tcG9uZW50KGNsYXNzIEFwaU1ha2VyU3VwZXJBZG1pbiBleHRlbmRzIEJhc2VDb21wb25lbnQge1xuICBzZXR1cCgpIHtcbiAgICB0aGlzLnF1ZXJ5UGFyYW1zID0gdXNlUXVlcnlQYXJhbXMoKVxuXG4gICAgaWYgKHRoaXMucXVlcnlQYXJhbXMubW9kZWwpIHtcbiAgICAgIHRoaXMubW9kZWxDbGFzcyA9IG1vZGVsc1t0aGlzLnF1ZXJ5UGFyYW1zLm1vZGVsXVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1vZGVsQ2xhc3MgPSBudWxsXG4gICAgfVxuXG4gICAgdGhpcy5jb25maWdSZWFkZXIgPSB1c2VNZW1vKCgpID0+IHRoaXMubW9kZWxDbGFzcyAmJiBDb25maWdSZWFkZXIuZm9yTW9kZWwodGhpcy5tb2RlbENsYXNzKSwgW3RoaXMubW9kZWxDbGFzc10pXG4gICAgdGhpcy5tb2RlbElkID0gdGhpcy5xdWVyeVBhcmFtcy5tb2RlbF9pZFxuICAgIHRoaXMubW9kZWxOYW1lID0gdGhpcy5tb2RlbENsYXNzPy5tb2RlbENsYXNzRGF0YSgpPy5uYW1lXG4gICAgdGhpcy5jdXJyZW50VXNlciA9IHVzZUN1cnJlbnRVc2VyKClcblxuICAgIHRoaXMuY2FuQ2FuID0gdXNlQ2FuQ2FuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBhYmlsaXRpZXMgPSBbXVxuXG4gICAgICAgIGlmICh0aGlzLm1vZGVsQ2xhc3MpIGFiaWxpdGllcy5wdXNoKFt0aGlzLm1vZGVsQ2xhc3MsIFtcIm5ld1wiXV0pXG5cbiAgICAgICAgcmV0dXJuIGFiaWxpdGllc1xuICAgICAgfSxcbiAgICAgIFt0aGlzLmN1cnJlbnRVc2VyPy5pZCgpLCB0aGlzLm1vZGVsQ2xhc3NdXG4gICAgKVxuXG4gICAgdGhpcy51c2VTdGF0ZXMoe1xuICAgICAgbW9kZWw6IHVuZGVmaW5lZFxuICAgIH0pXG4gICAgdXNlTWVtbyhcbiAgICAgICgpID0+IHsgdGhpcy5sb2FkTW9kZWwoKSB9LFxuICAgICAgW3RoaXMubW9kZWxJZF1cbiAgICApXG4gIH1cblxuICBsb2FkTW9kZWwgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qge2NvbmZpZ1JlYWRlciwgbW9kZWxDbGFzcywgbW9kZWxJZCwgbW9kZWxOYW1lfSA9IHRoaXMudHRcblxuICAgIGlmIChtb2RlbElkICYmIG1vZGVsQ2xhc3MpIHtcbiAgICAgIGNvbnN0IGFiaWxpdGllcyA9IHt9XG4gICAgICBjb25zdCBhYmlsaXRpZXNGb3JNb2RlbCA9IFtcImRlc3Ryb3lcIiwgXCJlZGl0XCJdXG4gICAgICBjb25zdCBsYXlvdXRTZWxlY3QgPSBjb25maWdSZWFkZXI/Lm1vZGVsQ29uZmlnPy5sYXlvdXQ/LnNlbGVjdFxuXG4gICAgICBhYmlsaXRpZXNbbW9kZWxOYW1lXSA9IGFiaWxpdGllc0Zvck1vZGVsXG5cbiAgICAgIGNvbnN0IHF1ZXJ5ID0gYXdhaXQgbW9kZWxDbGFzc1xuICAgICAgICAucmFuc2Fjayh7aWRfZXE6IG1vZGVsSWR9KVxuICAgICAgICAuYWJpbGl0aWVzKGFiaWxpdGllcylcblxuICAgICAgaWYgKGxheW91dFNlbGVjdCkgcXVlcnkuc2VsZWN0KGxheW91dFNlbGVjdClcblxuICAgICAgY29uc3QgbW9kZWwgPSBhd2FpdCBxdWVyeS5maXJzdCgpXG5cbiAgICAgIHRoaXMuc2V0U3RhdGUoe21vZGVsfSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7bW9kZWw6IHVuZGVmaW5lZH0pXG4gICAgfVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtjYW5DYW4sIGNvbmZpZ1JlYWRlciwgbW9kZWxDbGFzcywgbW9kZWxJZCwgbW9kZWxOYW1lLCBxdWVyeVBhcmFtc30gPSB0aGlzLnR0XG4gICAgY29uc3Qge21vZGVsfSA9IHRoaXMuc1xuICAgIGNvbnN0IG1vZGVsQ29uZmlnQWN0aW9ucyA9IGNvbmZpZ1JlYWRlcj8ubW9kZWxDb25maWc/LmFjdGlvbnNcbiAgICBsZXQgcGFnZVRvU2hvd1xuXG4gICAgaWYgKHF1ZXJ5UGFyYW1zLm1vZGVsICYmIHF1ZXJ5UGFyYW1zLm1vZGVsX2lkICYmIHF1ZXJ5UGFyYW1zLm1vZGVsX3JlZmxlY3Rpb24pIHtcbiAgICAgIHBhZ2VUb1Nob3cgPSBcInNob3dfcmVmbGVjdGlvblwiXG4gICAgfSBlbHNlIGlmIChxdWVyeVBhcmFtcy5tb2RlbCAmJiBxdWVyeVBhcmFtcy5tb2RlbF9pZCAmJiBxdWVyeVBhcmFtcy5tb2RlID09IFwiZWRpdFwiKSB7XG4gICAgICBwYWdlVG9TaG93ID0gXCJlZGl0XCJcbiAgICB9IGVsc2UgaWYgKHF1ZXJ5UGFyYW1zLm1vZGVsICYmIHF1ZXJ5UGFyYW1zLm1vZGVsX2lkKSB7XG4gICAgICBwYWdlVG9TaG93ID0gXCJzaG93XCJcbiAgICB9IGVsc2UgaWYgKHF1ZXJ5UGFyYW1zLm1vZGVsICYmIHF1ZXJ5UGFyYW1zLm1vZGUgPT0gXCJuZXdcIikge1xuICAgICAgcGFnZVRvU2hvdyA9IFwiZWRpdFwiXG4gICAgfSBlbHNlIGlmIChxdWVyeVBhcmFtcy5tb2RlbCkge1xuICAgICAgcGFnZVRvU2hvdyA9IFwiaW5kZXhcIlxuICAgIH0gZWxzZSB7XG4gICAgICBwYWdlVG9TaG93ID0gXCJ3ZWxjb21lXCJcbiAgICB9XG5cbiAgICBjb25zdCBhY3Rpb25zVmlld1N0eWxlID0gdXNlU3R5bGVzKHN0eWxlcywgXCJhY3Rpb25zVmlld1wiKVxuXG4gICAgY29uc3QgYWN0aW9ucyA9IHVzZU1lbW8oXG4gICAgICAoKSA9PiA8VmlldyBzdHlsZT17YWN0aW9uc1ZpZXdTdHlsZX0+XG4gICAgICAgIHttb2RlbCAmJiBtb2RlbENvbmZpZ0FjdGlvbnMgJiYgbW9kZWxDb25maWdBY3Rpb25zKHttb2RlbH0pfVxuICAgICAgICB7bW9kZWxDbGFzcyAmJiBwYWdlVG9TaG93ID09IFwiaW5kZXhcIiAmJlxuICAgICAgICAgIDw+XG4gICAgICAgICAgICB7Y2FuQ2FuPy5jYW4oXCJuZXdcIiwgbW9kZWxDbGFzcykgJiYgaGFzRWRpdENvbmZpZyhtb2RlbENsYXNzKSAmJlxuICAgICAgICAgICAgICA8TGlua1xuICAgICAgICAgICAgICAgIGRhdGFTZXQ9e3tjbGFzczogXCJjcmVhdGUtbmV3LW1vZGVsLWxpbmtcIn19XG4gICAgICAgICAgICAgICAgc3R5bGU9e3N0eWxlcy5jcmVhdGVOZXdNb2RlbExpbmt9XG4gICAgICAgICAgICAgICAgdG89e1BhcmFtcy53aXRoUGFyYW1zKHttb2RlbDogbW9kZWxOYW1lLCBtb2RlOiBcIm5ld1wifSl9XG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8VGV4dD5cbiAgICAgICAgICAgICAgICAgIENyZWF0ZSBuZXdcbiAgICAgICAgICAgICAgICA8L1RleHQ+XG4gICAgICAgICAgICAgIDwvTGluaz5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA8Lz5cbiAgICAgICAgfVxuICAgICAgICB7bW9kZWwgJiYgcGFnZVRvU2hvdyA9PSBcInNob3dcIiAmJlxuICAgICAgICAgIDw+XG4gICAgICAgICAgICB7bW9kZWwuY2FuKFwiZWRpdFwiKSAmJiBoYXNFZGl0Q29uZmlnKG1vZGVsQ2xhc3MpICYmXG4gICAgICAgICAgICAgIDxMaW5rXG4gICAgICAgICAgICAgICAgZGF0YVNldD17e2NsYXNzOiBcImVkaXQtbW9kZWwtbGlua1wifX1cbiAgICAgICAgICAgICAgICBzdHlsZT17c3R5bGVzLmVkaXRNb2RlbExpbmt9XG4gICAgICAgICAgICAgICAgdG89e1BhcmFtcy53aXRoUGFyYW1zKHttb2RlbDogbW9kZWxOYW1lLCBtb2RlbF9pZDogbW9kZWxJZCwgbW9kZTogXCJlZGl0XCJ9KX1cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxUZXh0PlxuICAgICAgICAgICAgICAgICAgRWRpdFxuICAgICAgICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgICAgICAgPC9MaW5rPlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAge21vZGVsLmNhbihcImRlc3Ryb3lcIikgJiZcbiAgICAgICAgICAgICAgPFByZXNzYWJsZVxuICAgICAgICAgICAgICAgIGRhdGFTZXQ9e3tjbGFzczogXCJkZXN0cm95LW1vZGVsLWxpbmtcIn19XG4gICAgICAgICAgICAgICAgb25QcmVzcz17dGhpcy50dC5vbkRlc3Ryb3lDbGlja2VkfVxuICAgICAgICAgICAgICAgIHN0eWxlPXtzdHlsZXMuZGVzdHJveU1vZGVsTGlua31cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxUZXh0PlxuICAgICAgICAgICAgICAgICAgRGVsZXRlXG4gICAgICAgICAgICAgICAgPC9UZXh0PlxuICAgICAgICAgICAgICA8L1ByZXNzYWJsZT5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA8Lz5cbiAgICAgICAgfVxuICAgICAgICB7cGFnZVRvU2hvdyA9PSBcInNob3dfcmVmbGVjdGlvblwiICYmXG4gICAgICAgICAgPFNob3dSZWZsZWN0aW9uQWN0aW9ucyBtb2RlbD17bW9kZWx9IG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9IHJlZmxlY3Rpb25OYW1lPXtxdWVyeVBhcmFtcy5tb2RlbF9yZWZsZWN0aW9ufSAvPlxuICAgICAgICB9XG4gICAgICA8L1ZpZXc+LFxuICAgICAgW2NhbkNhbiwgY29uZmlnUmVhZGVyPy5hY3Rpb25zLCBtb2RlbCwgbW9kZWxDbGFzcywgcGFnZVRvU2hvd11cbiAgICApXG5cbiAgICByZXR1cm4gKFxuICAgICAgPExheW91dCBhY3Rpb25zPXthY3Rpb25zfSBhY3RpdmU9e3F1ZXJ5UGFyYW1zLm1vZGVsfSBoZWFkZXJUaXRsZT17bW9kZWxDbGFzcz8ubW9kZWxOYW1lKCk/Lmh1bWFuKHtjb3VudDogMn0pfT5cbiAgICAgICAge3BhZ2VUb1Nob3cgPT0gXCJpbmRleFwiICYmXG4gICAgICAgICAgPEluZGV4UGFnZVxuICAgICAgICAgICAga2V5PXtgaW5kZXgtcGFnZS0ke21vZGVsTmFtZX1gfVxuICAgICAgICAgICAgbW9kZWxDbGFzcz17bW9kZWxDbGFzc31cbiAgICAgICAgICAvPlxuICAgICAgICB9XG4gICAgICAgIHtwYWdlVG9TaG93ID09IFwic2hvd1wiICYmXG4gICAgICAgICAgPFNob3dQYWdlXG4gICAgICAgICAgICBrZXk9e2BzaG93LXBhZ2UtJHttb2RlbE5hbWV9LSR7bW9kZWxJZH1gfVxuICAgICAgICAgICAgbW9kZWxDbGFzcz17bW9kZWxDbGFzc31cbiAgICAgICAgICAgIG1vZGVsSWQ9e21vZGVsSWR9XG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgICB7cGFnZVRvU2hvdyA9PSBcInNob3dfcmVmbGVjdGlvblwiICYmXG4gICAgICAgICAgPFNob3dSZWZsZWN0aW9uUGFnZVxuICAgICAgICAgICAga2V5PXtgc2hvdy1yZWZsZWN0aW9uLXBhZ2UtJHttb2RlbE5hbWV9LSR7bW9kZWxJZH1gfVxuICAgICAgICAgICAgbW9kZWxDbGFzcz17bW9kZWxDbGFzc31cbiAgICAgICAgICAgIG1vZGVsSWQ9e21vZGVsSWR9XG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgICB7cGFnZVRvU2hvdyA9PSBcImVkaXRcIiAmJlxuICAgICAgICAgIDxFZGl0UGFnZVxuICAgICAgICAgICAga2V5PXtgZWRpdC1wYWdlLSR7bW9kZWxOYW1lfS0ke21vZGVsSWR9YH1cbiAgICAgICAgICAgIG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9XG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgPC9MYXlvdXQ+XG4gICAgKVxuICB9XG5cbiAgb25EZXN0cm95Q2xpY2tlZCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoIWNvbmZpcm0oXCJBcmUgeW91IHN1cmU/XCIpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5zLm1vZGVsLmRlc3Ryb3koKVxuXG4gICAgICBQYXJhbXMuY2hhbmdlUGFyYW1zKHttb2RlOiB1bmRlZmluZWQsIG1vZGVsX2lkOiB1bmRlZmluZWR9KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBGbGFzaE5vdGlmaWNhdGlvbnMuZXJyb3JSZXNwb25zZShlcnJvcilcbiAgICB9XG4gIH1cbn0pKVxuIl19