import React, { useMemo } from "react";
import AttributeRow from "../../bootstrap/attribute-row.js";
import BaseComponent from "../../base-component.js";
import BelongsToAttributeRow from "./belongs-to-attribute-row.js";
import ConfigReader from "../config-reader.js";
import { digg } from "diggerize";
import memo from "set-state-compare/build/memo.js";
import * as inflection from "inflection";
import PropTypes from "prop-types";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import ShowNav from "../show-nav.js";
import useModel from "../../use-model.js";
import { View } from "react-native";
const AttributePresenter = memo(({ attribute, model, modelArgs }) => {
    const attributeRowProps = {
        model
    };
    if (typeof attribute == "object") {
        if (attribute.attribute)
            attributeRowProps.attribute = attribute.attribute;
        if (attribute.content)
            attributeRowProps.children = attribute.content(modelArgs);
        if (attribute.label)
            attributeRowProps.label = attribute.label;
    }
    else if (attribute) {
        attributeRowProps.attribute = attribute;
    }
    return (<AttributeRow {...attributeRowProps}/>);
});
export default memo(shapeComponent(class ApiMakerSuperAdminShowPage extends BaseComponent {
    static propTypes = {
        modelClass: PropTypes.func.isRequired
    };
    setup() {
        const { modelClass } = this.props;
        const configReader = useMemo(() => ConfigReader.forModel(modelClass), [modelClass]);
        const showConfig = configReader.modelConfig?.show;
        this.setInstance({ configReader, showConfig });
    }
    render() {
        const { modelClass } = this.props;
        const { configReader, showConfig } = this.tt;
        const attributes = configReader.attributesToShow();
        const extraContent = showConfig?.extraContent;
        const modelClassName = modelClass.modelClassData().name;
        const primaryKeyName = modelClass.primaryKey();
        const preload = [];
        const select = showConfig?.extraSelect || {};
        const modelClassSelect = select[modelClassName] || [];
        if (showConfig?.preload) {
            for (const showConfigPreload of showConfig.preload) {
                preload.push(showConfigPreload);
            }
        }
        if (!(modelClassName in select))
            select[modelClassName] = modelClassSelect;
        if (!modelClassSelect.includes(primaryKeyName))
            modelClassSelect.push(primaryKeyName);
        // Select all attributes selected by default because they will be shown by default
        for (const attribute of modelClass.attributes()) {
            if ((attribute.isSelectedByDefault() || attribute.name() == "name") && !modelClassSelect.includes(attribute.name())) {
                modelClassSelect.push(attribute.name());
            }
        }
        for (const reflection of modelClass.reflections()) {
            if (reflection.macro() == "belongs_to") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any belongs-to-relationships
                if (!modelClassSelect.includes(reflection.foreignKey())) {
                    const foreignKeyAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == reflection.foreignKey());
                    if (!foreignKeyAttribute) {
                        throw new Error(`${reflection.foreignKey()} wasn't defined as an attribute on ${modelClassName}`);
                    }
                    modelClassSelect.push(reflection.foreignKey());
                }
            }
            else if (reflection.macro() == "has_one") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any has-one-relationships
                if (!modelClassSelect.includes(reflection.foreignKey()) && !select[reflectionModelClassName].includes(reflection.foreignKey()) && !reflection.through()) {
                    select[reflectionModelClassName].push(reflection.foreignKey());
                }
            }
        }
        const useModelResult = useModel(modelClass, {
            loadByQueryParam: ({ queryParams }) => queryParams.model_id,
            preload,
            select
        });
        const camelizedLower = digg(modelClass.modelClassData(), "camelizedLower");
        const model = digg(useModelResult, camelizedLower);
        const modelArgs = {};
        modelArgs[inflection.camelize(modelClass.modelClassData().name, true)] = model;
        return (<View testID="super-admin/show-page">
        {model &&
                <ShowNav model={model} modelClass={modelClass}/>}
        {attributes && model && attributes.map((attribute) => <AttributePresenter attribute={attribute} key={attribute.key || attribute.attribute || attribute} modelArgs={modelArgs} model={model}/>)}
        {model && modelClass.reflections().filter((reflection) => reflection.macro() == "belongs_to" || reflection.macro() == "has_one").map((reflection) => <BelongsToAttributeRow key={reflection.name()} model={model} modelClass={modelClass} reflection={reflection}/>)}
        {model && extraContent && extraContent(modelArgs)}
      </View>);
    }
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInN1cGVyLWFkbWluL3Nob3ctcGFnZS9pbmRleC5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBQyxPQUFPLEVBQUMsTUFBTSxPQUFPLENBQUE7QUFDcEMsT0FBTyxZQUFZLE1BQU0sa0NBQWtDLENBQUE7QUFDM0QsT0FBTyxhQUFhLE1BQU0seUJBQXlCLENBQUE7QUFDbkQsT0FBTyxxQkFBcUIsTUFBTSwrQkFBK0IsQ0FBQTtBQUNqRSxPQUFPLFlBQVksTUFBTSxxQkFBcUIsQ0FBQTtBQUM5QyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQzlCLE9BQU8sSUFBSSxNQUFNLGlDQUFpQyxDQUFBO0FBQ2xELE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sNENBQTRDLENBQUE7QUFDekUsT0FBTyxPQUFPLE1BQU0sZ0JBQWdCLENBQUE7QUFDcEMsT0FBTyxRQUFRLE1BQU0sb0JBQW9CLENBQUE7QUFDekMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQTtBQUVqQyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsRUFBRSxFQUFFO0lBQ2hFLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsS0FBSztLQUNOLENBQUE7SUFFRCxJQUFJLE9BQU8sU0FBUyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLElBQUksU0FBUyxDQUFDLFNBQVM7WUFBRSxpQkFBaUIsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQTtRQUMxRSxJQUFJLFNBQVMsQ0FBQyxPQUFPO1lBQUUsaUJBQWlCLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxP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QU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFDaEQsQ0FDQTtRQUFBLENBQUMsVUFBVSxJQUFJLEtBQUssSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FDbkQsQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUcsQ0FDekksQ0FDRDtRQUFBLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxZQUFZLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRSxJQUFJLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQ2xKLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDLEVBQUcsQ0FDaEgsQ0FDRDtRQUFBLENBQUMsS0FBSyxJQUFJLFlBQVksSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQ25EO01BQUEsRUFBRSxJQUFJLENBQUMsQ0FDUixDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSBcInJlYWN0XCJcbmltcG9ydCBBdHRyaWJ1dGVSb3cgZnJvbSBcIi4uLy4uL2Jvb3RzdHJhcC9hdHRyaWJ1dGUtcm93LmpzXCJcbmltcG9ydCBCYXNlQ29tcG9uZW50IGZyb20gXCIuLi8uLi9iYXNlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgQmVsb25nc1RvQXR0cmlidXRlUm93IGZyb20gXCIuL2JlbG9uZ3MtdG8tYXR0cmlidXRlLXJvdy5qc1wiXG5pbXBvcnQgQ29uZmlnUmVhZGVyIGZyb20gXCIuLi9jb25maWctcmVhZGVyLmpzXCJcbmltcG9ydCB7ZGlnZ30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG5pbXBvcnQgKiBhcyBpbmZsZWN0aW9uIGZyb20gXCJpbmZsZWN0aW9uXCJcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSBcInByb3AtdHlwZXNcIlxuaW1wb3J0IHtzaGFwZUNvbXBvbmVudH0gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3NoYXBlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgU2hvd05hdiBmcm9tIFwiLi4vc2hvdy1uYXYuanNcIlxuaW1wb3J0IHVzZU1vZGVsIGZyb20gXCIuLi8uLi91c2UtbW9kZWwuanNcIlxuaW1wb3J0IHtWaWV3fSBmcm9tIFwicmVhY3QtbmF0aXZlXCJcblxuY29uc3QgQXR0cmlidXRlUHJlc2VudGVyID0gbWVtbygoe2F0dHJpYnV0ZSwgbW9kZWwsIG1vZGVsQXJnc30pID0+IHtcbiAgY29uc3QgYXR0cmlidXRlUm93UHJvcHMgPSB7XG4gICAgbW9kZWxcbiAgfVxuXG4gIGlmICh0eXBlb2YgYXR0cmlidXRlID09IFwib2JqZWN0XCIpIHtcbiAgICBpZiAoYXR0cmlidXRlLmF0dHJpYnV0ZSkgYXR0cmlidXRlUm93UHJvcHMuYXR0cmlidXRlID0gYXR0cmlidXRlLmF0dHJpYnV0ZVxuICAgIGlmIChhdHRyaWJ1dGUuY29udGVudCkgYXR0cmlidXRlUm93UHJvcHMuY2hpbGRyZW4gPSBhdHRyaWJ1dGUuY29udGVudChtb2RlbEFyZ3MpXG4gICAgaWYgKGF0dHJpYnV0ZS5sYWJlbCkgYXR0cmlidXRlUm93UHJvcHMubGFiZWwgPSBhdHRyaWJ1dGUubGFiZWxcbiAgfSBlbHNlIGlmIChhdHRyaWJ1dGUpIHtcbiAgICBhdHRyaWJ1dGVSb3dQcm9wcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGVcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgPEF0dHJpYnV0ZVJvdyB7Li4uYXR0cmlidXRlUm93UHJvcHN9IC8+XG4gIClcbn0pXG5cbmV4cG9ydCBkZWZhdWx0IG1lbW8oc2hhcGVDb21wb25lbnQoY2xhc3MgQXBpTWFrZXJTdXBlckFkbWluU2hvd1BhZ2UgZXh0ZW5kcyBCYXNlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBtb2RlbENsYXNzOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkXG4gIH1cblxuICBzZXR1cCgpIHtcbiAgICBjb25zdCB7bW9kZWxDbGFzc30gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgY29uZmlnUmVhZGVyID0gdXNlTWVtbygoKSA9PiBDb25maWdSZWFkZXIuZm9yTW9kZWwobW9kZWxDbGFzcyksIFttb2RlbENsYXNzXSlcbiAgICBjb25zdCBzaG93Q29uZmlnID0gY29uZmlnUmVhZGVyLm1vZGVsQ29uZmlnPy5zaG93XG5cbiAgICB0aGlzLnNldEluc3RhbmNlKHtjb25maWdSZWFkZXIsIHNob3dDb25maWd9KVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHttb2RlbENsYXNzfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7Y29uZmlnUmVhZGVyLCBzaG93Q29uZmlnfSA9IHRoaXMudHRcbiAgICBjb25zdCBhdHRyaWJ1dGVzID0gY29uZmlnUmVhZGVyLmF0dHJpYnV0ZXNUb1Nob3coKVxuICAgIGNvbnN0IGV4dHJhQ29udGVudCA9IHNob3dDb25maWc/LmV4dHJhQ29udGVudFxuICAgIGNvbnN0IG1vZGVsQ2xhc3NOYW1lID0gbW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLm5hbWVcbiAgICBjb25zdCBwcmltYXJ5S2V5TmFtZSA9IG1vZGVsQ2xhc3MucHJpbWFyeUtleSgpXG4gICAgY29uc3QgcHJlbG9hZCA9IFtdXG4gICAgY29uc3Qgc2VsZWN0ID0gc2hvd0NvbmZpZz8uZXh0cmFTZWxlY3QgfHwge31cbiAgICBjb25zdCBtb2RlbENsYXNzU2VsZWN0ID0gc2VsZWN0W21vZGVsQ2xhc3NOYW1lXSB8fCBbXVxuXG4gICAgaWYgKHNob3dDb25maWc/LnByZWxvYWQpIHtcbiAgICAgIGZvciAoY29uc3Qgc2hvd0NvbmZpZ1ByZWxvYWQgb2Ygc2hvd0NvbmZpZy5wcmVsb2FkKSB7XG4gICAgICAgIHByZWxvYWQucHVzaChzaG93Q29uZmlnUHJlbG9hZClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIShtb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbbW9kZWxDbGFzc05hbWVdID0gbW9kZWxDbGFzc1NlbGVjdFxuICAgIGlmICghbW9kZWxDbGFzc1NlbGVjdC5pbmNsdWRlcyhwcmltYXJ5S2V5TmFtZSkpIG1vZGVsQ2xhc3NTZWxlY3QucHVzaChwcmltYXJ5S2V5TmFtZSlcblxuICAgIC8vIFNlbGVjdCBhbGwgYXR0cmlidXRlcyBzZWxlY3RlZCBieSBkZWZhdWx0IGJlY2F1c2UgdGhleSB3aWxsIGJlIHNob3duIGJ5IGRlZmF1bHRcbiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZSBvZiBtb2RlbENsYXNzLmF0dHJpYnV0ZXMoKSkge1xuICAgICAgaWYgKChhdHRyaWJ1dGUuaXNTZWxlY3RlZEJ5RGVmYXVsdCgpIHx8IGF0dHJpYnV0ZS5uYW1lKCkgPT0gXCJuYW1lXCIpICYmICFtb2RlbENsYXNzU2VsZWN0LmluY2x1ZGVzKGF0dHJpYnV0ZS5uYW1lKCkpKSB7XG4gICAgICAgIG1vZGVsQ2xhc3NTZWxlY3QucHVzaChhdHRyaWJ1dGUubmFtZSgpKVxuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgcmVmbGVjdGlvbiBvZiBtb2RlbENsYXNzLnJlZmxlY3Rpb25zKCkpIHtcbiAgICAgIGlmIChyZWZsZWN0aW9uLm1hY3JvKCkgPT0gXCJiZWxvbmdzX3RvXCIpIHtcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3MgPSByZWZsZWN0aW9uLm1vZGVsQ2xhc3MoKVxuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzc05hbWUgPSByZWZsZWN0aW9uTW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLm5hbWVcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3NBdHRyaWJ1dGVzID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3MuYXR0cmlidXRlcygpXG4gICAgICAgIGNvbnN0IG5hbWVBdHRyaWJ1dGUgPSByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZSgpID09IFwibmFtZVwiKVxuXG4gICAgICAgIHByZWxvYWQucHVzaChpbmZsZWN0aW9uLnVuZGVyc2NvcmUocmVmbGVjdGlvbi5uYW1lKCkpKVxuXG4gICAgICAgIGlmICghKHJlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXSA9IFtdXG4gICAgICAgIGlmICghc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0uaW5jbHVkZXMoXCJpZFwiKSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChcImlkXCIpXG4gICAgICAgIGlmIChuYW1lQXR0cmlidXRlICYmICFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhcIm5hbWVcIikpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLnB1c2goXCJuYW1lXCIpXG5cbiAgICAgICAgLy8gVGhlIGZvcmVpZ24ga2V5IGlzIG5lZWRlZCB0byBsb29rIHVwIGFueSBiZWxvbmdzLXRvLXJlbGF0aW9uc2hpcHNcbiAgICAgICAgaWYgKCFtb2RlbENsYXNzU2VsZWN0LmluY2x1ZGVzKHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKSkge1xuICAgICAgICAgIGNvbnN0IGZvcmVpZ25LZXlBdHRyaWJ1dGUgPSByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZSgpID09IHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKVxuXG4gICAgICAgICAgaWYgKCFmb3JlaWduS2V5QXR0cmlidXRlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cmVmbGVjdGlvbi5mb3JlaWduS2V5KCl9IHdhc24ndCBkZWZpbmVkIGFzIGFuIGF0dHJpYnV0ZSBvbiAke21vZGVsQ2xhc3NOYW1lfWApXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbW9kZWxDbGFzc1NlbGVjdC5wdXNoKHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHJlZmxlY3Rpb24ubWFjcm8oKSA9PSBcImhhc19vbmVcIikge1xuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzcyA9IHJlZmxlY3Rpb24ubW9kZWxDbGFzcygpXG4gICAgICAgIGNvbnN0IHJlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZSA9IHJlZmxlY3Rpb25Nb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCkubmFtZVxuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMgPSByZWZsZWN0aW9uTW9kZWxDbGFzcy5hdHRyaWJ1dGVzKClcbiAgICAgICAgY29uc3QgbmFtZUF0dHJpYnV0ZSA9IHJlZmxlY3Rpb25Nb2RlbENsYXNzQXR0cmlidXRlcy5maW5kKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5uYW1lKCkgPT0gXCJuYW1lXCIpXG5cbiAgICAgICAgcHJlbG9hZC5wdXNoKGluZmxlY3Rpb24udW5kZXJzY29yZShyZWZsZWN0aW9uLm5hbWUoKSkpXG5cbiAgICAgICAgaWYgKCEocmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lIGluIHNlbGVjdCkpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdID0gW11cbiAgICAgICAgaWYgKCFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhcImlkXCIpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5wdXNoKFwiaWRcIilcbiAgICAgICAgaWYgKG5hbWVBdHRyaWJ1dGUgJiYgIXNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLmluY2x1ZGVzKFwibmFtZVwiKSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChcIm5hbWVcIilcblxuICAgICAgICAvLyBUaGUgZm9yZWlnbiBrZXkgaXMgbmVlZGVkIHRvIGxvb2sgdXAgYW55IGhhcy1vbmUtcmVsYXRpb25zaGlwc1xuICAgICAgICBpZiAoIW1vZGVsQ2xhc3NTZWxlY3QuaW5jbHVkZXMocmVmbGVjdGlvbi5mb3JlaWduS2V5KCkpICYmICFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSkgJiYgIXJlZmxlY3Rpb24udGhyb3VnaCgpKSB7XG4gICAgICAgICAgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHVzZU1vZGVsUmVzdWx0ID0gdXNlTW9kZWwobW9kZWxDbGFzcywge1xuICAgICAgbG9hZEJ5UXVlcnlQYXJhbTogKHtxdWVyeVBhcmFtc30pID0+IHF1ZXJ5UGFyYW1zLm1vZGVsX2lkLFxuICAgICAgcHJlbG9hZCxcbiAgICAgIHNlbGVjdFxuICAgIH0pXG4gICAgY29uc3QgY2FtZWxpemVkTG93ZXIgPSBkaWdnKG1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKSwgXCJjYW1lbGl6ZWRMb3dlclwiKVxuICAgIGNvbnN0IG1vZGVsID0gZGlnZyh1c2VNb2RlbFJlc3VsdCwgY2FtZWxpemVkTG93ZXIpXG4gICAgY29uc3QgbW9kZWxBcmdzID0ge31cblxuICAgIG1vZGVsQXJnc1tpbmZsZWN0aW9uLmNhbWVsaXplKG1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKS5uYW1lLCB0cnVlKV0gPSBtb2RlbFxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3IHRlc3RJRD1cInN1cGVyLWFkbWluL3Nob3ctcGFnZVwiPlxuICAgICAgICB7bW9kZWwgJiZcbiAgICAgICAgICA8U2hvd05hdiBtb2RlbD17bW9kZWx9IG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9IC8+XG4gICAgICAgIH1cbiAgICAgICAge2F0dHJpYnV0ZXMgJiYgbW9kZWwgJiYgYXR0cmlidXRlcy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICA8QXR0cmlidXRlUHJlc2VudGVyIGF0dHJpYnV0ZT17YXR0cmlidXRlfSBrZXk9e2F0dHJpYnV0ZS5rZXkgfHwgYXR0cmlidXRlLmF0dHJpYnV0ZSB8fCBhdHRyaWJ1dGV9IG1vZGVsQXJncz17bW9kZWxBcmdzfSBtb2RlbD17bW9kZWx9IC8+XG4gICAgICAgICl9XG4gICAgICAgIHttb2RlbCAmJiBtb2RlbENsYXNzLnJlZmxlY3Rpb25zKCkuZmlsdGVyKChyZWZsZWN0aW9uKSA9PiByZWZsZWN0aW9uLm1hY3JvKCkgPT0gXCJiZWxvbmdzX3RvXCIgfHwgcmVmbGVjdGlvbi5tYWNybygpID09IFwiaGFzX29uZVwiKS5tYXAoKHJlZmxlY3Rpb24pID0+XG4gICAgICAgICAgPEJlbG9uZ3NUb0F0dHJpYnV0ZVJvdyBrZXk9e3JlZmxlY3Rpb24ubmFtZSgpfSBtb2RlbD17bW9kZWx9IG1vZGVsQ2xhc3M9e21vZGVsQ2xhc3N9IHJlZmxlY3Rpb249e3JlZmxlY3Rpb259IC8+XG4gICAgICAgICl9XG4gICAgICAgIHttb2RlbCAmJiBleHRyYUNvbnRlbnQgJiYgZXh0cmFDb250ZW50KG1vZGVsQXJncyl9XG4gICAgICA8L1ZpZXc+XG4gICAgKVxuICB9XG59KSlcbiJdfQ==