import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import React, { useMemo } from "react";
import AttributeRow from "../../bootstrap/attribute-row";
import BaseComponent from "../../base-component";
import BelongsToAttributeRow from "./belongs-to-attribute-row";
import ConfigReader from "../config-reader";
import { digg } from "diggerize";
import memo from "set-state-compare/build/memo.js";
import * as inflection from "inflection";
import PropTypes from "prop-types";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import ShowNav from "../show-nav";
import useModel from "../../use-model.js";
import { View } from "react-native";
const AttributePresenter = memo(({ attribute, model, modelArgs }) => {
    const attributeRowProps = {
        model
    };
    if (typeof attribute == "object") {
        if (attribute.attribute)
            attributeRowProps.attribute = attribute.attribute;
        if (attribute.content)
            attributeRowProps.children = attribute.content(modelArgs);
        if (attribute.label)
            attributeRowProps.label = attribute.label;
    }
    else if (attribute) {
        attributeRowProps.attribute = attribute;
    }
    return (_jsx(AttributeRow, { ...attributeRowProps }));
});
export default memo(shapeComponent(class ApiMakerSuperAdminShowPage extends BaseComponent {
    static propTypes = {
        modelClass: PropTypes.func.isRequired
    };
    setup() {
        const { modelClass } = this.props;
        const configReader = useMemo(() => ConfigReader.forModel(modelClass), [modelClass]);
        const showConfig = configReader.modelConfig?.show;
        this.setInstance({ configReader, showConfig });
    }
    render() {
        const { modelClass } = this.props;
        const { configReader, showConfig } = this.tt;
        const attributes = configReader.attributesToShow();
        const extraContent = showConfig?.extraContent;
        const modelClassName = modelClass.modelClassData().name;
        const primaryKeyName = modelClass.primaryKey();
        const preload = [];
        const select = showConfig?.extraSelect || {};
        const modelClassSelect = select[modelClassName] || [];
        if (showConfig?.preload) {
            for (const showConfigPreload of showConfig.preload) {
                preload.push(showConfigPreload);
            }
        }
        if (!(modelClassName in select))
            select[modelClassName] = modelClassSelect;
        if (!modelClassSelect.includes(primaryKeyName))
            modelClassSelect.push(primaryKeyName);
        // Select all attributes selected by default because they will be shown by default
        for (const attribute of modelClass.attributes()) {
            if ((attribute.isSelectedByDefault() || attribute.name() == "name") && !modelClassSelect.includes(attribute.name())) {
                modelClassSelect.push(attribute.name());
            }
        }
        for (const reflection of modelClass.reflections()) {
            if (reflection.macro() == "belongs_to") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any belongs-to-relationships
                if (!modelClassSelect.includes(reflection.foreignKey())) {
                    const foreignKeyAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == reflection.foreignKey());
                    if (!foreignKeyAttribute) {
                        throw new Error(`${reflection.foreignKey()} wasn't defined as an attribute on ${modelClassName}`);
                    }
                    modelClassSelect.push(reflection.foreignKey());
                }
            }
            else if (reflection.macro() == "has_one") {
                const reflectionModelClass = reflection.modelClass();
                const reflectionModelClassName = reflectionModelClass.modelClassData().name;
                const reflectionModelClassAttributes = reflectionModelClass.attributes();
                const nameAttribute = reflectionModelClassAttributes.find((attribute) => attribute.name() == "name");
                preload.push(inflection.underscore(reflection.name()));
                if (!(reflectionModelClassName in select))
                    select[reflectionModelClassName] = [];
                if (!select[reflectionModelClassName].includes("id"))
                    select[reflectionModelClassName].push("id");
                if (nameAttribute && !select[reflectionModelClassName].includes("name"))
                    select[reflectionModelClassName].push("name");
                // The foreign key is needed to look up any has-one-relationships
                if (!modelClassSelect.includes(reflection.foreignKey()) && !select[reflectionModelClassName].includes(reflection.foreignKey()) && !reflection.through()) {
                    select[reflectionModelClassName].push(reflection.foreignKey());
                }
            }
        }
        const useModelResult = useModel(modelClass, {
            loadByQueryParam: ({ queryParams }) => queryParams.model_id,
            preload,
            select
        });
        const camelizedLower = digg(modelClass.modelClassData(), "camelizedLower");
        const model = digg(useModelResult, camelizedLower);
        const modelArgs = {};
        modelArgs[inflection.camelize(modelClass.modelClassData().name, true)] = model;
        return (_jsxs(View, { testID: "super-admin/show-page", children: [model &&
                    _jsx(ShowNav, { model: model, modelClass: modelClass }), attributes && model && attributes.map((attribute) => _jsx(AttributePresenter, { attribute: attribute, modelArgs: modelArgs, model: model }, attribute.key || attribute.attribute || attribute)), model && modelClass.reflections().filter((reflection) => reflection.macro() == "belongs_to" || reflection.macro() == "has_one").map((reflection) => _jsx(BelongsToAttributeRow, { model: model, modelClass: modelClass, reflection: reflection }, reflection.name())), model && extraContent && extraContent(modelArgs)] }));
    }
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInN1cGVyLWFkbWluL3Nob3ctcGFnZS9pbmRleC5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUMsT0FBTyxFQUFDLE1BQU0sT0FBTyxDQUFBO0FBQ3BDLE9BQU8sWUFBWSxNQUFNLCtCQUErQixDQUFBO0FBQ3hELE9BQU8sYUFBYSxNQUFNLHNCQUFzQixDQUFBO0FBQ2hELE9BQU8scUJBQXFCLE1BQU0sNEJBQTRCLENBQUE7QUFDOUQsT0FBTyxZQUFZLE1BQU0sa0JBQWtCLENBQUE7QUFDM0MsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUM5QixPQUFPLElBQUksTUFBTSxpQ0FBaUMsQ0FBQTtBQUNsRCxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUE7QUFDbEMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDRDQUE0QyxDQUFBO0FBQ3pFLE9BQU8sT0FBTyxNQUFNLGFBQWEsQ0FBQTtBQUNqQyxPQUFPLFFBQVEsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sY0FBYyxDQUFBO0FBRWpDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLENBQUMsRUFBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBQyxFQUFFLEVBQUU7SUFDaEUsTUFBTSxpQkFBaUIsR0FBRztRQUN4QixLQUFLO0tBQ04sQ0FBQTtJQUVELElBQUksT0FBTyxTQUFTLElBQUksUUFBUSxFQUFFLENBQUM7UUFDakMsSUFBSSxTQUFTLENBQUMsU0FBUztZQUFFLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFBO1FBQzFFLElBQUksU0FBUyxDQUFDLE9BQU87WUFBRSxpQkFBaUIsQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLE9B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SyxFQUFFLFVBQVUsRUFBRSxVQUFVLEdBQUksRUFFbEQsVUFBVSxJQUFJLEtBQUssSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FDbkQsS0FBQyxrQkFBa0IsSUFBQyxTQUFTLEVBQUUsU0FBUyxFQUEwRCxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxLQUFLLElBQXJGLFNBQVMsQ0FBQyxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQXdDLENBQ3pJLEVBQ0EsS0FBSyxJQUFJLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxZQUFZLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRSxJQUFJLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQ2xKLEtBQUMscUJBQXFCLElBQXlCLEtBQUssRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsVUFBVSxJQUEvRSxVQUFVLENBQUMsSUFBSSxFQUFFLENBQWtFLENBQ2hILEVBQ0EsS0FBSyxJQUFJLFlBQVksSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLElBQzVDLENBQ1IsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwge3VzZU1lbW99IGZyb20gXCJyZWFjdFwiXG5pbXBvcnQgQXR0cmlidXRlUm93IGZyb20gXCIuLi8uLi9ib290c3RyYXAvYXR0cmlidXRlLXJvd1wiXG5pbXBvcnQgQmFzZUNvbXBvbmVudCBmcm9tIFwiLi4vLi4vYmFzZS1jb21wb25lbnRcIlxuaW1wb3J0IEJlbG9uZ3NUb0F0dHJpYnV0ZVJvdyBmcm9tIFwiLi9iZWxvbmdzLXRvLWF0dHJpYnV0ZS1yb3dcIlxuaW1wb3J0IENvbmZpZ1JlYWRlciBmcm9tIFwiLi4vY29uZmlnLXJlYWRlclwiXG5pbXBvcnQge2RpZ2d9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IG1lbW8gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL21lbW8uanNcIlxuaW1wb3J0ICogYXMgaW5mbGVjdGlvbiBmcm9tIFwiaW5mbGVjdGlvblwiXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCJcbmltcG9ydCB7c2hhcGVDb21wb25lbnR9IGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC9zaGFwZS1jb21wb25lbnQuanNcIlxuaW1wb3J0IFNob3dOYXYgZnJvbSBcIi4uL3Nob3ctbmF2XCJcbmltcG9ydCB1c2VNb2RlbCBmcm9tIFwiLi4vLi4vdXNlLW1vZGVsLmpzXCJcbmltcG9ydCB7Vmlld30gZnJvbSBcInJlYWN0LW5hdGl2ZVwiXG5cbmNvbnN0IEF0dHJpYnV0ZVByZXNlbnRlciA9IG1lbW8oKHthdHRyaWJ1dGUsIG1vZGVsLCBtb2RlbEFyZ3N9KSA9PiB7XG4gIGNvbnN0IGF0dHJpYnV0ZVJvd1Byb3BzID0ge1xuICAgIG1vZGVsXG4gIH1cblxuICBpZiAodHlwZW9mIGF0dHJpYnV0ZSA9PSBcIm9iamVjdFwiKSB7XG4gICAgaWYgKGF0dHJpYnV0ZS5hdHRyaWJ1dGUpIGF0dHJpYnV0ZVJvd1Byb3BzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZS5hdHRyaWJ1dGVcbiAgICBpZiAoYXR0cmlidXRlLmNvbnRlbnQpIGF0dHJpYnV0ZVJvd1Byb3BzLmNoaWxkcmVuID0gYXR0cmlidXRlLmNvbnRlbnQobW9kZWxBcmdzKVxuICAgIGlmIChhdHRyaWJ1dGUubGFiZWwpIGF0dHJpYnV0ZVJvd1Byb3BzLmxhYmVsID0gYXR0cmlidXRlLmxhYmVsXG4gIH0gZWxzZSBpZiAoYXR0cmlidXRlKSB7XG4gICAgYXR0cmlidXRlUm93UHJvcHMuYXR0cmlidXRlID0gYXR0cmlidXRlXG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxBdHRyaWJ1dGVSb3cgey4uLmF0dHJpYnV0ZVJvd1Byb3BzfSAvPlxuICApXG59KVxuXG5leHBvcnQgZGVmYXVsdCBtZW1vKHNoYXBlQ29tcG9uZW50KGNsYXNzIEFwaU1ha2VyU3VwZXJBZG1pblNob3dQYWdlIGV4dGVuZHMgQmFzZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgbW9kZWxDbGFzczogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZFxuICB9XG5cbiAgc2V0dXAoKSB7XG4gICAgY29uc3Qge21vZGVsQ2xhc3N9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IGNvbmZpZ1JlYWRlciA9IHVzZU1lbW8oKCkgPT4gQ29uZmlnUmVhZGVyLmZvck1vZGVsKG1vZGVsQ2xhc3MpLCBbbW9kZWxDbGFzc10pXG4gICAgY29uc3Qgc2hvd0NvbmZpZyA9IGNvbmZpZ1JlYWRlci5tb2RlbENvbmZpZz8uc2hvd1xuXG4gICAgdGhpcy5zZXRJbnN0YW5jZSh7Y29uZmlnUmVhZGVyLCBzaG93Q29uZmlnfSlcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7bW9kZWxDbGFzc30gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qge2NvbmZpZ1JlYWRlciwgc2hvd0NvbmZpZ30gPSB0aGlzLnR0XG4gICAgY29uc3QgYXR0cmlidXRlcyA9IGNvbmZpZ1JlYWRlci5hdHRyaWJ1dGVzVG9TaG93KClcbiAgICBjb25zdCBleHRyYUNvbnRlbnQgPSBzaG93Q29uZmlnPy5leHRyYUNvbnRlbnRcbiAgICBjb25zdCBtb2RlbENsYXNzTmFtZSA9IG1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKS5uYW1lXG4gICAgY29uc3QgcHJpbWFyeUtleU5hbWUgPSBtb2RlbENsYXNzLnByaW1hcnlLZXkoKVxuICAgIGNvbnN0IHByZWxvYWQgPSBbXVxuICAgIGNvbnN0IHNlbGVjdCA9IHNob3dDb25maWc/LmV4dHJhU2VsZWN0IHx8IHt9XG4gICAgY29uc3QgbW9kZWxDbGFzc1NlbGVjdCA9IHNlbGVjdFttb2RlbENsYXNzTmFtZV0gfHwgW11cblxuICAgIGlmIChzaG93Q29uZmlnPy5wcmVsb2FkKSB7XG4gICAgICBmb3IgKGNvbnN0IHNob3dDb25maWdQcmVsb2FkIG9mIHNob3dDb25maWcucHJlbG9hZCkge1xuICAgICAgICBwcmVsb2FkLnB1c2goc2hvd0NvbmZpZ1ByZWxvYWQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCEobW9kZWxDbGFzc05hbWUgaW4gc2VsZWN0KSkgc2VsZWN0W21vZGVsQ2xhc3NOYW1lXSA9IG1vZGVsQ2xhc3NTZWxlY3RcbiAgICBpZiAoIW1vZGVsQ2xhc3NTZWxlY3QuaW5jbHVkZXMocHJpbWFyeUtleU5hbWUpKSBtb2RlbENsYXNzU2VsZWN0LnB1c2gocHJpbWFyeUtleU5hbWUpXG5cbiAgICAvLyBTZWxlY3QgYWxsIGF0dHJpYnV0ZXMgc2VsZWN0ZWQgYnkgZGVmYXVsdCBiZWNhdXNlIHRoZXkgd2lsbCBiZSBzaG93biBieSBkZWZhdWx0XG4gICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgb2YgbW9kZWxDbGFzcy5hdHRyaWJ1dGVzKCkpIHtcbiAgICAgIGlmICgoYXR0cmlidXRlLmlzU2VsZWN0ZWRCeURlZmF1bHQoKSB8fCBhdHRyaWJ1dGUubmFtZSgpID09IFwibmFtZVwiKSAmJiAhbW9kZWxDbGFzc1NlbGVjdC5pbmNsdWRlcyhhdHRyaWJ1dGUubmFtZSgpKSkge1xuICAgICAgICBtb2RlbENsYXNzU2VsZWN0LnB1c2goYXR0cmlidXRlLm5hbWUoKSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHJlZmxlY3Rpb24gb2YgbW9kZWxDbGFzcy5yZWZsZWN0aW9ucygpKSB7XG4gICAgICBpZiAocmVmbGVjdGlvbi5tYWNybygpID09IFwiYmVsb25nc190b1wiKSB7XG4gICAgICAgIGNvbnN0IHJlZmxlY3Rpb25Nb2RlbENsYXNzID0gcmVmbGVjdGlvbi5tb2RlbENsYXNzKClcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3MubW9kZWxDbGFzc0RhdGEoKS5uYW1lXG4gICAgICAgIGNvbnN0IHJlZmxlY3Rpb25Nb2RlbENsYXNzQXR0cmlidXRlcyA9IHJlZmxlY3Rpb25Nb2RlbENsYXNzLmF0dHJpYnV0ZXMoKVxuICAgICAgICBjb25zdCBuYW1lQXR0cmlidXRlID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3NBdHRyaWJ1dGVzLmZpbmQoKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLm5hbWUoKSA9PSBcIm5hbWVcIilcblxuICAgICAgICBwcmVsb2FkLnB1c2goaW5mbGVjdGlvbi51bmRlcnNjb3JlKHJlZmxlY3Rpb24ubmFtZSgpKSlcblxuICAgICAgICBpZiAoIShyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWUgaW4gc2VsZWN0KSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0gPSBbXVxuICAgICAgICBpZiAoIXNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLmluY2x1ZGVzKFwiaWRcIikpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLnB1c2goXCJpZFwiKVxuICAgICAgICBpZiAobmFtZUF0dHJpYnV0ZSAmJiAhc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0uaW5jbHVkZXMoXCJuYW1lXCIpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5wdXNoKFwibmFtZVwiKVxuXG4gICAgICAgIC8vIFRoZSBmb3JlaWduIGtleSBpcyBuZWVkZWQgdG8gbG9vayB1cCBhbnkgYmVsb25ncy10by1yZWxhdGlvbnNoaXBzXG4gICAgICAgIGlmICghbW9kZWxDbGFzc1NlbGVjdC5pbmNsdWRlcyhyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSkpIHtcbiAgICAgICAgICBjb25zdCBmb3JlaWduS2V5QXR0cmlidXRlID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3NBdHRyaWJ1dGVzLmZpbmQoKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLm5hbWUoKSA9PSByZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSlcblxuICAgICAgICAgIGlmICghZm9yZWlnbktleUF0dHJpYnV0ZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3JlZmxlY3Rpb24uZm9yZWlnbktleSgpfSB3YXNuJ3QgZGVmaW5lZCBhcyBhbiBhdHRyaWJ1dGUgb24gJHttb2RlbENsYXNzTmFtZX1gKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIG1vZGVsQ2xhc3NTZWxlY3QucHVzaChyZWZsZWN0aW9uLmZvcmVpZ25LZXkoKSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChyZWZsZWN0aW9uLm1hY3JvKCkgPT0gXCJoYXNfb25lXCIpIHtcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3MgPSByZWZsZWN0aW9uLm1vZGVsQ2xhc3MoKVxuICAgICAgICBjb25zdCByZWZsZWN0aW9uTW9kZWxDbGFzc05hbWUgPSByZWZsZWN0aW9uTW9kZWxDbGFzcy5tb2RlbENsYXNzRGF0YSgpLm5hbWVcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbk1vZGVsQ2xhc3NBdHRyaWJ1dGVzID0gcmVmbGVjdGlvbk1vZGVsQ2xhc3MuYXR0cmlidXRlcygpXG4gICAgICAgIGNvbnN0IG5hbWVBdHRyaWJ1dGUgPSByZWZsZWN0aW9uTW9kZWxDbGFzc0F0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZSgpID09IFwibmFtZVwiKVxuXG4gICAgICAgIHByZWxvYWQucHVzaChpbmZsZWN0aW9uLnVuZGVyc2NvcmUocmVmbGVjdGlvbi5uYW1lKCkpKVxuXG4gICAgICAgIGlmICghKHJlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZSBpbiBzZWxlY3QpKSBzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXSA9IFtdXG4gICAgICAgIGlmICghc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0uaW5jbHVkZXMoXCJpZFwiKSkgc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0ucHVzaChcImlkXCIpXG4gICAgICAgIGlmIChuYW1lQXR0cmlidXRlICYmICFzZWxlY3RbcmVmbGVjdGlvbk1vZGVsQ2xhc3NOYW1lXS5pbmNsdWRlcyhcIm5hbWVcIikpIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLnB1c2goXCJuYW1lXCIpXG5cbiAgICAgICAgLy8gVGhlIGZvcmVpZ24ga2V5IGlzIG5lZWRlZCB0byBsb29rIHVwIGFueSBoYXMtb25lLXJlbGF0aW9uc2hpcHNcbiAgICAgICAgaWYgKCFtb2RlbENsYXNzU2VsZWN0LmluY2x1ZGVzKHJlZmxlY3Rpb24uZm9yZWlnbktleSgpKSAmJiAhc2VsZWN0W3JlZmxlY3Rpb25Nb2RlbENsYXNzTmFtZV0uaW5jbHVkZXMocmVmbGVjdGlvbi5mb3JlaWduS2V5KCkpICYmICFyZWZsZWN0aW9uLnRocm91Z2goKSkge1xuICAgICAgICAgIHNlbGVjdFtyZWZsZWN0aW9uTW9kZWxDbGFzc05hbWVdLnB1c2gocmVmbGVjdGlvbi5mb3JlaWduS2V5KCkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB1c2VNb2RlbFJlc3VsdCA9IHVzZU1vZGVsKG1vZGVsQ2xhc3MsIHtcbiAgICAgIGxvYWRCeVF1ZXJ5UGFyYW06ICh7cXVlcnlQYXJhbXN9KSA9PiBxdWVyeVBhcmFtcy5tb2RlbF9pZCxcbiAgICAgIHByZWxvYWQsXG4gICAgICBzZWxlY3RcbiAgICB9KVxuICAgIGNvbnN0IGNhbWVsaXplZExvd2VyID0gZGlnZyhtb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCksIFwiY2FtZWxpemVkTG93ZXJcIilcbiAgICBjb25zdCBtb2RlbCA9IGRpZ2codXNlTW9kZWxSZXN1bHQsIGNhbWVsaXplZExvd2VyKVxuICAgIGNvbnN0IG1vZGVsQXJncyA9IHt9XG5cbiAgICBtb2RlbEFyZ3NbaW5mbGVjdGlvbi5jYW1lbGl6ZShtb2RlbENsYXNzLm1vZGVsQ2xhc3NEYXRhKCkubmFtZSwgdHJ1ZSldID0gbW9kZWxcblxuICAgIHJldHVybiAoXG4gICAgICA8VmlldyB0ZXN0SUQ9XCJzdXBlci1hZG1pbi9zaG93LXBhZ2VcIj5cbiAgICAgICAge21vZGVsICYmXG4gICAgICAgICAgPFNob3dOYXYgbW9kZWw9e21vZGVsfSBtb2RlbENsYXNzPXttb2RlbENsYXNzfSAvPlxuICAgICAgICB9XG4gICAgICAgIHthdHRyaWJ1dGVzICYmIG1vZGVsICYmIGF0dHJpYnV0ZXMubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgPEF0dHJpYnV0ZVByZXNlbnRlciBhdHRyaWJ1dGU9e2F0dHJpYnV0ZX0ga2V5PXthdHRyaWJ1dGUua2V5IHx8IGF0dHJpYnV0ZS5hdHRyaWJ1dGUgfHwgYXR0cmlidXRlfSBtb2RlbEFyZ3M9e21vZGVsQXJnc30gbW9kZWw9e21vZGVsfSAvPlxuICAgICAgICApfVxuICAgICAgICB7bW9kZWwgJiYgbW9kZWxDbGFzcy5yZWZsZWN0aW9ucygpLmZpbHRlcigocmVmbGVjdGlvbikgPT4gcmVmbGVjdGlvbi5tYWNybygpID09IFwiYmVsb25nc190b1wiIHx8IHJlZmxlY3Rpb24ubWFjcm8oKSA9PSBcImhhc19vbmVcIikubWFwKChyZWZsZWN0aW9uKSA9PlxuICAgICAgICAgIDxCZWxvbmdzVG9BdHRyaWJ1dGVSb3cga2V5PXtyZWZsZWN0aW9uLm5hbWUoKX0gbW9kZWw9e21vZGVsfSBtb2RlbENsYXNzPXttb2RlbENsYXNzfSByZWZsZWN0aW9uPXtyZWZsZWN0aW9ufSAvPlxuICAgICAgICApfVxuICAgICAgICB7bW9kZWwgJiYgZXh0cmFDb250ZW50ICYmIGV4dHJhQ29udGVudChtb2RlbEFyZ3MpfVxuICAgICAgPC9WaWV3PlxuICAgIClcbiAgfVxufSkpXG4iXX0=