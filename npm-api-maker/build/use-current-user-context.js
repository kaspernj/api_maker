import { jsx as _jsx } from "react/jsx-runtime";
import React, { useCallback, useMemo } from "react"; // eslint-disable-line sort-imports
import Devise from "./devise.js";
import { digg } from "diggerize"; // eslint-disable-line sort-imports
import { events } from "./use-current-user.js"; // eslint-disable-line sort-imports
import * as inflection from "inflection"; // eslint-disable-line sort-imports
import Logger from "./logger.js";
import Services from "./services.js";
import useEventEmitter from "./use-event-emitter.js"; // eslint-disable-line sort-imports
import useShape from "set-state-compare/build/use-shape.js";
const logger = new Logger({ name: "ApiMaker / UseCurrentUserContext" });
logger.setDebug(false);
/**
 * @param {object} props
 * @param {function} props.children
 * @param {string} [props.scope]
 * @returns {import("react").ReactNode}
 */
const UseCurrentUserContext = (props) => {
    const { children, scope = "user", ...restProps } = props;
    if (Object.keys(restProps).length > 0) {
        throw new Error(`Unknown props given to UseCurrentUserContext: ${Object.keys(restProps).join(", ")}`);
    }
    const s = useShape(props);
    const scopeName = `current${inflection.camelize(scope)}`;
    const scopeInstance = Devise.getScope(scope);
    const ScopeContext = scopeInstance.getContext();
    s.meta.scope = scope;
    s.meta.scopeName = scopeName;
    const loadCurrentUserFromRequest = useCallback(async () => {
        const { scope } = s.m;
        const getArgsMethodName = `get${inflection.camelize(scope)}Args`;
        const args = Devise[getArgsMethodName]();
        logger.debug(() => `Loading ${scope} with request`);
        const result = await Services.current().sendRequest("Devise::Current", { query: args.query, scope });
        const current = digg(result, "current")[0];
        if (current)
            Devise.updateSession(current);
        s.set({
            result: {
                loaded: true,
                model: current
            }
        });
        events.emit("currentUserLoaded", { current });
    }, []);
    const defaultCurrentUser = useCallback(() => {
        const { scope, scopeName } = s.m;
        let current;
        if (Devise.current().hasCurrentScope(s.m.scope)) {
            current = Devise.current().getCurrentScope(scope);
            logger.debug(() => `Setting ${scope} from current scope: ${current?.id()}`);
        }
        else if (Devise.current().hasGlobalCurrentScope(scope)) {
            current = Devise[scopeName]();
            logger.debug(() => `Setting ${scope} from global current scope: ${current?.id()}`);
        }
        if (current) {
            events.emit("currentUserLoaded", { current });
        }
        return current;
    }, []);
    s.useStates({
        result: () => ({
            loaded: false,
            model: defaultCurrentUser()
        })
    });
    const updateCurrentUser = useCallback(() => {
        s.set({
            result: {
                loaded: true,
                model: Devise[s.m.scopeName]()
            }
        });
    }, []);
    useMemo(() => {
        if (!Devise.current().hasGlobalCurrentScope(s.m.scope) && !Devise.current().hasCurrentScope(s.m.scope)) {
            logger.debug(() => `Devise hasn't got current scope ${s.m.scope} so loading from request`);
            loadCurrentUserFromRequest();
        }
    }, []);
    const onDeviseSignIn = useCallback(() => {
        updateCurrentUser();
    }, []);
    const onDeviseSignOut = useCallback(() => {
        updateCurrentUser();
    }, []);
    useEventEmitter(Devise.events(), "onDeviseSignIn", onDeviseSignIn);
    useEventEmitter(Devise.events(), "onDeviseSignOut", onDeviseSignOut);
    return (_jsx(ScopeContext.Provider, { value: s.s.result, children: children }));
};
export default UseCurrentUserContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWN1cnJlbnQtdXNlci1jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJ1c2UtY3VycmVudC11c2VyLWNvbnRleHQuanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssRUFBRSxFQUFDLFdBQVcsRUFBRSxPQUFPLEVBQUMsTUFBTSxPQUFPLENBQUEsQ0FBQyxtQ0FBbUM7QUFDckYsT0FBTyxNQUFNLE1BQU0sYUFBYSxDQUFBO0FBQ2hDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxXQUFXLENBQUEsQ0FBQyxtQ0FBbUM7QUFDbEUsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLHVCQUF1QixDQUFBLENBQUMsbUNBQW1DO0FBQ2hGLE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBLENBQUMsbUNBQW1DO0FBQzVFLE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQTtBQUNoQyxPQUFPLFFBQVEsTUFBTSxlQUFlLENBQUE7QUFDcEMsT0FBTyxlQUFlLE1BQU0sd0JBQXdCLENBQUEsQ0FBQyxtQ0FBbUM7QUFDeEYsT0FBTyxRQUFRLE1BQU0sc0NBQXNDLENBQUE7QUFFM0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsRUFBQyxJQUFJLEVBQUUsa0NBQWtDLEVBQUMsQ0FBQyxDQUFBO0FBRXJFLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7QUFFdEI7Ozs7O0dBS0c7QUFDSCxNQUFNLHFCQUFxQixHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDdEMsTUFBTSxFQUFDLFFBQVEsRUFBRSxLQUFLLEdBQUcsTUFBTSxFQUFFLEdBQUcsU0FBUyxFQUFDLEdBQUcsS0FBSyxDQUFBO0lBRXRELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsTUFBTSxDQUFDLElB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QUUsQ0FBQTtJQUNyQixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFTixlQUFlLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFBO0lBQ2xFLGVBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxDQUFDLENBQUE7SUFFcEUsT0FBTyxDQUNMLEtBQUMsWUFBWSxDQUFDLFFBQVEsSUFBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLFlBQ3JDLFFBQVEsR0FDYSxDQUN6QixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsZUFBZSxxQkFBcUIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwge3VzZUNhbGxiYWNrLCB1c2VNZW1vfSBmcm9tIFwicmVhY3RcIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHNvcnQtaW1wb3J0c1xuaW1wb3J0IERldmlzZSBmcm9tIFwiLi9kZXZpc2UuanNcIlxuaW1wb3J0IHtkaWdnfSBmcm9tIFwiZGlnZ2VyaXplXCIgLy8gZXNsaW50LWRpc2FibGUtbGluZSBzb3J0LWltcG9ydHNcbmltcG9ydCB7ZXZlbnRzfSBmcm9tIFwiLi91c2UtY3VycmVudC11c2VyLmpzXCIgLy8gZXNsaW50LWRpc2FibGUtbGluZSBzb3J0LWltcG9ydHNcbmltcG9ydCAqIGFzIGluZmxlY3Rpb24gZnJvbSBcImluZmxlY3Rpb25cIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHNvcnQtaW1wb3J0c1xuaW1wb3J0IExvZ2dlciBmcm9tIFwiLi9sb2dnZXIuanNcIlxuaW1wb3J0IFNlcnZpY2VzIGZyb20gXCIuL3NlcnZpY2VzLmpzXCJcbmltcG9ydCB1c2VFdmVudEVtaXR0ZXIgZnJvbSBcIi4vdXNlLWV2ZW50LWVtaXR0ZXIuanNcIiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHNvcnQtaW1wb3J0c1xuaW1wb3J0IHVzZVNoYXBlIGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC91c2Utc2hhcGUuanNcIlxuXG5jb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHtuYW1lOiBcIkFwaU1ha2VyIC8gVXNlQ3VycmVudFVzZXJDb250ZXh0XCJ9KVxuXG5sb2dnZXIuc2V0RGVidWcoZmFsc2UpXG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IHByb3BzXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBwcm9wcy5jaGlsZHJlblxuICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wcy5zY29wZV1cbiAqIEByZXR1cm5zIHtpbXBvcnQoXCJyZWFjdFwiKS5SZWFjdE5vZGV9XG4gKi9cbmNvbnN0IFVzZUN1cnJlbnRVc2VyQ29udGV4dCA9IChwcm9wcykgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlYWN0L2Z1bmN0aW9uLWNvbXBvbmVudC1kZWZpbml0aW9uLCBqZXN0L3JlcXVpcmUtaG9va1xuICBjb25zdCB7Y2hpbGRyZW4sIHNjb3BlID0gXCJ1c2VyXCIsIC4uLnJlc3RQcm9wc30gPSBwcm9wc1xuXG4gIGlmIChPYmplY3Qua2V5cyhyZXN0UHJvcHMpLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcHJvcHMgZ2l2ZW4gdG8gVXNlQ3VycmVudFVzZXJDb250ZXh0OiAke09iamVjdC5rZXlzKHJlc3RQcm9wcykuam9pbihcIiwgXCIpfWApXG4gIH1cblxuICBjb25zdCBzID0gdXNlU2hhcGUocHJvcHMpXG4gIGNvbnN0IHNjb3BlTmFtZSA9IGBjdXJyZW50JHtpbmZsZWN0aW9uLmNhbWVsaXplKHNjb3BlKX1gXG4gIGNvbnN0IHNjb3BlSW5zdGFuY2UgPSBEZXZpc2UuZ2V0U2NvcGUoc2NvcGUpXG4gIGNvbnN0IFNjb3BlQ29udGV4dCA9IHNjb3BlSW5zdGFuY2UuZ2V0Q29udGV4dCgpXG5cbiAgcy5tZXRhLnNjb3BlID0gc2NvcGVcbiAgcy5tZXRhLnNjb3BlTmFtZSA9IHNjb3BlTmFtZVxuXG4gIGNvbnN0IGxvYWRDdXJyZW50VXNlckZyb21SZXF1ZXN0ID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICAgIGNvbnN0IHtzY29wZX0gPSBzLm1cbiAgICBjb25zdCBnZXRBcmdzTWV0aG9kTmFtZSA9IGBnZXQke2luZmxlY3Rpb24uY2FtZWxpemUoc2NvcGUpfUFyZ3NgXG4gICAgY29uc3QgYXJncyA9IERldmlzZVtnZXRBcmdzTWV0aG9kTmFtZV0oKVxuXG4gICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBMb2FkaW5nICR7c2NvcGV9IHdpdGggcmVxdWVzdGApXG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTZXJ2aWNlcy5jdXJyZW50KCkuc2VuZFJlcXVlc3QoXCJEZXZpc2U6OkN1cnJlbnRcIiwge3F1ZXJ5OiBhcmdzLnF1ZXJ5LCBzY29wZX0pXG4gICAgY29uc3QgY3VycmVudCA9IGRpZ2cocmVzdWx0LCBcImN1cnJlbnRcIilbMF1cblxuICAgIGlmIChjdXJyZW50KSBEZXZpc2UudXBkYXRlU2Vzc2lvbihjdXJyZW50KVxuXG4gICAgcy5zZXQoe1xuICAgICAgcmVzdWx0OiB7XG4gICAgICAgIGxvYWRlZDogdHJ1ZSxcbiAgICAgICAgbW9kZWw6IGN1cnJlbnRcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgZXZlbnRzLmVtaXQoXCJjdXJyZW50VXNlckxvYWRlZFwiLCB7Y3VycmVudH0pXG4gIH0sIFtdKVxuXG4gIGNvbnN0IGRlZmF1bHRDdXJyZW50VXNlciA9IHVzZUNhbGxiYWNrKCgpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgICBjb25zdCB7c2NvcGUsIHNjb3BlTmFtZX0gPSBzLm1cbiAgICBsZXQgY3VycmVudFxuXG4gICAgaWYgKERldmlzZS5jdXJyZW50KCkuaGFzQ3VycmVudFNjb3BlKHMubS5zY29wZSkpIHtcbiAgICAgIGN1cnJlbnQgPSBEZXZpc2UuY3VycmVudCgpLmdldEN1cnJlbnRTY29wZShzY29wZSlcblxuICAgICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBTZXR0aW5nICR7c2NvcGV9IGZyb20gY3VycmVudCBzY29wZTogJHtjdXJyZW50Py5pZCgpfWApXG4gICAgfSBlbHNlIGlmIChEZXZpc2UuY3VycmVudCgpLmhhc0dsb2JhbEN1cnJlbnRTY29wZShzY29wZSkpIHtcbiAgICAgIGN1cnJlbnQgPSBEZXZpc2Vbc2NvcGVOYW1lXSgpXG5cbiAgICAgIGxvZ2dlci5kZWJ1ZygoKSA9PiBgU2V0dGluZyAke3Njb3BlfSBmcm9tIGdsb2JhbCBjdXJyZW50IHNjb3BlOiAke2N1cnJlbnQ/LmlkKCl9YClcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudCkge1xuICAgICAgZXZlbnRzLmVtaXQoXCJjdXJyZW50VXNlckxvYWRlZFwiLCB7Y3VycmVudH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRcbiAgfSwgW10pXG5cbiAgcy51c2VTdGF0ZXMoe1xuICAgIHJlc3VsdDogKCkgPT4gKHtcbiAgICAgIGxvYWRlZDogZmFsc2UsXG4gICAgICBtb2RlbDogZGVmYXVsdEN1cnJlbnRVc2VyKClcbiAgICB9KVxuICB9KVxuXG4gIGNvbnN0IHVwZGF0ZUN1cnJlbnRVc2VyID0gdXNlQ2FsbGJhY2soKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICAgIHMuc2V0KHtcbiAgICAgIHJlc3VsdDoge1xuICAgICAgICBsb2FkZWQ6IHRydWUsXG4gICAgICAgIG1vZGVsOiBEZXZpc2Vbcy5tLnNjb3BlTmFtZV0oKVxuICAgICAgfVxuICAgIH0pXG4gIH0sIFtdKVxuXG4gIHVzZU1lbW8oKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICAgIGlmICghRGV2aXNlLmN1cnJlbnQoKS5oYXNHbG9iYWxDdXJyZW50U2NvcGUocy5tLnNjb3BlKSAmJiAhRGV2aXNlLmN1cnJlbnQoKS5oYXNDdXJyZW50U2NvcGUocy5tLnNjb3BlKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCgpID0+IGBEZXZpc2UgaGFzbid0IGdvdCBjdXJyZW50IHNjb3BlICR7cy5tLnNjb3BlfSBzbyBsb2FkaW5nIGZyb20gcmVxdWVzdGApXG4gICAgICBsb2FkQ3VycmVudFVzZXJGcm9tUmVxdWVzdCgpXG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCBvbkRldmlzZVNpZ25JbiA9IHVzZUNhbGxiYWNrKCgpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgICB1cGRhdGVDdXJyZW50VXNlcigpXG4gIH0sIFtdKVxuXG4gIGNvbnN0IG9uRGV2aXNlU2lnbk91dCA9IHVzZUNhbGxiYWNrKCgpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgICB1cGRhdGVDdXJyZW50VXNlcigpXG4gIH0sIFtdKVxuXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduSW5cIiwgb25EZXZpc2VTaWduSW4pXG4gIHVzZUV2ZW50RW1pdHRlcihEZXZpc2UuZXZlbnRzKCksIFwib25EZXZpc2VTaWduT3V0XCIsIG9uRGV2aXNlU2lnbk91dClcblxuICByZXR1cm4gKFxuICAgIDxTY29wZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3Mucy5yZXN1bHR9PlxuICAgICAge2NoaWxkcmVufVxuICAgIDwvU2NvcGVDb250ZXh0LlByb3ZpZGVyPlxuICApXG59XG5cbmV4cG9ydCBkZWZhdWx0IFVzZUN1cnJlbnRVc2VyQ29udGV4dFxuIl19