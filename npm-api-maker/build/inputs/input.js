import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import AutoSubmit from "./auto-submit.js";
import BaseComponent from "../base-component";
import { dig, digg, digs } from "diggerize";
import inputWrapper from "./input-wrapper";
import memo from "set-state-compare/build/memo.js";
import Money from "./money";
import PropTypes from "prop-types";
import React, { useMemo, useRef } from "react";
import replaceall from "replaceall";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import strftime from "strftime";
import { useForm } from "../form";
import useI18n from "i18n-on-steroids/src/use-i18n.mjs";
import useUpdatedEvent from "../use-updated-event.js";
const ApiMakerInputsInput = memo(shapeComponent(class ApiMakerInputsInput extends BaseComponent {
    static defaultProps = {
        autoRefresh: false,
        autoSubmit: false,
        model: null,
        localizedNumber: false
    };
    static propTypes = {
        attribute: PropTypes.string,
        autoRefresh: PropTypes.bool.isRequired,
        autoSubmit: PropTypes.bool.isRequired,
        className: PropTypes.string,
        formatValue: PropTypes.func,
        id: PropTypes.string,
        localizedNumber: PropTypes.bool.isRequired,
        model: PropTypes.object,
        name: PropTypes.string,
        onChange: PropTypes.func,
        onMatchValidationError: PropTypes.func,
        type: PropTypes.string
    };
    setup() {
        const { t } = useI18n({ namespace: "js.api_maker.inputs.input" });
        const { autoRefresh, inputProps, model } = this.p;
        const { defaultValue, name } = inputProps;
        this.form = useForm();
        this.visibleInputRef = useRef();
        this.t = t;
        this.useStates({
            blankInputName: digg(inputProps, "type") == "file"
        });
        useMemo(() => {
            if (name) {
                this.tt.form?.setValue(name, defaultValue);
            }
        }, []);
        useUpdatedEvent(model, this.tt.onModelUpdated, { active: Boolean(autoRefresh && model) });
    }
    render() {
        const { attribute, autoRefresh, autoSubmit, defaultValue, formatValue, id, inputProps, inputRef, localizedNumber, model, name, onChange, onErrors, onMatchValidationError, type, wrapperOpts, ...restProps } = this.props;
        const sharedProps = {
            id: localizedNumber ? null : inputProps.id,
            name: localizedNumber ? null : inputProps.name,
        };
        const ref = localizedNumber ? this.visibleInputRef : this.inputReference();
        const { ref: inputPropsRef, ...inputPropsWithoutRef } = inputProps;
        return (_jsxs(_Fragment, { children: [localizedNumber &&
                    _jsx("input", { defaultValue: defaultValue, id: inputProps.id, name: this.inputName(), ref: this.inputReference(), type: "hidden" }), type == "money" &&
                    _jsx(Money, { attribute: attribute, defaultValue: this.inputDefaultValueLocalized(), inputRef: this.inputReference(), model: model, onChange: this.onInputChanged, ...inputPropsWithoutRef, ...sharedProps, ...restProps }), type == "textarea" &&
                    _jsx("textarea", { defaultValue: this.inputDefaultValueLocalized(), onChange: this.onInputChanged, ref: ref, ...inputPropsWithoutRef, ...sharedProps, ...restProps }), type != "money" && type != "textarea" &&
                    _jsx("input", { defaultValue: this.inputDefaultValueLocalized(), onChange: this.onInputChanged, ref: ref, ...inputPropsWithoutRef, ...sharedProps, name: localizedNumber ? null : this.inputName(), ...restProps })] }));
    }
    actualValue(visibleInput) {
        const { t } = this.tt;
        const { localizedNumber } = digs(this.props, "localizedNumber");
        const value = digg(visibleInput, "value");
        if (localizedNumber) {
            const decimal = t("number.currency.format.separator");
            const integerSeparator = t("number.currency.format.delimiter");
            let unformatted = replaceall(integerSeparator, "", value);
            unformatted = replaceall(decimal, ".", unformatted);
            return unformatted;
        }
        return value;
    }
    autoSubmit = () => new AutoSubmit({ component: this }).autoSubmit();
    formatValue(value) {
        const { formatValue, type } = this.props;
        if (formatValue) {
            return formatValue(value);
        }
        else if (value instanceof Date && !isNaN(value.getTime())) {
            // We need to use a certain format for datetime-local
            if (type == "datetime-local") {
                return strftime("%Y-%m-%dT%H:%M:%S", value);
            }
            else if (type == "date") {
                return strftime("%Y-%m-%d", value);
            }
        }
        return value;
    }
    inputDefaultValueLocalized() {
        const { t } = this.tt;
        const { defaultValue } = this.props;
        const { localizedNumber } = digs(this.props, "localizedNumber");
        if (localizedNumber && defaultValue !== null && defaultValue !== undefined) {
            const separator = t("number.currency.format.separator");
            const delimiter = t("number.currency.format.delimiter");
            let formatted = `${defaultValue}`;
            formatted = replaceall(".", "{{separator}}", formatted);
            formatted = replaceall(",", "{{delimiter}}", formatted);
            formatted = replaceall("{{separator}}", separator, formatted);
            formatted = replaceall("{{delimiter}}", delimiter, formatted);
            return formatted;
        }
        return defaultValue;
    }
    inputName() {
        if (this.state.blankInputName)
            return "";
        return this.props.inputProps.name;
    }
    inputReference = () => digg(this, "props", "inputProps", "ref");
    onModelUpdated = (args) => {
        const inputRef = this.inputReference();
        if (!inputRef.current) {
            // This can happen if the component is being unmounted
            return;
        }
        const { attribute } = digs(this.props, "attribute");
        const newModel = digg(args, "model");
        const currentValue = digg(inputRef, "current", "value");
        const newValue = newModel.readAttribute(attribute);
        const newFormattedValue = this.formatValue(newValue);
        if (currentValue != newFormattedValue) {
            inputRef.current.value = newFormattedValue;
        }
    };
    onInputChanged = (e) => {
        const { form } = this.tt;
        const { attribute, autoSubmit, inputProps, model, onChange } = this.props;
        const { localizedNumber } = digs(this.props, "localizedNumber");
        const { name } = inputProps;
        if (localizedNumber)
            this.inputReference().current.value = this.actualValue(digg(e, "target"));
        if (attribute && autoSubmit && model)
            this.delayAutoSubmit();
        if (digg(inputProps, "type") == "file")
            this.setState({ blankInputName: this.getBlankInputName() });
        if (form && name) {
            form.setValue(name, e.target.value);
        }
        if (onChange)
            onChange(e);
    };
    delayAutoSubmit() {
        if (this.delayAutoSubmitTimeout) {
            clearTimeout(this.delayAutoSubmitTimeout);
        }
        this.delayAutoSubmitTimeout = setTimeout(this.autoSubmit, 200);
    }
    // This fixes an issue in Firefox and ActiveStorage, where uploads would be a blank string if a file wasn't chosen
    getBlankInputName() {
        const value = dig(this.inputReference(), "current", "value");
        if (this.props.inputProps.type == "file" && value == "")
            return true;
    }
}));
export { ApiMakerInputsInput as Input };
export default inputWrapper(ApiMakerInputsInput);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbImlucHV0cy9pbnB1dC5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sVUFBVSxNQUFNLGtCQUFrQixDQUFBO0FBQ3pDLE9BQU8sYUFBYSxNQUFNLG1CQUFtQixDQUFBO0FBQzdDLE9BQU8sRUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUN6QyxPQUFPLFlBQVksTUFBTSxpQkFBaUIsQ0FBQTtBQUMxQyxPQUFPLElBQUksTUFBTSxpQ0FBaUMsQ0FBQTtBQUNsRCxPQUFPLEtBQUssTUFBTSxTQUFTLENBQUE7QUFDM0IsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sS0FBSyxFQUFFLEVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUM1QyxPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDRDQUE0QyxDQUFBO0FBQ3pFLE9BQU8sUUFBUSxNQUFNLFVBQVUsQ0FBQTtBQUMvQixPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sU0FBUyxDQUFBO0FBQy9CLE9BQU8sT0FBTyxNQUFNLG1DQUFtQyxDQUFBO0FBQ3ZELE9BQU8sZUFBZSxNQUFNLHlCQUF5QixDQUFBO0FBRXJELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLG1CQUFvQixTQUFRLGFBQWE7SUFDN0YsTUFBTSxDQUFDLFlBQVksR0FBRztRQUNwQixXQUFXLEVBQUUsS0FBSztRQUNsQixVQUFVLEVBQUUsS0FBSztRQUNqQixLQUFLLEVBQUUsSUFBSTtRQUNYLGVBQWUsRUFBRSxLQUFLO0tBQ3ZCLENBQUE7SUFFRCxNQUFNLENBQUMsU0FBUyxHQUFHO1FBQ2pCLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTTtRQUMzQixXQUFXLEVBQUUsU0FBUyxDQUFD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RUFBQyxDQUFBO0FBQ3JDLGVBQWUsWUFBWSxDQUFDLG1CQUFtQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQXV0b1N1Ym1pdCBmcm9tIFwiLi9hdXRvLXN1Ym1pdC5qc1wiXG5pbXBvcnQgQmFzZUNvbXBvbmVudCBmcm9tIFwiLi4vYmFzZS1jb21wb25lbnRcIlxuaW1wb3J0IHtkaWcsIGRpZ2csIGRpZ3N9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IGlucHV0V3JhcHBlciBmcm9tIFwiLi9pbnB1dC13cmFwcGVyXCJcbmltcG9ydCBtZW1vIGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC9tZW1vLmpzXCJcbmltcG9ydCBNb25leSBmcm9tIFwiLi9tb25leVwiXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCJcbmltcG9ydCBSZWFjdCwge3VzZU1lbW8sIHVzZVJlZn0gZnJvbSBcInJlYWN0XCJcbmltcG9ydCByZXBsYWNlYWxsIGZyb20gXCJyZXBsYWNlYWxsXCJcbmltcG9ydCB7c2hhcGVDb21wb25lbnR9IGZyb20gXCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC9zaGFwZS1jb21wb25lbnQuanNcIlxuaW1wb3J0IHN0cmZ0aW1lIGZyb20gXCJzdHJmdGltZVwiXG5pbXBvcnQge3VzZUZvcm19IGZyb20gXCIuLi9mb3JtXCJcbmltcG9ydCB1c2VJMThuIGZyb20gXCJpMThuLW9uLXN0ZXJvaWRzL3NyYy91c2UtaTE4bi5tanNcIlxuaW1wb3J0IHVzZVVwZGF0ZWRFdmVudCBmcm9tIFwiLi4vdXNlLXVwZGF0ZWQtZXZlbnQuanNcIlxuXG5jb25zdCBBcGlNYWtlcklucHV0c0lucHV0ID0gbWVtbyhzaGFwZUNvbXBvbmVudChjbGFzcyBBcGlNYWtlcklucHV0c0lucHV0IGV4dGVuZHMgQmFzZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgYXV0b1JlZnJlc2g6IGZhbHNlLFxuICAgIGF1dG9TdWJtaXQ6IGZhbHNlLFxuICAgIG1vZGVsOiBudWxsLFxuICAgIGxvY2FsaXplZE51bWJlcjogZmFsc2VcbiAgfVxuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgYXR0cmlidXRlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGF1dG9SZWZyZXNoOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIGF1dG9TdWJtaXQ6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGZvcm1hdFZhbHVlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBpZDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBsb2NhbGl6ZWROdW1iZXI6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgbW9kZWw6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgbmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25NYXRjaFZhbGlkYXRpb25FcnJvcjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgdHlwZTogUHJvcFR5cGVzLnN0cmluZ1xuICB9XG5cbiAgc2V0dXAoKSB7XG4gICAgY29uc3Qge3R9ID0gdXNlSTE4bih7bmFtZXNwYWNlOiBcImpzLmFwaV9tYWtlci5pbnB1dHMuaW5wdXRcIn0pXG4gICAgY29uc3Qge2F1dG9SZWZyZXNoLCBpbnB1dFByb3BzLCBtb2RlbH0gPSB0aGlzLnBcbiAgICBjb25zdCB7ZGVmYXVsdFZhbHVlLCBuYW1lfSA9IGlucHV0UHJvcHNcblxuICAgIHRoaXMuZm9ybSA9IHVzZUZvcm0oKVxuICAgIHRoaXMudmlzaWJsZUlucHV0UmVmID0gdXNlUmVmKClcbiAgICB0aGlzLnQgPSB0XG5cbiAgICB0aGlzLnVzZVN0YXRlcyh7XG4gICAgICBibGFua0lucHV0TmFtZTogZGlnZyhpbnB1dFByb3BzLCBcInR5cGVcIikgPT0gXCJmaWxlXCJcbiAgICB9KVxuXG4gICAgdXNlTWVtbygoKSA9PiB7XG4gICAgICBpZiAobmFtZSkge1xuICAgICAgICB0aGlzLnR0LmZvcm0/LnNldFZhbHVlKG5hbWUsIGRlZmF1bHRWYWx1ZSlcbiAgICAgIH1cbiAgICB9LCBbXSlcblxuICAgIHVzZVVwZGF0ZWRFdmVudChtb2RlbCwgdGhpcy50dC5vbk1vZGVsVXBkYXRlZCwge2FjdGl2ZTogQm9vbGVhbihhdXRvUmVmcmVzaCAmJiBtb2RlbCl9KVxuICB9XG5cbiAgcmVuZGVyICgpIHtcbiAgICBjb25zdCB7XG4gICAgICBhdHRyaWJ1dGUsXG4gICAgICBhdXRvUmVmcmVzaCxcbiAgICAgIGF1dG9TdWJtaXQsXG4gICAgICBkZWZhdWx0VmFsdWUsXG4gICAgICBmb3JtYXRWYWx1ZSxcbiAgICAgIGlkLFxuICAgICAgaW5wdXRQcm9wcyxcbiAgICAgIGlucHV0UmVmLFxuICAgICAgbG9jYWxpemVkTnVtYmVyLFxuICAgICAgbW9kZWwsXG4gICAgICBuYW1lLFxuICAgICAgb25DaGFuZ2UsXG4gICAgICBvbkVycm9ycyxcbiAgICAgIG9uTWF0Y2hWYWxpZGF0aW9uRXJyb3IsXG4gICAgICB0eXBlLFxuICAgICAgd3JhcHBlck9wdHMsXG4gICAgICAuLi5yZXN0UHJvcHNcbiAgICB9ID0gdGhpcy5wcm9wc1xuXG4gICAgY29uc3Qgc2hhcmVkUHJvcHMgPSB7XG4gICAgICBpZDogbG9jYWxpemVkTnVtYmVyID8gbnVsbCA6IGlucHV0UHJvcHMuaWQsXG4gICAgICBuYW1lOiBsb2NhbGl6ZWROdW1iZXIgPyBudWxsIDogaW5wdXRQcm9wcy5uYW1lLFxuICAgIH1cbiAgICBjb25zdCByZWYgPSBsb2NhbGl6ZWROdW1iZXIgPyB0aGlzLnZpc2libGVJbnB1dFJlZiA6IHRoaXMuaW5wdXRSZWZlcmVuY2UoKVxuICAgIGNvbnN0IHtyZWY6IGlucHV0UHJvcHNSZWYsIC4uLmlucHV0UHJvcHNXaXRob3V0UmVmfSA9IGlucHV0UHJvcHNcblxuICAgIHJldHVybiAoXG4gICAgICA8PlxuICAgICAgICB7bG9jYWxpemVkTnVtYmVyICYmXG4gICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU9e2RlZmF1bHRWYWx1ZX1cbiAgICAgICAgICAgIGlkPXtpbnB1dFByb3BzLmlkfVxuICAgICAgICAgICAgbmFtZT17dGhpcy5pbnB1dE5hbWUoKX1cbiAgICAgICAgICAgIHJlZj17dGhpcy5pbnB1dFJlZmVyZW5jZSgpfVxuICAgICAgICAgICAgdHlwZT1cImhpZGRlblwiXG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgICB7dHlwZSA9PSBcIm1vbmV5XCIgJiZcbiAgICAgICAgICA8TW9uZXlcbiAgICAgICAgICAgIGF0dHJpYnV0ZT17YXR0cmlidXRlfVxuICAgICAgICAgICAgZGVmYXVsdFZhbHVlPXt0aGlzLmlucHV0RGVmYXVsdFZhbHVlTG9jYWxpemVkKCl9XG4gICAgICAgICAgICBpbnB1dFJlZj17dGhpcy5pbnB1dFJlZmVyZW5jZSgpfVxuICAgICAgICAgICAgbW9kZWw9e21vZGVsfVxuICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25JbnB1dENoYW5nZWR9XG4gICAgICAgICAgICB7Li4uaW5wdXRQcm9wc1dpdGhvdXRSZWZ9XG4gICAgICAgICAgICB7Li4uc2hhcmVkUHJvcHN9XG4gICAgICAgICAgICB7Li4ucmVzdFByb3BzfVxuICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgICAge3R5cGUgPT0gXCJ0ZXh0YXJlYVwiICYmXG4gICAgICAgICAgPHRleHRhcmVhXG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU9e3RoaXMuaW5wdXREZWZhdWx0VmFsdWVMb2NhbGl6ZWQoKX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uSW5wdXRDaGFuZ2VkfVxuICAgICAgICAgICAgcmVmPXtyZWZ9XG4gICAgICAgICAgICB7Li4uaW5wdXRQcm9wc1dpdGhvdXRSZWZ9XG4gICAgICAgICAgICB7Li4uc2hhcmVkUHJvcHN9XG4gICAgICAgICAgICB7Li4ucmVzdFByb3BzfVxuICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgICAge3R5cGUgIT0gXCJtb25leVwiICYmIHR5cGUgIT0gXCJ0ZXh0YXJlYVwiICYmXG4gICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU9e3RoaXMuaW5wdXREZWZhdWx0VmFsdWVMb2NhbGl6ZWQoKX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uSW5wdXRDaGFuZ2VkfVxuICAgICAgICAgICAgcmVmPXtyZWZ9XG4gICAgICAgICAgICB7Li4uaW5wdXRQcm9wc1dpdGhvdXRSZWZ9XG4gICAgICAgICAgICB7Li4uc2hhcmVkUHJvcHN9XG4gICAgICAgICAgICBuYW1lPXtsb2NhbGl6ZWROdW1iZXIgPyBudWxsIDogdGhpcy5pbnB1dE5hbWUoKX1cbiAgICAgICAgICAgIHsuLi5yZXN0UHJvcHN9XG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgPC8+XG4gICAgKVxuICB9XG5cbiAgYWN0dWFsVmFsdWUgKHZpc2libGVJbnB1dCkge1xuICAgIGNvbnN0IHt0fSA9IHRoaXMudHRcbiAgICBjb25zdCB7bG9jYWxpemVkTnVtYmVyfSA9IGRpZ3ModGhpcy5wcm9wcywgXCJsb2NhbGl6ZWROdW1iZXJcIilcbiAgICBjb25zdCB2YWx1ZSA9IGRpZ2codmlzaWJsZUlucHV0LCBcInZhbHVlXCIpXG5cbiAgICBpZiAobG9jYWxpemVkTnVtYmVyKSB7XG4gICAgICBjb25zdCBkZWNpbWFsID0gdChcIm51bWJlci5jdXJyZW5jeS5mb3JtYXQuc2VwYXJhdG9yXCIpXG4gICAgICBjb25zdCBpbnRlZ2VyU2VwYXJhdG9yID0gdChcIm51bWJlci5jdXJyZW5jeS5mb3JtYXQuZGVsaW1pdGVyXCIpXG5cbiAgICAgIGxldCB1bmZvcm1hdHRlZCA9IHJlcGxhY2VhbGwoaW50ZWdlclNlcGFyYXRvciwgXCJcIiwgdmFsdWUpXG5cbiAgICAgIHVuZm9ybWF0dGVkID0gcmVwbGFjZWFsbChkZWNpbWFsLCBcIi5cIiwgdW5mb3JtYXR0ZWQpXG5cbiAgICAgIHJldHVybiB1bmZvcm1hdHRlZFxuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZVxuICB9XG5cbiAgYXV0b1N1Ym1pdCA9ICgpID0+IG5ldyBBdXRvU3VibWl0KHtjb21wb25lbnQ6IHRoaXN9KS5hdXRvU3VibWl0KClcblxuICBmb3JtYXRWYWx1ZSAodmFsdWUpIHtcbiAgICBjb25zdCB7Zm9ybWF0VmFsdWUsIHR5cGV9ID0gdGhpcy5wcm9wc1xuXG4gICAgaWYgKGZvcm1hdFZhbHVlKSB7XG4gICAgICByZXR1cm4gZm9ybWF0VmFsdWUodmFsdWUpXG4gICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHZhbHVlLmdldFRpbWUoKSkpIHtcbiAgICAgIC8vIFdlIG5lZWQgdG8gdXNlIGEgY2VydGFpbiBmb3JtYXQgZm9yIGRhdGV0aW1lLWxvY2FsXG4gICAgICBpZiAodHlwZSA9PSBcImRhdGV0aW1lLWxvY2FsXCIpIHtcbiAgICAgICAgcmV0dXJuIHN0cmZ0aW1lKFwiJVktJW0tJWRUJUg6JU06JVNcIiwgdmFsdWUpXG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gXCJkYXRlXCIpIHtcbiAgICAgICAgcmV0dXJuIHN0cmZ0aW1lKFwiJVktJW0tJWRcIiwgdmFsdWUpXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlXG4gIH1cblxuICBpbnB1dERlZmF1bHRWYWx1ZUxvY2FsaXplZCAoKSB7XG4gICAgY29uc3Qge3R9ID0gdGhpcy50dFxuICAgIGNvbnN0IHtkZWZhdWx0VmFsdWV9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IHtsb2NhbGl6ZWROdW1iZXJ9ID0gZGlncyh0aGlzLnByb3BzLCBcImxvY2FsaXplZE51bWJlclwiKVxuXG4gICAgaWYgKGxvY2FsaXplZE51bWJlciAmJiBkZWZhdWx0VmFsdWUgIT09IG51bGwgJiYgZGVmYXVsdFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHNlcGFyYXRvciA9IHQoXCJudW1iZXIuY3VycmVuY3kuZm9ybWF0LnNlcGFyYXRvclwiKVxuICAgICAgY29uc3QgZGVsaW1pdGVyID0gdChcIm51bWJlci5jdXJyZW5jeS5mb3JtYXQuZGVsaW1pdGVyXCIpXG5cbiAgICAgIGxldCBmb3JtYXR0ZWQgPSBgJHtkZWZhdWx0VmFsdWV9YFxuXG4gICAgICBmb3JtYXR0ZWQgPSByZXBsYWNlYWxsKFwiLlwiLCBcInt7c2VwYXJhdG9yfX1cIiwgZm9ybWF0dGVkKVxuICAgICAgZm9ybWF0dGVkID0gcmVwbGFjZWFsbChcIixcIiwgXCJ7e2RlbGltaXRlcn19XCIsIGZvcm1hdHRlZClcbiAgICAgIGZvcm1hdHRlZCA9IHJlcGxhY2VhbGwoXCJ7e3NlcGFyYXRvcn19XCIsIHNlcGFyYXRvciwgZm9ybWF0dGVkKVxuICAgICAgZm9ybWF0dGVkID0gcmVwbGFjZWFsbChcInt7ZGVsaW1pdGVyfX1cIiwgZGVsaW1pdGVyLCBmb3JtYXR0ZWQpXG5cbiAgICAgIHJldHVybiBmb3JtYXR0ZWRcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmYXVsdFZhbHVlXG4gIH1cblxuICBpbnB1dE5hbWUgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlLmJsYW5rSW5wdXROYW1lKSByZXR1cm4gXCJcIlxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuaW5wdXRQcm9wcy5uYW1lXG4gIH1cblxuICBpbnB1dFJlZmVyZW5jZSA9ICgpID0+IGRpZ2codGhpcywgXCJwcm9wc1wiLCBcImlucHV0UHJvcHNcIiwgXCJyZWZcIilcblxuICBvbk1vZGVsVXBkYXRlZCA9IChhcmdzKSA9PiB7XG4gICAgY29uc3QgaW5wdXRSZWYgPSB0aGlzLmlucHV0UmVmZXJlbmNlKClcblxuICAgIGlmICghaW5wdXRSZWYuY3VycmVudCkge1xuICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGlmIHRoZSBjb21wb25lbnQgaXMgYmVpbmcgdW5tb3VudGVkXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCB7YXR0cmlidXRlfSA9IGRpZ3ModGhpcy5wcm9wcywgXCJhdHRyaWJ1dGVcIilcbiAgICBjb25zdCBuZXdNb2RlbCA9IGRpZ2coYXJncywgXCJtb2RlbFwiKVxuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGRpZ2coaW5wdXRSZWYsIFwiY3VycmVudFwiLCBcInZhbHVlXCIpXG4gICAgY29uc3QgbmV3VmFsdWUgPSBuZXdNb2RlbC5yZWFkQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICBjb25zdCBuZXdGb3JtYXR0ZWRWYWx1ZSA9IHRoaXMuZm9ybWF0VmFsdWUobmV3VmFsdWUpXG5cbiAgICBpZiAoY3VycmVudFZhbHVlICE9IG5ld0Zvcm1hdHRlZFZhbHVlKSB7XG4gICAgICBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gbmV3Rm9ybWF0dGVkVmFsdWVcbiAgICB9XG4gIH1cblxuICBvbklucHV0Q2hhbmdlZCA9IChlKSA9PiB7XG4gICAgY29uc3Qge2Zvcm19ID0gdGhpcy50dFxuICAgIGNvbnN0IHthdHRyaWJ1dGUsIGF1dG9TdWJtaXQsIGlucHV0UHJvcHMsIG1vZGVsLCBvbkNoYW5nZX0gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qge2xvY2FsaXplZE51bWJlcn0gPSBkaWdzKHRoaXMucHJvcHMsIFwibG9jYWxpemVkTnVtYmVyXCIpXG4gICAgY29uc3Qge25hbWV9ID0gaW5wdXRQcm9wc1xuXG4gICAgaWYgKGxvY2FsaXplZE51bWJlcikgdGhpcy5pbnB1dFJlZmVyZW5jZSgpLmN1cnJlbnQudmFsdWUgPSB0aGlzLmFjdHVhbFZhbHVlKGRpZ2coZSwgXCJ0YXJnZXRcIikpXG5cbiAgICBpZiAoYXR0cmlidXRlICYmIGF1dG9TdWJtaXQgJiYgbW9kZWwpIHRoaXMuZGVsYXlBdXRvU3VibWl0KClcbiAgICBpZiAoZGlnZyhpbnB1dFByb3BzLCBcInR5cGVcIikgPT0gXCJmaWxlXCIpIHRoaXMuc2V0U3RhdGUoe2JsYW5rSW5wdXROYW1lOiB0aGlzLmdldEJsYW5rSW5wdXROYW1lKCl9KVxuXG4gICAgaWYgKGZvcm0gJiYgbmFtZSkge1xuICAgICAgZm9ybS5zZXRWYWx1ZShuYW1lLCBlLnRhcmdldC52YWx1ZSlcbiAgICB9XG5cbiAgICBpZiAob25DaGFuZ2UpIG9uQ2hhbmdlKGUpXG4gIH1cblxuICBkZWxheUF1dG9TdWJtaXQgKCkge1xuICAgIGlmICh0aGlzLmRlbGF5QXV0b1N1Ym1pdFRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRlbGF5QXV0b1N1Ym1pdFRpbWVvdXQpXG4gICAgfVxuXG4gICAgdGhpcy5kZWxheUF1dG9TdWJtaXRUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLmF1dG9TdWJtaXQsIDIwMClcbiAgfVxuXG4gIC8vIFRoaXMgZml4ZXMgYW4gaXNzdWUgaW4gRmlyZWZveCBhbmQgQWN0aXZlU3RvcmFnZSwgd2hlcmUgdXBsb2FkcyB3b3VsZCBiZSBhIGJsYW5rIHN0cmluZyBpZiBhIGZpbGUgd2Fzbid0IGNob3NlblxuICBnZXRCbGFua0lucHV0TmFtZSAoKSB7XG4gICAgY29uc3QgdmFsdWUgPSBkaWcodGhpcy5pbnB1dFJlZmVyZW5jZSgpLCBcImN1cnJlbnRcIiwgXCJ2YWx1ZVwiKVxuXG4gICAgaWYgKHRoaXMucHJvcHMuaW5wdXRQcm9wcy50eXBlID09IFwiZmlsZVwiICYmIHZhbHVlID09IFwiXCIpXG4gICAgICByZXR1cm4gdHJ1ZVxuICB9XG59KSlcblxuZXhwb3J0IHtBcGlNYWtlcklucHV0c0lucHV0IGFzIElucHV0fVxuZXhwb3J0IGRlZmF1bHQgaW5wdXRXcmFwcGVyKEFwaU1ha2VySW5wdXRzSW5wdXQpXG4iXX0=