import CableSubscriptionPool from "./cable-subscription-pool.js";
import CableSubscription from "./cable-subscription.js";
import { dig } from "diggerize";
import RunLast from "./run-last.js";
const shared = {};
export default class ApiMakerCableConnectionPool {
    cableSubscriptionPools = [];
    connections = {};
    upcomingSubscriptionData = {};
    upcomingSubscriptions = {};
    static current() {
        if (!shared.apiMakerCableConnectionPool)
            shared.apiMakerCableConnectionPool = new ApiMakerCableConnectionPool();
        return shared.apiMakerCableConnectionPool;
    }
    connectEventToExistingSubscription({ path, subscription, value }) {
        for (const cableSubscriptionPool of this.cableSubscriptionPools) {
            if (!cableSubscriptionPool.isConnected()) {
                continue;
            }
            let existingSubscriptions;
            if (value === true) {
                existingSubscriptions = dig(cableSubscriptionPool.subscriptions, ...path);
            }
            else {
                existingSubscriptions = dig(cableSubscriptionPool.subscriptions, ...path, value);
            }
            if (existingSubscriptions !== undefined) {
                if (!Array.isArray(existingSubscriptions)) {
                    throw new Error(`existingSubscriptions wasn't an array: ${typeof existingSubscriptions} (${dig(existingSubscriptions, "constructor", "name")})`);
                }
                existingSubscriptions.push(subscription);
                cableSubscriptionPool.connectUnsubscriptionForSubscription(subscription);
                return true;
            }
        }
        return false;
    }
    connectModelEvent({ callback, path, value }) {
        const subscription = new CableSubscription();
        subscription.events.addListener("received", callback);
        if (this.connectEventToExistingSubscription({ path, subscription, value })) {
            // Managed to connect to existing connection
            return subscription;
        }
        let currentSubscriptionData = this.upcomingSubscriptionData;
        let currentSubscription = this.upcomingSubscriptions;
        for (let i = 0; i < path.length; i++) {
            const pathPart = path[i];
            if (!(pathPart in currentSubscriptionData)) {
                if (i == path.length - 1) {
                    currentSubscriptionData[pathPart] = [];
                }
                else {
                    currentSubscriptionData[pathPart] = {};
                }
            }
            currentSubscriptionData = currentSubscriptionData[pathPart];
            if (!(pathPart in currentSubscription)) {
                if (value === true && i == path.length - 1) {
                    currentSubscription[pathPart] = [];
                }
                else {
                    currentSubscription[pathPart] = {};
                }
            }
            currentSubscription = currentSubscription[pathPart];
        }
        if (!currentSubscriptionData.includes(value)) {
            currentSubscriptionData.push(value);
        }
        if (value === true) {
            currentSubscription.push(subscription);
        }
        else {
            if (!(value in currentSubscription)) {
                currentSubscription[value] = [];
            }
            currentSubscription[value].push(subscription);
        }
        this.scheduleConnectUpcomingRunLast.queue();
        return subscription;
    }
    connectCreated = (modelName, callback) => this.connectModelEvent({ callback, value: true, path: [modelName, "creates"] });
    connectEvent = (modelName, modelId, eventName, callback) => this.connectModelEvent({ callback, value: modelId, path: [modelName, "events", eventName] });
    connectDestroyed = (modelName, modelId, callback) => this.connectModelEvent({ callback, value: modelId, path: [modelName, "destroys"] });
    connectModelClassEvent = (modelName, eventName, callback) => this.connectModelEvent({ callback, value: eventName, path: [modelName, "model_class_events"] });
    connectUpdate = (modelName, modelId, callback) => this.connectModelEvent({ callback, value: modelId, path: [modelName, "updates"] });
    connectUpcoming = () => {
        const subscriptionData = this.upcomingSubscriptionData;
        const subscriptions = this.upcomingSubscriptions;
        this.upcomingSubscriptionData = {};
        this.upcomingSubscriptions = {};
        const cableSubscriptionPool = new CableSubscriptionPool();
        cableSubscriptionPool.registerSubscriptions(subscriptions);
        cableSubscriptionPool.connect(subscriptionData);
        this.cableSubscriptionPools.push(cableSubscriptionPool);
    };
    scheduleConnectUpcomingRunLast = new RunLast(this.connectUpcoming);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FibGUtY29ubmVjdGlvbi1wb29sLmpzIiwic291cmNlUm9vdCI6Ii9zcmMvIiwic291cmNlcyI6WyJjYWJsZS1jb25uZWN0aW9uLXBvb2wuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxxQkFBcUIsTUFBTSw4QkFBOEIsQ0FBQTtBQUNoRSxPQUFPLGlCQUFpQixNQUFNLHlCQUF5QixDQUFBO0FBQ3ZELE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxXQUFXLENBQUE7QUFDN0IsT0FBTyxPQUFPLE1BQU0sZUFBZSxDQUFBO0FBRW5DLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtBQUVqQixNQUFNLENBQUMsT0FBTyxPQUFPLDJCQUEyQjtJQUM5QyxzQkFBc0IsR0FBRyxFQUFFLENBQUE7SUFDM0IsV0FBVyxHQUFHLEVBQUUsQ0FBQTtJQUNoQix3QkFBd0IsR0FBRyxFQUFFLENBQUE7SUFDN0IscUJBQXFCLEdBQUcsRUFBRSxDQUFBO0lBRTFCLE1BQU0sQ0FBQyxPQUFPO1FBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQywyQkFBMkI7WUFBRSxNQUFNLENBQUMsMkJBQTJCLEdBQUcsSUFBSSwyQkFBMkIsRUFBRSxDQUFBO1FBRS9HLE9BQU8sTUFBTSxDQUFDLDJCQUEyQixDQUFBO0lBQzNDLENBQUM7SUFFRCxrQ0FBa0MsQ0FBRSxFQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFDO1FBQzdELEtBQUssTUFBTSxxQkFBcUIsSUFBSSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQztnQkFDekMsU0FBUTtZQUNWLENBQUM7WUFFRCxJQUFJLHFCQUFxQixDQUFBO1lBRXpCLElBQUksS0FBSyxLQUFLLElBQUksRUFBRSxDQUFDO2dCQUNuQixxQkFBcUIsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsYUFBYSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUE7WUFD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QUFDLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQyxFQUFDLENBQUMsQ0FBQTtJQUMxSixhQUFhLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxFQUFDLENBQUMsQ0FBQTtJQUVsSSxlQUFlLEdBQUcsR0FBRyxFQUFFO1FBQ3JCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFBO1FBQ3RELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQTtRQUVoRCxJQUFJLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFBO1FBQ2xDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUE7UUFFL0IsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLHFCQUFxQixFQUFFLENBQUE7UUFFekQscUJBQXFCLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDMUQscUJBQXFCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUE7UUFFL0MsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0lBQ3pELENBQUMsQ0FBQTtJQUVELDhCQUE4QixHQUFHLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtDQUNuRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDYWJsZVN1YnNjcmlwdGlvblBvb2wgZnJvbSBcIi4vY2FibGUtc3Vic2NyaXB0aW9uLXBvb2wuanNcIlxuaW1wb3J0IENhYmxlU3Vic2NyaXB0aW9uIGZyb20gXCIuL2NhYmxlLXN1YnNjcmlwdGlvbi5qc1wiXG5pbXBvcnQge2RpZ30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgUnVuTGFzdCBmcm9tIFwiLi9ydW4tbGFzdC5qc1wiXG5cbmNvbnN0IHNoYXJlZCA9IHt9XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCB7XG4gIGNhYmxlU3Vic2NyaXB0aW9uUG9vbHMgPSBbXVxuICBjb25uZWN0aW9ucyA9IHt9XG4gIHVwY29taW5nU3Vic2NyaXB0aW9uRGF0YSA9IHt9XG4gIHVwY29taW5nU3Vic2NyaXB0aW9ucyA9IHt9XG5cbiAgc3RhdGljIGN1cnJlbnQgKCkge1xuICAgIGlmICghc2hhcmVkLmFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCkgc2hhcmVkLmFwaU1ha2VyQ2FibGVDb25uZWN0aW9uUG9vbCA9IG5ldyBBcGlNYWtlckNhYmxlQ29ubmVjdGlvblBvb2woKVxuXG4gICAgcmV0dXJuIHNoYXJlZC5hcGlNYWtlckNhYmxlQ29ubmVjdGlvblBvb2xcbiAgfVxuXG4gIGNvbm5lY3RFdmVudFRvRXhpc3RpbmdTdWJzY3JpcHRpb24gKHtwYXRoLCBzdWJzY3JpcHRpb24sIHZhbHVlfSkge1xuICAgIGZvciAoY29uc3QgY2FibGVTdWJzY3JpcHRpb25Qb29sIG9mIHRoaXMuY2FibGVTdWJzY3JpcHRpb25Qb29scykge1xuICAgICAgaWYgKCFjYWJsZVN1YnNjcmlwdGlvblBvb2wuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBsZXQgZXhpc3RpbmdTdWJzY3JpcHRpb25zXG5cbiAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgICAgICBleGlzdGluZ1N1YnNjcmlwdGlvbnMgPSBkaWcoY2FibGVTdWJzY3JpcHRpb25Qb29sLnN1YnNjcmlwdGlvbnMsIC4uLnBhdGgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBleGlzdGluZ1N1YnNjcmlwdGlvbnMgPSBkaWcoY2FibGVTdWJzY3JpcHRpb25Qb29sLnN1YnNjcmlwdGlvbnMsIC4uLnBhdGgsIHZhbHVlKVxuICAgICAgfVxuXG4gICAgICBpZiAoZXhpc3RpbmdTdWJzY3JpcHRpb25zICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGV4aXN0aW5nU3Vic2NyaXB0aW9ucykpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGV4aXN0aW5nU3Vic2NyaXB0aW9ucyB3YXNuJ3QgYW4gYXJyYXk6ICR7dHlwZW9mIGV4aXN0aW5nU3Vic2NyaXB0aW9uc30gKCR7ZGlnKGV4aXN0aW5nU3Vic2NyaXB0aW9ucywgXCJjb25zdHJ1Y3RvclwiLCBcIm5hbWVcIil9KWApXG4gICAgICAgIH1cblxuICAgICAgICBleGlzdGluZ1N1YnNjcmlwdGlvbnMucHVzaChzdWJzY3JpcHRpb24pXG4gICAgICAgIGNhYmxlU3Vic2NyaXB0aW9uUG9vbC5jb25uZWN0VW5zdWJzY3JpcHRpb25Gb3JTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKVxuXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBjb25uZWN0TW9kZWxFdmVudCAoe2NhbGxiYWNrLCBwYXRoLCB2YWx1ZX0pIHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBuZXcgQ2FibGVTdWJzY3JpcHRpb24oKVxuXG4gICAgc3Vic2NyaXB0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihcInJlY2VpdmVkXCIsIGNhbGxiYWNrKVxuXG4gICAgaWYgKHRoaXMuY29ubmVjdEV2ZW50VG9FeGlzdGluZ1N1YnNjcmlwdGlvbih7cGF0aCwgc3Vic2NyaXB0aW9uLCB2YWx1ZX0pKSB7XG4gICAgICAvLyBNYW5hZ2VkIHRvIGNvbm5lY3QgdG8gZXhpc3RpbmcgY29ubmVjdGlvblxuICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvblxuICAgIH1cblxuICAgIGxldCBjdXJyZW50U3Vic2NyaXB0aW9uRGF0YSA9IHRoaXMudXBjb21pbmdTdWJzY3JpcHRpb25EYXRhXG4gICAgbGV0IGN1cnJlbnRTdWJzY3JpcHRpb24gPSB0aGlzLnVwY29taW5nU3Vic2NyaXB0aW9uc1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBwYXRoUGFydCA9IHBhdGhbaV1cblxuICAgICAgaWYgKCEocGF0aFBhcnQgaW4gY3VycmVudFN1YnNjcmlwdGlvbkRhdGEpKSB7XG4gICAgICAgIGlmIChpID09IHBhdGgubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb25EYXRhW3BhdGhQYXJ0XSA9IFtdXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY3VycmVudFN1YnNjcmlwdGlvbkRhdGFbcGF0aFBhcnRdID0ge31cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjdXJyZW50U3Vic2NyaXB0aW9uRGF0YSA9IGN1cnJlbnRTdWJzY3JpcHRpb25EYXRhW3BhdGhQYXJ0XVxuXG4gICAgICBpZiAoIShwYXRoUGFydCBpbiBjdXJyZW50U3Vic2NyaXB0aW9uKSkge1xuICAgICAgICBpZiAodmFsdWUgPT09IHRydWUgJiYgaSA9PSBwYXRoLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBjdXJyZW50U3Vic2NyaXB0aW9uW3BhdGhQYXJ0XSA9IFtdXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY3VycmVudFN1YnNjcmlwdGlvbltwYXRoUGFydF0gPSB7fVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGN1cnJlbnRTdWJzY3JpcHRpb24gPSBjdXJyZW50U3Vic2NyaXB0aW9uW3BhdGhQYXJ0XVxuICAgIH1cblxuICAgIGlmICghY3VycmVudFN1YnNjcmlwdGlvbkRhdGEuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICBjdXJyZW50U3Vic2NyaXB0aW9uRGF0YS5wdXNoKHZhbHVlKVxuICAgIH1cblxuICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgICAgY3VycmVudFN1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbilcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCEodmFsdWUgaW4gY3VycmVudFN1YnNjcmlwdGlvbikpIHtcbiAgICAgICAgY3VycmVudFN1YnNjcmlwdGlvblt2YWx1ZV0gPSBbXVxuICAgICAgfVxuXG4gICAgICBjdXJyZW50U3Vic2NyaXB0aW9uW3ZhbHVlXS5wdXNoKHN1YnNjcmlwdGlvbilcbiAgICB9XG5cbiAgICB0aGlzLnNjaGVkdWxlQ29ubmVjdFVwY29taW5nUnVuTGFzdC5xdWV1ZSgpXG5cbiAgICByZXR1cm4gc3Vic2NyaXB0aW9uXG4gIH1cblxuICBjb25uZWN0Q3JlYXRlZCA9IChtb2RlbE5hbWUsIGNhbGxiYWNrKSA9PiB0aGlzLmNvbm5lY3RNb2RlbEV2ZW50KHtjYWxsYmFjaywgdmFsdWU6IHRydWUsIHBhdGg6IFttb2RlbE5hbWUsIFwiY3JlYXRlc1wiXX0pXG4gIGNvbm5lY3RFdmVudCA9IChtb2RlbE5hbWUsIG1vZGVsSWQsIGV2ZW50TmFtZSwgY2FsbGJhY2spID0+IHRoaXMuY29ubmVjdE1vZGVsRXZlbnQoe2NhbGxiYWNrLCB2YWx1ZTogbW9kZWxJZCwgcGF0aDogW21vZGVsTmFtZSwgXCJldmVudHNcIiwgZXZlbnROYW1lXX0pXG4gIGNvbm5lY3REZXN0cm95ZWQgPSAobW9kZWxOYW1lLCBtb2RlbElkLCBjYWxsYmFjaykgPT4gdGhpcy5jb25uZWN0TW9kZWxFdmVudCh7Y2FsbGJhY2ssIHZhbHVlOiBtb2RlbElkLCBwYXRoOiBbbW9kZWxOYW1lLCBcImRlc3Ryb3lzXCJdfSlcbiAgY29ubmVjdE1vZGVsQ2xhc3NFdmVudCA9IChtb2RlbE5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2spID0+IHRoaXMuY29ubmVjdE1vZGVsRXZlbnQoe2NhbGxiYWNrLCB2YWx1ZTogZXZlbnROYW1lLCBwYXRoOiBbbW9kZWxOYW1lLCBcIm1vZGVsX2NsYXNzX2V2ZW50c1wiXX0pXG4gIGNvbm5lY3RVcGRhdGUgPSAobW9kZWxOYW1lLCBtb2RlbElkLCBjYWxsYmFjaykgPT4gdGhpcy5jb25uZWN0TW9kZWxFdmVudCh7Y2FsbGJhY2ssIHZhbHVlOiBtb2RlbElkLCBwYXRoOiBbbW9kZWxOYW1lLCBcInVwZGF0ZXNcIl19KVxuXG4gIGNvbm5lY3RVcGNvbWluZyA9ICgpID0+IHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb25EYXRhID0gdGhpcy51cGNvbWluZ1N1YnNjcmlwdGlvbkRhdGFcbiAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gdGhpcy51cGNvbWluZ1N1YnNjcmlwdGlvbnNcblxuICAgIHRoaXMudXBjb21pbmdTdWJzY3JpcHRpb25EYXRhID0ge31cbiAgICB0aGlzLnVwY29taW5nU3Vic2NyaXB0aW9ucyA9IHt9XG5cbiAgICBjb25zdCBjYWJsZVN1YnNjcmlwdGlvblBvb2wgPSBuZXcgQ2FibGVTdWJzY3JpcHRpb25Qb29sKClcblxuICAgIGNhYmxlU3Vic2NyaXB0aW9uUG9vbC5yZWdpc3RlclN1YnNjcmlwdGlvbnMoc3Vic2NyaXB0aW9ucylcbiAgICBjYWJsZVN1YnNjcmlwdGlvblBvb2wuY29ubmVjdChzdWJzY3JpcHRpb25EYXRhKVxuXG4gICAgdGhpcy5jYWJsZVN1YnNjcmlwdGlvblBvb2xzLnB1c2goY2FibGVTdWJzY3JpcHRpb25Qb29sKVxuICB9XG5cbiAgc2NoZWR1bGVDb25uZWN0VXBjb21pbmdSdW5MYXN0ID0gbmV3IFJ1bkxhc3QodGhpcy5jb25uZWN0VXBjb21pbmcpXG59XG4iXX0=