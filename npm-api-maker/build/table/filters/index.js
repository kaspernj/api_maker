import BaseComponent from "../../base-component.js";
import { digg, digs } from "diggerize";
import Filter from "./filter.js";
import FilterForm from "./filter-form.js";
import { FlashNotifications } from "flash-notifications";
import LoadSearchModal from "./load-search-modal.js";
import SaveSearchModal from "./save-search-modal.js";
import Params from "../../params.js";
import PropTypes from "prop-types";
import { TableSearch } from "models.js";
import memo from "set-state-compare/build/memo.js";
import { shapeComponent } from "set-state-compare/build/shape-component.js";
import React from "react";
import useI18n from "i18n-on-steroids/src/use-i18n.mjs";
import useQueryParams from "on-location-changed/build/use-query-params.js";
import { View } from "react-native";
export default memo(shapeComponent(class ApiMakerTableFilters extends BaseComponent {
    static propTypes = {
        currentUser: PropTypes.object,
        modelClass: PropTypes.func.isRequired,
        queryName: PropTypes.string.isRequired,
        querySName: PropTypes.string.isRequired
    };
    setup() {
        const { t } = useI18n({ namespace: "js.api_maker.table.filters" });
        this.queryParams = useQueryParams();
        this.t = t;
        this.useStates({
            filter: undefined,
            showLoadSearchModal: undefined,
            showSaveSearchModal: false
        });
    }
    render() {
        const { modelClass, querySName } = digs(this.props, "modelClass", "querySName");
        const { currentUser } = this.props;
        const { filter, showLoadSearchModal, showSaveSearchModal } = digs(this.state, "filter", "showLoadSearchModal", "showSaveSearchModal");
        const currentFilters = this.currentFilters();
        return (<View dataSet={this.cache("rootViewDataSet", { class: "api-maker--table--filters" })} style={this.cache("rootViewStyle", { alignItems: "flex-start" })}>
        {filter &&
                <FilterForm filter={filter} key={`filter-${filter.filterIndex}`} modelClass={modelClass} onApplyClicked={this.tt.onApplyClicked} onRequestClose={this.tt.onFilterFormRequestClose} querySearchName={querySName}/>}
        {showLoadSearchModal &&
                <LoadSearchModal currentUser={currentUser} modelClass={modelClass} onEditSearchPressed={digg(this, "onEditSearchPressed")} onRequestClose={digg(this, "onRequestCloseLoadSearchModal")} querySearchName={querySName}/>}
        {showSaveSearchModal &&
                <SaveSearchModal currentFilters={digg(this, "currentFilters")} currentUser={currentUser} onRequestClose={digg(this, "onRequestCloseSaveSearchModal")} search={showSaveSearchModal}/>}
        {currentFilters?.map((filterData, filterIndex) => <Filter key={filterIndex} filterIndex={filterIndex} onClick={this.tt.onFilterClicked} onRemoveClicked={this.tt.onRemoveClicked} {...filterData}/>)}
        <View dataSet={this.cache("filterActionsDataSet", { class: "filter-actions" })} style={this.cache("filterActionsStyle", { flexDirection: "row", marginTop: 10 })}>
          <button className="add-new-filter-button" onClick={this.tt.onAddFilterClicked}>
            {this.t(".add_new_filter", { defaultValue: "Add new filter" })}
          </button>
          {currentUser &&
                <>
              <button className="save-search-button" onClick={this.tt.onSaveSearchClicked} style={{ marginLeft: 10 }}>
                {this.t(".save_search", { defaultValue: "Save search" })}
              </button>
              <button className="load-search-button" onClick={this.tt.onLoadSearchClicked} style={{ marginLeft: 10 }}>
                {this.t(".load_search", { defaultValue: "Load search" })}
              </button>
            </>}
        </View>
      </View>);
    }
    currentFilters = () => {
        const { querySName } = digs(this.props, "querySName");
        const currentFilters = this.queryParams[querySName] || [];
        return currentFilters.map((currentFilter) => JSON.parse(currentFilter));
    };
    onAddFilterClicked = (e) => {
        e.preventDefault();
        const newFilterIndex = this.currentFilters().length;
        this.setState({
            filter: {
                filterIndex: newFilterIndex
            }
        });
    };
    onApplyClicked = () => this.setState({ filter: undefined });
    onEditSearchPressed = ({ search }) => {
        this.onRequestCloseLoadSearchModal();
        this.setState({
            showSaveSearchModal: search
        });
    };
    onFilterClicked = (filter) => this.setState({ filter });
    onFilterFormRequestClose = () => this.setState({ filter: undefined });
    onLoadSearchClicked = (e) => {
        e.preventDefault();
        this.setState({
            showLoadSearchModal: true
        });
    };
    onRemoveClicked = ({ filterIndex }) => {
        const { querySName } = digs(this.props, "querySName");
        const searchParams = Params.parse()[querySName] || {};
        delete searchParams[filterIndex];
        const newParams = {};
        newParams[querySName] = searchParams;
        Params.changeParams(newParams);
        this.setState({
            filter: undefined
        });
    };
    onRequestCloseLoadSearchModal = () => this.setState({ showLoadSearchModal: false });
    onRequestCloseSaveSearchModal = () => this.setState({ showSaveSearchModal: undefined });
    onSaveSearchClicked = (e) => {
        e.preventDefault();
        if (this.hasAnyFilters()) {
            this.setState({ showSaveSearchModal: new TableSearch() });
        }
        else {
            FlashNotifications.alert(this.t(".no_filters_has_been_set", { defaultValue: "No filters has been set" }));
        }
    };
    hasAnyFilters = () => Object.keys(this.currentFilters()).length > 0;
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInRhYmxlL2ZpbHRlcnMvaW5kZXguanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sYUFBYSxNQUFNLHlCQUF5QixDQUFBO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQ3BDLE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQTtBQUNoQyxPQUFPLFVBQVUsTUFBTSxrQkFBa0IsQ0FBQTtBQUN6QyxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQTtBQUN0RCxPQUFPLGVBQWUsTUFBTSx3QkFBd0IsQ0FBQTtBQUNwRCxPQUFPLGVBQWUsTUFBTSx3QkFBd0IsQ0FBQTtBQUNwRCxPQUFPLE1BQU0sTUFBTSxpQkFBaUIsQ0FBQTtBQUNwQyxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUE7QUFDbEMsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUNyQyxPQUFPLElBQUksTUFBTSxpQ0FBaUMsQ0FBQTtBQUNsRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sNENBQTRDLENBQUE7QUFDekUsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sT0FBTyxNQUFNLG1DQUFtQyxDQUFBO0FBQ3ZELE9BQU8sY0FBYyxNQUFNLCtDQUErQyxDQUFBO0FBQzFFLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUE7QUFFakMsZUFBZSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sb0JBQXFCLFNBQVEsYUFBYTtJQUNqRixNQUFNLENBQUMsU0FBUyxHQUFHO1FBQ2pCLFdBQVcsRUFBRSxTQUFTLENBQUMsTUFBTTtRQUM3QixVQUFVLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVO1FBQ3JDLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7UUFDdEMsVUFBVSxFQUFFLFNB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QUMsUUFBUSxDQUFDLEVBQUMsbUJBQW1CLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQTtJQUVyRixtQkFBbUIsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQzFCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUVsQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLFdBQVcsRUFBRSxFQUFDLENBQUMsQ0FBQTtRQUN6RCxDQUFDO2FBQU0sQ0FBQztZQUNOLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLDBCQUEwQixFQUFFLEVBQUMsWUFBWSxFQUFFLHlCQUF5QixFQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3pHLENBQUM7SUFDSCxDQUFDLENBQUE7SUFFRCxhQUFhLEdBQUcsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO0NBQ3BFLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJhc2VDb21wb25lbnQgZnJvbSBcIi4uLy4uL2Jhc2UtY29tcG9uZW50LmpzXCJcbmltcG9ydCB7ZGlnZywgZGlnc30gZnJvbSBcImRpZ2dlcml6ZVwiXG5pbXBvcnQgRmlsdGVyIGZyb20gXCIuL2ZpbHRlci5qc1wiXG5pbXBvcnQgRmlsdGVyRm9ybSBmcm9tIFwiLi9maWx0ZXItZm9ybS5qc1wiXG5pbXBvcnQge0ZsYXNoTm90aWZpY2F0aW9uc30gZnJvbSBcImZsYXNoLW5vdGlmaWNhdGlvbnNcIlxuaW1wb3J0IExvYWRTZWFyY2hNb2RhbCBmcm9tIFwiLi9sb2FkLXNlYXJjaC1tb2RhbC5qc1wiXG5pbXBvcnQgU2F2ZVNlYXJjaE1vZGFsIGZyb20gXCIuL3NhdmUtc2VhcmNoLW1vZGFsLmpzXCJcbmltcG9ydCBQYXJhbXMgZnJvbSBcIi4uLy4uL3BhcmFtcy5qc1wiXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCJcbmltcG9ydCB7VGFibGVTZWFyY2h9IGZyb20gXCJtb2RlbHMuanNcIlxuaW1wb3J0IG1lbW8gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL21lbW8uanNcIlxuaW1wb3J0IHtzaGFwZUNvbXBvbmVudH0gZnJvbSBcInNldC1zdGF0ZS1jb21wYXJlL2J1aWxkL3NoYXBlLWNvbXBvbmVudC5qc1wiXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCJcbmltcG9ydCB1c2VJMThuIGZyb20gXCJpMThuLW9uLXN0ZXJvaWRzL3NyYy91c2UtaTE4bi5tanNcIlxuaW1wb3J0IHVzZVF1ZXJ5UGFyYW1zIGZyb20gXCJvbi1sb2NhdGlvbi1jaGFuZ2VkL2J1aWxkL3VzZS1xdWVyeS1wYXJhbXMuanNcIlxuaW1wb3J0IHtWaWV3fSBmcm9tIFwicmVhY3QtbmF0aXZlXCJcblxuZXhwb3J0IGRlZmF1bHQgbWVtbyhzaGFwZUNvbXBvbmVudChjbGFzcyBBcGlNYWtlclRhYmxlRmlsdGVycyBleHRlbmRzIEJhc2VDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIGN1cnJlbnRVc2VyOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIG1vZGVsQ2xhc3M6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgcXVlcnlOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgcXVlcnlTTmFtZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkXG4gIH1cblxuICBzZXR1cCgpIHtcbiAgICBjb25zdCB7dH0gPSB1c2VJMThuKHtuYW1lc3BhY2U6IFwianMuYXBpX21ha2VyLnRhYmxlLmZpbHRlcnNcIn0pXG5cbiAgICB0aGlzLnF1ZXJ5UGFyYW1zID0gdXNlUXVlcnlQYXJhbXMoKVxuICAgIHRoaXMudCA9IHRcbiAgICB0aGlzLnVzZVN0YXRlcyh7XG4gICAgICBmaWx0ZXI6IHVuZGVmaW5lZCxcbiAgICAgIHNob3dMb2FkU2VhcmNoTW9kYWw6IHVuZGVmaW5lZCxcbiAgICAgIHNob3dTYXZlU2VhcmNoTW9kYWw6IGZhbHNlXG4gICAgfSlcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7bW9kZWxDbGFzcywgcXVlcnlTTmFtZX0gPSBkaWdzKHRoaXMucHJvcHMsIFwibW9kZWxDbGFzc1wiLCBcInF1ZXJ5U05hbWVcIilcbiAgICBjb25zdCB7Y3VycmVudFVzZXJ9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IHtmaWx0ZXIsIHNob3dMb2FkU2VhcmNoTW9kYWwsIHNob3dTYXZlU2VhcmNoTW9kYWx9ID0gZGlncyh0aGlzLnN0YXRlLCBcImZpbHRlclwiLCBcInNob3dMb2FkU2VhcmNoTW9kYWxcIiwgXCJzaG93U2F2ZVNlYXJjaE1vZGFsXCIpXG4gICAgY29uc3QgY3VycmVudEZpbHRlcnMgPSB0aGlzLmN1cnJlbnRGaWx0ZXJzKClcblxuICAgIHJldHVybiAoXG4gICAgICA8VmlldyBkYXRhU2V0PXt0aGlzLmNhY2hlKFwicm9vdFZpZXdEYXRhU2V0XCIsIHtjbGFzczogXCJhcGktbWFrZXItLXRhYmxlLS1maWx0ZXJzXCJ9KX0gc3R5bGU9e3RoaXMuY2FjaGUoXCJyb290Vmlld1N0eWxlXCIsIHthbGlnbkl0ZW1zOiBcImZsZXgtc3RhcnRcIn0pfT5cbiAgICAgICAge2ZpbHRlciAmJlxuICAgICAgICAgIDxGaWx0ZXJGb3JtXG4gICAgICAgICAgICBmaWx0ZXI9e2ZpbHRlcn1cbiAgICAgICAgICAgIGtleT17YGZpbHRlci0ke2ZpbHRlci5maWx0ZXJJbmRleH1gfVxuICAgICAgICAgICAgbW9kZWxDbGFzcz17bW9kZWxDbGFzc31cbiAgICAgICAgICAgIG9uQXBwbHlDbGlja2VkPXt0aGlzLnR0Lm9uQXBwbHlDbGlja2VkfVxuICAgICAgICAgICAgb25SZXF1ZXN0Q2xvc2U9e3RoaXMudHQub25GaWx0ZXJGb3JtUmVxdWVzdENsb3NlfVxuICAgICAgICAgICAgcXVlcnlTZWFyY2hOYW1lPXtxdWVyeVNOYW1lfVxuICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgICAge3Nob3dMb2FkU2VhcmNoTW9kYWwgJiZcbiAgICAgICAgICA8TG9hZFNlYXJjaE1vZGFsXG4gICAgICAgICAgICBjdXJyZW50VXNlcj17Y3VycmVudFVzZXJ9XG4gICAgICAgICAgICBtb2RlbENsYXNzPXttb2RlbENsYXNzfVxuICAgICAgICAgICAgb25FZGl0U2VhcmNoUHJlc3NlZD17ZGlnZyh0aGlzLCBcIm9uRWRpdFNlYXJjaFByZXNzZWRcIil9XG4gICAgICAgICAgICBvblJlcXVlc3RDbG9zZT17ZGlnZyh0aGlzLCBcIm9uUmVxdWVzdENsb3NlTG9hZFNlYXJjaE1vZGFsXCIpfVxuICAgICAgICAgICAgcXVlcnlTZWFyY2hOYW1lPXtxdWVyeVNOYW1lfVxuICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgICAge3Nob3dTYXZlU2VhcmNoTW9kYWwgJiZcbiAgICAgICAgICA8U2F2ZVNlYXJjaE1vZGFsXG4gICAgICAgICAgICBjdXJyZW50RmlsdGVycz17ZGlnZyh0aGlzLCBcImN1cnJlbnRGaWx0ZXJzXCIpfVxuICAgICAgICAgICAgY3VycmVudFVzZXI9e2N1cnJlbnRVc2VyfVxuICAgICAgICAgICAgb25SZXF1ZXN0Q2xvc2U9e2RpZ2codGhpcywgXCJvblJlcXVlc3RDbG9zZVNhdmVTZWFyY2hNb2RhbFwiKX1cbiAgICAgICAgICAgIHNlYXJjaD17c2hvd1NhdmVTZWFyY2hNb2RhbH1cbiAgICAgICAgICAvPlxuICAgICAgICB9XG4gICAgICAgIHtjdXJyZW50RmlsdGVycz8ubWFwKChmaWx0ZXJEYXRhLCBmaWx0ZXJJbmRleCkgPT5cbiAgICAgICAgICA8RmlsdGVyXG4gICAgICAgICAgICBrZXk9e2ZpbHRlckluZGV4fVxuICAgICAgICAgICAgZmlsdGVySW5kZXg9e2ZpbHRlckluZGV4fVxuICAgICAgICAgICAgb25DbGljaz17dGhpcy50dC5vbkZpbHRlckNsaWNrZWR9XG4gICAgICAgICAgICBvblJlbW92ZUNsaWNrZWQ9e3RoaXMudHQub25SZW1vdmVDbGlja2VkfVxuICAgICAgICAgICAgey4uLmZpbHRlckRhdGF9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAgPFZpZXcgZGF0YVNldD17dGhpcy5jYWNoZShcImZpbHRlckFjdGlvbnNEYXRhU2V0XCIsIHtjbGFzczogXCJmaWx0ZXItYWN0aW9uc1wifSl9IHN0eWxlPXt0aGlzLmNhY2hlKFwiZmlsdGVyQWN0aW9uc1N0eWxlXCIsIHtmbGV4RGlyZWN0aW9uOiBcInJvd1wiLCBtYXJnaW5Ub3A6IDEwfSl9PlxuICAgICAgICAgIDxidXR0b24gY2xhc3NOYW1lPVwiYWRkLW5ldy1maWx0ZXItYnV0dG9uXCIgb25DbGljaz17dGhpcy50dC5vbkFkZEZpbHRlckNsaWNrZWR9PlxuICAgICAgICAgICAge3RoaXMudChcIi5hZGRfbmV3X2ZpbHRlclwiLCB7ZGVmYXVsdFZhbHVlOiBcIkFkZCBuZXcgZmlsdGVyXCJ9KX1cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICB7Y3VycmVudFVzZXIgJiZcbiAgICAgICAgICAgIDw+XG4gICAgICAgICAgICAgIDxidXR0b24gY2xhc3NOYW1lPVwic2F2ZS1zZWFyY2gtYnV0dG9uXCIgb25DbGljaz17dGhpcy50dC5vblNhdmVTZWFyY2hDbGlja2VkfSBzdHlsZT17e21hcmdpbkxlZnQ6IDEwfX0+XG4gICAgICAgICAgICAgICAge3RoaXMudChcIi5zYXZlX3NlYXJjaFwiLCB7ZGVmYXVsdFZhbHVlOiBcIlNhdmUgc2VhcmNoXCJ9KX1cbiAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgIDxidXR0b24gY2xhc3NOYW1lPVwibG9hZC1zZWFyY2gtYnV0dG9uXCIgb25DbGljaz17dGhpcy50dC5vbkxvYWRTZWFyY2hDbGlja2VkfSBzdHlsZT17e21hcmdpbkxlZnQ6IDEwfX0+XG4gICAgICAgICAgICAgICAge3RoaXMudChcIi5sb2FkX3NlYXJjaFwiLCB7ZGVmYXVsdFZhbHVlOiBcIkxvYWQgc2VhcmNoXCJ9KX1cbiAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICA8Lz5cbiAgICAgICAgICB9XG4gICAgICAgIDwvVmlldz5cbiAgICAgIDwvVmlldz5cbiAgICApXG4gIH1cblxuICBjdXJyZW50RmlsdGVycyA9ICgpID0+IHtcbiAgICBjb25zdCB7cXVlcnlTTmFtZX0gPSBkaWdzKHRoaXMucHJvcHMsIFwicXVlcnlTTmFtZVwiKVxuICAgIGNvbnN0IGN1cnJlbnRGaWx0ZXJzID0gdGhpcy5xdWVyeVBhcmFtc1txdWVyeVNOYW1lXSB8fCBbXVxuXG4gICAgcmV0dXJuIGN1cnJlbnRGaWx0ZXJzLm1hcCgoY3VycmVudEZpbHRlcikgPT4gSlNPTi5wYXJzZShjdXJyZW50RmlsdGVyKSlcbiAgfVxuXG4gIG9uQWRkRmlsdGVyQ2xpY2tlZCA9IChlKSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpXG5cbiAgICBjb25zdCBuZXdGaWx0ZXJJbmRleCA9IHRoaXMuY3VycmVudEZpbHRlcnMoKS5sZW5ndGhcblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgZmlsdGVyOiB7XG4gICAgICAgIGZpbHRlckluZGV4OiBuZXdGaWx0ZXJJbmRleFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBvbkFwcGx5Q2xpY2tlZCA9ICgpID0+IHRoaXMuc2V0U3RhdGUoe2ZpbHRlcjogdW5kZWZpbmVkfSlcblxuICBvbkVkaXRTZWFyY2hQcmVzc2VkID0gKHtzZWFyY2h9KSA9PiB7XG4gICAgdGhpcy5vblJlcXVlc3RDbG9zZUxvYWRTZWFyY2hNb2RhbCgpXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBzaG93U2F2ZVNlYXJjaE1vZGFsOiBzZWFyY2hcbiAgICB9KVxuICB9XG5cbiAgb25GaWx0ZXJDbGlja2VkID0gKGZpbHRlcikgPT4gdGhpcy5zZXRTdGF0ZSh7ZmlsdGVyfSlcbiAgb25GaWx0ZXJGb3JtUmVxdWVzdENsb3NlID0gKCkgPT4gdGhpcy5zZXRTdGF0ZSh7ZmlsdGVyOiB1bmRlZmluZWR9KVxuXG4gIG9uTG9hZFNlYXJjaENsaWNrZWQgPSAoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKVxuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBzaG93TG9hZFNlYXJjaE1vZGFsOiB0cnVlXG4gICAgfSlcbiAgfVxuXG4gIG9uUmVtb3ZlQ2xpY2tlZCA9ICh7ZmlsdGVySW5kZXh9KSA9PiB7XG4gICAgY29uc3Qge3F1ZXJ5U05hbWV9ID0gZGlncyh0aGlzLnByb3BzLCBcInF1ZXJ5U05hbWVcIilcbiAgICBjb25zdCBzZWFyY2hQYXJhbXMgPSBQYXJhbXMucGFyc2UoKVtxdWVyeVNOYW1lXSB8fCB7fVxuXG4gICAgZGVsZXRlIHNlYXJjaFBhcmFtc1tmaWx0ZXJJbmRleF1cblxuICAgIGNvbnN0IG5ld1BhcmFtcyA9IHt9XG5cbiAgICBuZXdQYXJhbXNbcXVlcnlTTmFtZV0gPSBzZWFyY2hQYXJhbXNcblxuICAgIFBhcmFtcy5jaGFuZ2VQYXJhbXMobmV3UGFyYW1zKVxuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBmaWx0ZXI6IHVuZGVmaW5lZFxuICAgIH0pXG4gIH1cblxuICBvblJlcXVlc3RDbG9zZUxvYWRTZWFyY2hNb2RhbCA9ICgpID0+IHRoaXMuc2V0U3RhdGUoe3Nob3dMb2FkU2VhcmNoTW9kYWw6IGZhbHNlfSlcbiAgb25SZXF1ZXN0Q2xvc2VTYXZlU2VhcmNoTW9kYWwgPSAoKSA9PiB0aGlzLnNldFN0YXRlKHtzaG93U2F2ZVNlYXJjaE1vZGFsOiB1bmRlZmluZWR9KVxuXG4gIG9uU2F2ZVNlYXJjaENsaWNrZWQgPSAoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKVxuXG4gICAgaWYgKHRoaXMuaGFzQW55RmlsdGVycygpKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtzaG93U2F2ZVNlYXJjaE1vZGFsOiBuZXcgVGFibGVTZWFyY2goKX0pXG4gICAgfSBlbHNlIHtcbiAgICAgIEZsYXNoTm90aWZpY2F0aW9ucy5hbGVydCh0aGlzLnQoXCIubm9fZmlsdGVyc19oYXNfYmVlbl9zZXRcIiwge2RlZmF1bHRWYWx1ZTogXCJObyBmaWx0ZXJzIGhhcyBiZWVuIHNldFwifSkpXG4gICAgfVxuICB9XG5cbiAgaGFzQW55RmlsdGVycyA9ICgpID0+IE9iamVjdC5rZXlzKHRoaXMuY3VycmVudEZpbHRlcnMoKSkubGVuZ3RoID4gMFxufSkpXG4iXX0=