import { digs } from "diggerize";
import * as inflection from "inflection";
import modelCallbackArgs from "./model-callback-args.js";
import MoneyFormatter from "../money-formatter.js";
import React from "react";
import Text from "../utils/text.js";
export default class ApiMakerTableColumnContent {
    constructor({ column, l, mode = "react-native", model, t, table }) {
        this.column = column;
        this.l = l;
        this.mode = mode;
        this.model = model;
        this.t = t;
        this.table = table;
    }
    columnContentFromContentArg() {
        const args = modelCallbackArgs(this.table, this.model);
        args.mode = this.mode;
        const value = this.column.content(args);
        return this.presentColumnValue(value);
    }
    columnsContentFromAttributeAndPath() {
        const { attribute: attributeName } = digs(this.column, "attribute");
        const attributeNameUnderscore = inflection.underscore(attributeName);
        const path = this.column.path || [];
        let value;
        let currentModel = this.model;
        if (path.length > 0) {
            for (const pathPart of path) {
                currentModel = currentModel[pathPart]();
                if (!currentModel)
                    return;
            }
        }
        if (!(attributeName in currentModel)) {
            throw new Error(`${currentModel.constructor.modelName().human()} doesn't respond to ${attributeName}`);
        }
        if (currentModel.isAttributeLoaded(attributeName)) {
            value = currentModel[attributeName]();
        }
        const attribute = currentModel.constructor.attributes().find((attribute) => attribute.name() == attributeNameUnderscore);
        const modelColumn = attribute?.getColumn();
        if (modelColumn?.getType() == "date" && value) {
            const contentText = this.presentDateTime({ apiMakerType: "date", value });
            if (this.mode == "html") {
                return contentText;
            }
            else {
                return (<Text>{contentText}</Text>);
            }
        }
        return this.presentColumnValue(value);
    }
    content() {
        if (this.column.content) {
            return this.columnContentFromContentArg();
        }
        else if (!this.column.content && this.column.attribute) {
            return this.columnsContentFromAttributeAndPath();
        }
    }
    presentColumnValue = (value) => {
        let contentText;
        if (value instanceof Date) {
            contentText = this.presentDateTime({ value });
        }
        else if (MoneyFormatter.isMoney(value)) {
            contentText = MoneyFormatter.format(value);
        }
        else if (typeof value == "boolean") {
            if (value) {
                contentText = this.t("js.shared.yes", { defaultValue: "Yes" });
            }
            else {
                contentText = this.t("js.shared.no", { defaultValue: "No" });
            }
        }
        else if (Array.isArray(value)) {
            contentText = value
                .map((valuePart) => this.presentColumnValue(valuePart))
                .filter((valuePart) => Boolean(valuePart))
                .join(", ");
        }
        else if (typeof value == "string") {
            contentText = value;
        }
        else {
            // Its a React node - just return it and trust the provider to be HTML compatible.
            return value;
        }
        if (this.mode == "html") {
            return contentText;
        }
        return <Text>{contentText}</Text>;
    };
    presentDateTime = ({ apiMakerType, value }) => {
        if (!apiMakerType || apiMakerType == "time") {
            const dateTimeFormatName = this.table.props.defaultDateTimeFormatName || "time.formats.default";
            return this.l(dateTimeFormatName, value);
        }
        else if (apiMakerType == "date") {
            const dateFormatName = this.table.props.defaultDateFormatName || "date.formats.default";
            return this.l(dateFormatName, value);
        }
        else {
            throw new Error(`Unhandled type: ${apiMakerType}`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWNvbnRlbnQuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInRhYmxlL2NvbHVtbi1jb250ZW50LmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQzlCLE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8saUJBQWlCLE1BQU0sMEJBQTBCLENBQUE7QUFDeEQsT0FBTyxjQUFjLE1BQU0sdUJBQXVCLENBQUE7QUFDbEQsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sSUFBSSxNQUFNLGtCQUFrQixDQUFBO0FBRW5DLE1BQU0sQ0FBQyxPQUFPLE9BQU8sMEJBQTBCO0lBQzdDLFlBQVksRUFBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLElBQUksR0FBRyxjQUFjLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUM7UUFDN0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7UUFDcEIsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDVixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNoQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUNsQixJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNWLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO0lBQ3BCLENBQUM7SUFFRCwyQkFBMkI7UUFDekIsTUFBTSxJQUFJLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFdEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1FBRXJCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRXZDLE9BQU8sSUFBSSxDQUFDLGtC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QVksRUFBRSxLQUFLLEVBQUMsRUFBRSxFQUFFO1FBQzFDLElBQUksQ0FBQyxZQUFZLElBQUksWUFBWSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQzVDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMseUJBQXlCLElBQUksc0JBQXNCLENBQUE7WUFFL0YsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQzFDLENBQUM7YUFBTSxJQUFJLFlBQVksSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNsQyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsSUFBSSxzQkFBc0IsQ0FBQTtZQUV2RixPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ3RDLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUNwRCxDQUFDO0lBQ0gsQ0FBQyxDQUFBO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2RpZ3N9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0ICogYXMgaW5mbGVjdGlvbiBmcm9tIFwiaW5mbGVjdGlvblwiXG5pbXBvcnQgbW9kZWxDYWxsYmFja0FyZ3MgZnJvbSBcIi4vbW9kZWwtY2FsbGJhY2stYXJncy5qc1wiXG5pbXBvcnQgTW9uZXlGb3JtYXR0ZXIgZnJvbSBcIi4uL21vbmV5LWZvcm1hdHRlci5qc1wiXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCJcbmltcG9ydCBUZXh0IGZyb20gXCIuLi91dGlscy90ZXh0LmpzXCJcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXBpTWFrZXJUYWJsZUNvbHVtbkNvbnRlbnQge1xuICBjb25zdHJ1Y3Rvcih7Y29sdW1uLCBsLCBtb2RlID0gXCJyZWFjdC1uYXRpdmVcIiwgbW9kZWwsIHQsIHRhYmxlfSkge1xuICAgIHRoaXMuY29sdW1uID0gY29sdW1uXG4gICAgdGhpcy5sID0gbFxuICAgIHRoaXMubW9kZSA9IG1vZGVcbiAgICB0aGlzLm1vZGVsID0gbW9kZWxcbiAgICB0aGlzLnQgPSB0XG4gICAgdGhpcy50YWJsZSA9IHRhYmxlXG4gIH1cblxuICBjb2x1bW5Db250ZW50RnJvbUNvbnRlbnRBcmcoKSB7XG4gICAgY29uc3QgYXJncyA9IG1vZGVsQ2FsbGJhY2tBcmdzKHRoaXMudGFibGUsIHRoaXMubW9kZWwpXG5cbiAgICBhcmdzLm1vZGUgPSB0aGlzLm1vZGVcblxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jb2x1bW4uY29udGVudChhcmdzKVxuXG4gICAgcmV0dXJuIHRoaXMucHJlc2VudENvbHVtblZhbHVlKHZhbHVlKVxuICB9XG5cbiAgY29sdW1uc0NvbnRlbnRGcm9tQXR0cmlidXRlQW5kUGF0aCgpIHtcbiAgICBjb25zdCB7YXR0cmlidXRlOiBhdHRyaWJ1dGVOYW1lfSA9IGRpZ3ModGhpcy5jb2x1bW4sIFwiYXR0cmlidXRlXCIpXG4gICAgY29uc3QgYXR0cmlidXRlTmFtZVVuZGVyc2NvcmUgPSBpbmZsZWN0aW9uLnVuZGVyc2NvcmUoYXR0cmlidXRlTmFtZSlcbiAgICBjb25zdCBwYXRoID0gdGhpcy5jb2x1bW4ucGF0aCB8fCBbXVxuICAgIGxldCB2YWx1ZVxuICAgIGxldCBjdXJyZW50TW9kZWwgPSB0aGlzLm1vZGVsXG5cbiAgICBpZiAocGF0aC5sZW5ndGggPiAwKSB7XG4gICAgICBmb3IgKGNvbnN0IHBhdGhQYXJ0IG9mIHBhdGgpIHtcbiAgICAgICAgY3VycmVudE1vZGVsID0gY3VycmVudE1vZGVsW3BhdGhQYXJ0XSgpXG4gICAgICAgIGlmICghY3VycmVudE1vZGVsKSByZXR1cm5cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIShhdHRyaWJ1dGVOYW1lIGluIGN1cnJlbnRNb2RlbCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtjdXJyZW50TW9kZWwuY29uc3RydWN0b3IubW9kZWxOYW1lKCkuaHVtYW4oKX0gZG9lc24ndCByZXNwb25kIHRvICR7YXR0cmlidXRlTmFtZX1gKVxuICAgIH1cblxuICAgIGlmIChjdXJyZW50TW9kZWwuaXNBdHRyaWJ1dGVMb2FkZWQoYXR0cmlidXRlTmFtZSkpIHtcbiAgICAgIHZhbHVlID0gY3VycmVudE1vZGVsW2F0dHJpYnV0ZU5hbWVdKClcbiAgICB9XG5cbiAgICBjb25zdCBhdHRyaWJ1dGUgPSBjdXJyZW50TW9kZWwuY29uc3RydWN0b3IuYXR0cmlidXRlcygpLmZpbmQoKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLm5hbWUoKSA9PSBhdHRyaWJ1dGVOYW1lVW5kZXJzY29yZSlcbiAgICBjb25zdCBtb2RlbENvbHVtbiA9IGF0dHJpYnV0ZT8uZ2V0Q29sdW1uKClcblxuICAgIGlmIChtb2RlbENvbHVtbj8uZ2V0VHlwZSgpID09IFwiZGF0ZVwiICYmIHZhbHVlKSB7XG4gICAgICBjb25zdCBjb250ZW50VGV4dCA9IHRoaXMucHJlc2VudERhdGVUaW1lKHthcGlNYWtlclR5cGU6IFwiZGF0ZVwiLCB2YWx1ZX0pXG5cbiAgICAgIGlmICh0aGlzLm1vZGUgPT0gXCJodG1sXCIpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnRUZXh0XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIDxUZXh0Pntjb250ZW50VGV4dH08L1RleHQ+XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmVzZW50Q29sdW1uVmFsdWUodmFsdWUpXG4gIH1cblxuICBjb250ZW50KCkge1xuICAgIGlmICh0aGlzLmNvbHVtbi5jb250ZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5jb2x1bW5Db250ZW50RnJvbUNvbnRlbnRBcmcoKVxuICAgIH0gZWxzZSBpZiAoIXRoaXMuY29sdW1uLmNvbnRlbnQgJiYgdGhpcy5jb2x1bW4uYXR0cmlidXRlKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb2x1bW5zQ29udGVudEZyb21BdHRyaWJ1dGVBbmRQYXRoKClcbiAgICB9XG4gIH1cblxuICBwcmVzZW50Q29sdW1uVmFsdWUgPSAodmFsdWUpID0+IHtcbiAgICBsZXQgY29udGVudFRleHRcblxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgIGNvbnRlbnRUZXh0ID0gdGhpcy5wcmVzZW50RGF0ZVRpbWUoe3ZhbHVlfSlcbiAgICB9IGVsc2UgaWYgKE1vbmV5Rm9ybWF0dGVyLmlzTW9uZXkodmFsdWUpKSB7XG4gICAgICBjb250ZW50VGV4dCA9IE1vbmV5Rm9ybWF0dGVyLmZvcm1hdCh2YWx1ZSlcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcImJvb2xlYW5cIikge1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIGNvbnRlbnRUZXh0ID0gdGhpcy50KFwianMuc2hhcmVkLnllc1wiLCB7ZGVmYXVsdFZhbHVlOiBcIlllc1wifSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnRlbnRUZXh0ID0gdGhpcy50KFwianMuc2hhcmVkLm5vXCIsIHtkZWZhdWx0VmFsdWU6IFwiTm9cIn0pXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgY29udGVudFRleHQgPSB2YWx1ZVxuICAgICAgICAubWFwKCh2YWx1ZVBhcnQpID0+IHRoaXMucHJlc2VudENvbHVtblZhbHVlKHZhbHVlUGFydCkpXG4gICAgICAgIC5maWx0ZXIoKHZhbHVlUGFydCkgPT4gQm9vbGVhbih2YWx1ZVBhcnQpKVxuICAgICAgICAuam9pbihcIiwgXCIpXG5cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb250ZW50VGV4dCA9IHZhbHVlXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEl0cyBhIFJlYWN0IG5vZGUgLSBqdXN0IHJldHVybiBpdCBhbmQgdHJ1c3QgdGhlIHByb3ZpZGVyIHRvIGJlIEhUTUwgY29tcGF0aWJsZS5cbiAgICAgIHJldHVybiB2YWx1ZVxuICAgIH1cblxuICAgIGlmICh0aGlzLm1vZGUgPT0gXCJodG1sXCIpIHtcbiAgICAgIHJldHVybiBjb250ZW50VGV4dFxuICAgIH1cblxuICAgIHJldHVybiA8VGV4dD57Y29udGVudFRleHR9PC9UZXh0PlxuICB9XG5cbiAgcHJlc2VudERhdGVUaW1lID0gKHthcGlNYWtlclR5cGUsIHZhbHVlfSkgPT4ge1xuICAgIGlmICghYXBpTWFrZXJUeXBlIHx8IGFwaU1ha2VyVHlwZSA9PSBcInRpbWVcIikge1xuICAgICAgY29uc3QgZGF0ZVRpbWVGb3JtYXROYW1lID0gdGhpcy50YWJsZS5wcm9wcy5kZWZhdWx0RGF0ZVRpbWVGb3JtYXROYW1lIHx8IFwidGltZS5mb3JtYXRzLmRlZmF1bHRcIlxuXG4gICAgICByZXR1cm4gdGhpcy5sKGRhdGVUaW1lRm9ybWF0TmFtZSwgdmFsdWUpXG4gICAgfSBlbHNlIGlmIChhcGlNYWtlclR5cGUgPT0gXCJkYXRlXCIpIHtcbiAgICAgIGNvbnN0IGRhdGVGb3JtYXROYW1lID0gdGhpcy50YWJsZS5wcm9wcy5kZWZhdWx0RGF0ZUZvcm1hdE5hbWUgfHwgXCJkYXRlLmZvcm1hdHMuZGVmYXVsdFwiXG5cbiAgICAgIHJldHVybiB0aGlzLmwoZGF0ZUZvcm1hdE5hbWUsIHZhbHVlKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuaGFuZGxlZCB0eXBlOiAke2FwaU1ha2VyVHlwZX1gKVxuICAgIH1cbiAgfVxufVxuIl19