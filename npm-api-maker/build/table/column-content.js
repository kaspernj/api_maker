import { jsx as _jsx } from "react/jsx-runtime";
import { digs } from "diggerize";
import * as inflection from "inflection";
import modelCallbackArgs from "./model-callback-args.js";
import MoneyFormatter from "../money-formatter.js";
import React from "react";
import Text from "../utils/text";
export default class ApiMakerTableColumnContent {
    constructor({ column, l, mode = "react-native", model, t, table }) {
        this.column = column;
        this.l = l;
        this.mode = mode;
        this.model = model;
        this.t = t;
        this.table = table;
    }
    columnContentFromContentArg() {
        const args = modelCallbackArgs(this.table, this.model);
        args.mode = this.mode;
        const value = this.column.content(args);
        return this.presentColumnValue(value);
    }
    columnsContentFromAttributeAndPath() {
        const { attribute: attributeName } = digs(this.column, "attribute");
        const attributeNameUnderscore = inflection.underscore(attributeName);
        const path = this.column.path || [];
        let value;
        let currentModel = this.model;
        if (path.length > 0) {
            for (const pathPart of path) {
                currentModel = currentModel[pathPart]();
                if (!currentModel)
                    return;
            }
        }
        if (!(attributeName in currentModel)) {
            throw new Error(`${currentModel.constructor.modelName().human()} doesn't respond to ${attributeName}`);
        }
        if (currentModel.isAttributeLoaded(attributeName)) {
            value = currentModel[attributeName]();
        }
        const attribute = currentModel.constructor.attributes().find((attribute) => attribute.name() == attributeNameUnderscore);
        const modelColumn = attribute?.getColumn();
        if (modelColumn?.getType() == "date" && value) {
            const contentText = this.presentDateTime({ apiMakerType: "date", value });
            if (this.mode == "html") {
                return contentText;
            }
            else {
                return (_jsx(Text, { children: contentText }));
            }
        }
        return this.presentColumnValue(value);
    }
    content() {
        if (this.column.content) {
            return this.columnContentFromContentArg();
        }
        else if (!this.column.content && this.column.attribute) {
            return this.columnsContentFromAttributeAndPath();
        }
    }
    presentColumnValue = (value) => {
        let contentText;
        if (value instanceof Date) {
            contentText = this.presentDateTime({ value });
        }
        else if (MoneyFormatter.isMoney(value)) {
            contentText = MoneyFormatter.format(value);
        }
        else if (typeof value == "boolean") {
            if (value) {
                contentText = this.t("js.shared.yes", { defaultValue: "Yes" });
            }
            else {
                contentText = this.t("js.shared.no", { defaultValue: "No" });
            }
        }
        else if (Array.isArray(value)) {
            contentText = value
                .map((valuePart) => this.presentColumnValue(valuePart))
                .filter((valuePart) => Boolean(valuePart))
                .join(", ");
        }
        else if (typeof value == "string") {
            contentText = value;
        }
        else {
            // Its a React node - just return it and trust the provider to be HTML compatible.
            return value;
        }
        if (this.mode == "html") {
            return contentText;
        }
        return _jsx(Text, { children: contentText });
    };
    presentDateTime = ({ apiMakerType, value }) => {
        if (!apiMakerType || apiMakerType == "time") {
            const dateTimeFormatName = this.table.props.defaultDateTimeFormatName || "time.formats.default";
            return this.l(dateTimeFormatName, value);
        }
        else if (apiMakerType == "date") {
            const dateFormatName = this.table.props.defaultDateFormatName || "date.formats.default";
            return this.l(dateFormatName, value);
        }
        else {
            throw new Error(`Unhandled type: ${apiMakerType}`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWNvbnRlbnQuanMiLCJzb3VyY2VSb290IjoiL3NyYy8iLCJzb3VyY2VzIjpbInRhYmxlL2NvbHVtbi1jb250ZW50LmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUM5QixPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUN4QyxPQUFPLGlCQUFpQixNQUFNLDBCQUEwQixDQUFBO0FBQ3hELE9BQU8sY0FBYyxNQUFNLHVCQUF1QixDQUFBO0FBQ2xELE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLElBQUksTUFBTSxlQUFlLENBQUE7QUFFaEMsTUFBTSxDQUFDLE9BQU8sT0FBTywwQkFBMEI7SUFDN0MsWUFBWSxFQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsSUFBSSxHQUFHLGNBQWMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBQztRQUM3RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtRQUNwQixJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNWLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ2xCLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ1YsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7SUFDcEIsQ0FBQztJQUVELDJCQUEyQjtRQUN6QixNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUV0RCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7UUFFckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFdkMsT0FBTyxJQUFJLENBQUMsa0JB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QUMsWUFBWSxJQUFJLFlBQVksSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUM1QyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLHlCQUF5QixJQUFJLHNCQUFzQixDQUFBO1lBRS9GLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUMxQyxDQUFDO2FBQU0sSUFBSSxZQUFZLElBQUksTUFBTSxFQUFFLENBQUM7WUFDbEMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMscUJBQXFCLElBQUksc0JBQXNCLENBQUE7WUFFdkYsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN0QyxDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLFlBQVksRUFBRSxDQUFDLENBQUE7UUFDcEQsQ0FBQztJQUNILENBQUMsQ0FBQTtDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtkaWdzfSBmcm9tIFwiZGlnZ2VyaXplXCJcbmltcG9ydCAqIGFzIGluZmxlY3Rpb24gZnJvbSBcImluZmxlY3Rpb25cIlxuaW1wb3J0IG1vZGVsQ2FsbGJhY2tBcmdzIGZyb20gXCIuL21vZGVsLWNhbGxiYWNrLWFyZ3MuanNcIlxuaW1wb3J0IE1vbmV5Rm9ybWF0dGVyIGZyb20gXCIuLi9tb25leS1mb3JtYXR0ZXIuanNcIlxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiXG5pbXBvcnQgVGV4dCBmcm9tIFwiLi4vdXRpbHMvdGV4dFwiXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwaU1ha2VyVGFibGVDb2x1bW5Db250ZW50IHtcbiAgY29uc3RydWN0b3Ioe2NvbHVtbiwgbCwgbW9kZSA9IFwicmVhY3QtbmF0aXZlXCIsIG1vZGVsLCB0LCB0YWJsZX0pIHtcbiAgICB0aGlzLmNvbHVtbiA9IGNvbHVtblxuICAgIHRoaXMubCA9IGxcbiAgICB0aGlzLm1vZGUgPSBtb2RlXG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsXG4gICAgdGhpcy50ID0gdFxuICAgIHRoaXMudGFibGUgPSB0YWJsZVxuICB9XG5cbiAgY29sdW1uQ29udGVudEZyb21Db250ZW50QXJnKCkge1xuICAgIGNvbnN0IGFyZ3MgPSBtb2RlbENhbGxiYWNrQXJncyh0aGlzLnRhYmxlLCB0aGlzLm1vZGVsKVxuXG4gICAgYXJncy5tb2RlID0gdGhpcy5tb2RlXG5cbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuY29sdW1uLmNvbnRlbnQoYXJncylcblxuICAgIHJldHVybiB0aGlzLnByZXNlbnRDb2x1bW5WYWx1ZSh2YWx1ZSlcbiAgfVxuXG4gIGNvbHVtbnNDb250ZW50RnJvbUF0dHJpYnV0ZUFuZFBhdGgoKSB7XG4gICAgY29uc3Qge2F0dHJpYnV0ZTogYXR0cmlidXRlTmFtZX0gPSBkaWdzKHRoaXMuY29sdW1uLCBcImF0dHJpYnV0ZVwiKVxuICAgIGNvbnN0IGF0dHJpYnV0ZU5hbWVVbmRlcnNjb3JlID0gaW5mbGVjdGlvbi51bmRlcnNjb3JlKGF0dHJpYnV0ZU5hbWUpXG4gICAgY29uc3QgcGF0aCA9IHRoaXMuY29sdW1uLnBhdGggfHwgW11cbiAgICBsZXQgdmFsdWVcbiAgICBsZXQgY3VycmVudE1vZGVsID0gdGhpcy5tb2RlbFxuXG4gICAgaWYgKHBhdGgubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChjb25zdCBwYXRoUGFydCBvZiBwYXRoKSB7XG4gICAgICAgIGN1cnJlbnRNb2RlbCA9IGN1cnJlbnRNb2RlbFtwYXRoUGFydF0oKVxuICAgICAgICBpZiAoIWN1cnJlbnRNb2RlbCkgcmV0dXJuXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCEoYXR0cmlidXRlTmFtZSBpbiBjdXJyZW50TW9kZWwpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7Y3VycmVudE1vZGVsLmNvbnN0cnVjdG9yLm1vZGVsTmFtZSgpLmh1bWFuKCl9IGRvZXNuJ3QgcmVzcG9uZCB0byAke2F0dHJpYnV0ZU5hbWV9YClcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudE1vZGVsLmlzQXR0cmlidXRlTG9hZGVkKGF0dHJpYnV0ZU5hbWUpKSB7XG4gICAgICB2YWx1ZSA9IGN1cnJlbnRNb2RlbFthdHRyaWJ1dGVOYW1lXSgpXG4gICAgfVxuXG4gICAgY29uc3QgYXR0cmlidXRlID0gY3VycmVudE1vZGVsLmNvbnN0cnVjdG9yLmF0dHJpYnV0ZXMoKS5maW5kKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5uYW1lKCkgPT0gYXR0cmlidXRlTmFtZVVuZGVyc2NvcmUpXG4gICAgY29uc3QgbW9kZWxDb2x1bW4gPSBhdHRyaWJ1dGU/LmdldENvbHVtbigpXG5cbiAgICBpZiAobW9kZWxDb2x1bW4/LmdldFR5cGUoKSA9PSBcImRhdGVcIiAmJiB2YWx1ZSkge1xuICAgICAgY29uc3QgY29udGVudFRleHQgPSB0aGlzLnByZXNlbnREYXRlVGltZSh7YXBpTWFrZXJUeXBlOiBcImRhdGVcIiwgdmFsdWV9KVxuXG4gICAgICBpZiAodGhpcy5tb2RlID09IFwiaHRtbFwiKSB7XG4gICAgICAgIHJldHVybiBjb250ZW50VGV4dFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8VGV4dD57Y29udGVudFRleHR9PC9UZXh0PlxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJlc2VudENvbHVtblZhbHVlKHZhbHVlKVxuICB9XG5cbiAgY29udGVudCgpIHtcbiAgICBpZiAodGhpcy5jb2x1bW4uY29udGVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29sdW1uQ29udGVudEZyb21Db250ZW50QXJnKClcbiAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbHVtbi5jb250ZW50ICYmIHRoaXMuY29sdW1uLmF0dHJpYnV0ZSkge1xuICAgICAgcmV0dXJuIHRoaXMuY29sdW1uc0NvbnRlbnRGcm9tQXR0cmlidXRlQW5kUGF0aCgpXG4gICAgfVxuICB9XG5cbiAgcHJlc2VudENvbHVtblZhbHVlID0gKHZhbHVlKSA9PiB7XG4gICAgbGV0IGNvbnRlbnRUZXh0XG5cbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICBjb250ZW50VGV4dCA9IHRoaXMucHJlc2VudERhdGVUaW1lKHt2YWx1ZX0pXG4gICAgfSBlbHNlIGlmIChNb25leUZvcm1hdHRlci5pc01vbmV5KHZhbHVlKSkge1xuICAgICAgY29udGVudFRleHQgPSBNb25leUZvcm1hdHRlci5mb3JtYXQodmFsdWUpXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gXCJib29sZWFuXCIpIHtcbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICBjb250ZW50VGV4dCA9IHRoaXMudChcImpzLnNoYXJlZC55ZXNcIiwge2RlZmF1bHRWYWx1ZTogXCJZZXNcIn0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb250ZW50VGV4dCA9IHRoaXMudChcImpzLnNoYXJlZC5ub1wiLCB7ZGVmYXVsdFZhbHVlOiBcIk5vXCJ9KVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIGNvbnRlbnRUZXh0ID0gdmFsdWVcbiAgICAgICAgLm1hcCgodmFsdWVQYXJ0KSA9PiB0aGlzLnByZXNlbnRDb2x1bW5WYWx1ZSh2YWx1ZVBhcnQpKVxuICAgICAgICAuZmlsdGVyKCh2YWx1ZVBhcnQpID0+IEJvb2xlYW4odmFsdWVQYXJ0KSlcbiAgICAgICAgLmpvaW4oXCIsIFwiKVxuXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gXCJzdHJpbmdcIikge1xuICAgICAgY29udGVudFRleHQgPSB2YWx1ZVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJdHMgYSBSZWFjdCBub2RlIC0ganVzdCByZXR1cm4gaXQgYW5kIHRydXN0IHRoZSBwcm92aWRlciB0byBiZSBIVE1MIGNvbXBhdGlibGUuXG4gICAgICByZXR1cm4gdmFsdWVcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tb2RlID09IFwiaHRtbFwiKSB7XG4gICAgICByZXR1cm4gY29udGVudFRleHRcbiAgICB9XG5cbiAgICByZXR1cm4gPFRleHQ+e2NvbnRlbnRUZXh0fTwvVGV4dD5cbiAgfVxuXG4gIHByZXNlbnREYXRlVGltZSA9ICh7YXBpTWFrZXJUeXBlLCB2YWx1ZX0pID0+IHtcbiAgICBpZiAoIWFwaU1ha2VyVHlwZSB8fCBhcGlNYWtlclR5cGUgPT0gXCJ0aW1lXCIpIHtcbiAgICAgIGNvbnN0IGRhdGVUaW1lRm9ybWF0TmFtZSA9IHRoaXMudGFibGUucHJvcHMuZGVmYXVsdERhdGVUaW1lRm9ybWF0TmFtZSB8fCBcInRpbWUuZm9ybWF0cy5kZWZhdWx0XCJcblxuICAgICAgcmV0dXJuIHRoaXMubChkYXRlVGltZUZvcm1hdE5hbWUsIHZhbHVlKVxuICAgIH0gZWxzZSBpZiAoYXBpTWFrZXJUeXBlID09IFwiZGF0ZVwiKSB7XG4gICAgICBjb25zdCBkYXRlRm9ybWF0TmFtZSA9IHRoaXMudGFibGUucHJvcHMuZGVmYXVsdERhdGVGb3JtYXROYW1lIHx8IFwiZGF0ZS5mb3JtYXRzLmRlZmF1bHRcIlxuXG4gICAgICByZXR1cm4gdGhpcy5sKGRhdGVGb3JtYXROYW1lLCB2YWx1ZSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmhhbmRsZWQgdHlwZTogJHthcGlNYWtlclR5cGV9YClcbiAgICB9XG4gIH1cbn1cbiJdfQ==