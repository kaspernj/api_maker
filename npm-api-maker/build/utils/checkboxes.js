import { shapeComponent, ShapeComponent } from "set-state-compare/build/shape-component.js";
import React, { useMemo } from "react";
import Checkbox from "./checkbox.js";
import { digs } from "diggerize";
import { useForm } from "../form.js";
import * as inflection from "inflection";
import InvalidFeedback from "./invalid-feedback.js";
import memo from "set-state-compare/build/memo.js";
import PropTypes from "prop-types";
import propTypesExact from "prop-types-exact";
import Text from "./text.js";
import useInput from "../use-input.js";
import { View } from "react-native";
const OptionElement = memo(shapeComponent(class OptionElement extends ShapeComponent {
    static propTypes = propTypesExact({
        checked: PropTypes.bool.isRequired,
        inputName: PropTypes.string.isRequired,
        onChange: PropTypes.func.isRequired,
        option: PropTypes.array.isRequired
    });
    render() {
        const { checked, inputName, option } = this.p;
        const dataSet = useMemo(() => ({
            component: "api-maker/utils/checkboxes/option",
            name: inputName,
            value: option[1]
        }), [inputName, option[1]]);
        return (<View>
        <Checkbox checked={checked} dataSet={dataSet} label={option[0]} onCheckedChange={this.tt.onChange}/>
      </View>);
    }
    onChange = (checked) => this.p.onChange({ checked, option: this.p.option });
}));
export default memo(shapeComponent(class ApiMakerUtilsCheckboxes extends ShapeComponent {
    static propTypes = propTypesExact({
        attribute: PropTypes.string,
        defaultValue: PropTypes.array,
        label: PropTypes.string,
        labelClassName: PropTypes.string,
        model: PropTypes.object,
        name: PropTypes.string,
        onChange: PropTypes.func,
        options: PropTypes.array.isRequired
    });
    setup() {
        const { inputProps, wrapperOpts } = useInput({ props: this.props });
        this.generatedId = useMemo(() => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15), []);
        this.setInstance({
            form: useForm(),
            inputProps,
            wrapperOpts
        });
        this.useStates({
            checkedOptions: () => {
                if (Array.isArray(this.props.defaultValue))
                    return this.props.defaultValue;
                if (this.props.defaultValue)
                    return [this.props.defaultValue];
                return [];
            }
        });
        useMemo(() => {
            if (this.form && inputProps.name) {
                this.form.setValue(inputProps.name, this.s.checkedOptions);
            }
        }, []);
    }
    render() {
        const { wrapperOpts } = this.tt;
        const { errors } = digs(wrapperOpts, "errors");
        return (<View dataSet={this.cache("rootViewDataSet", { component: "api-maker/utils/checkboxes" })}>
        <Text style={this.cache("textStyle", { fontWeight: "bold" })}>
          {this.tt.wrapperOpts.label}
        </Text>
        {this.props.options.map((option) => <OptionElement checked={this.isChecked(option)} inputName={this.inputName()} key={option[1]} onChange={this.tt.onOptionChecked} option={option}/>)}
        {errors.length > 0 &&
                <InvalidFeedback errors={errors}/>}
      </View>);
    }
    inputDefaultValue() {
        const { attribute, defaultValue, model } = this.props;
        if (defaultValue) {
            return defaultValue;
        }
        else if (attribute && model) {
            if (!model[attribute])
                throw `No such attribute: ${attribute}`;
            return this.props.model[attribute]();
        }
    }
    inputName() {
        if (this.props.name) {
            return `${this.props.name}[]`;
        }
        else if (this.props.model) {
            return `${this.props.model.modelClassData().paramKey}[${inflection.underscore(this.props.attribute)}]`;
        }
    }
    isChecked = (option) => this.s.checkedOptions.includes(option[1]);
    onOptionChecked = ({ checked, option }) => {
        const { inputProps, form } = this.tt;
        const { name } = inputProps;
        let newOptions;
        if (checked) {
            newOptions = this.s.checkedOptions.concat([option[1]]);
            this.setState({ checkedOptions: newOptions });
        }
        else {
            newOptions = this.s.checkedOptions.filter((value) => value != option[1]);
            this.setState({ checkedOptions: newOptions });
        }
        if (this.props.onChange) {
            this.p.onChange({ checked, option });
        }
        if (form && name) {
            form.setValue(name, newOptions);
        }
    };
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tib3hlcy5qcyIsInNvdXJjZVJvb3QiOiIvc3JjLyIsInNvdXJjZXMiOlsidXRpbHMvY2hlY2tib3hlcy5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGNBQWMsRUFBRSxjQUFjLEVBQUMsTUFBTSw0Q0FBNEMsQ0FBQTtBQUN6RixPQUFPLEtBQUssRUFBRSxFQUFDLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQTtBQUNwQyxPQUFPLFFBQVEsTUFBTSxlQUFlLENBQUE7QUFDcEMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLFdBQVcsQ0FBQTtBQUM5QixPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sS0FBSyxVQUFVLE1BQU0sWUFBWSxDQUFBO0FBQ3hDLE9BQU8sZUFBZSxNQUFNLHVCQUF1QixDQUFBO0FBQ25ELE9BQU8sSUFBSSxNQUFNLGlDQUFpQyxDQUFBO0FBQ2xELE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLGNBQWMsTUFBTSxrQkFBa0IsQ0FBQTtBQUM3QyxPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFDNUIsT0FBTyxRQUFRLE1BQU0saUJBQWlCLENBQUE7QUFDdEMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQTtBQUVqQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sYUFBYyxTQUFRLGNBQWM7SUFDbEYsTUFBTSxDQUFDLFNBQVMsR0FBRyxjQUFjLENBQUM7UUFDaEMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVTtRQUNsQyxTQUFTLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO1FBQ3RDLFFBQVEsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVU7UUFDbkMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsVUFBVTtLQUNuQyxDQUFDLENBQUE7SUFFRixNQUFNO1FBQ0osTUFBTSxF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XCJzZXQtc3RhdGUtY29tcGFyZS9idWlsZC9zaGFwZS1jb21wb25lbnQuanNcIlxuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSBcInJlYWN0XCJcbmltcG9ydCBDaGVja2JveCBmcm9tIFwiLi9jaGVja2JveC5qc1wiXG5pbXBvcnQge2RpZ3N9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IHt1c2VGb3JtfSBmcm9tIFwiLi4vZm9ybS5qc1wiXG5pbXBvcnQgKiBhcyBpbmZsZWN0aW9uIGZyb20gXCJpbmZsZWN0aW9uXCJcbmltcG9ydCBJbnZhbGlkRmVlZGJhY2sgZnJvbSBcIi4vaW52YWxpZC1mZWVkYmFjay5qc1wiXG5pbXBvcnQgbWVtbyBmcm9tIFwic2V0LXN0YXRlLWNvbXBhcmUvYnVpbGQvbWVtby5qc1wiXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCJcbmltcG9ydCBwcm9wVHlwZXNFeGFjdCBmcm9tIFwicHJvcC10eXBlcy1leGFjdFwiXG5pbXBvcnQgVGV4dCBmcm9tIFwiLi90ZXh0LmpzXCJcbmltcG9ydCB1c2VJbnB1dCBmcm9tIFwiLi4vdXNlLWlucHV0LmpzXCJcbmltcG9ydCB7Vmlld30gZnJvbSBcInJlYWN0LW5hdGl2ZVwiXG5cbmNvbnN0IE9wdGlvbkVsZW1lbnQgPSBtZW1vKHNoYXBlQ29tcG9uZW50KGNsYXNzIE9wdGlvbkVsZW1lbnQgZXh0ZW5kcyBTaGFwZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSBwcm9wVHlwZXNFeGFjdCh7XG4gICAgY2hlY2tlZDogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcbiAgICBpbnB1dE5hbWU6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICBvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICBvcHRpb246IFByb3BUeXBlcy5hcnJheS5pc1JlcXVpcmVkXG4gIH0pXG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtjaGVja2VkLCBpbnB1dE5hbWUsIG9wdGlvbn0gPSB0aGlzLnBcbiAgICBjb25zdCBkYXRhU2V0ID0gdXNlTWVtbygoKSA9PiAoe1xuICAgICAgY29tcG9uZW50OiBcImFwaS1tYWtlci91dGlscy9jaGVja2JveGVzL29wdGlvblwiLFxuICAgICAgbmFtZTogaW5wdXROYW1lLFxuICAgICAgdmFsdWU6IG9wdGlvblsxXVxuICAgIH0pLCBbaW5wdXROYW1lLCBvcHRpb25bMV1dKVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3ID5cbiAgICAgICAgPENoZWNrYm94XG4gICAgICAgICAgY2hlY2tlZD17Y2hlY2tlZH1cbiAgICAgICAgICBkYXRhU2V0PXtkYXRhU2V0fVxuICAgICAgICAgIGxhYmVsPXtvcHRpb25bMF19XG4gICAgICAgICAgb25DaGVja2VkQ2hhbmdlPXt0aGlzLnR0Lm9uQ2hhbmdlfVxuICAgICAgICAvPlxuICAgICAgPC9WaWV3PlxuICAgIClcbiAgfVxuXG4gIG9uQ2hhbmdlID0gKGNoZWNrZWQpID0+IHRoaXMucC5vbkNoYW5nZSh7Y2hlY2tlZCwgb3B0aW9uOiB0aGlzLnAub3B0aW9ufSlcbn0pKVxuXG5leHBvcnQgZGVmYXVsdCBtZW1vKHNoYXBlQ29tcG9uZW50KGNsYXNzIEFwaU1ha2VyVXRpbHNDaGVja2JveGVzIGV4dGVuZHMgU2hhcGVDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0gcHJvcFR5cGVzRXhhY3Qoe1xuICAgIGF0dHJpYnV0ZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBkZWZhdWx0VmFsdWU6IFByb3BUeXBlcy5hcnJheSxcbiAgICBsYWJlbDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBsYWJlbENsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBtb2RlbDogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBuYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIG9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvcHRpb25zOiBQcm9wVHlwZXMuYXJyYXkuaXNSZXF1aXJlZFxuICB9KVxuXG4gIHNldHVwKCkge1xuICAgIGNvbnN0IHtpbnB1dFByb3BzLCB3cmFwcGVyT3B0c30gPSB1c2VJbnB1dCh7cHJvcHM6IHRoaXMucHJvcHN9KVxuXG4gICAgdGhpcy5nZW5lcmF0ZWRJZCA9IHVzZU1lbW8oXG4gICAgICAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgMTUpICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDE1KSxcbiAgICAgIFtdXG4gICAgKVxuXG4gICAgdGhpcy5zZXRJbnN0YW5jZSh7XG4gICAgICBmb3JtOiB1c2VGb3JtKCksXG4gICAgICBpbnB1dFByb3BzLFxuICAgICAgd3JhcHBlck9wdHNcbiAgICB9KVxuICAgIHRoaXMudXNlU3RhdGVzKHtcbiAgICAgIGNoZWNrZWRPcHRpb25zOiAoKSA9PiB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMucHJvcHMuZGVmYXVsdFZhbHVlKSkgcmV0dXJuIHRoaXMucHJvcHMuZGVmYXVsdFZhbHVlXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRlZmF1bHRWYWx1ZSkgcmV0dXJuIFt0aGlzLnByb3BzLmRlZmF1bHRWYWx1ZV1cblxuICAgICAgICByZXR1cm4gW11cbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdXNlTWVtbygoKSA9PiB7XG4gICAgICBpZiAodGhpcy5mb3JtICYmIGlucHV0UHJvcHMubmFtZSkge1xuICAgICAgICB0aGlzLmZvcm0uc2V0VmFsdWUoaW5wdXRQcm9wcy5uYW1lLCB0aGlzLnMuY2hlY2tlZE9wdGlvbnMpXG4gICAgICB9XG4gICAgfSwgW10pXG4gIH1cblxuICByZW5kZXIgKCkge1xuICAgIGNvbnN0IHt3cmFwcGVyT3B0c30gPSB0aGlzLnR0XG4gICAgY29uc3Qge2Vycm9yc30gPSBkaWdzKHdyYXBwZXJPcHRzLCBcImVycm9yc1wiKVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3IGRhdGFTZXQ9e3RoaXMuY2FjaGUoXCJyb290Vmlld0RhdGFTZXRcIiwge2NvbXBvbmVudDogXCJhcGktbWFrZXIvdXRpbHMvY2hlY2tib3hlc1wifSl9PlxuICAgICAgICA8VGV4dCBzdHlsZT17dGhpcy5jYWNoZShcInRleHRTdHlsZVwiLCB7Zm9udFdlaWdodDogXCJib2xkXCJ9KX0+XG4gICAgICAgICAge3RoaXMudHQud3JhcHBlck9wdHMubGFiZWx9XG4gICAgICAgIDwvVGV4dD5cbiAgICAgICAge3RoaXMucHJvcHMub3B0aW9ucy5tYXAoKG9wdGlvbikgPT5cbiAgICAgICAgICA8T3B0aW9uRWxlbWVudFxuICAgICAgICAgICAgY2hlY2tlZD17dGhpcy5pc0NoZWNrZWQob3B0aW9uKX1cbiAgICAgICAgICAgIGlucHV0TmFtZT17dGhpcy5pbnB1dE5hbWUoKX1cbiAgICAgICAgICAgIGtleT17b3B0aW9uWzFdfVxuICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMudHQub25PcHRpb25DaGVja2VkfVxuICAgICAgICAgICAgb3B0aW9uPXtvcHRpb259XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2Vycm9ycy5sZW5ndGggPiAwICYmXG4gICAgICAgICAgPEludmFsaWRGZWVkYmFjayBlcnJvcnM9e2Vycm9yc30gLz5cbiAgICAgICAgfVxuICAgICAgPC9WaWV3PlxuICAgIClcbiAgfVxuXG4gIGlucHV0RGVmYXVsdFZhbHVlICgpIHtcbiAgICBjb25zdCB7YXR0cmlidXRlLCBkZWZhdWx0VmFsdWUsIG1vZGVsfSA9IHRoaXMucHJvcHNcblxuICAgIGlmIChkZWZhdWx0VmFsdWUpIHtcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWVcbiAgICB9IGVsc2UgaWYgKGF0dHJpYnV0ZSAmJiBtb2RlbCkge1xuICAgICAgaWYgKCFtb2RlbFthdHRyaWJ1dGVdKSB0aHJvdyBgTm8gc3VjaCBhdHRyaWJ1dGU6ICR7YXR0cmlidXRlfWBcblxuICAgICAgcmV0dXJuIHRoaXMucHJvcHMubW9kZWxbYXR0cmlidXRlXSgpXG4gICAgfVxuICB9XG5cbiAgaW5wdXROYW1lICgpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5uYW1lKSB7XG4gICAgICByZXR1cm4gYCR7dGhpcy5wcm9wcy5uYW1lfVtdYFxuICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy5tb2RlbCkge1xuICAgICAgcmV0dXJuIGAke3RoaXMucHJvcHMubW9kZWwubW9kZWxDbGFzc0RhdGEoKS5wYXJhbUtleX1bJHtpbmZsZWN0aW9uLnVuZGVyc2NvcmUodGhpcy5wcm9wcy5hdHRyaWJ1dGUpfV1gXG4gICAgfVxuICB9XG5cbiAgaXNDaGVja2VkID0gKG9wdGlvbikgPT4gdGhpcy5zLmNoZWNrZWRPcHRpb25zLmluY2x1ZGVzKG9wdGlvblsxXSlcblxuICBvbk9wdGlvbkNoZWNrZWQgPSAoe2NoZWNrZWQsIG9wdGlvbn0pID0+IHtcbiAgICBjb25zdCB7aW5wdXRQcm9wcywgZm9ybX0gPSB0aGlzLnR0XG4gICAgY29uc3Qge25hbWV9ID0gaW5wdXRQcm9wc1xuICAgIGxldCBuZXdPcHRpb25zXG5cbiAgICBpZiAoY2hlY2tlZCkge1xuICAgICAgbmV3T3B0aW9ucyA9IHRoaXMucy5jaGVja2VkT3B0aW9ucy5jb25jYXQoW29wdGlvblsxXV0pXG5cbiAgICAgIHRoaXMuc2V0U3RhdGUoe2NoZWNrZWRPcHRpb25zOiBuZXdPcHRpb25zfSlcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3T3B0aW9ucyA9IHRoaXMucy5jaGVja2VkT3B0aW9ucy5maWx0ZXIoKHZhbHVlKSA9PiB2YWx1ZSAhPSBvcHRpb25bMV0pXG5cbiAgICAgIHRoaXMuc2V0U3RhdGUoe2NoZWNrZWRPcHRpb25zOiBuZXdPcHRpb25zfSlcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy5vbkNoYW5nZSkge1xuICAgICAgdGhpcy5wLm9uQ2hhbmdlKHtjaGVja2VkLCBvcHRpb259KVxuICAgIH1cblxuICAgIGlmIChmb3JtICYmIG5hbWUpIHtcbiAgICAgIGZvcm0uc2V0VmFsdWUobmFtZSwgbmV3T3B0aW9ucylcbiAgICB9XG4gIH1cbn0pKVxuIl19