import { digg } from "diggerize";
import { EventEmitter } from "eventemitter3";
export default class DraggableSortController {
    constructor({ data, events, keyExtractor }) {
        this.data = data;
        this.currentOrder = [...data];
        this.events = events || new EventEmitter();
        this.keyExtractor = keyExtractor;
        this.draggedItem = null;
        this.draggedItemData = null;
        this.draggedItemNewPosition = null;
        this.draggedOverItem = null;
        this.draggedOverItemData = null;
        this.itemData = {};
        for (const itemIndex in data) {
            this.itemData[itemIndex] = {
                index: itemIndex,
                item: data[itemIndex],
                position: itemIndex
            };
        }
    }
    getEvents = () => this.events;
    getItemDataForItem = (item) => this.getItemDataForIndex(this.data.indexOf(item));
    getItemDataForKey = (key) => this.itemData.find((itemDataI) => digg(itemDataI, "key") == key);
    getItemDataForIndex = (index) => digg(this, "itemData", index);
    onDragStart = ({ item, itemIndex }) => {
        if (item) {
            this.draggedItem = item;
            this.draggedItemData = this.getItemDataForIndex(itemIndex);
            this.draggedItemIndex = itemIndex;
            this.draggedItemPosition = this.draggedItemData.position;
            this.events.emit("onDragStart", { item, itemData: this.draggedItemData });
        }
    };
    onDragEnd = () => {
        const itemData = this.draggedItemData;
        const fromIndex = itemData.index;
        const fromPosition = digg(this, "draggedItemPosition");
        const toPosition = this.draggedItemNewPosition;
        const fromItem = this.draggedItem;
        const toItem = this.draggedOverItem;
        const callbackArgs = { item: itemData.item, itemData, fromIndex, fromItem, fromPosition, toItem, toPosition };
        this.draggedItemData.events.emit("resetPosition", {
            callback: () => {
                this.events.emit("onDragEndAnimation", callbackArgs);
            }
        });
        this.draggedItem = null;
        this.draggedItemData = null;
        this.draggedItemNewPosition = null;
        this.draggedOverItem = null;
        this.draggedOverItemData = null;
        this.events.emit("onDragEnd", callbackArgs);
    };
    onItemLayout = ({ events, index, item, layout }) => {
        if (!(index in this.itemData))
            throw new Error(`Item not found for index ${index}`);
        const itemData = this.itemData[index];
        itemData.layout = layout;
        if (!itemData.initialLayout) {
            itemData.baseX = layout.x;
            itemData.events = events;
            itemData.initialLayout = layout;
            itemData.key = this.keyExtractor(item);
        }
    };
    onMove = ({ gestate }) => {
        // Send move-event to the item being dragged so it will actually move around
        this.draggedItemData?.events?.emit("move", { gestate });
        const moveX = gestate.dx + this.initialDragPosition.x;
        for (const itemIndex in this.itemData) {
            const itemData = this.getItemDataForIndex(itemIndex);
            const baseX = digg(itemData, "baseX");
            let smallestWidth = this.draggedItemData.layout.width;
            if (itemData.layout.width < smallestWidth)
                smallestWidth = itemData.layout.width;
            if (moveX > baseX && moveX < (baseX + smallestWidth) && itemIndex != this.draggedItemData.index) {
                this.draggedOverItem = itemData.item;
                this.draggedOverItemData = itemData;
                const positionOfDraggedItem = this.currentOrder.indexOf(this.draggedItemData.item);
                const positionOfOverItem = this.currentOrder.indexOf(this.draggedOverItemData.item);
                this.currentOrder[positionOfDraggedItem] = this.draggedOverItemData.item;
                this.currentOrder[positionOfOverItem] = this.draggedItemData.item;
                this.draggedItemData.position = positionOfOverItem;
                this.draggedOverItemData.position = positionOfDraggedItem;
                this.updatePositionOfItems();
                this.draggedItemNewPosition = positionOfOverItem;
            }
        }
    };
    setInitialDragPosition = (initialDragPosition) => {
        this.initialDragPosition = initialDragPosition;
    };
    updatePositionOfItems() {
        let currentPosition = 0;
        for (const item of this.currentOrder) {
            const itemData = this.getItemDataForItem(item);
            if (digg(itemData, "index") != digg(this, "draggedItemData", "index")) { // Dont animate dragged element to a new position because it is currently being dragged
                itemData.events.emit("moveToPosition", {
                    x: currentPosition,
                    y: 0
                });
            }
            itemData.baseX = currentPosition;
            currentPosition += digg(itemData, "layout", "width");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIvc3JjLyIsInNvdXJjZXMiOlsiZHJhZ2dhYmxlLXNvcnQvY29udHJvbGxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVyxDQUFBO0FBQzlCLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxlQUFlLENBQUE7QUFFMUMsTUFBTSxDQUFDLE9BQU8sT0FBTyx1QkFBdUI7SUFDMUMsWUFBWSxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFDO1FBQ3RDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFBO1FBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLElBQUksWUFBWSxFQUFFLENBQUE7UUFDMUMsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUE7UUFFaEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUE7UUFDdkIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUE7UUFDM0IsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQTtRQUVsQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQTtRQUMzQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFBO1FBRS9CLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFBO1FBRWxCLEtBQUssTUFBTSxTQUFTLElBQUksSUFBSSxFQUFFLENBQUM7WUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRztnQkFDekIsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNyQixRQUFRLEVBQUUsU0FBUzthQUNwQixDQUFBO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxTQUFTLEdBQUcsR0FBRyxFQUFF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QUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7WUFFOUMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLHVGQUF1RjtnQkFDOUosUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7b0JBQ3JDLENBQUMsRUFBRSxlQUFlO29CQUNsQixDQUFDLEVBQUUsQ0FBQztpQkFDTCxDQUFDLENBQUE7WUFDSixDQUFDO1lBRUQsUUFBUSxDQUFDLEtBQUssR0FBRyxlQUFlLENBQUE7WUFDaEMsZUFBZSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3RELENBQUM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2RpZ2d9IGZyb20gXCJkaWdnZXJpemVcIlxuaW1wb3J0IHtFdmVudEVtaXR0ZXJ9IGZyb20gXCJldmVudGVtaXR0ZXIzXCJcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRHJhZ2dhYmxlU29ydENvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3Rvcih7ZGF0YSwgZXZlbnRzLCBrZXlFeHRyYWN0b3J9KSB7XG4gICAgdGhpcy5kYXRhID0gZGF0YVxuICAgIHRoaXMuY3VycmVudE9yZGVyID0gWy4uLmRhdGFdXG4gICAgdGhpcy5ldmVudHMgPSBldmVudHMgfHwgbmV3IEV2ZW50RW1pdHRlcigpXG4gICAgdGhpcy5rZXlFeHRyYWN0b3IgPSBrZXlFeHRyYWN0b3JcblxuICAgIHRoaXMuZHJhZ2dlZEl0ZW0gPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkSXRlbURhdGEgPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkSXRlbU5ld1Bvc2l0aW9uID0gbnVsbFxuXG4gICAgdGhpcy5kcmFnZ2VkT3Zlckl0ZW0gPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkT3Zlckl0ZW1EYXRhID0gbnVsbFxuXG4gICAgdGhpcy5pdGVtRGF0YSA9IHt9XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW1JbmRleCBpbiBkYXRhKSB7XG4gICAgICB0aGlzLml0ZW1EYXRhW2l0ZW1JbmRleF0gPSB7XG4gICAgICAgIGluZGV4OiBpdGVtSW5kZXgsXG4gICAgICAgIGl0ZW06IGRhdGFbaXRlbUluZGV4XSxcbiAgICAgICAgcG9zaXRpb246IGl0ZW1JbmRleFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldEV2ZW50cyA9ICgpID0+IHRoaXMuZXZlbnRzXG4gIGdldEl0ZW1EYXRhRm9ySXRlbSA9IChpdGVtKSA9PiB0aGlzLmdldEl0ZW1EYXRhRm9ySW5kZXgodGhpcy5kYXRhLmluZGV4T2YoaXRlbSkpXG4gIGdldEl0ZW1EYXRhRm9yS2V5ID0gKGtleSkgPT4gdGhpcy5pdGVtRGF0YS5maW5kKChpdGVtRGF0YUkpID0+IGRpZ2coaXRlbURhdGFJLCBcImtleVwiKSA9PSBrZXkpXG4gIGdldEl0ZW1EYXRhRm9ySW5kZXggPSAoaW5kZXgpID0+IGRpZ2codGhpcywgXCJpdGVtRGF0YVwiLCBpbmRleClcblxuICBvbkRyYWdTdGFydCA9ICh7aXRlbSwgaXRlbUluZGV4fSkgPT4ge1xuICAgIGlmIChpdGVtKSB7XG4gICAgICB0aGlzLmRyYWdnZWRJdGVtID0gaXRlbVxuICAgICAgdGhpcy5kcmFnZ2VkSXRlbURhdGEgPSB0aGlzLmdldEl0ZW1EYXRhRm9ySW5kZXgoaXRlbUluZGV4KVxuICAgICAgdGhpcy5kcmFnZ2VkSXRlbUluZGV4ID0gaXRlbUluZGV4XG4gICAgICB0aGlzLmRyYWdnZWRJdGVtUG9zaXRpb24gPSB0aGlzLmRyYWdnZWRJdGVtRGF0YS5wb3NpdGlvblxuICAgICAgdGhpcy5ldmVudHMuZW1pdChcIm9uRHJhZ1N0YXJ0XCIsIHtpdGVtLCBpdGVtRGF0YTogdGhpcy5kcmFnZ2VkSXRlbURhdGF9KVxuICAgIH1cbiAgfVxuXG4gIG9uRHJhZ0VuZCA9ICgpID0+IHtcbiAgICBjb25zdCBpdGVtRGF0YSA9IHRoaXMuZHJhZ2dlZEl0ZW1EYXRhXG4gICAgY29uc3QgZnJvbUluZGV4ID0gaXRlbURhdGEuaW5kZXhcbiAgICBjb25zdCBmcm9tUG9zaXRpb24gPSBkaWdnKHRoaXMsIFwiZHJhZ2dlZEl0ZW1Qb3NpdGlvblwiKVxuICAgIGNvbnN0IHRvUG9zaXRpb24gPSB0aGlzLmRyYWdnZWRJdGVtTmV3UG9zaXRpb25cbiAgICBjb25zdCBmcm9tSXRlbSA9IHRoaXMuZHJhZ2dlZEl0ZW1cbiAgICBjb25zdCB0b0l0ZW0gPSB0aGlzLmRyYWdnZWRPdmVySXRlbVxuICAgIGNvbnN0IGNhbGxiYWNrQXJncyA9IHtpdGVtOiBpdGVtRGF0YS5pdGVtLCBpdGVtRGF0YSwgZnJvbUluZGV4LCBmcm9tSXRlbSwgZnJvbVBvc2l0aW9uLCB0b0l0ZW0sIHRvUG9zaXRpb259XG5cbiAgICB0aGlzLmRyYWdnZWRJdGVtRGF0YS5ldmVudHMuZW1pdChcInJlc2V0UG9zaXRpb25cIiwge1xuICAgICAgY2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5ldmVudHMuZW1pdChcIm9uRHJhZ0VuZEFuaW1hdGlvblwiLCBjYWxsYmFja0FyZ3MpXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuZHJhZ2dlZEl0ZW0gPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkSXRlbURhdGEgPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkSXRlbU5ld1Bvc2l0aW9uID0gbnVsbFxuXG4gICAgdGhpcy5kcmFnZ2VkT3Zlckl0ZW0gPSBudWxsXG4gICAgdGhpcy5kcmFnZ2VkT3Zlckl0ZW1EYXRhID0gbnVsbFxuXG4gICAgdGhpcy5ldmVudHMuZW1pdChcIm9uRHJhZ0VuZFwiLCBjYWxsYmFja0FyZ3MpXG4gIH1cblxuICBvbkl0ZW1MYXlvdXQgPSAoe2V2ZW50cywgaW5kZXgsIGl0ZW0sIGxheW91dH0pID0+IHtcbiAgICBpZiAoIShpbmRleCBpbiB0aGlzLml0ZW1EYXRhKSkgdGhyb3cgbmV3IEVycm9yKGBJdGVtIG5vdCBmb3VuZCBmb3IgaW5kZXggJHtpbmRleH1gKVxuXG4gICAgY29uc3QgaXRlbURhdGEgPSB0aGlzLml0ZW1EYXRhW2luZGV4XVxuXG4gICAgaXRlbURhdGEubGF5b3V0ID0gbGF5b3V0XG5cbiAgICBpZiAoIWl0ZW1EYXRhLmluaXRpYWxMYXlvdXQpIHtcbiAgICAgIGl0ZW1EYXRhLmJhc2VYID0gbGF5b3V0LnhcbiAgICAgIGl0ZW1EYXRhLmV2ZW50cyA9IGV2ZW50c1xuICAgICAgaXRlbURhdGEuaW5pdGlhbExheW91dCA9IGxheW91dFxuICAgICAgaXRlbURhdGEua2V5ID0gdGhpcy5rZXlFeHRyYWN0b3IoaXRlbSlcbiAgICB9XG4gIH1cblxuICBvbk1vdmUgPSAoe2dlc3RhdGV9KSA9PiB7XG4gICAgLy8gU2VuZCBtb3ZlLWV2ZW50IHRvIHRoZSBpdGVtIGJlaW5nIGRyYWdnZWQgc28gaXQgd2lsbCBhY3R1YWxseSBtb3ZlIGFyb3VuZFxuICAgIHRoaXMuZHJhZ2dlZEl0ZW1EYXRhPy5ldmVudHM/LmVtaXQoXCJtb3ZlXCIsIHtnZXN0YXRlfSlcblxuICAgIGNvbnN0IG1vdmVYID0gZ2VzdGF0ZS5keCArIHRoaXMuaW5pdGlhbERyYWdQb3NpdGlvbi54XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW1JbmRleCBpbiB0aGlzLml0ZW1EYXRhKSB7XG4gICAgICBjb25zdCBpdGVtRGF0YSA9IHRoaXMuZ2V0SXRlbURhdGFGb3JJbmRleChpdGVtSW5kZXgpXG4gICAgICBjb25zdCBiYXNlWCA9IGRpZ2coaXRlbURhdGEsIFwiYmFzZVhcIilcbiAgICAgIGxldCBzbWFsbGVzdFdpZHRoID0gdGhpcy5kcmFnZ2VkSXRlbURhdGEubGF5b3V0LndpZHRoXG5cbiAgICAgIGlmIChpdGVtRGF0YS5sYXlvdXQud2lkdGggPCBzbWFsbGVzdFdpZHRoKSBzbWFsbGVzdFdpZHRoID0gaXRlbURhdGEubGF5b3V0LndpZHRoXG5cbiAgICAgIGlmIChtb3ZlWCA+IGJhc2VYICYmIG1vdmVYIDwgKGJhc2VYICsgc21hbGxlc3RXaWR0aCkgJiYgaXRlbUluZGV4ICE9IHRoaXMuZHJhZ2dlZEl0ZW1EYXRhLmluZGV4KSB7XG4gICAgICAgIHRoaXMuZHJhZ2dlZE92ZXJJdGVtID0gaXRlbURhdGEuaXRlbVxuICAgICAgICB0aGlzLmRyYWdnZWRPdmVySXRlbURhdGEgPSBpdGVtRGF0YVxuXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uT2ZEcmFnZ2VkSXRlbSA9IHRoaXMuY3VycmVudE9yZGVyLmluZGV4T2YodGhpcy5kcmFnZ2VkSXRlbURhdGEuaXRlbSlcbiAgICAgICAgY29uc3QgcG9zaXRpb25PZk92ZXJJdGVtID0gdGhpcy5jdXJyZW50T3JkZXIuaW5kZXhPZih0aGlzLmRyYWdnZWRPdmVySXRlbURhdGEuaXRlbSlcblxuICAgICAgICB0aGlzLmN1cnJlbnRPcmRlcltwb3NpdGlvbk9mRHJhZ2dlZEl0ZW1dID0gdGhpcy5kcmFnZ2VkT3Zlckl0ZW1EYXRhLml0ZW1cbiAgICAgICAgdGhpcy5jdXJyZW50T3JkZXJbcG9zaXRpb25PZk92ZXJJdGVtXSA9IHRoaXMuZHJhZ2dlZEl0ZW1EYXRhLml0ZW1cblxuICAgICAgICB0aGlzLmRyYWdnZWRJdGVtRGF0YS5wb3NpdGlvbiA9IHBvc2l0aW9uT2ZPdmVySXRlbVxuICAgICAgICB0aGlzLmRyYWdnZWRPdmVySXRlbURhdGEucG9zaXRpb24gPSBwb3NpdGlvbk9mRHJhZ2dlZEl0ZW1cblxuICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uT2ZJdGVtcygpXG4gICAgICAgIHRoaXMuZHJhZ2dlZEl0ZW1OZXdQb3NpdGlvbiA9IHBvc2l0aW9uT2ZPdmVySXRlbVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldEluaXRpYWxEcmFnUG9zaXRpb24gPSAoaW5pdGlhbERyYWdQb3NpdGlvbikgPT4ge1xuICAgIHRoaXMuaW5pdGlhbERyYWdQb3NpdGlvbiA9IGluaXRpYWxEcmFnUG9zaXRpb25cbiAgfVxuXG4gIHVwZGF0ZVBvc2l0aW9uT2ZJdGVtcygpIHtcbiAgICBsZXQgY3VycmVudFBvc2l0aW9uID0gMFxuXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHRoaXMuY3VycmVudE9yZGVyKSB7XG4gICAgICBjb25zdCBpdGVtRGF0YSA9IHRoaXMuZ2V0SXRlbURhdGFGb3JJdGVtKGl0ZW0pXG5cbiAgICAgIGlmIChkaWdnKGl0ZW1EYXRhLCBcImluZGV4XCIpICE9IGRpZ2codGhpcywgXCJkcmFnZ2VkSXRlbURhdGFcIiwgXCJpbmRleFwiKSkgeyAvLyBEb250IGFuaW1hdGUgZHJhZ2dlZCBlbGVtZW50IHRvIGEgbmV3IHBvc2l0aW9uIGJlY2F1c2UgaXQgaXMgY3VycmVudGx5IGJlaW5nIGRyYWdnZWRcbiAgICAgICAgaXRlbURhdGEuZXZlbnRzLmVtaXQoXCJtb3ZlVG9Qb3NpdGlvblwiLCB7XG4gICAgICAgICAgeDogY3VycmVudFBvc2l0aW9uLFxuICAgICAgICAgIHk6IDBcbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgaXRlbURhdGEuYmFzZVggPSBjdXJyZW50UG9zaXRpb25cbiAgICAgIGN1cnJlbnRQb3NpdGlvbiArPSBkaWdnKGl0ZW1EYXRhLCBcImxheW91dFwiLCBcIndpZHRoXCIpXG4gICAgfVxuICB9XG59XG4iXX0=